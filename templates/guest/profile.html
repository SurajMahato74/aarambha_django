{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
    <link href="{% static 'website/css/bootstrap.min.css' %}" rel="stylesheet" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{% static 'website/css/slick.min.css' %}" crossorigin="anonymous"
        referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{% static 'website/css/owl.carousel.min.css' %}" />
    <!-- Link Swiper's CSS -->
    <link rel="stylesheet" href="{% static 'website/css/swiper-bundle.min.css' %}" />
    <!-- Link Swiper's CSS end-->
    <link rel="stylesheet" href="{% static 'website/css/animate.min.css' %}" />
    <!-- custom-css  -->
    <link rel="stylesheet" href="{% static 'website/css/index.css' %}" />
    <link rel="stylesheet" href="{% static 'website/css/style.css' %}" />
    <!-- custom-css end -->
    <link rel="icon" type="image.png' %}" href="{% static 'website/images/favicon.png' %}" />
    <title>Guest Welcome â€¢ Aarambha Foundation</title>
    <style>
        .sidebar .list-group-item.active {
            background-color: #2D3B5B;
            border-color: #2D3B5B;
            color: white;
        }

        .sidebar .card {
            background-color: #f8f6f4;
        }

        .profile-section {
            background-color: #f8f6f4;
        }

        .application-table tbody tr {
            transition: background 0.2s ease;
        }

        .application-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* Status pill */
        .status-pill {
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        /* Example status colors */
        .status-approved {
            background: #e6f4ea;
            color: #1e7e34;
        }

        .status-pending {
            background: #fff4e5;
            color: #b45309;
        }

        .status-rejected {
            background: #fdecea;
            color: #b02a37;
        }

        /* Application detail modal background */
        #applicationDetailModal .modal-content,
        #interviewScheduleModal .modal-content,
        #editApplicationModal .modal-content {
            background-color: #f8f6f4;
            /* light beige */
            border-radius: 12px;
        }

        /* Header background */
        #applicationDetailModal .modal-header,
        #interviewScheduleModal .modal-header,
        #editApplicationModal .modal-header {
            background-color: #2D3B5B;
            color: #fff;
            border-bottom: none;
        }

        /* Footer background */
        #applicationDetailModal .modal-footer,
        #interviewScheduleModal .modal-footer,
        #editApplicationModal .modal-footer {
            background-color: #f1f1f1;
        }
        .profile-section h6{
            letter-spacing: 1px !important;
            font-size: 16px;
            margin-bottom: 5px;
        }
        #applicationModalBody h6{
            letter-spacing: 1px !important;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .profile-section p{
            font-size: 14px;
        }
        #applicationModalBody p{
            font-size: 12px;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
</head>

<body>
    {% include 'website/includes/navbar.html'%}
    <!-- Guest Welcome Content -->
    <section class="py-3 profile-section" style="min-height: 100vh;">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <header class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center gap-2">
                        </div>
                    </header>

                    <div class="row">
                        <!-- Horizontal Navigation -->
                        <div class="col-12 mb-2">
                            <div class="card p-0 ">
                                <div class="card-body p-0">
                                    <nav class="nav nav-pills nav-justified" id="sidebarNav">
                                        <a href="#" class="nav-link active" data-target="profile" style="background-color: #2D3B5B; border-color: #2D3B5B;">
                                            <i class="fas fa-user me-1"></i>Profile
                                        </a>
                                        <a href="#" class="nav-link" data-target="notices" style="color: #E36F1E;">
                                            <i class="fas fa-bell me-1"></i>Notices
                                        </a>
                                        <a href="#" class="nav-link" data-target="applications" style="color: #E36F1E;">
                                            <i class="fas fa-file-alt me-1"></i>Applications
                                        </a>
                                        <a href="#" class="nav-link" data-target="donations" style="color: #E36F1E;">
                                            <i class="fas fa-heart me-1"></i>My Donations
                                        </a>
                                    </nav>
                                </div>
                            </div>
                        </div>
                        <!-- Main Content -->
                        <div class="col-12">
                            <div id="profile" class="content-section" style="display: block; ">
                                <div class="card">
                                    <div class="card-header" style="background-color: #E36F1E; color: white;">
                                        <h5 class="mb-0"><i class="fas fa-user me-2"></i>Profile Information</h5>
                                    </div>
                                    <div class="card-body" id="profileContainer">
                                        <div class="text-center py-4">
                                            <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                                            <p class="text-muted">Loading profile...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="notices" class="content-section" style="display: none; ">
                                <div id="noticesContainer">
                                    <div class="text-center py-2">
                                        <i class="fas fa-spinner fa-spin fa-2x text-muted mb-2"></i>
                                        <p class="text-muted">Loading notices...</p>
                                    </div>
                                </div>
                            </div>
                            <div id="applications" class="content-section" style="display: none; ">
                                <div class="table-responsive">
                                    <table class="table table-borderless">
                                        <thead style="background: #2D3B5B; color: #fff;">
                                            <tr>
                                                <th>Type</th>
                                                <th>Status</th>
                                                <th>Payment Status</th>
                                                <th>Applied Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="applicationsTableBody">
                                            <tr>
                                                <td colspan="5" class="text-center py-4">
                                                    <i class="fas fa-spinner fa-spin me-2"></i>Loading applications...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div id="donations" class="content-section" style="display: none; ">
                                <div class="table-responsive">
                                    <table class="table table-borderless">
                                        <thead style="background: #2D3B5B; color: #fff;">
                                            <tr>
                                                <th>Amount</th>
                                                <th>Status</th>
                                                <th>Transaction ID</th>
                                                <th>Date</th>
                                                <th>Receipt ID</th>
                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="donationsTableBody">
                                            <tr>
                                                <td colspan="5" class="text-center py-4">
                                                    <i class="fas fa-spinner fa-spin me-2"></i>Loading donations...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    {% include "website/includes/login_modal.html" %}

    {% include "website/includes/footer.html" %}
<!-- Application Details Modal -->
<div class="modal fade" id="applicationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background-color: #f8f6f4;">
            <div class="modal-header" style="background-color: #E36F1E; color: white;">
                <h5 class="modal-title">Application Details</h5>
                <button type="button" class="close " data-dismiss="modal" aria-label="Close">
                    <span  aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="applicationModalBody" style="background-color: #f8f6f4;">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Interview Details Modal -->
<div class="modal fade" id="interviewModal" tabindex="-1">
    <div class="modal-dialog modal-md">
        <div class="modal-content" style="background-color: #f8f6f4;">
            <div class="modal-header" style="background-color: #E36F1E; color: white;">
                <h5 class="modal-title">Interview Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="interviewModalBody" style="background-color: #f8f6f4;">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Edit Application Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="background-color: #f8f6f4;">
            <div class="modal-header" style="background-color: #E36F1E; color: white;">
                <h5 class="modal-title">Edit Application</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="editModalBody" style="background-color: #f8f6f4; max-height: 70vh; overflow-y: auto;">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

    <!-- scripts start -->
    <!-- jquery  start-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <!-- jquery end -->
    <!-- bootstrap  start -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
    <!-- bootstrap end -->
    <script src="{% static 'website/js/slick.min.js' %}" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Swiper JS -->
    <script src="{% static 'website/js/swiper-bundle.min.js' %}" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script src="{% static 'website/js/modernizr.min.js' %}" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script>
    <script src="{% static 'website/js/owl.carousel.min.js' %}"></script>
    <script src="{% static 'website/js/api.js' %}"></script>
    <script src="{% static 'website/js/main.js' %}"></script>
    <script src="{% static 'website/js/animation.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="{% static 'website/js/general.js' %}"></script>
    <script src="{% static 'website/js/nav.js' %}"></script>
    <script src="{% static 'js/navbar.js' %}"></script>
    <script src="{% static 'js/config.js' %}"></script>
    <script src="{% static 'js/auth-utils.js' %}"></script>
    <script src="{% static 'js/debug-utils.js' %}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Profile page loaded successfully');
            
            // Check for hash in URL and auto-click applications tab
            if (window.location.hash === '#applications') {
                setTimeout(() => {
                    const applicationsTab = document.querySelector('[data-target="applications"]');
                    if (applicationsTab) {
                        applicationsTab.click();
                    }
                }, 500);
            }
            
            // Check for donation redirect parameter and auto-click donations tab
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('tab') === 'donations' || window.location.hash === '#donations') {
                setTimeout(() => {
                    const donationsTab = document.querySelector('[data-target="donations"]');
                    if (donationsTab) {
                        donationsTab.click();
                    }
                }, 500);
            }
            
            {% if django_authenticated %}
            // Sync Django auth to localStorage
            localStorage.setItem('access_token', '{{ access_token }}');
            localStorage.setItem('refresh_token', '{{ refresh_token }}');
            localStorage.setItem('user', '{{ user_data|escapejs }}');
            
            const userData = JSON.parse('{{ user_data|escapejs }}');
            console.log('User authenticated:', userData);
            
            // Set user info in UI
            if (document.getElementById('profileEmail')) {
                document.getElementById('profileEmail').textContent = userData.email;
            }
            
            // Update navbar auth after syncing
            setTimeout(() => {
                if (typeof updateNavbarAuth === 'function') {
                    updateNavbarAuth();
                }
            }, 100);
            {% else %}
            // For non-Django authenticated users, check localStorage
            const user = getUser();
            if (user) {
                if (document.getElementById('profileEmail')) {
                    document.getElementById('profileEmail').textContent = user.email;
                }
            }
            {% endif %}
            
            // Load profile on page load
            loadProfile();
            
            // Setup horizontal navigation
            document.getElementById('sidebarNav').addEventListener('click', function (e) {
                e.preventDefault();
                if (e.target.classList.contains('nav-link')) {
                    const target = e.target.getAttribute('data-target');
                    document.querySelectorAll('#sidebarNav .nav-link').forEach(item => {
                        item.classList.remove('active');
                        item.style.backgroundColor = '';
                        item.style.color = '#2D3B5B';
                    });
                    e.target.classList.add('active');
                    e.target.style.backgroundColor = '#2D3B5B';
                    e.target.style.color = 'white';
                    document.querySelectorAll('.content-section').forEach(section => section.style.display = 'none');
                    document.getElementById(target).style.display = 'block';
                    
                    // Load data when switching to applications tab
                    if (target === 'applications') {
                        loadApplications();
                    }
                    // Load data when switching to profile tab
                    if (target === 'profile') {
                        loadProfile();
                    }
                    // Load data when switching to notices tab
                    if (target === 'notices') {
                        loadNotices();
                    }
                    // Load data when switching to donations tab
                    if (target === 'donations') {
                        loadDonations();
                    }
                }
            });
        });
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear all localStorage data
                localStorage.removeItem('user');
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                
                // Make POST request to logout endpoint
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/logout/';
                
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                 document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                                 '{{ csrf_token }}';
                
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        async function loadNotices() {
            try {
                // Check if user is authenticated
                const token = localStorage.getItem('access_token');
                if (!token) {
                    throw new Error('No authentication token');
                }
                
                const response = await fetchAPI('/api/notices/my-notifications/');
                
                if (!response.ok) {
                    // If 403, try to refresh token or redirect to login
                    if (response.status === 403) {
                        console.log('Authentication failed, redirecting to login');
                        localStorage.clear();
                        window.location.href = '/accounts/login/';
                        return;
                    }
                    throw new Error('Failed to fetch notices');
                }
                
                const data = await response.json();
                console.log('Notifications data:', data);
                
                // Handle case where API returns an object with notifications array
                const notificationsList = data.notifications || data.results || data || [];

                const container = document.getElementById('noticesContainer');

                if (notificationsList.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No notices available at the moment.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = notificationsList.map(notification => {
                        let alertClass = 'alert-secondary';
                        let iconClass = 'fas fa-bell';

                        switch (notification.notification_type) {
                            case 'application_submitted':
                            case 'application_resubmitted':
                                alertClass = 'alert-primary';
                                iconClass = 'fas fa-paper-plane';
                                break;
                            case 'application_updated':
                                alertClass = 'alert-warning';
                                iconClass = 'fas fa-edit';
                                break;
                            case 'application_approved':
                                alertClass = 'alert-success';
                                iconClass = 'fas fa-check-circle';
                                break;
                            case 'application_rejected':
                                alertClass = 'alert-danger';
                                iconClass = 'fas fa-times-circle';
                                break;
                            case 'interview_scheduled':
                            case 'interview_rescheduled':
                                alertClass = 'alert-info';
                                iconClass = 'fas fa-calendar';
                                break;
                        }

                        const createdDate = new Date(notification.created_at).toLocaleDateString();
                        const isUnread = !notification.is_read ? '<span class="badge bg-primary ms-2">New</span>' : '';

                        return `
                            <div class="alert ${alertClass} mb-2 ${!notification.is_read ? 'border-start border-primary border-1' : ''}">
                                <h6 class="alert-heading">
                                    <i class="${iconClass}"></i> ${notification.title}${isUnread}
                                </h6>
                                <p class="mb-2">${notification.message}</p>
                                <hr>
                                <p class="mb-0 small text-muted">
                                    <i class="far fa-calendar-alt me-1"></i> ${createdDate}
                                    ${notification.related_application_id ? `<br><strong>Application ID:</strong> ${notification.related_application_id}` : ''}
                                </p>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading notices:', error);
                document.getElementById('noticesContainer').innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Please login to view notices.</p>
                        <a href="/accounts/login/" class="btn btn-primary btn-sm">Login</a>
                    </div>
                `;
            }
        }
        
        async function loadApplications() {
            try {
                // Load regular applications
                const response = await fetchAPI('/api/applications/my-applications/');
                const applications = await response.json();
                
                // Load sponsorship applications
                const sponsorshipResponse = await fetchAPI('/api/applications/sponsorships/my/');
                const sponsorships = await sponsorshipResponse.json();
                
                // Load school dropout reports
                const reportsResponse = await fetchAPI('/api/core/reports/school-dropout/my/');
                const reports = await reportsResponse.json();
                
                const tbody = document.getElementById('applicationsTableBody');
                
                if (applications.length === 0 && sponsorships.length === 0 && reports.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <i class="fas fa-file-lines fa-3x text-muted mb-3"></i>
                                <p class="text-muted mb-4">No applications found.</p>
                                <div class="d-flex gap-3 justify-content-center">
                                    <a href="/member-form/" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-user-plus me-1"></i>Apply as Member
                                    </a>
                                    <a href="/volunteer-form/" class="btn btn-outline-success btn-sm">
                                        <i class="fas fa-hands-helping me-1"></i>Apply as Volunteer
                                    </a>
                                    <a href="/sponsor-child-form/" class="btn btn-outline-warning btn-sm">
                                        <i class="fas fa-heart me-1"></i>Sponsor a Child
                                    </a>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    let allApplications = [];
                    
                    // Add regular applications
                    applications.forEach(app => {
                        allApplications.push({
                            ...app,
                            type: 'application',
                            display_type: app.application_type.toUpperCase()
                        });
                    });
                    
                    // Add sponsorship applications
                    sponsorships.forEach(sponsorship => {
                        allApplications.push({
                            ...sponsorship,
                            type: 'sponsorship',
                            display_type: 'CHILD SPONSORSHIP',
                            application_type: 'sponsorship'
                        });
                    });
                    
                    // Add school dropout reports
                    reports.forEach(report => {
                        allApplications.push({
                            ...report,
                            type: 'report',
                            display_type: 'SCHOOL DROPOUT REPORT',
                            application_type: 'report',
                            applied_at: report.created_at
                        });
                    });
                    
                    // Sort by creation date
                    allApplications.sort((a, b) => new Date(b.applied_at || b.created_at) - new Date(a.applied_at || a.created_at));
                    
                    tbody.innerHTML = allApplications.map(app => `
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-${app.type === 'sponsorship' ? 'heart' : app.type === 'report' ? 'exclamation-triangle' : app.application_type === 'member' ? 'user' : 'hands-helping'} me-2 text-primary"></i>
                                    <div>
                                        <div class="fw-bold">${app.display_type}</div>
                                        <small class="text-muted">ID: #${app.id}</small>
                                        ${app.type === 'report' ? `<br><small class="text-muted">${app.dropout_name} - ${app.school_name}</small>` : ''}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge" style="background-color: ${getStatusColor(app.status)}; color: #000 !important;">
                                    ${app.status.replace('_', ' ').toUpperCase()}
                                </span>
                                ${app.type === 'application' && app.status === 'rejected' && app.rejection_type === 'correction' ? 
                                    '<br><small class="text-warning">Can be edited</small>' : ''}
                                ${app.type === 'application' && app.status === 'interview_scheduled' ? 
                                    `<br><small class="text-info"><i class="fas fa-calendar me-1"></i>Scheduled: ${new Date(app.interview_datetime).toLocaleDateString()}</small>` : ''}
                            </td>
                            <td>
                                ${app.type === 'application' && app.application_type === 'member' && app.payment_required ? `
                                    <span class="badge ${app.payment_completed ? 'bg-success' : 'bg-warning'}" style="color: #000 !important;">
                                        ${app.payment_completed ? 'Paid' : 'Pending'}
                                    </span>
                                    ${app.payment_completed ? `<br><small style="color: #000;">Paid Rs. ${app.payment_amount}</small>` : `<br><small class="text-muted">Rs. ${app.payment_amount}</small>`}
                                    ${app.payment_completed && app.payment_date ? `<br><small class="text-muted">${new Date(app.payment_date).toLocaleDateString()}</small>` : ''}
                                ` : app.type === 'sponsorship' && app.payment_amount ? `
                                    <span class="text-success">Rs. ${app.payment_amount}</span>
                                ` : '<span class="text-muted">N/A</span>'}
                            </td>
                            <td>
                                <div>${new Date(app.applied_at || app.created_at).toLocaleDateString()}</div>
                                <small class="text-muted">${new Date(app.applied_at || app.created_at).toLocaleTimeString()}</small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="fs-3" onclick="${app.type === 'sponsorship' ? 'showSponsorshipModal' : app.type === 'report' ? 'showReportModal' : 'showApplicationModal'}(${app.id})" title="Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${app.type === 'application' && app.status === 'interview_scheduled' ? `
                                        <button class="fs-3" onclick="viewInterviewDetails(${app.id})" title="Interview Details">
                                            <i class="fas fa-calendar"></i>
                                        </button>
                                        ${!app.interview_acknowledged ? `
                                            <button class="fs-3" onclick="acknowledgeInterview(${app.id})" title="Acknowledge Interview">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        ` : `
                                            <span class="badge ms-1" title="Interview Acknowledged" style="background-color: #28a745; color: white;">
                                                <i class="fas fa-check-circle"></i> Ack
                                            </span>
                                        `}
                                    ` : ''}
                                    ${app.type === 'application' && app.status === 'rejected' && app.rejection_type === 'correction' ? `
                                        <button class="fs-3" onclick="editApplication(${app.id})" title="Edit Application">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    ` : ''}
                                    ${app.type === 'sponsorship' && app.status === 'rejected' && app.can_reapply ? `
                                        <button class="fs-3" onclick="editSponsorship(${app.id})" title="Edit & Reapply">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading applications:', error);
                document.getElementById('applicationsTableBody').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>No applications found.</p>
                        </td>
                    </tr>
                `;
            }
        }
        
        function getStatusColor(status) {
            const colors = {
                pending: '#ffc107',
                interview_scheduled: '#17a2b8',
                rejected: '#dc3545',
                approved: '#28a745',
                investigated: '#17a2b8',
                resolved: '#28a745'
            };
            return colors[status] || '#6c757d';
        }
        
        async function showSponsorshipModal(id) {
            try {
                const response = await fetchAPI(`/api/applications/sponsorships/${id}/`);
                const sponsorship = await response.json();
                
                const modalBody = document.getElementById('applicationModalBody');
                modalBody.innerHTML = `
                    <!-- Profile Header -->
                    <div class="row mb-2">
                        <div class="col-md-12">
                            <h5 class="mb-0" style="color: #E36F1E;">Child Sponsorship Application</h5>
                            <p class="text-muted mb-0">${sponsorship.email} | ${sponsorship.phone}</p>
                            <span class="badge fs-6 px-3 py-2" style="background-color: ${getStatusColor(sponsorship.status)}; color: #000 !important;">${sponsorship.status.replace('_', ' ').toUpperCase()}</span>
                            <p class="small text-muted mb-2">Application #${sponsorship.id} | ${new Date(sponsorship.created_at).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <hr/>
                    
                    <!-- Personal Information -->
                    <div class="row mb-2">
                        <div class="col-md-4">
                            <h6 class="text-primary"><i class="fas fa-user me-2"></i>Personal Information</h6>
                            <p><strong>Full Name:</strong> ${sponsorship.full_name}</p>
                            <p><strong>Country:</strong> ${sponsorship.country}</p>
                            <p><strong>City:</strong> ${sponsorship.city}</p>
                            <p><strong>Address:</strong> ${sponsorship.address}</p>
                            <p><strong>Occupation:</strong> ${sponsorship.occupation || 'N/A'}</p>
                            <p><strong>Organization:</strong> ${sponsorship.organization || 'N/A'}</p>
                        </div>
                        
                        <div class="col-md-4">
                            <h6 class="text-primary"><i class="fas fa-heart me-2"></i>Sponsorship Preferences</h6>
                            <p><strong>Type:</strong> ${sponsorship.sponsorship_type}</p>
                            <p><strong>Child Gender:</strong> ${sponsorship.child_gender || 'No preference'}</p>
                            <p><strong>Child Age:</strong> ${sponsorship.child_age || 'No preference'}</p>
                            ${sponsorship.special_requests ? `<p><strong>Special Requests:</strong> ${sponsorship.special_requests}</p>` : ''}
                        </div>
                        
                        <div class="col-md-4">
                            <h6 class="text-primary"><i class="fas fa-envelope me-2"></i>Communication</h6>
                            <p><strong>Update Frequency:</strong> ${sponsorship.update_frequency}</p>
                            <p><strong>Methods:</strong> ${sponsorship.comm_method.join(', ') || 'Not specified'}</p>
                            ${sponsorship.message ? `<p><strong>Message:</strong> ${sponsorship.message}</p>` : ''}
                        </div>
                    </div>
                    
                    <!-- Payment Information -->
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <h6 class="text-primary"><i class="fas fa-credit-card me-2"></i>Payment Information</h6>
                            <p><strong>Method:</strong> ${sponsorship.payment_method}</p>
                            <p><strong>Amount:</strong> ${sponsorship.payment_amount ? 'Rs. ' + sponsorship.payment_amount : 'Not specified'}</p>
                            <p><strong>Frequency:</strong> ${sponsorship.payment_frequency}</p>
                            <p><strong>Tax Deductible:</strong> ${sponsorship.tax_deductible ? 'Yes' : 'No'}</p>
                        </div>
                        
                        ${sponsorship.admin_notes ? `
                        <div class="col-md-6">
                            <h6 class="text-primary"><i class="fas fa-sticky-note me-2"></i>Admin Notes</h6>
                            <div class="alert alert-info">${sponsorship.admin_notes}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // Show modal using Bootstrap 4 syntax
                $('#applicationModal').modal('show');
            } catch (error) {
                console.error('Error loading sponsorship details:', error);
                alert('Error loading sponsorship details.');
            }
        }
        
        async function showReportModal(id) {
            try {
                const response = await fetchAPI(`/api/core/reports/school-dropout/admin/${id}/`);
                const report = await response.json();
                
                const modalBody = document.getElementById('applicationModalBody');
                modalBody.innerHTML = `
                    <!-- Profile Header -->
                    <div class="row mb-2">
                        <div class="col-md-12">
                            <h5 class="mb-0" style="color: #E36F1E;">School Dropout Report</h5>
                            <p class="text-muted mb-0">${report.reporter_email} | ${report.reporter_phone || 'N/A'}</p>
                            <span class="badge fs-6 px-3 py-2" style="background-color: ${getStatusColor(report.status)}; color: #000 !important;">${report.status.replace('_', ' ').toUpperCase()}</span>
                            <p class="small text-muted mb-2">Report #${report.id} | ${new Date(report.created_at).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <hr/>
                    
                    <!-- Reporter Information -->
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <h6 class="text-primary"><i class="fas fa-user me-2"></i>Reporter Information</h6>
                            <p><strong>Name:</strong> ${report.reporter_name}</p>
                            <p><strong>Email:</strong> ${report.reporter_email}</p>
                            <p><strong>Phone:</strong> ${report.reporter_phone || 'N/A'}</p>
                            <p><strong>Anonymous:</strong> ${report.is_anonymous ? 'Yes' : 'No'}</p>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-primary"><i class="fas fa-child me-2"></i>Child Information</h6>
                            <p><strong>Name:</strong> ${report.dropout_name}</p>
                            <p><strong>Age:</strong> ${report.dropout_age}</p>
                            <p><strong>Gender:</strong> ${report.dropout_gender}</p>
                        </div>
                    </div>
                    
                    <!-- School Information -->
                    <div class="row mb-2">
                        <div class="col-md-12">
                            <h6 class="text-primary"><i class="fas fa-school me-2"></i>School Information</h6>
                            <p><strong>School Name:</strong> ${report.school_name}</p>
                            <p><strong>Location:</strong> ${report.school_location}</p>
                            <p><strong>District:</strong> ${report.district}</p>
                        </div>
                    </div>
                    
                    <!-- Report Details -->
                    <div class="row mb-2">
                        <div class="col-md-12">
                            <h6 class="text-primary"><i class="fas fa-info-circle me-2"></i>Report Details</h6>
                            <p><strong>Reason for Dropout:</strong></p>
                            <div class="alert alert-light">${report.reason_for_dropout}</div>
                            ${report.additional_notes ? `
                                <p><strong>Additional Notes:</strong></p>
                                <div class="alert alert-light">${report.additional_notes}</div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Timeline -->
                    <div class="row mb-2">
                        <div class="col-md-12">
                            <h6 class="text-primary"><i class="fas fa-clock me-2"></i>Timeline</h6>
                            <p class="mb-0"><strong>Submitted:</strong> ${new Date(report.created_at).toLocaleString()}</p>
                            <p class="mb-0"><strong>Last Updated:</strong> ${new Date(report.updated_at).toLocaleString()}</p>
                        </div>
                    </div>
                `;
                
                // Show modal using Bootstrap 4 syntax
                $('#applicationModal').modal('show');
            } catch (error) {
                console.error('Error loading report details:', error);
                alert('Error loading report details.');
            }
        }
        
        async function showApplicationModal(id) {
            try {
                const response = await fetchAPI(`/api/applications/${id}/`);
                const app = await response.json();
                
                const modalBody = document.getElementById('applicationModalBody');
                modalBody.innerHTML = `
                    <!-- Profile Header -->
                    <div class="row mb-2">
                        <div class="col-md-4">
                            ${app.photo ? `<img src="${app.photo}" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover; border: 1px solid #E36F1E;">` : '<div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width: 120px; height: 120px; color: white; font-size: 48px;"><i class="fas fa-user"></i></div>'}
                        </div>
                       <div class="col-md-8">
                         <h5 class="mb-0" style="color: #E36F1E;">${app.full_name || 'N/A'}</h5>
                         <p class="text-muted mb-0">${app.profession || 'N/A'}</p>
                         <p class="small text-muted"><i class="fas fa-envelope me-1"></i>${app.user_email || 'N/A'} | <i class="fas fa-phone me-1"></i>${app.phone || 'N/A'}</p>
                         <span class="badge fs-6 px-3 py-2" style="background-color: ${getStatusColor(app.status)}">${app.status.replace('_', ' ').toUpperCase()}</span>
                         <p class="small text-muted mb-2">Application #${app.id} | ${app.application_type.toUpperCase()}</p>
                         </div>

                    </div>
                    <hr/>
                    
                    
                    <!-- Personal Information -->
                    <div class="row mb-2">
                        <div class="col-md-4">
                            <h6 class="text-primary "><i class="fas fa-user me-2"></i>Personal Information</h6>
                            <p><strong>Date of Birth:</strong> ${app.date_of_birth || 'N/A'}</p>
                            <p><strong>Country:</strong> ${app.country || 'N/A'}</p>
                            <p><strong>District:</strong> ${app.district || 'N/A'}</p>
                            <p><strong>Temporary Address:</strong> ${app.temporary_address || 'N/A'}</p>
                            <p><strong>Permanent Address:</strong> ${app.permanent_address || 'N/A'}</p>
                        </div>
                       
                        <div class="col-md-4">
                            <h6 class="text-primary "><i class="fas fa-briefcase me-2"></i>Professional Information</h6>
                            <p><strong>Time Commitment:</strong> ${app.time_commitment || 'N/A'}</p>
                            <p><strong>Other Organizations:</strong> ${app.other_organizations || 'None'}</p>
                        </div>
                        <div class="col-md-4">
                            ${app.social_link ? `<p><strong>Social Link:</strong> <a href="${app.social_link}" target="_blank" class="text-decoration-none"><i class="fas fa-link me-1"></i>View Profile</a></p>` : ''}
                        </div>
                   
                    
                    ${app.skills && app.skills.length > 0 ? `
                    <!-- Skills -->
                        <div class="col-md-4">
                            <h6 class="text-primary "><i class="fas fa-star me-2"></i>Skills</h6>
                            <div class="d-flex flex-wrap gap-2">
                                ${app.skills.map(skill => `<span class="badge bg-primary text-dark border">${skill}</span>`).join('')}
                            </div>
                        
                    </div>` : ''}
                    
                    ${app.why_join ? `
                    <!-- Why Join -->
                        <div class="col-md-4">
                            <h6 class="text-primary"><i class="fas fa-heart me-2"></i>Why Join</h6>
                            <p class="text-muted bg-light  rounded">${app.why_join}</p>
                        </div>` : ''}
                    
                    ${app.self_definition ? `
                    <!-- Self Definition -->
                
                        <div class="col-md-4">
                            <h6 class="text-primary "><i class="fas fa-quote-left me-2"></i>Self Definition</h6>
                            <p class="text-muted bg-light  rounded">${app.self_definition}</p>
                        </div>
                   ` : ''}
                    
                    ${app.ideas ? `
                    <!-- Ideas -->
                   
                        <div class="col-md-4">
                            <h6 class="text-primary "><i class="fas fa-lightbulb me-2"></i>Ideas</h6>
                            <p class="text-muted bg-light  rounded">${app.ideas}</p>
                        </div>
               ` : ''}
                    
                    ${app.hobbies_interests ? `
                    <!-- Hobbies & Interests -->
                        <div class="col-md-4">
                            <h6 class="text-primary "><i class="fas fa-gamepad me-2"></i>Hobbies & Interests</h6>
                            <p class="text-muted bg-light  rounded">${app.hobbies_interests}</p>
                        </div>
                  ` : ''}
                    </div>
                    
                    <!-- Documents -->
                    <div class="row mb-2">
                        <div class="col-12">
                            <h6 class="text-primary mb-2"><i class="fas fa-file-alt me-2"></i>Documents</h6>
                            <div class="row">
                                ${app.citizenship_front ? `<div class="col-md-6 mb-2"><a href="${app.citizenship_front}" target="_blank" class="btn btn-outline-primary btn-sm w-100 py-2" style="font-size:12px"><i class="fas fa-id-card me-1"></i>Citizenship Front</a></div>` : ''}
                                ${app.citizenship_back ? `<div class="col-md-6 mb-2"><a href="${app.citizenship_back}" target="_blank" class="btn btn-outline-primary btn-sm w-100 py-2" style="font-size:12px"><i class="fas fa-id-card me-1"></i>Citizenship Back</a></div>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="row mb-2">
                    
                    ${app.payment_required ? `
                    <!-- Payment Information -->
                        <div class="col-md-4">
                            <h6 class="text-primary "><i class="fas fa-credit-card me-2"></i>Payment Information</h6>
                            <div class="bg-light  rounded">
                                <p class="mb-2"><strong>Amount:</strong> Rs. ${app.payment_amount}</p>
                                <p class="mb-2"><strong>Status:</strong> <span class="badge ${app.payment_completed ? 'bg-success' : 'bg-warning'}">${app.payment_completed ? 'Completed' : 'Pending'}</span></p>
                                ${app.payment_date ? `<p class="mb-0"><strong>Date:</strong> ${new Date(app.payment_date).toLocaleDateString()}</p>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${app.rejection_reason ? `
                    <!-- Rejection Reason -->
                   
                        <div class="col-md-4">
                            <h6 class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Rejection Reason</h6>
                            <div class="alert alert-danger">${app.rejection_reason}</div>
                        </div>
                   ` : ''}
                    
                    <!-- Application Timeline -->
                 
                        <div class="col-md-4">
                            <h6 class="text-primary"><i class="fas fa-clock me-2"></i>Timeline</h6>
                            <div class="bg-light  rounded">
                                <p class="mb-0"><strong>Applied:</strong> ${new Date(app.applied_at).toLocaleString()}</p>
                                <p class="mb-0"><strong>Last Updated:</strong> ${new Date(app.updated_at).toLocaleString()}</p>
                            </div>
                        </div>
                 
                    </div>
                `;
                
                // Show modal using Bootstrap 4 syntax
                $('#applicationModal').modal('show');
            } catch (error) {
                console.error('Error loading application details:', error);
                alert('Error loading application details.');
            }
        }
        
        async function viewInterviewDetails(id) {
            try {
                const response = await fetchAPI(`/api/applications/${id}/`);
                const app = await response.json();
                
                const modalBody = document.getElementById('interviewModalBody');
                
                if (app.interview_datetime) {
                    modalBody.innerHTML = `
                        <div class="text-center mb-4">
                            <i class="fas fa-calendar-alt fa-3x text-primary mb-3"></i>
                            <h5 style="color: #E36F1E;">Interview Scheduled</h5>
                        </div>
                        
                        <div class="bg-light p-3 rounded mb-3">
                            <h6 class="text-primary mb-3"><i class="fas fa-clock me-2"></i>Schedule</h6>
                            <p class="mb-2"><strong>Date & Time:</strong> ${new Date(app.interview_datetime).toLocaleString()}</p>
                            <p class="mb-0"><strong>Status:</strong> <span class="badge ${app.interview_acknowledged ? 'bg-success' : 'bg-warning'}">${app.interview_acknowledged ? 'Acknowledged' : 'Pending Acknowledgment'}</span></p>
                        </div>
                        
                        ${app.interview_link ? `
                        <div class="bg-light p-3 rounded mb-3">
                            <h6 class="text-primary mb-3"><i class="fas fa-link me-2"></i>Meeting Link</h6>
                            <p class="mb-0"><a href="${app.interview_link}" target="_blank" class="btn btn-outline-primary btn-sm"><i class="fas fa-external-link-alt me-1"></i>Join Interview</a></p>
                        </div>` : ''}
                        
                        ${app.interview_description ? `
                        <div class="bg-light p-3 rounded mb-3">
                            <h6 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>Instructions</h6>
                            <p class="mb-0">${app.interview_description}</p>
                        </div>` : ''}
                        
                        <div class="text-center">
                            ${!app.interview_acknowledged ? `
                            <button class="btn btn-success" onclick="acknowledgeInterview(${app.id}); $('#interviewModal').modal('hide');">
                                <i class="fas fa-check me-1"></i>Acknowledge Interview
                            </button>` : `
                            <div class="alert alert-success mb-0">
                                <i class="fas fa-check-circle me-2"></i>Interview acknowledged successfully!
                            </div>`}
                        </div>
                    `;
                } else {
                    modalBody.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No interview details available.</p>
                        </div>
                    `;
                }
                
                $('#interviewModal').modal('show');
            } catch (error) {
                console.error('Error loading interview details:', error);
                alert('Error loading interview details.');
            }
        }
        
        async function acknowledgeInterview(id) {
            try {
                const token = localStorage.getItem('access_token');
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                 document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                
                const response = await fetch(`/api/applications/${id}/acknowledge/`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'X-CSRFToken': csrfToken
                    }
                });
                
                if (response.ok) {
                    alert('Interview acknowledged successfully!');
                    loadApplications();
                } else {
                    const errorData = await response.json();
                    alert(`Failed to acknowledge interview: ${errorData.detail || 'Authentication required'}`);
                }
            } catch (error) {
                console.error('Error acknowledging interview:', error);
                alert('Error acknowledging interview.');
            }
        }
        
        function editApplication(id) {
            loadEditForm(id);
        }
        
        function editSponsorship(id) {
            // Redirect to sponsor child form with edit mode
            window.location.href = `/sponsor-child-form/?edit=${id}`;
        }
        
        async function loadEditForm(id) {
            try {
                const response = await fetchAPI(`/api/applications/${id}/`);
                const app = await response.json();
                
                const modalBody = document.getElementById('editModalBody');
                const isVolunteer = app.application_type === 'volunteer';
                
                modalBody.innerHTML = `
                    <form id="editApplicationForm">
                        <div class="row">
                            <!-- Personal Information -->
                            <div class="col-12 mb-4">
                                <h5 style="color: #E36F1E; border-bottom: 2px solid #E36F1E; padding-bottom: 5px;">Personal Information</h5>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Name <span class="text-danger">*</span></label>
                                    <input type="text" name="full_name" value="${app.full_name || ''}" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Date of Birth <span class="text-danger">*</span></label>
                                    <input type="date" name="date_of_birth" value="${app.date_of_birth || ''}" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Phone <span class="text-danger">*</span></label>
                                    <input type="text" name="phone" value="${app.phone || ''}" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Country <span class="text-danger">*</span></label>
                                    <select name="country" class="form-control" required id="editCountry">
                                        <option value="">Loading...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4" id="editDistrictField" style="display:none;">
                                <div class="form-group">
                                    <label>District <span class="text-danger">*</span></label>
                                    <select name="district" class="form-control" id="editDistrict">
                                        <option value="">Select District</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Temporary Address <span class="text-danger">*</span></label>
                                    <input type="text" name="temporary_address" value="${app.temporary_address || ''}" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Permanent Address <span class="text-danger">*</span></label>
                                    <input type="text" name="permanent_address" value="${app.permanent_address || ''}" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Profession <span class="text-danger">*</span></label>
                                    <input type="text" name="profession" value="${app.profession || ''}" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Social Link <span class="text-danger">*</span></label>
                                    <input type="text" name="social_link" value="${app.social_link || ''}" class="form-control" required>
                                </div>
                            </div>
                            
                            <!-- Application Questions -->
                            <div class="col-12 mb-4 mt-4">
                                <h5 style="color: #E36F1E; border-bottom: 2px solid #E36F1E; padding-bottom: 5px;">Application Questions</h5>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Why do you want to join? <span class="text-danger">*</span></label>
                                    <textarea name="why_join" class="form-control" rows="3" required>${app.why_join || ''}</textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Self Definition <span class="text-danger">*</span></label>
                                    <textarea name="self_definition" class="form-control" rows="3" required>${app.self_definition || ''}</textarea>
                                </div>
                            </div>
                            
                            ${!isVolunteer ? `
                            <div class="col-12">
                                <div class="form-group">
                                    <label>Ideas</label>
                                    <textarea name="ideas" class="form-control" rows="3">${app.ideas || ''}</textarea>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${isVolunteer ? `
                            <div class="col-12">
                                <div class="form-group">
                                    <label>Hobbies & Interests <span class="text-danger">*</span></label>
                                    <textarea name="hobbies_interests" class="form-control" rows="3" required>${app.hobbies_interests || ''}</textarea>
                                </div>
                            </div>
                            ` : ''}
                            
                            <div class="col-12">
                                <div class="form-group">
                                    <label>Skills <span class="text-danger">*</span></label>
                                    <div id="skillsCheckboxes" class="row">
                                        <!-- Skills loaded dynamically -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-group">
                                    <label>Time Commitment <span class="text-danger">*</span></label>
                                    <div id="timeCommitmentRadios">
                                        <!-- Time commitment loaded dynamically -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-group">
                                    <label>Other Organizations</label>
                                    <textarea name="other_organizations" class="form-control" rows="3">${app.other_organizations || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="col-12 text-center mt-4">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-save me-2"></i>Update Application
                                </button>
                                <button type="button" class="btn btn-secondary btn-lg ml-2" data-dismiss="modal">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </button>
                            </div>
                        </div>
                    </form>
                `;
                
                // Load countries
                loadCountriesForEdit(app.country, app.district);
                
                // Load skills
                loadSkillsForEdit(app.skills || []);
                
                // Load time commitment
                loadTimeCommitmentForEdit(app.time_commitment);
                
                // Setup form submission
                document.getElementById('editApplicationForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    updateApplication(id, e.target);
                });
                
                $('#editModal').modal('show');
            } catch (error) {
                console.error('Error loading edit form:', error);
                alert('Error loading edit form.');
            }
        }
        
        async function loadProfile() {
            try {
                // Check for approved sponsorships but don't redirect - show both options
                const sponsorshipResponse = await fetchAPI('/api/applications/sponsorships/my/');
                const sponsorships = await sponsorshipResponse.json();
                const approvedSponsorships = sponsorships.filter(s => s.status === 'approved' || s.status === 'active');
                
                const response = await fetchAPI('/api/applications/my-applications/');
                const applications = await response.json();
                const app = applications[0]; // Get first application
                
                const container = document.getElementById('profileContainer');
                
                if (!app) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No profile information available.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div class="row">
                        <div class="col-12 text-center mb-2">
                            <div class="d-flex justify-content-center mb-1">
                                ${app.photo ? `<img src="${app.photo}" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover; border: 1px solid #E36F1E;">` : '<div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width: 120px; height: 120px; color: white; font-size: 48px;"><i class="fas fa-user"></i></div>'}
                            </div>
                            <h4 style="color: #E36F1E;">${app.full_name || 'N/A'}</h4>
                            <p class="text-muted small">${app.profession || 'N/A'}</p>
                            <p class="text-info small"><strong>Type:</strong> ${app.application_type.toUpperCase()}</p>
                            ${app.application_type === 'member' && app.payment_required ? `
                                <p class="small mb-1">
                                    <strong>Payment:</strong> 
                                    <span class="badge ${app.payment_completed ? 'bg-success' : 'bg-warning'} ms-1" style="color: #000 !important;">
                                        ${app.payment_completed ? 'Paid' : 'Pending'}
                                    </span>
                                    ${app.payment_completed ? ` <span style="color: #000;">Rs. ${app.payment_amount}</span>` : ` <span class="text-muted">Rs. ${app.payment_amount}</span>`}
                                </p>
                            ` : ''}
                            <span class="badge px-2 py-1" style="background-color: ${getStatusColor(app.status)}; font-size: 12px;">${app.status.replace('_', ' ').toUpperCase()}</span>
                            ${app.status === 'approved' ? `
                                <div class="mt-2">
                                    ${app.application_type === 'member' && app.payment_completed ? `
                                        <div class="alert alert-success py-2 mb-2" style="font-size:12px">
                                            <i class="fas fa-check-circle me-1"></i>Paid for Member (Rs. ${app.payment_amount})
                                        </div>
                                        <div class="d-flex gap-2">
                                            <a href="/member/dashboard/" class="btn btn-primary btn-sm py-1" style="font-size:11px">
                                                Member
                                            </a>
                                            <a href="/sponsor/dashboard/" class="btn btn-outline-secondary btn-sm py-1" style="font-size:11px">
                                                Sponsor
                                            </a>
                                        </div>
                                    ` : app.application_type === 'member' && app.payment_required && !app.payment_completed ? `
                                        <div class="alert alert-warning py-2 mb-2" style="font-size:12px">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Payment Required (Rs. ${app.payment_amount})
                                        </div>
                                        <div class="d-flex gap-2">
                                            <a href="/member/dashboard/" class="btn btn-secondary btn-sm py-1" style="font-size:11px" disabled>
                                                Member (Pay)
                                            </a>
                                            <a href="/sponsor/dashboard/" class="btn btn-outline-secondary btn-sm py-1" style="font-size:11px">
                                                Sponsor
                                            </a>
                                        </div>
                                    ` : `
                                        <div class="d-flex gap-2">
                                            <a href="${app.application_type === 'member' ? '/member/dashboard/' : '/dashboard/volunteer/'}" class="btn btn-primary btn-sm py-1" style="font-size:11px">
                                                ${app.application_type === 'member' ? 'Member' : 'Volunteer'}
                                            </a>
                                            <a href="/sponsor/dashboard/" class="btn btn-outline-secondary btn-sm py-1" style="font-size:11px">
                                                Sponsor
                                            </a>
                                        </div>
                                    `}
                                </div>
                            ` : ''}
                            ${app.application_type === 'member' && app.payment_required && !app.payment_completed ? `
                                <div class="mt-2">
                                    <div class="alert alert-warning py-2 mb-2" style="font-size:12px">
                                        <i class="fas fa-credit-card me-1"></i>Payment Required for Member
                                    </div>
                                    <button onclick="initiatePayment(${app.id})" class="btn btn-success btn-sm py-2" style="font-size:12px">
                                        <i class="fas fa-credit-card me-1"></i>Pay Now (Rs. ${app.payment_amount})
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <h6 class="text-primary small"><i class="fas fa-envelope me-2"></i>Contact Information</h6>
                            <p class="mb-1 small"><strong>Email:</strong> ${app.user_email || 'N/A'}</p>
                            <p class="mb-1 small"><strong>Phone:</strong> ${app.phone || 'N/A'}</p>
                            <p class="mb-1 small"><strong>Date of Birth:</strong> ${app.date_of_birth || 'N/A'}</p>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-primary small"><i class="fas fa-map-marker-alt me-2"></i>Location</h6>
                            <p class="mb-1 small"><strong>Country:</strong> ${app.country || 'N/A'}</p>
                            <p class="mb-1 small"><strong>District:</strong> ${app.district || 'N/A'}</p>
                            <p class="mb-1 small"><strong>Temporary Address:</strong> ${app.temporary_address || 'N/A'}</p>
                            <p class="mb-1 small"><strong>Permanent Address:</strong> ${app.permanent_address || 'N/A'}</p>
                        </div>
                  
                        <div class="col-md-3">
                            <h6 class="text-primary small"><i class="fas fa-briefcase me-2"></i>Professional</h6>
                            <p class="mb-1 small"><strong>Time Commitment:</strong> ${app.time_commitment || 'N/A'}</p>
                            <p class="mb-1 small"><strong>Other Organizations:</strong> ${app.other_organizations || 'None'}</p>
                            ${app.social_link ? `<p class="mb-1 small"><strong>Social Link:</strong> <a href="${app.social_link}" target="_blank">View Profile</a></p>` : ''}
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-primary small"><i class="fas fa-star me-2"></i>Skills</h6>
                            ${app.skills && app.skills.length > 0 ? `
                                <div class="d-flex flex-wrap gap-1">
                                    ${app.skills.map(skill => `<span class="badge bg-light text-dark border" style="font-size: 10px;">${skill}</span>`).join('')}
                                </div>
                            ` : '<p class="text-muted small">No skills listed</p>'}
                        </div>
                    </div>
                    ${app.why_join ? `
                    <div class="mb-3">
                        <h6 class="text-primary small"><i class="fas fa-heart me-2"></i>Why Join</h6>
                        <p class="text-muted small">${app.why_join}</p>
                    </div>` : ''}
                    ${app.self_definition ? `
                    <div class="mb-3">
                        <h6 class="text-primary small"><i class="fas fa-quote-left me-2"></i>Self Definition</h6>
                        <p class="text-muted small">${app.self_definition}</p>
                    </div>` : ''}
                `;
            } catch (error) {
                console.error('Error loading profile:', error);
                document.getElementById('profileContainer').innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                        <p class="text-danger">Error loading profile information.</p>
                    </div>
                `;
            }
        }
        
        async function loadCountriesForEdit(selectedCountry, selectedDistrict) {
            try {
                const response = await fetch('https://restcountries.com/v3.1/all?fields=name');
                const countries = await response.json();
                const sorted = countries.sort((a, b) => a.name.common.localeCompare(b.name.common));
                
                const select = document.getElementById('editCountry');
                select.innerHTML = sorted.map(c => 
                    `<option value="${c.name.common}" ${c.name.common === selectedCountry ? 'selected' : ''}>${c.name.common}</option>`
                ).join('');
                
                // Setup district field toggle
                select.addEventListener('change', toggleEditDistrictField);
                toggleEditDistrictField();
                
                // Set selected district if Nepal
                if (selectedCountry === 'Nepal' && selectedDistrict) {
                    setTimeout(() => {
                        const districtSelect = document.getElementById('editDistrict');
                        if (districtSelect) {
                            districtSelect.value = selectedDistrict;
                        }
                    }, 100);
                }
            } catch (error) {
                console.error('Error loading countries:', error);
                document.getElementById('editCountry').innerHTML = '<option value="Nepal" selected>Nepal</option>';
            }
        }
        
        function toggleEditDistrictField() {
            const country = document.getElementById('editCountry').value;
            const districtField = document.getElementById('editDistrictField');
            const districtSelect = document.getElementById('editDistrict');
            
            if (country === 'Nepal') {
                districtField.style.display = 'block';
                districtSelect.required = true;
                // Load Nepal districts
                const districts = ['Achham', 'Arghakhanchi', 'Baglung', 'Baitadi', 'Bajhang', 'Bajura', 'Banke', 'Bara', 'Bardiya', 'Bhaktapur', 'Bhojpur', 'Chitwan', 'Dadeldhura', 'Dailekh', 'Dang', 'Darchula', 'Dhading', 'Dhankuta', 'Dhanusa', 'Dolakha', 'Dolpa', 'Doti', 'Gorkha', 'Gulmi', 'Humla', 'Ilam', 'Jajarkot', 'Jhapa', 'Jumla', 'Kailali', 'Kalikot', 'Kanchanpur', 'Kapilvastu', 'Kaski', 'Kathmandu', 'Kavrepalanchok', 'Khotang', 'Lalitpur', 'Lamjung', 'Mahottari', 'Makwanpur', 'Manang', 'Morang', 'Mugu', 'Mustang', 'Myagdi', 'Nawalparasi', 'Nuwakot', 'Okhaldhunga', 'Palpa', 'Panchthar', 'Parbat', 'Parsa', 'Pyuthan', 'Ramechhap', 'Rasuwa', 'Rautahat', 'Rolpa', 'Rukum', 'Rupandehi', 'Salyan', 'Sankhuwasabha', 'Saptari', 'Sarlahi', 'Sindhuli', 'Sindhupalchok', 'Siraha', 'Solukhumbu', 'Sunsari', 'Surkhet', 'Syangja', 'Tanahu', 'Taplejung', 'Terhathum', 'Udayapur'];
                districtSelect.innerHTML = '<option value="">Select District</option>' + 
                    districts.map(d => `<option value="${d}">${d}</option>`).join('');
            } else {
                districtField.style.display = 'none';
                districtSelect.required = false;
                districtSelect.value = '';
            }
        }
        
        function loadSkillsForEdit(selectedSkills) {
            const skills = ['Leadership', 'Graphics Designing', 'Photoshop', 'Web Designing', 'Team Building', 'Management', 'Social Media Marketing', 'Other'];
            const container = document.getElementById('skillsCheckboxes');
            
            container.innerHTML = skills.map(skill => `
                <div class="col-md-3 col-sm-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="skills" value="${skill}" id="skill_${skill.replace(/\s+/g, '_')}" ${selectedSkills.includes(skill) ? 'checked' : ''}>
                        <label class="form-check-label" for="skill_${skill.replace(/\s+/g, '_')}">${skill}</label>
                    </div>
                </div>
            `).join('');
        }
        
        function loadTimeCommitmentForEdit(selectedTime) {
            const options = ['Less than 5 hours', '5-10 hours', '10-15 hours', '15-20 hours', 'More than 20 hours'];
            const container = document.getElementById('timeCommitmentRadios');
            
            container.innerHTML = options.map(option => `
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="time_commitment" value="${option}" id="time_${option.replace(/\s+/g, '_')}" ${selectedTime === option ? 'checked' : ''} required>
                    <label class="form-check-label" for="time_${option.replace(/\s+/g, '_')}">${option}</label>
                </div>
            `).join('');
        }
        
        async function updateApplication(id, form) {
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
            
            try {
                const formData = new FormData(form);
                
                // Handle skills
                const skills = [];
                document.querySelectorAll('input[name="skills"]:checked').forEach(cb => {
                    skills.push(cb.value);
                });
                formData.delete('skills');
                formData.append('skills', JSON.stringify(skills));
                
                const token = getToken();
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const csrfToken = getCookie('csrftoken');
                if (csrfToken) {
                    headers['X-CSRFToken'] = csrfToken;
                }
                
                const response = await fetch(`/api/applications/${id}/update/`, {
                    method: 'PATCH',
                    headers: headers,
                    body: formData,
                    credentials: 'include'
                });
                
                if (response.ok) {
                    $('#editModal').modal('hide');
                    alert('Application updated successfully! Status changed to pending for review.');
                    loadApplications();
                    loadProfile();
                } else {
                    const data = await response.json();
                    alert('Failed to update application: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating application:', error);
                alert('Error updating application.');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        async function initiatePayment(applicationId) {
            try {
                const response = await fetchAPI(`/api/applications/${applicationId}/initiate-payment/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.test_mode) {
                        // Test mode - show message and don't open payment window
                        alert('Test Mode: Payment initiated successfully. Use "Skip & Confirm Payment" button to complete the payment.');
                    } else {
                        // Production/Sandbox mode - redirect to Khalti payment page
                        window.location.href = data.payment_url;  // Same tab redirect
                        // Don't show alert since user is being redirected
                    }
                    
                    // Refresh the page after some time
                    setTimeout(() => {
                        loadApplications();
                        loadProfile();
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    alert('Failed to initiate payment: ' + (errorData.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error initiating payment:', error);
                alert('Error initiating payment. Please try again.');
            }
        }
        
        async function confirmTestPayment(applicationId) {
            if (!confirm('This is for testing purposes only. Confirm payment without actual transaction?')) {
                return;
            }
            
            try {
                const response = await fetchAPI(`/api/applications/${applicationId}/confirm-test-payment/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    alert('Test payment confirmed successfully!');
                    loadApplications();
                    loadProfile();
                } else {
                    const errorData = await response.json();
                    alert('Failed to confirm payment: ' + (errorData.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error confirming test payment:', error);
                alert('Error confirming payment. Please try again.');
            }
        }
        
        async function loadDonations() {
            try {
                let apiUrl = '/api/core/donations/my/';
                
                // Add email parameter if user is not authenticated but we have email
                if (!localStorage.getItem('access_token')) {
                    const user = getUser();
                    if (user && user.email) {
                        apiUrl += `?email=${encodeURIComponent(user.email)}`;
                    }
                }
                
                const response = await fetchAPI(apiUrl);
                const donations = await response.json();
                
                const tbody = document.getElementById('donationsTableBody');
                
                if (donations.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <i class="fas fa-heart fa-3x text-muted mb-3"></i>
                                <p class="text-muted mb-4">No donations found.</p>
                                <p class="text-muted small">Your donations will appear here after you make a contribution.</p>
                            </td>
                        </tr>
                    `;
                } else {
                    tbody.innerHTML = donations.map(donation => `
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-heart me-2 text-danger"></i>
                                    <div>
                                        <div class="fw-bold">Rs. ${donation.amount}</div>
                                        <small class="text-muted">Donation</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge" style="background-color: ${getDonationStatusColor(donation.payment_status)}; color: #000 !important;">
                                    ${donation.payment_status.replace('_', ' ').toUpperCase()}
                                </span>
                            </td>
                            <td>
                                <div class="text-muted small">
                                    ${donation.transaction_id || 'N/A'}
                                </div>
                            </td>
                            <td>
                                <div>${new Date(donation.created_at).toLocaleDateString()}</div>
                                <small class="text-muted">${new Date(donation.created_at).toLocaleTimeString()}</small>
                                ${donation.completed_at ? `<br><small class="text-success">Completed: ${new Date(donation.completed_at).toLocaleDateString()}</small>` : ''}
                            </td>
                            <td>
                                <div class="text-muted small">
                                    ${donation.purchase_order_id}
                                </div>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-primary btn-sm" onclick="printReceipt(${donation.id})" title="Print Receipt">
                                        <i class="fas fa-receipt"></i>
                                    </button>
                                    <button class="btn btn-outline-success btn-sm" onclick="printCertificate(${donation.id})" title="Print Certificate">
                                        <i class="fas fa-certificate"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading donations:', error);
                document.getElementById('donationsTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>Error loading donations.</p>
                        </td>
                    </tr>
                `;
            }
        }
        
        function getDonationStatusColor(status) {
            const colors = {
                completed: '#28a745',
                pending: '#ffc107',
                initiated: '#17a2b8',
                failed: '#dc3545',
                expired: '#6c757d',
                canceled: '#6c757d'
            };
            return colors[status] || '#6c757d';
        }
        
        async function printReceipt(donationId) {
            try {
                const response = await fetchAPI(`/api/core/donations/${donationId}/`);
                const donation = await response.json();
                
                const receiptWindow = window.open('', '_blank', 'width=800,height=600');
                receiptWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Donation Receipt</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; border-bottom: 2px solid #E36F1E; padding-bottom: 20px; margin-bottom: 20px; }
                            .logo { font-size: 24px; font-weight: bold; color: #E36F1E; }
                            .receipt-title { font-size: 20px; margin: 10px 0; }
                            .details { margin: 20px 0; }
                            .row { display: flex; justify-content: space-between; margin: 10px 0; }
                            .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #666; }
                            @media print { .no-print { display: none; } }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div class="logo">Aarambha Foundation</div>
                            <div class="receipt-title">Donation Receipt</div>
                        </div>
                        
                        <div class="details">
                            <div class="row"><strong>Receipt ID:</strong> <span>${donation.purchase_order_id}</span></div>
                            <div class="row"><strong>Donor Name:</strong> <span>${donation.full_name}</span></div>
                            <div class="row"><strong>Email:</strong> <span>${donation.email}</span></div>
                            <div class="row"><strong>Phone:</strong> <span>${donation.phone || 'N/A'}</span></div>
                            <div class="row"><strong>Amount:</strong> <span>Rs. ${donation.amount}</span></div>
                            <div class="row"><strong>Program:</strong> <span>${donation.program_name || 'General Donation'}</span></div>
                            <div class="row"><strong>Transaction ID:</strong> <span>${donation.transaction_id || 'N/A'}</span></div>
                            <div class="row"><strong>Date:</strong> <span>${new Date(donation.created_at).toLocaleDateString()}</span></div>
                            <div class="row"><strong>Status:</strong> <span>${donation.payment_status.toUpperCase()}</span></div>
                        </div>
                        
                        <div class="footer">
                            <p>Thank you for your generous donation to Aarambha Foundation!</p>
                            <p>This receipt serves as proof of your donation for tax purposes.</p>
                            <p>Contact: we.aarambha@gmail.com | +977 (984)346-7402</p>
                        </div>
                        
                        <div class="no-print" style="text-align: center; margin-top: 20px;">
                            <button onclick="window.print()" style="padding: 10px 20px; background: #E36F1E; color: white; border: none; border-radius: 5px;">Print Receipt</button>
                            <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; margin-left: 10px;">Close</button>
                        </div>
                    </body>
                    </html>
                `);
                receiptWindow.document.close();
            } catch (error) {
                console.error('Error generating receipt:', error);
                alert('Error generating receipt. Please try again.');
            }
        }
        
        async function printCertificate(donationId) {
            try {
                const response = await fetchAPI(`/api/core/donations/${donationId}/`);
                const donation = await response.json();
                
                const certificateWindow = window.open('', '_blank', 'width=800,height=600');
                certificateWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Donation Certificate</title>
                        <style>
                            body { font-family: 'Times New Roman', serif; margin: 0; padding: 40px; background: #f9f9f9; }
                            .certificate { background: white; border: 10px solid #E36F1E; padding: 40px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
                            .header { font-size: 32px; font-weight: bold; color: #E36F1E; margin-bottom: 20px; }
                            .title { font-size: 28px; font-weight: bold; margin: 20px 0; text-decoration: underline; }
                            .content { font-size: 18px; line-height: 1.6; margin: 30px 0; }
                            .donor-name { font-size: 24px; font-weight: bold; color: #2D3B5B; margin: 20px 0; }
                            .amount { font-size: 22px; font-weight: bold; color: #E36F1E; }
                            .footer { margin-top: 40px; font-size: 14px; }
                            .signature { margin-top: 50px; display: flex; justify-content: space-between; }
                            .sig-line { border-top: 1px solid #000; width: 200px; text-align: center; padding-top: 5px; }
                            @media print { .no-print { display: none; } body { background: white; } }
                        </style>
                    </head>
                    <body>
                        <div class="certificate">
                            <div class="header">AARAMBHA FOUNDATION</div>
                            <div class="title">CERTIFICATE OF APPRECIATION</div>
                            
                            <div class="content">
                                <p>This is to certify that</p>
                                <div class="donor-name">${donation.full_name}</div>
                                <p>has generously contributed</p>
                                <div class="amount">Rs. ${donation.amount}</div>
                                <p>to support our mission of providing education, healthcare, and community development programs.</p>
                                ${donation.program_name ? `<p>This donation was made specifically for: <strong>${donation.program_name}</strong></p>` : ''}
                                <p>Your contribution helps us make a lasting impact in our communities and brings hope to those in need.</p>
                            </div>
                            
                            <div class="footer">
                                <p><strong>Date:</strong> ${new Date(donation.created_at).toLocaleDateString()}</p>
                                <p><strong>Certificate ID:</strong> ${donation.purchase_order_id}</p>
                            </div>
                            
                            <div class="signature">
                                <div class="sig-line">Authorized Signature</div>
                                <div class="sig-line">Foundation Seal</div>
                            </div>
                        </div>
                        
                        <div class="no-print" style="text-align: center; margin-top: 20px;">
                            <button onclick="window.print()" style="padding: 10px 20px; background: #E36F1E; color: white; border: none; border-radius: 5px;">Print Certificate</button>
                            <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; margin-left: 10px;">Close</button>
                        </div>
                    </body>
                    </html>
                `);
                certificateWindow.document.close();
            } catch (error) {
                console.error('Error generating certificate:', error);
                alert('Error generating certificate. Please try again.');
            }
        }
    </script>
</body>

</html>