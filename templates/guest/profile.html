{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
    <link href="{% static 'website/css/bootstrap.min.css' %}" rel="stylesheet" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{% static 'website/css/slick.min.css' %}" crossorigin="anonymous"
        referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{% static 'website/css/owl.carousel.min.css' %}" />
    <!-- Link Swiper's CSS -->
    <link rel="stylesheet" href="{% static 'website/css/swiper-bundle.min.css' %}" />
    <!-- Link Swiper's CSS end-->
    <link rel="stylesheet" href="{% static 'website/css/animate.min.css' %}" />
    <!-- custom-css  -->
    <link rel="stylesheet" href="{% static 'website/css/index.css' %}" />
    <link rel="stylesheet" href="{% static 'website/css/style.css' %}" />
    <!-- custom-css end -->
    <link rel="icon" type="image.png' %}" href="{% static 'website/images/favicon.png' %}" />
    <title>Guest Welcome â€¢ Aarambha Foundation</title>
    <style>
        .sidebar .list-group-item.active {
            background-color: #d6692a;
            border-color: #d6692a;
            color: white;
        }

        .sidebar .card {
            background-color: #f8f6f4;
        }

        .profile-section {
            background-color: #f8f6f4;
        }

        .application-table tbody tr {
            transition: background 0.2s ease;
        }

        .application-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* Status pill */
        .status-pill {
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        /* Example status colors */
        .status-approved {
            background: #e6f4ea;
            color: #1e7e34;
        }

        .status-pending {
            background: #fff4e5;
            color: #b45309;
        }

        .status-rejected {
            background: #fdecea;
            color: #b02a37;
        }

        /* Application detail modal background */
        #applicationDetailModal .modal-content,
        #interviewScheduleModal .modal-content,
        #editApplicationModal .modal-content {
            background-color: #f8f6f4;
            /* light beige */
            border-radius: 12px;
        }

        /* Header background */
        #applicationDetailModal .modal-header,
        #interviewScheduleModal .modal-header,
        #editApplicationModal .modal-header {
            background-color: #d6692a;
            color: #fff;
            border-bottom: none;
        }

        /* Footer background */
        #applicationDetailModal .modal-footer,
        #interviewScheduleModal .modal-footer,
        #editApplicationModal .modal-footer {
            background-color: #f1f1f1;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
</head>

<body>
    {% include 'website/includes/navbar.html'%}
    <!-- Guest Welcome Content -->
    <section class="py-3 profile-section" style="min-height: 100vh;">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <header class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center gap-2">
                        </div>
                    </header>

                    <div class="row">
                        <!-- Horizontal Navigation -->
                        <div class="col-12 mb-3">
                            <div class="card">
                                <div class="card-body p-2">
                                    <nav class="nav nav-pills nav-justified" id="sidebarNav">
                                        <a href="#" class="nav-link active" data-target="profile" style="background-color: #E36F1E; border-color: #E36F1E;">
                                            <i class="fas fa-user me-1"></i>Profile
                                        </a>
                                        <a href="#" class="nav-link" data-target="notices" style="color: #E36F1E;">
                                            <i class="fas fa-bell me-1"></i>Notices
                                        </a>
                                        <a href="#" class="nav-link" data-target="applications" style="color: #E36F1E;">
                                            <i class="fas fa-file-alt me-1"></i>Applications
                                        </a>
                                    </nav>
                                </div>
                            </div>
                        </div>
                        <!-- Main Content -->
                        <div class="col-12">
                            <div id="profile" class="content-section" style="display: block; min-height: 70vh; max-height: 70vh; overflow-y: auto;">
                                <div class="card">
                                    <div class="card-header" style="background-color: #E36F1E; color: white;">
                                        <h5 class="mb-0"><i class="fas fa-user me-2"></i>Profile Information</h5>
                                    </div>
                                    <div class="card-body" id="profileContainer">
                                        <div class="text-center py-4">
                                            <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                                            <p class="text-muted">Loading profile...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="notices" class="content-section" style="display: none; min-height: 70vh; max-height: 70vh; overflow-y: auto;">
                                <div id="noticesContainer">
                                    <div class="text-center py-4">
                                        <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                                        <p class="text-muted">Loading notices...</p>
                                    </div>
                                </div>
                            </div>
                            <div id="applications" class="content-section" style="display: none; min-height: 70vh;">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Type</th>
                                                <th>Status</th>
                                                <th>Applied Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="applicationsTableBody">
                                            <tr>
                                                <td colspan="4" class="text-center py-4">
                                                    <i class="fas fa-spinner fa-spin me-2"></i>Loading applications...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    {% include "website/includes/login_modal.html" %}

    <footer class="footer__section wow fadeInUp" data-wow-duration="1s" data-wow-delay="0.2s">
        <div class="footer_overlay pt-5">
            <div class="container">
                <div class="row">
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                        <div class="footer__logo">
                            <img src="{% static 'website/images/logo.png' %}" width="100%" height="100%" alt="" />
                        </div>
                        <div class="footer__description">
                            <p>
                                A youth-driven foundation empowering education, equality, and
                                opportunities across Nepal.
                            </p>
                        </div>
                        <div class="social__media">
                            <ul class="d-flex">
                                <a
                                    href="{% if contact_info.facebook_url %}{{ contact_info.facebook_url }}{% else %}https://www.facebook.com/aarambhafoundation{% endif %}">
                                    <li><i class="fa-brands fa-facebook-f"></i></li>
                                </a>
                                <a
                                    href="{% if contact_info.instagram_url %}{{ contact_info.instagram_url }}{% else %}https://www.instagram.com/aarambhafoundation/{% endif %}">
                                    <li><i class="fa-brands fa-instagram"></i></li>
                                </a>
                                {% if contact_info.whatsapp_url %}
                                <a href="{{ contact_info.whatsapp_url }}">
                                    <li><i class="fa-brands fa-whatsapp"></i></li>
                                </a>
                                {% else %}
                                <a href="">
                                    <li><i class="fa-brands fa-whatsapp"></i></li>
                                </a>
                                {% endif %}
                                <a
                                    href="{% if contact_info.linkedin_url %}{{ contact_info.linkedin_url }}{% else %}https://www.linkedin.com/company/aarambhafoundation/{% endif %}">
                                    <li><i class="fa-brands fa-linkedin"></i></li>
                                </a>
                                <a
                                    href="{% if contact_info.youtube_url %}{{ contact_info.youtube_url }}{% else %}https://www.youtube.com/channel/UCthVlyi3N4EfnGj9-pS-bMA{% endif %}">
                                    <li><i class="fa-brands fa-youtube"></i></li>
                                </a>
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-6 mb-3">
                        <h2><span>Q</span>uick Links</h2>
                        <ul class="quick-links">
                            <li><a href="who-we-are">About Us</a></li>
                            <li><a href="{% url 'website_member_form' %}">Be a Member</a></li>
                            <li><a href="{% url 'website_volunteer_form' %}">Be a volunteer</a></li>
                            <li><a href="">Our Work</a></li>
                            <li><a href="">Privacy & Policy</a></li>
                        </ul>
                    </div>
                    <div class="col-lg-3 col-md-6 col-6 mb-3">
                        <h2><span>C</span>ontact Us</h2>
                        <div class="contact__details">
                            <ul class="fa-ul">
                                <li>
                                    <h6><i class="fa-solid fa-house"></i> Address</h6>
                                    <span>{{ contact_info.address|default:"Basundhara, Kathmandu, Nepal" }}</span>
                                </li>
                                <li>
                                    <h6><i class="fa-solid fa-phone"></i> Phone No</h6>
                                    <span>{{ contact_info.phone|default:"+977 (984)346-7402" }}</span>
                                </li>
                                <li>
                                    <h6><i class="fa-solid fa-envelope"></i> Email</h6>
                                    <span><a href="mailto:{{ contact_info.email|default:'we.aarambha@gmail.com' }}">{{
                                            contact_info.email|default:"we.aarambha@gmail.com" }}</a></span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                        <h2><span>O</span>ur Awards</h2>
                        <div class="gallery_wrapper">
                            <div class="row flex-wrap">
                                {% for award in awards %}
                                <div class="col-4">
                                    <img src="{{ award.image.url }}" width="100%" height="100%" alt="{{ award.title }}"
                                        title="{{ award.title }}" />
                                </div>
                                {% empty %}
                                <!-- Fallback award if no awards in database -->
                                <div class="col-4">
                                    <img src="{% static 'website/images/Award-1.jpg' %}" width="100%" height="100%"
                                        alt="" />
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="copyright">
            <div class="container">
                <div class="d-flex justify-content-center align-items-center">
                    <div class="right__wrapper" style="text-align: center">
                        <span style="color: white; text-align: center">
                            &copy;
                            <script>
                                document.write(new Date().getFullYear());
                            </script>
                            Aarambha Foundation. All Rights Reserved.
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </footer>

<!-- Application Details Modal -->
<div class="modal fade" id="applicationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background-color: #f8f6f4;">
            <div class="modal-header" style="background-color: #E36F1E; color: white;">
                <h5 class="modal-title">Application Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="applicationModalBody" style="background-color: #f8f6f4;">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Interview Details Modal -->
<div class="modal fade" id="interviewModal" tabindex="-1">
    <div class="modal-dialog modal-md">
        <div class="modal-content" style="background-color: #f8f6f4;">
            <div class="modal-header" style="background-color: #E36F1E; color: white;">
                <h5 class="modal-title">Interview Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="interviewModalBody" style="background-color: #f8f6f4;">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

    <!-- scripts start -->
    <!-- jquery  start-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <!-- jquery end -->
    <!-- bootstrap  start -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
    <!-- bootstrap end -->
    <script src="{% static 'website/js/slick.min.js' %}" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Swiper JS -->
    <script src="{% static 'website/js/swiper-bundle.min.js' %}" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script src="{% static 'website/js/modernizr.min.js' %}" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script>
    <script src="{% static 'website/js/owl.carousel.min.js' %}"></script>
    <script src="{% static 'website/js/api.js' %}"></script>
    <script src="{% static 'website/js/main.js' %}"></script>
    <script src="{% static 'website/js/animation.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="{% static 'website/js/general.js' %}"></script>
    <script src="{% static 'website/js/nav.js' %}"></script>
    <script src="{% static 'js/navbar.js' %}"></script>
    <script src="{% static 'js/config.js' %}"></script>
    <script src="{% static 'js/auth-utils.js' %}"></script>
    <script src="{% static 'js/debug-utils.js' %}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Profile page loaded successfully');
            
            {% if django_authenticated %}
            // Sync Django auth to localStorage
            localStorage.setItem('access_token', '{{ access_token }}');
            localStorage.setItem('refresh_token', '{{ refresh_token }}');
            localStorage.setItem('user', '{{ user_data|escapejs }}');
            
            const userData = JSON.parse('{{ user_data|escapejs }}');
            console.log('User authenticated:', userData);
            
            // Set user info in UI
            if (document.getElementById('profileEmail')) {
                document.getElementById('profileEmail').textContent = userData.email;
            }
            
            // Update navbar auth after syncing
            setTimeout(() => {
                if (typeof updateNavbarAuth === 'function') {
                    updateNavbarAuth();
                }
            }, 100);
            {% else %}
            // For non-Django authenticated users, check localStorage
            const user = getUser();
            if (user) {
                if (document.getElementById('profileEmail')) {
                    document.getElementById('profileEmail').textContent = user.email;
                }
            }
            {% endif %}
            
            // Load profile on page load
            loadProfile();
            
            // Setup horizontal navigation
            document.getElementById('sidebarNav').addEventListener('click', function (e) {
                e.preventDefault();
                if (e.target.classList.contains('nav-link')) {
                    const target = e.target.getAttribute('data-target');
                    document.querySelectorAll('#sidebarNav .nav-link').forEach(item => {
                        item.classList.remove('active');
                        item.style.backgroundColor = '';
                        item.style.color = '#E36F1E';
                    });
                    e.target.classList.add('active');
                    e.target.style.backgroundColor = '#E36F1E';
                    e.target.style.color = 'white';
                    document.querySelectorAll('.content-section').forEach(section => section.style.display = 'none');
                    document.getElementById(target).style.display = 'block';
                    
                    // Load data when switching to applications tab
                    if (target === 'applications') {
                        loadApplications();
                    }
                    // Load data when switching to profile tab
                    if (target === 'profile') {
                        loadProfile();
                    }
                    // Load data when switching to notices tab
                    if (target === 'notices') {
                        loadNotices();
                    }
                }
            });
        });
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear all localStorage data
                localStorage.removeItem('user');
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                
                // Make POST request to logout endpoint
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/logout/';
                
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                 document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                                 '{{ csrf_token }}';
                
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        async function loadNotices() {
            try {
                // Check if user is authenticated
                const token = localStorage.getItem('access_token');
                if (!token) {
                    throw new Error('No authentication token');
                }
                
                const response = await fetchAPI('/api/notices/my-notifications/');
                
                if (!response.ok) {
                    // If 403, try to refresh token or redirect to login
                    if (response.status === 403) {
                        console.log('Authentication failed, redirecting to login');
                        localStorage.clear();
                        window.location.href = '/accounts/login/';
                        return;
                    }
                    throw new Error('Failed to fetch notices');
                }
                
                const data = await response.json();
                console.log('Notifications data:', data);
                
                // Handle case where API returns an object with notifications array
                const notificationsList = data.notifications || data.results || data || [];

                const container = document.getElementById('noticesContainer');

                if (notificationsList.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No notices available at the moment.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = notificationsList.map(notification => {
                        let alertClass = 'alert-secondary';
                        let iconClass = 'fas fa-bell';

                        switch (notification.notification_type) {
                            case 'application_submitted':
                            case 'application_resubmitted':
                                alertClass = 'alert-primary';
                                iconClass = 'fas fa-paper-plane';
                                break;
                            case 'application_updated':
                                alertClass = 'alert-warning';
                                iconClass = 'fas fa-edit';
                                break;
                            case 'application_approved':
                                alertClass = 'alert-success';
                                iconClass = 'fas fa-check-circle';
                                break;
                            case 'application_rejected':
                                alertClass = 'alert-danger';
                                iconClass = 'fas fa-times-circle';
                                break;
                            case 'interview_scheduled':
                            case 'interview_rescheduled':
                                alertClass = 'alert-info';
                                iconClass = 'fas fa-calendar';
                                break;
                        }

                        const createdDate = new Date(notification.created_at).toLocaleDateString();
                        const isUnread = !notification.is_read ? '<span class="badge bg-primary ms-2">New</span>' : '';

                        return `
                            <div class="alert ${alertClass} mb-3 ${!notification.is_read ? 'border-start border-primary border-4' : ''}">
                                <h6 class="alert-heading">
                                    <i class="${iconClass}"></i> ${notification.title}${isUnread}
                                </h6>
                                <p class="mb-2">${notification.message}</p>
                                <hr>
                                <p class="mb-0 small text-muted">
                                    <i class="far fa-calendar-alt me-1"></i> ${createdDate}
                                    ${notification.related_application_id ? `<br><strong>Application ID:</strong> ${notification.related_application_id}` : ''}
                                </p>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading notices:', error);
                document.getElementById('noticesContainer').innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Please login to view notices.</p>
                        <a href="/accounts/login/" class="btn btn-primary btn-sm">Login</a>
                    </div>
                `;
            }
        }
        
        async function loadApplications() {
            try {
                const response = await fetchAPI('/api/applications/my-applications/');
                const applications = await response.json();
                
                const tbody = document.getElementById('applicationsTableBody');
                
                if (applications.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center py-4">
                                <i class="fas fa-file-lines fa-3x text-muted mb-3"></i>
                                <p class="text-muted mb-4">No applications found.</p>
                                <div class="d-flex gap-3 justify-content-center">
                                    <a href="/member-form/" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-user-plus me-1"></i>Apply as Member
                                    </a>
                                    <a href="/volunteer-form/" class="btn btn-outline-success btn-sm">
                                        <i class="fas fa-hands-helping me-1"></i>Apply as Volunteer
                                    </a>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    tbody.innerHTML = applications.map(app => `
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-${app.application_type === 'member' ? 'user' : 'hands-helping'} me-2 text-primary"></i>
                                    <div>
                                        <div class="fw-bold">${app.application_type.toUpperCase()}</div>
                                        <small class="text-muted">ID: #${app.id}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge" style="background-color: ${getStatusColor(app.status)}">
                                    ${app.status.replace('_', ' ').toUpperCase()}
                                </span>
                                ${app.status === 'rejected' && app.rejection_type === 'correction' ? 
                                    '<br><small class="text-warning">Can be edited</small>' : ''}
                                ${app.status === 'interview_scheduled' ? 
                                    `<br><small class="text-info"><i class="fas fa-calendar me-1"></i>Scheduled: ${new Date(app.interview_datetime).toLocaleDateString()}</small>` : ''}
                                ${app.status === 'interview_scheduled' && app.interview_acknowledged ? 
                                    '<br><small class="text-success"><i class="fas fa-check-circle me-1"></i>Acknowledged</small>' : ''}
                                ${app.status === 'interview_scheduled' && app.interview_attended === true ? 
                                    '<br><small class="text-primary"><i class="fas fa-user-check me-1"></i>Attended</small>' : ''}
                                ${app.status === 'interview_scheduled' && app.interview_attended === false ? 
                                    '<br><small class="text-danger"><i class="fas fa-user-times me-1"></i>Not Attended</small>' : ''}
                            </td>
                            <td>
                                <div>${new Date(app.applied_at).toLocaleDateString()}</div>
                                <small class="text-muted">${new Date(app.applied_at).toLocaleTimeString()}</small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-primary" onclick="showApplicationModal(${app.id})" title="Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${app.status === 'interview_scheduled' ? `
                                        <button class="btn btn-outline-info" onclick="viewInterviewDetails(${app.id})" title="Interview Details">
                                            <i class="fas fa-calendar"></i>
                                        </button>
                                        ${!app.interview_acknowledged ? `
                                            <button class="btn btn-outline-success" onclick="acknowledgeInterview(${app.id})" title="Acknowledge Interview">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        ` : `
                                            <span class="badge ms-1" title="Interview Acknowledged" style="background-color: #28a745; color: white;">
                                                <i class="fas fa-check-circle"></i> Ack
                                            </span>
                                        `}
                                    ` : ''}
                                    ${app.status === 'rejected' && app.rejection_type === 'correction' ? `
                                        <button class="btn btn-outline-warning" onclick="editApplication(${app.id})" title="Edit Application">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading applications:', error);
                document.getElementById('applicationsTableBody').innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>No applications found.</p>
                        </td>
                    </tr>
                `;
            }
        }
        
        function getStatusColor(status) {
            const colors = {
                pending: '#ffc107',
                interview_scheduled: '#17a2b8',
                rejected: '#dc3545',
                approved: '#28a745'
            };
            return colors[status] || '#6c757d';
        }
        
        async function showApplicationModal(id) {
            try {
                const response = await fetchAPI(`/api/applications/${id}/`);
                const app = await response.json();
                
                const modalBody = document.getElementById('applicationModalBody');
                modalBody.innerHTML = `
                    <!-- Profile Header -->
                    <div class="text-center mb-4">
                        ${app.photo ? `<img src="${app.photo}" class="rounded-circle mb-3" style="width: 120px; height: 120px; object-fit: cover; border: 4px solid #E36F1E;">` : '<div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center mb-3" style="width: 120px; height: 120px; color: white; font-size: 48px;"><i class="fas fa-user"></i></div>'}
                        <h4 class="mb-1" style="color: #E36F1E;">${app.full_name || 'N/A'}</h4>
                        <p class="text-muted mb-2">${app.profession || 'N/A'}</p>
                        <p class="small text-muted"><i class="fas fa-envelope me-1"></i>${app.user_email || 'N/A'} | <i class="fas fa-phone me-1"></i>${app.phone || 'N/A'}</p>
                    </div>
                    
                    <!-- Application Status -->
                    <div class="text-center mb-4">
                        <span class="badge fs-6 px-3 py-2" style="background-color: ${getStatusColor(app.status)}">${app.status.replace('_', ' ').toUpperCase()}</span>
                        <p class="small text-muted mt-2">Application #${app.id} | ${app.application_type.toUpperCase()}</p>
                    </div>
                    
                    <hr>
                    
                    <!-- Personal Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3"><i class="fas fa-user me-2"></i>Personal Information</h6>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Date of Birth:</strong> ${app.date_of_birth || 'N/A'}</p>
                            <p><strong>Country:</strong> ${app.country || 'N/A'}</p>
                            <p><strong>District:</strong> ${app.district || 'N/A'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Temporary Address:</strong> ${app.temporary_address || 'N/A'}</p>
                            <p><strong>Permanent Address:</strong> ${app.permanent_address || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <!-- Professional Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3"><i class="fas fa-briefcase me-2"></i>Professional Information</h6>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Time Commitment:</strong> ${app.time_commitment || 'N/A'}</p>
                            <p><strong>Other Organizations:</strong> ${app.other_organizations || 'None'}</p>
                        </div>
                        <div class="col-md-6">
                            ${app.social_link ? `<p><strong>Social Link:</strong> <a href="${app.social_link}" target="_blank" class="text-decoration-none"><i class="fas fa-link me-1"></i>View Profile</a></p>` : ''}
                        </div>
                    </div>
                    
                    ${app.skills && app.skills.length > 0 ? `
                    <!-- Skills -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3"><i class="fas fa-star me-2"></i>Skills</h6>
                            <div class="d-flex flex-wrap gap-2">
                                ${app.skills.map(skill => `<span class="badge bg-light text-dark border">${skill}</span>`).join('')}
                            </div>
                        </div>
                    </div>` : ''}
                    
                    ${app.why_join ? `
                    <!-- Why Join -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3"><i class="fas fa-heart me-2"></i>Why Join</h6>
                            <p class="text-muted bg-light p-3 rounded">${app.why_join}</p>
                        </div>
                    </div>` : ''}
                    
                    ${app.self_definition ? `
                    <!-- Self Definition -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3"><i class="fas fa-quote-left me-2"></i>Self Definition</h6>
                            <p class="text-muted bg-light p-3 rounded">${app.self_definition}</p>
                        </div>
                    </div>` : ''}
                    
                    ${app.ideas ? `
                    <!-- Ideas -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3"><i class="fas fa-lightbulb me-2"></i>Ideas</h6>
                            <p class="text-muted bg-light p-3 rounded">${app.ideas}</p>
                        </div>
                    </div>` : ''}
                    
                    ${app.hobbies_interests ? `
                    <!-- Hobbies & Interests -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3"><i class="fas fa-gamepad me-2"></i>Hobbies & Interests</h6>
                            <p class="text-muted bg-light p-3 rounded">${app.hobbies_interests}</p>
                        </div>
                    </div>` : ''}
                    
                    <!-- Documents -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3"><i class="fas fa-file-alt me-2"></i>Documents</h6>
                            <div class="row">
                                ${app.citizenship_front ? `<div class="col-md-6 mb-2"><a href="${app.citizenship_front}" target="_blank" class="btn btn-outline-primary btn-sm w-100"><i class="fas fa-id-card me-1"></i>Citizenship Front</a></div>` : ''}
                                ${app.citizenship_back ? `<div class="col-md-6 mb-2"><a href="${app.citizenship_back}" target="_blank" class="btn btn-outline-primary btn-sm w-100"><i class="fas fa-id-card me-1"></i>Citizenship Back</a></div>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${app.payment_required ? `
                    <!-- Payment Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3"><i class="fas fa-credit-card me-2"></i>Payment Information</h6>
                            <div class="bg-light p-3 rounded">
                                <p class="mb-2"><strong>Amount:</strong> Rs. ${app.payment_amount}</p>
                                <p class="mb-2"><strong>Status:</strong> <span class="badge ${app.payment_completed ? 'bg-success' : 'bg-warning'}">${app.payment_completed ? 'Completed' : 'Pending'}</span></p>
                                ${app.payment_date ? `<p class="mb-0"><strong>Date:</strong> ${new Date(app.payment_date).toLocaleDateString()}</p>` : ''}
                            </div>
                        </div>
                    </div>` : ''}
                    
                    ${app.rejection_reason ? `
                    <!-- Rejection Reason -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-danger mb-3"><i class="fas fa-exclamation-triangle me-2"></i>Rejection Reason</h6>
                            <div class="alert alert-danger">${app.rejection_reason}</div>
                        </div>
                    </div>` : ''}
                    
                    <!-- Application Timeline -->
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-primary mb-3"><i class="fas fa-clock me-2"></i>Timeline</h6>
                            <div class="bg-light p-3 rounded">
                                <p class="mb-1"><strong>Applied:</strong> ${new Date(app.applied_at).toLocaleString()}</p>
                                <p class="mb-0"><strong>Last Updated:</strong> ${new Date(app.updated_at).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                `;
                
                // Show modal using Bootstrap 4 syntax
                $('#applicationModal').modal('show');
            } catch (error) {
                console.error('Error loading application details:', error);
                alert('Error loading application details.');
            }
        }
        
        async function viewInterviewDetails(id) {
            try {
                const response = await fetchAPI(`/api/applications/${id}/`);
                const app = await response.json();
                
                const modalBody = document.getElementById('interviewModalBody');
                
                if (app.interview_datetime) {
                    modalBody.innerHTML = `
                        <div class="text-center mb-4">
                            <i class="fas fa-calendar-alt fa-3x text-primary mb-3"></i>
                            <h5 style="color: #E36F1E;">Interview Scheduled</h5>
                        </div>
                        
                        <div class="bg-light p-3 rounded mb-3">
                            <h6 class="text-primary mb-3"><i class="fas fa-clock me-2"></i>Schedule</h6>
                            <p class="mb-2"><strong>Date & Time:</strong> ${new Date(app.interview_datetime).toLocaleString()}</p>
                            <p class="mb-0"><strong>Status:</strong> <span class="badge ${app.interview_acknowledged ? 'bg-success' : 'bg-warning'}">${app.interview_acknowledged ? 'Acknowledged' : 'Pending Acknowledgment'}</span></p>
                        </div>
                        
                        ${app.interview_link ? `
                        <div class="bg-light p-3 rounded mb-3">
                            <h6 class="text-primary mb-3"><i class="fas fa-link me-2"></i>Meeting Link</h6>
                            <p class="mb-0"><a href="${app.interview_link}" target="_blank" class="btn btn-outline-primary btn-sm"><i class="fas fa-external-link-alt me-1"></i>Join Interview</a></p>
                        </div>` : ''}
                        
                        ${app.interview_description ? `
                        <div class="bg-light p-3 rounded mb-3">
                            <h6 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>Instructions</h6>
                            <p class="mb-0">${app.interview_description}</p>
                        </div>` : ''}
                        
                        <div class="text-center">
                            ${!app.interview_acknowledged ? `
                            <button class="btn btn-success" onclick="acknowledgeInterview(${app.id}); $('#interviewModal').modal('hide');">
                                <i class="fas fa-check me-1"></i>Acknowledge Interview
                            </button>` : `
                            <div class="alert alert-success mb-0">
                                <i class="fas fa-check-circle me-2"></i>Interview acknowledged successfully!
                            </div>`}
                        </div>
                    `;
                } else {
                    modalBody.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No interview details available.</p>
                        </div>
                    `;
                }
                
                $('#interviewModal').modal('show');
            } catch (error) {
                console.error('Error loading interview details:', error);
                alert('Error loading interview details.');
            }
        }
        
        async function acknowledgeInterview(id) {
            try {
                const token = localStorage.getItem('access_token');
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                 document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                
                const response = await fetch(`/api/applications/${id}/acknowledge/`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'X-CSRFToken': csrfToken
                    }
                });
                
                if (response.ok) {
                    alert('Interview acknowledged successfully!');
                    loadApplications();
                } else {
                    const errorData = await response.json();
                    alert(`Failed to acknowledge interview: ${errorData.detail || 'Authentication required'}`);
                }
            } catch (error) {
                console.error('Error acknowledging interview:', error);
                alert('Error acknowledging interview.');
            }
        }
        
        function editApplication(id) {
            // Redirect to edit form or show edit modal
            alert('Edit functionality will be implemented soon.');
        }
        
        async function loadProfile() {
            try {
                const response = await fetchAPI('/api/applications/my-applications/');
                const applications = await response.json();
                const app = applications[0]; // Get first application
                
                const container = document.getElementById('profileContainer');
                
                if (!app) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No profile information available.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div class="row">
                        <div class="col-12 text-center mb-4">
                            ${app.photo ? `<img src="${app.photo}" class="rounded-circle mb-2" style="width: 120px; height: 120px; object-fit: cover; border: 3px solid #E36F1E;">` : '<div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center mb-2" style="width: 120px; height: 120px; color: white; font-size: 48px;"><i class="fas fa-user"></i></div>'}
                            <h4 style="color: #E36F1E;">${app.full_name || 'N/A'}</h4>
                            <p class="text-muted small">${app.profession || 'N/A'}</p>
                            <p class="text-info small"><strong>Type:</strong> ${app.application_type.toUpperCase()}</p>
                            <span class="badge px-2 py-1" style="background-color: ${getStatusColor(app.status)}; font-size: 12px;">${app.status.replace('_', ' ').toUpperCase()}</span>
                            ${app.status === 'approved' ? `
                                <div class="mt-2">
                                    <a href="${app.application_type === 'member' ? '/member/dashboard/' : '/dashboard/volunteer/'}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-arrow-right me-1"></i>Go to ${app.application_type === 'member' ? 'Member' : 'Volunteer'} Dashboard
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary small"><i class="fas fa-envelope me-2"></i>Contact Information</h6>
                            <p class="mb-1 small"><strong>Email:</strong> ${app.user_email || 'N/A'}</p>
                            <p class="mb-1 small"><strong>Phone:</strong> ${app.phone || 'N/A'}</p>
                            <p class="mb-1 small"><strong>Date of Birth:</strong> ${app.date_of_birth || 'N/A'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary small"><i class="fas fa-map-marker-alt me-2"></i>Location</h6>
                            <p class="mb-1 small"><strong>Country:</strong> ${app.country || 'N/A'}</p>
                            <p class="mb-1 small"><strong>District:</strong> ${app.district || 'N/A'}</p>
                            <p class="mb-1 small"><strong>Temporary Address:</strong> ${app.temporary_address || 'N/A'}</p>
                            <p class="mb-1 small"><strong>Permanent Address:</strong> ${app.permanent_address || 'N/A'}</p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6 class="text-primary small"><i class="fas fa-briefcase me-2"></i>Professional</h6>
                            <p class="mb-1 small"><strong>Time Commitment:</strong> ${app.time_commitment || 'N/A'}</p>
                            <p class="mb-1 small"><strong>Other Organizations:</strong> ${app.other_organizations || 'None'}</p>
                            ${app.social_link ? `<p class="mb-1 small"><strong>Social Link:</strong> <a href="${app.social_link}" target="_blank">View Profile</a></p>` : ''}
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary small"><i class="fas fa-star me-2"></i>Skills</h6>
                            ${app.skills && app.skills.length > 0 ? `
                                <div class="d-flex flex-wrap gap-1">
                                    ${app.skills.map(skill => `<span class="badge bg-light text-dark border" style="font-size: 10px;">${skill}</span>`).join('')}
                                </div>
                            ` : '<p class="text-muted small">No skills listed</p>'}
                        </div>
                    </div>
                    ${app.why_join ? `
                    <div class="mb-3">
                        <h6 class="text-primary small"><i class="fas fa-heart me-2"></i>Why Join</h6>
                        <p class="text-muted small">${app.why_join}</p>
                    </div>` : ''}
                    ${app.self_definition ? `
                    <div class="mb-3">
                        <h6 class="text-primary small"><i class="fas fa-quote-left me-2"></i>Self Definition</h6>
                        <p class="text-muted small">${app.self_definition}</p>
                    </div>` : ''}
                `;
            } catch (error) {
                console.error('Error loading profile:', error);
                document.getElementById('profileContainer').innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                        <p class="text-danger">Error loading profile information.</p>
                    </div>
                `;
            }
        }
    </script>
</body>

</html>