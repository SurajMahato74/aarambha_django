{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
    <link href="{% static 'website/css/bootstrap.min.css' %}" rel="stylesheet" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{% static 'website/css/slick.min.css' %}" crossorigin="anonymous"
        referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{% static 'website/css/owl.carousel.min.css' %}" />
    <!-- Link Swiper's CSS -->
    <link rel="stylesheet" href="{% static 'website/css/swiper-bundle.min.css' %}" />
    <!-- Link Swiper's CSS end-->
    <link rel="stylesheet" href="{% static 'website/css/animate.min.css' %}" />
    <!-- custom-css  -->
    <link rel="stylesheet" href="{% static 'website/css/index.css' %}" />
    <link rel="stylesheet" href="{% static 'website/css/style.css' %}" />
    <!-- custom-css end -->
    <link rel="icon" type="image.png' %}" href="{% static 'website/images/favicon.png' %}" />
    <title>Guest Welcome • Aarambha Foundation</title>
    <style>
        .sidebar .list-group-item.active {
            background-color: #d6692a;
            border-color: #d6692a;
            color: white;
        }

        .sidebar .card {
            background-color: #f8f6f4;
        }

        .profile-section {
            background-color: #f8f6f4;
        }

        .application-table tbody tr {
            transition: background 0.2s ease;
        }

        .application-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* Status pill */
        .status-pill {
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        /* Example status colors */
        .status-approved {
            background: #e6f4ea;
            color: #1e7e34;
        }

        .status-pending {
            background: #fff4e5;
            color: #b45309;
        }

        .status-rejected {
            background: #fdecea;
            color: #b02a37;
        }

        /* Application detail modal background */
        #applicationDetailModal .modal-content,
        #interviewScheduleModal .modal-content,
        #editApplicationModal .modal-content {
            background-color: #f8f6f4;
            /* light beige */
            border-radius: 12px;
        }

        /* Header background */
        #applicationDetailModal .modal-header,
        #interviewScheduleModal .modal-header,
        #editApplicationModal .modal-header {
            background-color: #d6692a;
            color: #fff;
            border-bottom: none;
        }

        /* Footer background */
        #applicationDetailModal .modal-footer,
        #interviewScheduleModal .modal-footer,
        #editApplicationModal .modal-footer {
            background-color: #f1f1f1;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
</head>

<body>
    {% include 'website/includes/navbar.html'%}
    <!-- Guest Welcome Content -->
    <section class="py-3 profile-section">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <header class="d-flex justify-content-between align-items-center mb-3">
                        <h1 class="h4 mb-0">My Profile</h1>
                        <div class="d-flex align-items-center gap-2">
                            <span id="userName" class="text-muted small"></span>
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center text-white fw-bold"
                                style="width: 32px; height: 32px; font-size: 12px;" id="userInitial">G</div>
                        </div>
                    </header>

                    <div class="row" style="height: calc(100vh - 200px);">
                        <!-- Sidebar -->
                        <div class="col-md-2 sidebar" style="height: 100%; overflow-y: hidden;">
                            <div class="card h-100 d-flex flex-column">
                                <div class="card-body p-1 flex-grow-1">
                                    <div class="list-group list-group-flush" id="sidebarNav">
                                        <a href="#" class="list-group-item list-group-item-action active"
                                            data-target="notices">
                                            <i class="fas fa-bell me-2"></i>Notices
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action"
                                            data-target="applications">
                                            <i class="fas fa-file-alt me-2"></i>Applications
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action" data-target="tasks">
                                            <i class="fas fa-tasks me-2"></i>My Tasks
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action"
                                            data-target="profile">
                                            <i class="fas fa-user me-2"></i>Profile Info
                                        </a>
                                    </div>
                                </div>
                                <div class="card-footer p-1 text-center">
                                    <button class="btn btn-outline-danger btn-sm px-3" onclick="logout()">
                                        Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Main Content -->
                        <div class="col-md-10" style="height: 100%; overflow-y: auto;">
                            {% include 'guest/notices.html' %}
                            {% include 'guest/applications.html' %}
                            {% include 'guest/tasks.html' %}
                            {% include 'guest/personal_info.html' %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    {% include "website/includes/login_modal.html" %}

    <footer class="footer__section wow fadeInUp" data-wow-duration="1s" data-wow-delay="0.2s">
        <div class="footer_overlay pt-5">
            <div class="container">
                <div class="row">
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                        <div class="footer__logo">
                            <img src="{% static 'website/images/logo.png' %}" width="100%" height="100%" alt="" />
                        </div>
                        <div class="footer__description">
                            <p>
                                A youth-driven foundation empowering education, equality, and
                                opportunities across Nepal.
                            </p>
                        </div>
                        <div class="social__media">
                            <ul class="d-flex">
                                <a
                                    href="{% if contact_info.facebook_url %}{{ contact_info.facebook_url }}{% else %}https://www.facebook.com/aarambhafoundation{% endif %}">
                                    <li><i class="fa-brands fa-facebook-f"></i></li>
                                </a>
                                <a
                                    href="{% if contact_info.instagram_url %}{{ contact_info.instagram_url }}{% else %}https://www.instagram.com/aarambhafoundation/{% endif %}">
                                    <li><i class="fa-brands fa-instagram"></i></li>
                                </a>
                                {% if contact_info.whatsapp_url %}
                                <a href="{{ contact_info.whatsapp_url }}">
                                    <li><i class="fa-brands fa-whatsapp"></i></li>
                                </a>
                                {% else %}
                                <a href="">
                                    <li><i class="fa-brands fa-whatsapp"></i></li>
                                </a>
                                {% endif %}
                                <a
                                    href="{% if contact_info.linkedin_url %}{{ contact_info.linkedin_url }}{% else %}https://www.linkedin.com/company/aarambhafoundation/{% endif %}">
                                    <li><i class="fa-brands fa-linkedin"></i></li>
                                </a>
                                <a
                                    href="{% if contact_info.youtube_url %}{{ contact_info.youtube_url }}{% else %}https://www.youtube.com/channel/UCthVlyi3N4EfnGj9-pS-bMA{% endif %}">
                                    <li><i class="fa-brands fa-youtube"></i></li>
                                </a>
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-6 mb-3">
                        <h2><span>Q</span>uick Links</h2>
                        <ul class="quick-links">
                            <li><a href="who-we-are">About Us</a></li>
                            <li><a href="{% url 'website_member_form' %}">Be a Member</a></li>
                            <li><a href="{% url 'website_volunteer_form' %}">Be a volunteer</a></li>
                            <li><a href="">Our Work</a></li>
                            <li><a href="">Privacy & Policy</a></li>
                        </ul>
                    </div>
                    <div class="col-lg-3 col-md-6 col-6 mb-3">
                        <h2><span>C</span>ontact Us</h2>
                        <div class="contact__details">
                            <ul class="fa-ul">
                                <li>
                                    <h6><i class="fa-solid fa-house"></i> Address</h6>
                                    <span>{{ contact_info.address|default:"Basundhara, Kathmandu, Nepal" }}</span>
                                </li>
                                <li>
                                    <h6><i class="fa-solid fa-phone"></i> Phone No</h6>
                                    <span>{{ contact_info.phone|default:"+977 (984)346-7402" }}</span>
                                </li>
                                <li>
                                    <h6><i class="fa-solid fa-envelope"></i> Email</h6>
                                    <span><a href="mailto:{{ contact_info.email|default:'we.aarambha@gmail.com' }}">{{
                                            contact_info.email|default:"we.aarambha@gmail.com" }}</a></span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                        <h2><span>O</span>ur Awards</h2>
                        <div class="gallery_wrapper">
                            <div class="row flex-wrap">
                                {% for award in awards %}
                                <div class="col-4">
                                    <img src="{{ award.image.url }}" width="100%" height="100%" alt="{{ award.title }}"
                                        title="{{ award.title }}" />
                                </div>
                                {% empty %}
                                <!-- Fallback award if no awards in database -->
                                <div class="col-4">
                                    <img src="{% static 'website/images/Award-1.jpg' %}" width="100%" height="100%"
                                        alt="" />
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="copyright">
            <div class="container">
                <div class="d-flex justify-content-center align-items-center">
                    <div class="right__wrapper" style="text-align: center">
                        <span style="color: white; text-align: center">
                            &copy;
                            <script>
                                document.write(new Date().getFullYear());
                            </script>
                            Aarambha Foundation. All Rights Reserved.
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- scripts start -->
    <!-- jquery  start-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <!-- jquery end -->
    <!-- bootstrap  start -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
    <!-- bootstrap end -->
    <script src="{% static 'website/js/slick.min.js' %}" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Swiper JS -->
    <script src="{% static 'website/js/swiper-bundle.min.js' %}" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script src="{% static 'website/js/modernizr.min.js' %}" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script>
    <script src="{% static 'website/js/owl.carousel.min.js' %}"></script>
    <script src="{% static 'website/js/api.js' %}"></script>
    <script src="{% static 'website/js/main.js' %}"></script>
    <script src="{% static 'website/js/animation.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="{% static 'website/js/general.js' %}"></script>
    <script src="{% static 'website/js/nav.js' %}"></script>
    <script src="{% static 'js/navbar.js' %}"></script>
    <script src="{% static 'js/config.js' %}"></script>

    <script>
        const user = getUser();
        if (!user || user.user_type !== 'guest') window.location.href = '/';

        // Update navbar auth state
        updateNavbarAuth();

        // Set user info
        const email = user.email;
        document.getElementById('userName').textContent = email;
        document.getElementById('userInitial').textContent = email[0].toUpperCase();
        document.getElementById('profileEmail').textContent = email;

        async function loadData() {
            const response = await fetchAPI('/api/applications/my-applications/');
            const data = await response.json();

            // Store data globally for detail modal
            window.applicationsData = data;

            // Update stats
            document.getElementById('totalApps').textContent = data.length;
            document.getElementById('pendingApps').textContent = data.filter(a => a.status === 'pending').length;
            document.getElementById('interviewApps').textContent = data.filter(a => a.status === 'interview_scheduled').length;

            const container = document.getElementById('applicationsContainer');
            const quickActions = document.getElementById('quickActions');

            if (data.length === 0) {
                container.innerHTML = '';
                quickActions.style.display = 'block';
            } else {
                quickActions.style.display = 'none';

                container.innerHTML = `
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white fw-semibold">
            <i class="fas fa-file-alt me-2 text-primary"></i>
            My Applications
        </div>

        <div class="table-responsive">
            <table class="table align-middle mb-0 application-table">
                <thead class="table-light">
                    <tr>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Applied On</th>
                        <th class="text-end">Action</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map(app => `
                    <tr>
                        <td>
                            <div class="fw-semibold text-dark">
                                ${app.application_type.replace('_', ' ').toUpperCase()}
                            </div>
                            <small class="text-muted">Application ID #${app.id}</small>
                        </td>

                        <td>
                            <span class="status-pill ${getStatusColor(app.status)}">
                                ${app.status.replace('_', ' ').toUpperCase()}
                            </span>
                        </td>

                        <td class="text-muted">
                            <i class="far fa-calendar-alt me-1"></i>
                            ${new Date(app.applied_at).toLocaleDateString()}
                        </td>

                        <td class="text-end">
                            <div class="d-flex gap-1 justify-content-end">
                                ${app.status === 'interview_scheduled' ? `
                                    <button class="btn btn-sm btn-outline-info" onclick="showInterviewSchedule(${app.id})" title="View Interview Schedule">
                                        <i class="fas fa-calendar"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="showApplicationDetails(${app.id})" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                ` : app.status === 'rejected' && app.rejection_type === 'correction' ? `
                                    <button class="btn btn-sm btn-outline-warning" onclick="editApplication(${app.id})" title="Edit Application">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="showApplicationDetails(${app.id})" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                ` : `
                                    <button class="btn btn-sm btn-outline-primary" onclick="showApplicationDetails(${app.id})" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                `}
                            </div>
                        </td>
                    </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    </div>
    `;
            }
        }

        async function loadNotices() {
            const response = await fetchAPI('/api/notices/my-notifications/');
            const notifications = await response.json();

            const container = document.getElementById('noticesContainer');

            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No notices available at the moment.</p>
                    </div>
                `;
            } else {
                container.innerHTML = notifications.map(notification => {
                    let alertClass = 'alert-secondary';
                    let iconClass = 'fas fa-bell';

                    switch (notification.notification_type) {
                        case 'application_submitted':
                        case 'application_resubmitted':
                            alertClass = 'alert-primary';
                            iconClass = 'fas fa-paper-plane';
                            break;
                        case 'application_updated':
                            alertClass = 'alert-warning';
                            iconClass = 'fas fa-edit';
                            break;
                        case 'application_approved':
                            alertClass = 'alert-success';
                            iconClass = 'fas fa-check-circle';
                            break;
                        case 'application_rejected':
                            alertClass = 'alert-danger';
                            iconClass = 'fas fa-times-circle';
                            break;
                        case 'interview_scheduled':
                        case 'interview_rescheduled':
                            alertClass = 'alert-info';
                            iconClass = 'fas fa-calendar';
                            break;
                    }

                    const createdDate = new Date(notification.created_at).toLocaleDateString();
                    const isUnread = !notification.is_read ? '<span class="badge bg-primary ms-2">New</span>' : '';

                    return `
                        <div class="alert ${alertClass} mb-3 ${!notification.is_read ? 'border-start border-primary border-4' : ''}">
                            <h6 class="alert-heading">
                                <i class="${iconClass}"></i> ${notification.title}${isUnread}
                            </h6>
                            <p class="mb-2">${notification.message}</p>
                            <hr>
                            <p class="mb-0 small text-muted">
                                <i class="far fa-calendar-alt me-1"></i> ${createdDate}
                                ${notification.related_application_id ? `<br><strong>Application ID:</strong> ${notification.related_application_id}` : ''}
                            </p>
                        </div>
                    `;
                }).join('');
            }
        }

        function getStatusColor(status) {
            return { pending: 'bg-warning', interview_scheduled: 'bg-info', rejected: 'bg-danger', approved: 'bg-success' }[status] || 'bg-secondary';
        }

        function getStatusText(status) {
            return { pending: 'Under Review', interview_scheduled: 'Interview Scheduled', rejected: 'Not Accepted', approved: 'Approved' }[status] || status;
        }

        function showInterviewSchedule(appId) {
            // Find the application data
            const app = window.applicationsData.find(a => a.id === appId);
            if (!app || app.status !== 'interview_scheduled') return;

            // Create modal HTML
            const modalHtml = `
            <div class="modal fade" id="interviewScheduleModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-calendar text-info me-2"></i>Interview Schedule</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <h6 class="alert-heading mb-3">Interview Details for ${app.application_type.toUpperCase()} Application</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong><i class="fas fa-calendar-day me-2"></i>Date & Time:</strong></p>
                                        <p class="text-primary fs-5">${new Date(app.interview_datetime).toLocaleString()}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong><i class="fas fa-link me-2"></i>Meeting Link:</strong></p>
                                        ${app.interview_link ? `
                                            <div class="input-group">
                                                <input type="text" class="form-control form-control-sm" value="${app.interview_link}" readonly id="meetingLink_${app.id}">
                                                <button class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard('meetingLink_${app.id}')">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                                <a href="${app.interview_link}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                            </div>
                                        ` : '<span class="text-muted">Will be shared soon</span>'}
                                    </div>
                                </div>
                                ${app.interview_description ? `
                                    <div class="mt-3">
                                        <p class="mb-2"><strong><i class="fas fa-sticky-note me-2"></i>Additional Notes:</strong></p>
                                        <p class="text-muted">${app.interview_description}</p>
                                    </div>
                                ` : ''}
                                ${app.interview_attended !== null ? `
                                    <div class="mt-3">
                                        <p class="mb-1"><strong><i class="fas fa-check-circle me-2"></i>Attendance Status:</strong></p>
                                        <span class="badge ${app.interview_attended ? 'bg-success' : 'bg-danger'} fs-6">
                                            ${app.interview_attended ? '<i class="fas fa-check me-1"></i>Attended' : '<i class="fas fa-times me-1"></i>Not Attended'}
                                        </span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            `;

            // Remove existing modal if present
            const existingModal = document.getElementById('interviewScheduleModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('interviewScheduleModal'));
            modal.show();
        }

        function editApplication(appId) {
            // Find the application data
            const app = window.applicationsData.find(a => a.id === appId);
            if (!app) return;

            // Create edit modal HTML
            const modalHtml = `
            <div class="modal fade" id="editApplicationModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-edit text-warning me-2"></i>Edit ${app.application_type.toUpperCase()} Application</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editApplicationForm" enctype="multipart/form-data">
                                <input type="hidden" name="application_type" value="${app.application_type}">

                                <!-- Personal Information -->
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fas fa-user me-2"></i>Personal Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Full Name *</label>
                                                <input type="text" class="form-control" name="full_name" value="${app.full_name || ''}" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Date of Birth</label>
                                                <input type="date" class="form-control" name="date_of_birth" value="${app.date_of_birth ? app.date_of_birth.split('T')[0] : ''}">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Phone *</label>
                                                <input type="tel" class="form-control" name="phone" value="${app.phone || ''}" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Country *</label>
                                                <select class="form-control" name="country" id="editCountrySelect" required>
                                                    <option value="">Loading countries...</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3" id="editDistrictField">
                                                <label class="form-label">District *</label>
                                                <select class="form-control" name="district" id="editDistrictSelect">
                                                    <option value="">Select District</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Profession</label>
                                                <input type="text" class="form-control" name="profession" value="${app.profession || ''}">
                                            </div>
                                            <div class="col-md-12 mb-3">
                                                <label class="form-label">Social Link</label>
                                                <input type="url" class="form-control" name="social_link" value="${app.social_link || ''}" placeholder="https://...">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Temporary Address</label>
                                                <textarea class="form-control" name="temporary_address" rows="2">${app.temporary_address || ''}</textarea>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Permanent Address</label>
                                                <textarea class="form-control" name="permanent_address" rows="2">${app.permanent_address || ''}</textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Application Details -->
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fas fa-question-circle me-2"></i>Application Details</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Why do you want to join Aarambha Foundation? *</label>
                                            <textarea class="form-control" name="why_join" rows="3" required>${app.why_join || ''}</textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">How would you define yourself?</label>
                                            <textarea class="form-control" name="self_definition" rows="3">${app.self_definition || ''}</textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">What are your hobbies and interests?</label>
                                            <textarea class="form-control" name="hobbies_interests" rows="3">${app.hobbies_interests || ''}</textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Do you have any ideas to contribute to our foundation?</label>
                                            <textarea class="form-control" name="ideas" rows="3">${app.ideas || ''}</textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Skills (comma separated)</label>
                                            <input type="text" class="form-control" name="skills" value="${Array.isArray(app.skills) ? app.skills.join(', ') : app.skills || ''}" placeholder="e.g., Communication, Leadership, Technical Skills">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Time Commitment</label>
                                            <select class="form-control" name="time_commitment">
                                                <option value="" ${!app.time_commitment ? 'selected' : ''}>Select</option>
                                                <option value="full_time" ${app.time_commitment === 'full_time' ? 'selected' : ''}>Full Time</option>
                                                <option value="part_time" ${app.time_commitment === 'part_time' ? 'selected' : ''}>Part Time</option>
                                                <option value="weekends" ${app.time_commitment === 'weekends' ? 'selected' : ''}>Weekends Only</option>
                                                <option value="flexible" ${app.time_commitment === 'flexible' ? 'selected' : ''}>Flexible</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Are you involved with any other organizations?</label>
                                            <textarea class="form-control" name="other_organizations" rows="2">${app.other_organizations || ''}</textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Documents -->
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fas fa-file-alt me-2"></i>Documents</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Photo</label>
                                                <input type="file" class="form-control" name="photo" accept="image/*">
                                                ${app.photo ? `<small class="text-muted">Current: <a href="${app.photo}" target="_blank">View Photo</a></small>` : ''}
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Citizenship Front</label>
                                                <input type="file" class="form-control" name="citizenship_front" accept="image/*">
                                                ${app.citizenship_front ? `<small class="text-muted">Current: <a href="${app.citizenship_front}" target="_blank">View Document</a></small>` : ''}
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Citizenship Back</label>
                                                <input type="file" class="form-control" name="citizenship_back" accept="image/*">
                                                ${app.citizenship_back ? `<small class="text-muted">Current: <a href="${app.citizenship_back}" target="_blank">View Document</a></small>` : ''}
                                            </div>
                                        </div>
                                        <small class="text-muted">Leave file inputs empty to keep current documents. Only upload if you need to replace them.</small>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="submitEditApplication(${app.id})">
                                <i class="fas fa-save me-2"></i>Update Application
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            `;

            // Remove existing modal if present
            const existingModal = document.getElementById('editApplicationModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editApplicationModal'));
            modal.show();

            // Load countries and setup district logic after modal is shown
            setTimeout(() => {
                loadCountriesForEdit(app.country || 'Nepal');
                setupEditDistrictLogic(app);
            }, 100);
        }

        async function submitEditApplication(appId) {
            const form = document.getElementById('editApplicationForm');
            const formData = new FormData(form);

            // Process skills as array
            const skillsValue = formData.get('skills');
            if (skillsValue) {
                const skillsArray = skillsValue.split(',').map(skill => skill.trim()).filter(skill => skill);
                formData.set('skills', JSON.stringify(skillsArray));
            } else {
                formData.set('skills', JSON.stringify([]));
            }

            // Show loading state
            const submitBtn = document.querySelector('#editApplicationModal .btn-primary');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
            submitBtn.disabled = true;

            try {
                const response = await fetchAPI(`/api/applications/${appId}/update/`, {
                    method: 'PATCH',
                    body: formData
                    // Note: Do not set Content-Type header when using FormData
                    // The browser will set it automatically with the correct boundary
                });

                if (response.ok) {
                    const result = await response.json();

                    // Close modal
                    $('#editApplicationModal').modal('hide');


                    // Show success message
                    Swal.fire({
                        icon: 'success',
                        title: 'Application Updated!',
                        text: 'Your application has been updated successfully.',
                        timer: 3000,
                        showConfirmButton: false
                    });

                    // Reload applications data
                    loadData();

                    // Reload notices in case a new notice was created
                    loadNotices();

                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to update application');
                }

            } catch (error) {
                console.error('Update error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Update Failed',
                    text: error.message || 'An error occurred while updating your application. Please try again.',
                });
            } finally {
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        function showApplicationDetails(appId) {
            // Find the application data
            const app = window.applicationsData.find(a => a.id === appId);
            if (!app) return;

            // Create modal HTML
            const modalHtml = `
            <div class="modal fade" id="applicationDetailModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${app.application_type.toUpperCase()} Application Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h6>Application ID: ${app.id}</h6>
                                    <p class="text-muted small">Applied: ${new Date(app.applied_at).toLocaleDateString()}</p>
                                </div>
                                <span class="badge ${getStatusColor(app.status)}">${app.status.replace('_', ' ').toUpperCase()}</span>
                            </div>

                            ${app.status === 'rejected' && app.rejection_reason ? `
                                <div class="alert alert-danger mb-3">
                                    <h6 class="alert-heading">Rejection Reason</h6>
                                    <p class="mb-0">${app.rejection_reason}</p>
                                </div>
                            ` : ''}

                            ${app.status === 'interview_scheduled' ? `
                                <div class="alert alert-info mb-3">
                                    <h6 class="alert-heading"><i class="fas fa-calendar"></i> Interview Scheduled</h6>
                                    <p class="mb-1"><strong>Date:</strong> ${new Date(app.interview_datetime).toLocaleString()}</p>
                                    ${app.interview_link ? `<p class="mb-1"><strong>Link:</strong> <a href="${app.interview_link}" target="_blank" class="alert-link">${app.interview_link}</a></p>` : ''}
                                    ${app.interview_description ? `<p class="mb-2"><strong>Notes:</strong> ${app.interview_description}</p>` : ''}
                                    ${app.interview_attended !== null ? `<p class="mb-0"><strong>Attended:</strong> <span class="${app.interview_attended ? 'text-success' : 'text-danger'}">${app.interview_attended ? '✓ Yes' : '✗ No'}</span></p>` : ''}
                                </div>
                            ` : ''}

                            <!-- Personal Information -->
                            <h6 class="text-primary mb-3"><i class="fas fa-user"></i> Personal Information</h6>
                            <div class="table-responsive mb-4">
                                <table class="table table-bordered">
                                    <tbody>
                                        <tr><td class="bg-light" style="width: 30%"><strong>Full Name</strong></td><td>${app.full_name || 'N/A'}</td></tr>
                                        <tr><td class="bg-light"><strong>Date of Birth</strong></td><td>${app.date_of_birth ? new Date(app.date_of_birth).toLocaleDateString() : 'N/A'}</td></tr>
                                        <tr><td class="bg-light"><strong>Phone</strong></td><td>${app.phone || 'N/A'}</td></tr>
                                        <tr><td class="bg-light"><strong>Email</strong></td><td>${app.user_email || 'N/A'}</td></tr>
                                        <tr><td class="bg-light"><strong>Temporary Address</strong></td><td>${app.temporary_address || 'N/A'}</td></tr>
                                        <tr><td class="bg-light"><strong>Permanent Address</strong></td><td>${app.permanent_address || 'N/A'}</td></tr>
                                        <tr><td class="bg-light"><strong>Location</strong></td><td>${app.country || 'Nepal'}${app.district ? ' - ' + app.district : ''}</td></tr>
                                        <tr><td class="bg-light"><strong>Profession</strong></td><td>${app.profession || 'N/A'}</td></tr>
                                        <tr><td class="bg-light"><strong>Social Link</strong></td><td>${app.social_link ? `<a href="${app.social_link}" target="_blank">${app.social_link}</a>` : 'N/A'}</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Application Questions -->
                            <h6 class="text-primary mb-3"><i class="fas fa-question-circle"></i> Application Details</h6>
                            <div class="table-responsive mb-4">
                                <table class="table table-bordered">
                                    <tbody>
                                        <tr><td class="bg-light" style="width: 30%"><strong>Why Join</strong></td><td>${app.why_join || 'N/A'}</td></tr>
                                        <tr><td class="bg-light"><strong>Self Definition</strong></td><td>${app.self_definition || 'N/A'}</td></tr>
                                        <tr><td class="bg-light"><strong>Hobbies & Interests</strong></td><td>${app.hobbies_interests || 'N/A'}</td></tr>
                                        <tr><td class="bg-light"><strong>Ideas</strong></td><td>${app.ideas || 'N/A'}</td></tr>
                                        <tr><td class="bg-light"><strong>Skills</strong></td><td>${Array.isArray(app.skills) ? app.skills.join(', ') : app.skills || 'N/A'}</td></tr>
                                        <tr><td class="bg-light"><strong>Time Commitment</strong></td><td>${app.time_commitment || 'N/A'}</td></tr>
                                        <tr><td class="bg-light"><strong>Other Organizations</strong></td><td>${app.other_organizations || 'N/A'}</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Documents -->
                            <h6 class="text-primary mb-3"><i class="fas fa-file-alt"></i> Documents</h6>
                            <div class="row mb-4">
                                ${app.photo ? `
                                    <div class="col-md-4 mb-3">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h6>Photo</h6>
                                                <img src="${app.photo}" alt="Photo" class="img-fluid rounded" style="max-height: 150px;">
                                                <br><a href="${app.photo}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">View Full</a>
                                            </div>
                                        </div>
                                    </div>
                                ` : '<div class="col-12"><p class="text-muted">No photo uploaded</p></div>'}
                                ${app.citizenship_front ? `
                                    <div class="col-md-4 mb-3">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h6>Citizenship Front</h6>
                                                <img src="${app.citizenship_front}" alt="Citizenship Front" class="img-fluid rounded" style="max-height: 150px;">
                                                <br><a href="${app.citizenship_front}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">View Full</a>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${app.citizenship_back ? `
                                    <div class="col-md-4 mb-3">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h6>Citizenship Back</h6>
                                                <img src="${app.citizenship_back}" alt="Citizenship Back" class="img-fluid rounded" style="max-height: 150px;">
                                                <br><a href="${app.citizenship_back}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">View Full</a>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            `;

            // Remove existing modal if present
            const existingModal = document.getElementById('applicationDetailModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('applicationDetailModal'));
            modal.show();
        }

        // Load default tab data (notices is active by default)
        loadNotices();

        // Sidebar navigation
        document.getElementById('sidebarNav').addEventListener('click', function (e) {
            e.preventDefault();
            if (e.target.classList.contains('list-group-item')) {
                const target = e.target.getAttribute('data-target');
                // Update active class
                document.querySelectorAll('#sidebarNav .list-group-item').forEach(item => item.classList.remove('active'));
                e.target.classList.add('active');
                // Show target section
                document.querySelectorAll('.content-section').forEach(section => section.style.display = 'none');
                document.getElementById(target).style.display = 'block';
                // Load data if needed
                if (target === 'applications') {
                    loadData();
                } else if (target === 'notices') {
                    loadNotices();
                }
            }
        });

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            element.setSelectionRange(0, 99999); // For mobile devices
            navigator.clipboard.writeText(element.value).then(() => {
                // Show success feedback
                const button = element.nextElementSibling;
                const originalIcon = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-success');
                setTimeout(() => {
                    button.innerHTML = originalIcon;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-secondary');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                // Fallback for older browsers
                document.execCommand('copy');
            });
        }

        async function loadCountriesForEdit(selectedCountry = 'Nepal') {
            try {
                const response = await fetch('https://restcountries.com/v3.1/all?fields=name');
                const data = await response.json();
                const select = document.getElementById('editCountrySelect');
                const sorted = data.sort((a, b) => a.name.common.localeCompare(b.name.common));
                select.innerHTML = sorted.map(c =>
                    `<option value="${c.name.common}" ${c.name.common === selectedCountry ? 'selected' : ''}>${c.name.common}</option>`
                ).join('');
                toggleEditDistrictField();
            } catch (err) {
                console.error('Failed to load countries:', err);
                document.getElementById('editCountrySelect').innerHTML = '<option value="Nepal" selected>Nepal</option>';
                toggleEditDistrictField();
            }
        }

        function setupEditDistrictLogic(app) {
            // Populate districts
            const districts = [
                'Achham', 'Arghakhanchi', 'Baglung', 'Baitadi', 'Bajhang', 'Bajura', 'Banke', 'Bara',
                'Bardiya', 'Bhaktapur', 'Bhojpur', 'Chitwan', 'Dadeldhura', 'Dailekh', 'Dang', 'Darchula',
                'Dhading', 'Dhankuta', 'Dhanusa', 'Dolakha', 'Dolpa', 'Doti', 'Gorkha', 'Gulmi',
                'Humla', 'Ilam', 'Jajarkot', 'Jhapa', 'Jumla', 'Kailali', 'Kalikot', 'Kanchanpur',
                'Kapilvastu', 'Kaski', 'Kathmandu', 'Kavrepalanchok', 'Khotang', 'Lalitpur', 'Lamjung',
                'Mahottari', 'Makwanpur', 'Manang', 'Morang', 'Mugu', 'Mustang', 'Myagdi', 'Nawalparasi East',
                'Nawalparasi West', 'Nuwakot', 'Okhaldhunga', 'Palpa', 'Panchthar', 'Parbat', 'Parsa',
                'Pyuthan', 'Ramechhap', 'Rasuwa', 'Rautahat', 'Rolpa', 'Rukum East', 'Rukum West', 'Rupandehi',
                'Salyan', 'Sankhuwasabha', 'Saptari', 'Sarlahi', 'Sindhuli', 'Sindhupalchok', 'Siraha',
                'Solukhumbu', 'Sunsari', 'Surkhet', 'Syangja', 'Tanahu', 'Taplejung', 'Terhathum', 'Udayapur'
            ];

            const districtSelect = document.getElementById('editDistrictSelect');
            districtSelect.innerHTML = '<option value="">Select District</option>' +
                districts.map(d => `<option value="${d}">${d}</option>`).join('');

            document.getElementById('editCountrySelect').addEventListener('change', toggleEditDistrictField);

            // Set initial district value
            if (app.district) {
                setTimeout(() => {
                    districtSelect.value = app.district;
                }, 100);
            }
        }

        function toggleEditDistrictField() {
            const country = document.getElementById('editCountrySelect').value;
            const districtField = document.getElementById('editDistrictField');
            const districtSelect = document.getElementById('editDistrictSelect');

            if (country === 'Nepal') {
                districtField.style.display = 'block';
                districtSelect.required = true;
            } else {
                districtField.style.display = 'none';
                districtSelect.required = false;
                districtSelect.value = '';
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('user');
                window.location.href = '/';
            }
        }
    </script>
</body>

</html>