{% extends 'admin/base.html' %}
{% load static %}

{% block page_title %}Reading Materials{% endblock %}

{% block header_title %}Reading Materials{% endblock %}

{% block content %}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<div class="bg-slate-800 rounded-lg p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-white">Manage Reading Materials</h3>
        <button id="addMaterialBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded">
            <i class="fas fa-plus mr-2"></i>Add Material
        </button>
    </div>
    
    <div class="overflow-x-auto">
        <table id="materialsTable" class="w-full text-white">
            <thead>
                <tr class="border-b border-slate-600">
                    <th class="text-left p-3">Title</th>
                    <th class="text-left p-3">Category</th>
                    <th class="text-left p-3">Assignment</th>
                    <th class="text-left p-3">File</th>
                    <th class="text-left p-3">Status</th>
                    <th class="text-left p-3">Actions</th>
                </tr>
            </thead>
            <tbody id="materialsTableBody">
                <tr>
                    <td colspan="6" class="text-center p-8">
                        <i class="fas fa-spinner fa-spin fa-2x text-slate-400 mb-3"></i>
                        <p class="text-slate-400">Loading materials...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Add Material Modal -->
<div id="addMaterialModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Add Reading Material</h3>
                <button id="closeMaterialModal" class="text-slate-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="addMaterialForm" enctype="multipart/form-data">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-white mb-2">Title</label>
                        <input type="text" name="title" required class="w-full p-2 bg-slate-700 text-white rounded">
                    </div>
                    <div>
                        <label class="block text-white mb-2">Category</label>
                        <div class="flex gap-2">
                            <select name="category_id" required class="flex-1 p-2 bg-slate-700 text-white rounded">
                                <option value="">Select Category</option>
                            </select>
                            <button type="button" id="addCategoryBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-white mb-2">Description</label>
                    <div id="descriptionEditor" class="bg-slate-700 text-white rounded" style="height: 150px;"></div>
                    <input type="hidden" name="description" id="descriptionContent">
                </div>
                
                <div class="mb-4">
                    <label class="block text-white mb-2">File (PDF/DOC)</label>
                    <input type="file" name="file" accept=".pdf,.doc,.docx" class="w-full p-2 bg-slate-700 text-white rounded">
                    <small class="text-slate-400">Leave empty to keep current file</small>
                </div>
                
                <div class="mb-4">
                    <label class="block text-white mb-2">Cover Image (Optional)</label>
                    <input type="file" name="cover_image" accept="image/*" class="w-full p-2 bg-slate-700 text-white rounded">
                </div>
                
                <div class="mb-4">
                    <label class="block text-white mb-2">Assignment Type</label>
                    <select name="assignment_type" class="w-full p-2 bg-slate-700 text-white rounded">
                        <option value="all">All Users</option>
                        <option value="individual">Individual Users</option>
                        <option value="branch">By Branch</option>
                        <option value="branch_individual">Branch + Individual</option>
                    </select>
                </div>
                
                <div id="userSelection" class="mb-4 hidden">
                    <label class="block text-white mb-2">Select Users</label>
                    <div class="mb-2">
                        <input type="text" id="userSearch" placeholder="Search users..." class="w-full p-2 bg-slate-700 text-white rounded text-sm">
                    </div>
                    <div id="selectedUsersDisplay" class="mb-2 space-y-1"></div>
                    <div id="usersList" class="max-h-40 overflow-y-auto bg-slate-700 rounded p-2 border border-slate-600"></div>
                </div>
                
                <div id="branchSelection" class="mb-4 hidden">
                    <label class="block text-white mb-2">Select Branches</label>
                    <div class="mb-2">
                        <input type="text" id="branchSearch" placeholder="Search branches..." class="w-full p-2 bg-slate-700 text-white rounded text-sm">
                    </div>
                    <div id="selectedBranchesDisplay" class="mb-2 space-y-1"></div>
                    <div id="branchesList" class="max-h-40 overflow-y-auto bg-slate-700 rounded p-2 border border-slate-600"></div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelMaterial" class="px-4 py-2 bg-slate-600 text-white rounded hover:bg-slate-700">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600">Add Material</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div id="addCategoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Add Category</h3>
                <button id="closeCategoryModal" class="text-slate-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="addCategoryForm">
                <div class="mb-4">
                    <label class="block text-white mb-2">Category Name</label>
                    <input type="text" name="name" required class="w-full p-2 bg-slate-700 text-white rounded">
                </div>
                
                <div class="mb-4">
                    <label class="block text-white mb-2">Description</label>
                    <textarea name="description" class="w-full p-2 bg-slate-700 text-white rounded h-20"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelCategory" class="px-4 py-2 bg-slate-600 text-white rounded hover:bg-slate-700">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Add Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const currentUser = getUser();
    if (!currentUser || (!currentUser.is_superuser && currentUser.user_type !== 'admin')) {
        console.log('User check failed:', currentUser);
        window.location.href = '/';
    }
    
    let materials = [];
    let categories = [];
    let users = [];
    let branches = [];
    let selectedUserIds = [];
    let selectedBranchIds = [];
    let quill = null;
    let editingMaterialId = null;
    
    loadMaterials();
    loadCategories();
    loadUsers();
    loadBranches();
    initializeQuill();
    
    function initializeQuill() {
        quill = new Quill('#descriptionEditor', {
            theme: 'snow',
            placeholder: 'Enter material description...',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],
                    ['link'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['clean']
                ]
            }
        });
    }
    document.addEventListener('input', (e) => {
        if (e.target.id === 'userSearch') {
            setTimeout(() => renderUsers(), 100);
        } else if (e.target.id === 'branchSearch') {
            setTimeout(() => renderBranches(), 100);
        }
    });
    
    document.getElementById('addMaterialBtn').addEventListener('click', () => {
        editingMaterialId = null;
        document.querySelector('#addMaterialModal h3').textContent = 'Add Reading Material';
        document.getElementById('addMaterialModal').classList.remove('hidden');
    });
    
    document.getElementById('addCategoryBtn').addEventListener('click', () => {
        document.getElementById('addCategoryModal').classList.remove('hidden');
    });
    
    document.getElementById('closeMaterialModal').addEventListener('click', closeModal);
    document.getElementById('cancelMaterial').addEventListener('click', closeModal);
    
    document.getElementById('closeCategoryModal').addEventListener('click', closeCategoryModal);
    document.getElementById('cancelCategory').addEventListener('click', closeCategoryModal);
    
    document.querySelector('select[name="assignment_type"]').addEventListener('change', function() {
        const userSelection = document.getElementById('userSelection');
        const branchSelection = document.getElementById('branchSelection');
        
        userSelection.classList.add('hidden');
        branchSelection.classList.add('hidden');
        
        if (this.value === 'individual' || this.value === 'branch_individual') {
            userSelection.classList.remove('hidden');
        }
        if (this.value === 'branch' || this.value === 'branch_individual') {
            branchSelection.classList.remove('hidden');
        }
    });
    
    document.getElementById('addMaterialForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!editingMaterialId && !e.target.file.files[0]) {
            alert('Please select a file');
            return;
        }
        
        const formData = new FormData();
        formData.append('title', e.target.title.value);
        formData.append('description', quill.root.innerHTML);
        formData.append('category_id', e.target.category_id.value);
        if (e.target.file.files[0]) {
            formData.append('file', e.target.file.files[0]);
        }
        if (e.target.cover_image.files[0]) {
            formData.append('cover_image', e.target.cover_image.files[0]);
        }
        formData.append('assignment_type', e.target.assignment_type.value);
        
        // Add selected users
        selectedUserIds.forEach(userId => formData.append('assigned_users[]', userId));
        
        // Add selected branches
        selectedBranchIds.forEach(branchId => formData.append('assigned_branches[]', branchId));
        
        try {
            const token = localStorage.getItem('access_token');
            const url = editingMaterialId ? 
                `/api/materials/admin-materials/${editingMaterialId}/` : 
                '/api/materials/admin-materials/';
            const method = editingMaterialId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });
            
            if (response.ok) {
                closeModal();
                loadMaterials();
                e.target.reset();
                if (quill) quill.setContents([]);
            } else {
                alert('Error creating material');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error creating material');
        }
    });
    
    document.getElementById('addCategoryForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/materials/categories/', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });
            
            if (response.status === 401) {
                clearToken();
                window.location.href = '/';
                return;
            }
            
            if (response.ok) {
                closeCategoryModal();
                loadCategories();
                e.target.reset();
            } else {
                alert('Error creating category');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error creating category');
        }
    });
    
    async function loadMaterials() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/materials/admin-materials/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            const data = await response.json();
            materials = data.materials || [];
            renderMaterials();
        } catch (error) {
            console.error('Error loading materials:', error);
        }
    }
    
    async function loadCategories() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/materials/categories/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.status === 401) {
                clearToken();
                window.location.href = '/';
                return;
            }
            
            const data = await response.json();
            categories = data.categories || [];
            
            const select = document.querySelector('select[name="category_id"]');
            select.innerHTML = '<option value="">Select Category</option>';
            categories.forEach(cat => {
                select.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
            });
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }
    
    async function loadUsers() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/users/list/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            const data = await response.json();
            users = data.results || data.users || [];
            renderUsers();
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }
    
    async function loadBranches() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/branches/list/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            const data = await response.json();
            branches = data.branches || data.results || [];
            renderBranches();
        } catch (error) {
            console.error('Error loading branches:', error);
        }
    }
    
    function renderMaterials() {
        const tbody = document.getElementById('materialsTableBody');
        
        if (materials.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center p-8">
                        <i class="fas fa-book fa-3x text-slate-400 mb-3"></i>
                        <p class="text-slate-400">No materials found.</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = materials.map(material => `
            <tr class="border-b border-slate-700">
                <td class="p-3">${material.title}</td>
                <td class="p-3">${material.category.name}</td>
                <td class="p-3">
                    <span class="text-xs bg-blue-500 text-white px-2 py-1 rounded">
                        ${material.assignment_type.replace('_', ' ').toUpperCase()}
                    </span>
                    ${material.assignment_type !== 'all' ? `<br><small class="text-slate-400">
                        ${material.assigned_users?.length || 0} users, ${material.assigned_branches?.length || 0} branches
                    </small>` : ''}
                </td>
                <td class="p-3">
                    <a href="${material.file_url}" target="_blank" class="text-orange-500 hover:text-orange-400">
                        <i class="fas fa-file-pdf mr-1"></i>View
                    </a>
                </td>
                <td class="p-3">
                    <span class="text-xs ${material.is_active ? 'bg-green-500' : 'bg-red-500'} text-white px-2 py-1 rounded">
                        ${material.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td class="p-3">
                    <button onclick="editMaterial(${material.id})" class="text-blue-500 hover:text-blue-400 mr-2">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="text-red-500 hover:text-red-400 ml-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    function renderUsers() {
        const container = document.getElementById('usersList');
        const searchInput = document.getElementById('userSearch');
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        
        const filteredUsers = users.filter(user => {
            const fullName = `${user.first_name || ''} ${user.last_name || ''} ${user.email || ''}`.toLowerCase();
            return fullName.includes(searchTerm) && !selectedUserIds.includes(user.id);
        });
        
        if (filteredUsers.length === 0) {
            container.innerHTML = '<div class="text-slate-400 p-2">No users found</div>';
            return;
        }
        
        container.innerHTML = filteredUsers.map(user => `
            <div class="flex items-center text-white mb-2 p-2 hover:bg-slate-600 rounded cursor-pointer" onclick="selectUser(${user.id}, '${user.first_name || ''} ${user.last_name || ''}', '${user.email}')">
                <div>
                    <div class="font-medium">${user.first_name || ''} ${user.last_name || ''}</div>
                    <div class="text-xs text-slate-400">${user.email || ''}</div>
                </div>
            </div>
        `).join('');
    }
    
    function renderBranches() {
        const container = document.getElementById('branchesList');
        const searchInput = document.getElementById('branchSearch');
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        
        const filteredBranches = branches.filter(branch => 
            (branch.name || '').toLowerCase().includes(searchTerm) && !selectedBranchIds.includes(branch.id)
        );
        
        if (filteredBranches.length === 0) {
            container.innerHTML = '<div class="text-slate-400 p-2">No branches found</div>';
            return;
        }
        
        container.innerHTML = filteredBranches.map(branch => `
            <div class="flex items-center text-white mb-2 p-2 hover:bg-slate-600 rounded cursor-pointer" onclick="selectBranch(${branch.id}, '${branch.name}')">
                <div class="font-medium">${branch.name || ''}</div>
            </div>
        `).join('');
    }
    
    function selectUser(userId, userName, userEmail) {
        if (selectedUserIds.includes(userId)) return;
        
        selectedUserIds.push(userId);
        updateSelectedUsersDisplay();
        renderUsers();
        document.getElementById('userSearch').value = '';
    }
    
    function selectBranch(branchId, branchName) {
        if (selectedBranchIds.includes(branchId)) return;
        
        selectedBranchIds.push(branchId);
        updateSelectedBranchesDisplay();
        renderBranches();
        document.getElementById('branchSearch').value = '';
    }
    
    function updateSelectedUsersDisplay() {
        const container = document.getElementById('selectedUsersDisplay');
        container.innerHTML = selectedUserIds.map((userId, index) => {
            const user = users.find(u => u.id === userId);
            return `
                <div class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm flex items-center justify-between">
                    <span>${user ? `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.email : `User ${userId}`}</span>
                    <button onclick="removeUser(${index})" class="ml-2 text-blue-200 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }).join('');
    }
    
    function updateSelectedBranchesDisplay() {
        const container = document.getElementById('selectedBranchesDisplay');
        container.innerHTML = selectedBranchIds.map((branchId, index) => {
            const branch = branches.find(b => b.id === branchId);
            return `
                <div class="bg-green-600 text-white px-3 py-1 rounded-full text-sm flex items-center justify-between">
                    <span>${branch ? branch.name : `Branch ${branchId}`}</span>
                    <button onclick="removeBranch(${index})" class="ml-2 text-green-200 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }).join('');
    }
    
    function removeUser(index) {
        selectedUserIds.splice(index, 1);
        updateSelectedUsersDisplay();
        renderUsers();
    }
    
    function removeBranch(index) {
        selectedBranchIds.splice(index, 1);
        updateSelectedBranchesDisplay();
        renderBranches();
    }
    
    function editMaterial(materialId) {
        const material = materials.find(m => m.id === materialId);
        if (!material) return;
        
        editingMaterialId = materialId;
        document.querySelector('#addMaterialModal h3').textContent = 'Edit Reading Material';
        
        // Fill form with material data
        document.querySelector('input[name="title"]').value = material.title;
        document.querySelector('select[name="category_id"]').value = material.category.id;
        document.querySelector('select[name="assignment_type"]').value = material.assignment_type;
        
        if (quill) {
            quill.root.innerHTML = material.description;
        }
        
        // Set selected users and branches
        selectedUserIds = material.assigned_users.map(u => u.id);
        selectedBranchIds = material.assigned_branches.map(b => b.id);
        updateSelectedUsersDisplay();
        updateSelectedBranchesDisplay();
        
        // Show assignment fields if needed
        const assignmentType = material.assignment_type;
        document.getElementById('userSelection').style.display = 
            (assignmentType === 'individual' || assignmentType === 'branch_individual') ? 'block' : 'none';
        document.getElementById('branchSelection').style.display = 
            (assignmentType === 'branch' || assignmentType === 'branch_individual') ? 'block' : 'none';
        
        document.getElementById('addMaterialModal').classList.remove('hidden');
    }
    
    function closeModal() {
        document.getElementById('addMaterialModal').classList.add('hidden');
        selectedUserIds = [];
        selectedBranchIds = [];
        editingMaterialId = null;
        updateSelectedUsersDisplay();
        updateSelectedBranchesDisplay();
        if (quill) quill.setContents([]);
        document.getElementById('addMaterialForm').reset();
    }
    
    function closeCategoryModal() {
        document.getElementById('addCategoryModal').classList.add('hidden');
    }
</script>
{% endblock %}