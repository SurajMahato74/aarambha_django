{% extends 'admin/base.html' %}

{% block title %}Payment History{% endblock %}
{% block page_title %}Payment History{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
    <div class="card p-5 rounded-lg bg-slate-800/50">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-400 text-xs">Total Amount</p>
                <p class="text-2xl font-bold text-white mt-1">Rs. {{ stats.total_amount|floatformat:0 }}</p>
            </div>
            <i class="fas fa-dollar-sign text-2xl text-green-500"></i>
        </div>
    </div>
    <div class="card p-5 rounded-lg bg-slate-800/50">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-400 text-xs">Total Payments</p>
                <p class="text-2xl font-bold text-white mt-1">{{ stats.total_count }}</p>
            </div>
            <i class="fas fa-receipt text-2xl text-blue-500"></i>
        </div>
    </div>
    <div class="card p-5 rounded-lg bg-slate-800/50">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-400 text-xs">Payment Sources</p>
                <p class="text-2xl font-bold text-white mt-1">{{ stats.source_stats|length }}</p>
            </div>
            <i class="fas fa-sitemap text-2xl text-purple-500"></i>
        </div>
    </div>
    <div class="card p-5 rounded-lg bg-slate-800/50">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-400 text-xs">Payment Types</p>
                <p class="text-2xl font-bold text-white mt-1">{{ stats.type_stats|length }}</p>
            </div>
            <i class="fas fa-tags text-2xl text-orange-500"></i>
        </div>
    </div>
</div>

<!-- Source & Type Statistics -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Source Statistics -->
    <div class="card rounded-lg overflow-hidden bg-slate-800/50">
        <div class="p-5 border-b border-slate-700">
            <h3 class="font-medium text-white flex items-center">
                <i class="fas fa-chart-pie mr-2 text-blue-500"></i>
                Revenue by Source
            </h3>
        </div>
        <div class="p-5">
            {% for source, data in stats.source_stats.items %}
            <div class="flex justify-between items-center mb-3">
                <div>
                    <p class="text-white font-medium">{{ source }}</p>
                    <p class="text-slate-400 text-sm">{{ data.count }} payments</p>
                </div>
                <div class="text-right">
                    <p class="text-white font-bold">Rs. {{ data.amount|floatformat:0 }}</p>
                    <p class="text-slate-400 text-xs">{{ data.amount|floatformat:1 }}%</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Type Statistics -->
    <div class="card rounded-lg overflow-hidden bg-slate-800/50">
        <div class="p-5 border-b border-slate-700">
            <h3 class="font-medium text-white flex items-center">
                <i class="fas fa-chart-bar mr-2 text-green-500"></i>
                Revenue by Type
            </h3>
        </div>
        <div class="p-5">
            {% for type, data in stats.type_stats.items %}
            <div class="flex justify-between items-center mb-3">
                <div>
                    <p class="text-white font-medium">{{ type }}</p>
                    <p class="text-slate-400 text-sm">{{ data.count }} payments</p>
                </div>
                <div class="text-right">
                    <p class="text-white font-bold">Rs. {{ data.amount|floatformat:0 }}</p>
                    <p class="text-slate-400 text-xs">{{ data.amount|floatformat:1 }}%</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card rounded-lg bg-slate-800/50 mb-6">
    <div class="p-5 border-b border-slate-700">
        <h3 class="font-medium text-white flex items-center">
            <i class="fas fa-filter mr-2 text-yellow-500"></i>
            Filters
        </h3>
    </div>
    <div class="p-5">
        <form method="GET" class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
                <label class="block text-slate-400 text-sm mb-2">Source</label>
                <select name="source" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white">
                    <option value="">All Sources</option>
                    {% for source in available_sources %}
                    <option value="{{ source }}" {% if filters.source == source %}selected{% endif %}>{{ source }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-slate-400 text-sm mb-2">Type</label>
                <select name="type" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white">
                    <option value="">All Types</option>
                    {% for type in available_types %}
                    <option value="{{ type }}" {% if filters.type == type %}selected{% endif %}>{{ type }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-slate-400 text-sm mb-2">Date Range</label>
                <select name="date_filter" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white">
                    <option value="">All Time</option>
                    <option value="today" {% if filters.date_filter == 'today' %}selected{% endif %}>Today</option>
                    <option value="week" {% if filters.date_filter == 'week' %}selected{% endif %}>Last 7 Days</option>
                    <option value="month" {% if filters.date_filter == 'month' %}selected{% endif %}>Last 30 Days</option>
                    <option value="year" {% if filters.date_filter == 'year' %}selected{% endif %}>Last Year</option>
                </select>
            </div>
            <div>
                <label class="block text-slate-400 text-sm mb-2">Start Date</label>
                <input type="date" name="start_date" value="{{ filters.start_date }}" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white">
            </div>
            <div>
                <label class="block text-slate-400 text-sm mb-2">End Date</label>
                <input type="date" name="end_date" value="{{ filters.end_date }}" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white">
            </div>
            <div class="md:col-span-5 flex gap-2">
                <button type="submit" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-search mr-2"></i>Apply Filters
                </button>
                <a href="/admin/payment-history/" class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-times mr-2"></i>Clear Filters
                </a>
                <button type="button" onclick="exportPayments()" class="btn bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded ml-auto">
                    <i class="fas fa-download mr-2"></i>Export CSV
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Payment History Table -->
<div class="card rounded-lg overflow-hidden bg-slate-800/50">
    <div class="p-5 border-b border-slate-700">
        <h3 class="font-medium text-white flex items-center">
            <i class="fas fa-history mr-2 text-purple-500"></i>
            Payment History
        </h3>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-slate-700/50">
                <tr>
                    <th class="text-left p-4 text-slate-300 font-medium">Date</th>
                    <th class="text-left p-4 text-slate-300 font-medium">User</th>
                    <th class="text-left p-4 text-slate-300 font-medium">Type</th>
                    <th class="text-left p-4 text-slate-300 font-medium">Source</th>
                    <th class="text-left p-4 text-slate-300 font-medium">Amount</th>
                    <th class="text-left p-4 text-slate-300 font-medium">Transaction ID</th>
                    <th class="text-left p-4 text-slate-300 font-medium">Description</th>
                    <th class="text-left p-4 text-slate-300 font-medium">Actions</th>
                </tr>
            </thead>
            <tbody id="paymentsTable">
                <!-- Payments will be loaded here by JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- Payment Detail Modal -->
<div id="paymentDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-slate-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white">Payment Details</h3>
            <button onclick="closePaymentModal()" class="text-slate-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div id="paymentDetailContent">
            <!-- Payment details will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

<script>
const payments = {{ payments|safe }};

document.addEventListener('DOMContentLoaded', function() {
    loadPayments();
});

function loadPayments() {
    const tbody = document.getElementById('paymentsTable');
    
    if (payments.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-8 text-slate-400">
                    <i class="fas fa-inbox text-2xl mb-2"></i>
                    <p>No payments found</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = payments.map(payment => `
        <tr class="border-b border-slate-700/50 hover:bg-slate-700/30 transition">
            <td class="p-4 text-white">
                ${formatDate(payment.payment_date)}
            </td>
            <td class="p-4">
                <div>
                    <p class="text-white font-medium">${payment.user_name}</p>
                    <p class="text-slate-400 text-sm">${payment.user_email}</p>
                </div>
            </td>
            <td class="p-4">
                <span class="badge ${getTypeBadgeColor(payment.type)}">${payment.type}</span>
            </td>
            <td class="p-4">
                <span class="badge ${getSourceBadgeColor(payment.source)}">${payment.source}</span>
            </td>
            <td class="p-4 text-white font-bold">
                Rs. ${parseFloat(payment.amount).toLocaleString()}
            </td>
            <td class="p-4 text-slate-300 font-mono text-sm">
                ${payment.transaction_id || 'N/A'}
            </td>
            <td class="p-4 text-slate-300">
                ${payment.description.length > 50 ? payment.description.substring(0, 50) + '...' : payment.description}
            </td>
            <td class="p-4">
                <button onclick="viewPaymentDetail('${payment.id}')" class="btn btn-sm bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs">
                    <i class="fas fa-eye mr-1"></i>View
                </button>
            </td>
        </tr>
    `).join('');
}

function getTypeBadgeColor(type) {
    const colors = {
        'Membership Fee': 'bg-blue-900/30 text-blue-300',
        'Child Sponsorship': 'bg-green-900/30 text-green-300',
        'One Rupee Campaign': 'bg-yellow-900/30 text-yellow-300',
        'Birthday Campaign': 'bg-pink-900/30 text-pink-300',
        'General Donation': 'bg-purple-900/30 text-purple-300'
    };
    return colors[type] || 'bg-gray-900/30 text-gray-300';
}

function getSourceBadgeColor(source) {
    const colors = {
        'Member Application': 'bg-indigo-900/30 text-indigo-300',
        'Sponsor Children': 'bg-emerald-900/30 text-emerald-300',
        'Celebrate Birthday': 'bg-rose-900/30 text-rose-300',
        'Website Donations': 'bg-violet-900/30 text-violet-300'
    };
    return colors[source] || 'bg-gray-900/30 text-gray-300';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function viewPaymentDetail(paymentId) {
    const payment = payments.find(p => p.id === paymentId);
    if (!payment) return;
    
    const content = `
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-slate-400 text-sm mb-1">Payment ID</label>
                    <p class="text-white font-mono">${payment.id}</p>
                </div>
                <div>
                    <label class="block text-slate-400 text-sm mb-1">Date</label>
                    <p class="text-white">${formatDate(payment.payment_date)}</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-slate-400 text-sm mb-1">User Name</label>
                    <p class="text-white">${payment.user_name}</p>
                </div>
                <div>
                    <label class="block text-slate-400 text-sm mb-1">Email</label>
                    <p class="text-white">${payment.user_email}</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-slate-400 text-sm mb-1">Type</label>
                    <span class="badge ${getTypeBadgeColor(payment.type)}">${payment.type}</span>
                </div>
                <div>
                    <label class="block text-slate-400 text-sm mb-1">Source</label>
                    <span class="badge ${getSourceBadgeColor(payment.source)}">${payment.source}</span>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-slate-400 text-sm mb-1">Amount</label>
                    <p class="text-white text-xl font-bold">Rs. ${parseFloat(payment.amount).toLocaleString()}</p>
                </div>
                <div>
                    <label class="block text-slate-400 text-sm mb-1">Status</label>
                    <span class="badge bg-green-900/30 text-green-300">${payment.status}</span>
                </div>
            </div>
            
            <div>
                <label class="block text-slate-400 text-sm mb-1">Transaction ID</label>
                <p class="text-white font-mono">${payment.transaction_id || 'N/A'}</p>
            </div>
            
            <div>
                <label class="block text-slate-400 text-sm mb-1">Description</label>
                <p class="text-white">${payment.description}</p>
            </div>
        </div>
    `;
    
    document.getElementById('paymentDetailContent').innerHTML = content;
    document.getElementById('paymentDetailModal').classList.remove('hidden');
}

function closePaymentModal() {
    document.getElementById('paymentDetailModal').classList.add('hidden');
}

function exportPayments() {
    const csvContent = [
        ['Date', 'User Name', 'Email', 'Type', 'Source', 'Amount', 'Transaction ID', 'Description'].join(','),
        ...payments.map(payment => [
            formatDate(payment.payment_date),
            `"${payment.user_name}"`,
            payment.user_email,
            `"${payment.type}"`,
            `"${payment.source}"`,
            payment.amount,
            payment.transaction_id || '',
            `"${payment.description}"`
        ].join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `payment_history_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Close modal when clicking outside
document.getElementById('paymentDetailModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePaymentModal();
    }
});
</script>