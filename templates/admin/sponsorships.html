{% extends 'admin/base.html' %}

{% block title %}Child Sponsorships{% endblock %}
{% block page_title %}Child Sponsorship Management{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card p-4 rounded-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-slate-400 text-sm">Total Sponsorships</p>
                    <p class="text-2xl font-bold text-white" id="totalSponsorships">0</p>
                </div>
                <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-heart text-blue-400 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="card p-4 rounded-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-slate-400 text-sm">Pending</p>
                    <p class="text-2xl font-bold text-yellow-400" id="pendingSponsorships">0</p>
                </div>
                <div class="w-12 h-12 bg-yellow-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-clock text-yellow-400 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="card p-4 rounded-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-slate-400 text-sm">Approved</p>
                    <p class="text-2xl font-bold text-green-400" id="approvedSponsorships">0</p>
                </div>
                <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-check-circle text-green-400 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="card p-4 rounded-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-slate-400 text-sm">Active</p>
                    <p class="text-2xl font-bold text-indigo-400" id="activeSponsorships">0</p>
                </div>
                <div class="w-12 h-12 bg-indigo-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-handshake text-indigo-400 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="card p-4 rounded-lg">
        <div class="flex flex-wrap gap-4 items-center">
            <div class="flex-1 min-w-64">
                <input type="text" id="searchInput" placeholder="Search by name, email, or phone..."
                    class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <select id="statusFilter"
                class="px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
                <option value="active">Active</option>
                <option value="completed">Completed</option>
            </select>
            <select id="typeFilter"
                class="px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="">All Types</option>
                <option value="Full Sponsorship">Full Sponsorship</option>
                <option value="Partial Sponsorship">Partial Sponsorship</option>
                <option value="One-time Donation">One-time Donation</option>
            </select>
            <button onclick="loadSponsorships()" 
                class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                <i class="fas fa-search mr-2"></i>Search
            </button>
        </div>
    </div>

    <!-- Sponsorships Table -->
    <div class="card rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-slate-800">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Sponsor</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Type</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Preferences</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Payment</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Children</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Payments</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Date</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="sponsorshipsTableBody" class="divide-y divide-slate-700">
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-slate-400">
                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Loading sponsorships...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="flex justify-center items-center space-x-2"></div>
</div>

<!-- Sponsorship Detail Modal -->
<div id="sponsorshipModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-slate-800 rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-slate-700">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold text-white">Sponsorship Details</h3>
                <button onclick="closeSponsorshipModal()" class="text-slate-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        <div id="sponsorshipModalBody" class="p-6">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div id="statusModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-slate-800 rounded-lg max-w-md w-full mx-4">
        <div class="p-6 border-b border-slate-700">
            <h3 class="text-xl font-semibold text-white">Update Status</h3>
        </div>
        <div class="p-6">
            <form id="statusUpdateForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Status</label>
                        <select id="newStatus" required
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div id="rejectionReasonField" class="hidden">
                        <label class="block text-sm font-medium text-slate-300 mb-2">Rejection Reason <span class="text-red-400">*</span></label>
                        <textarea id="rejectionReason" rows="3" placeholder="Please provide reason for rejection..."
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                        <div class="mt-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="allowReapply" class="mr-2 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500">
                                <span class="text-sm text-slate-300">Allow sponsor to edit and reapply</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Admin Notes</label>
                        <textarea id="adminNotes" rows="4" placeholder="Add notes about this status change..."
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeStatusModal()"
                        class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                        Update Status
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Assign Children Modal -->
<div id="assignModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-slate-800 rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-slate-700">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold text-white">Assign Children to Sponsor</h3>
                <button onclick="closeAssignModal()" class="text-slate-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        <div class="p-6">
            <div class="mb-4">
                <input type="text" id="childSearchInput" placeholder="Search children by name, district, or school..."
                    class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="space-y-3 max-h-96 overflow-y-auto" id="childrenList">
                <div class="text-center text-slate-400 py-8">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading children...</p>
                </div>
            </div>
            <div class="mt-6">
                <h4 class="text-lg font-semibold text-white mb-3">Selected Children (<span id="selectedCount">0</span>)</h4>
                <div id="selectedChildren" class="space-y-2 max-h-32 overflow-y-auto">
                    <p class="text-slate-400 text-sm">No children selected</p>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeAssignModal()"
                    class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg transition-colors">
                    Cancel
                </button>
                <button type="button" onclick="assignSelectedChildren()" id="assignBtn"
                    class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                    <i class="fas fa-user-plus mr-2"></i>Assign Children
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let currentSponsorshipId = null;
let selectedChildrenIds = [];

document.addEventListener('DOMContentLoaded', function() {
    loadSponsorships();
    loadStats();
    
    // Setup search on enter
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            loadSponsorships();
        }
    });
    
    // Setup status update form
    document.getElementById('statusUpdateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        updateSponsorshipStatus();
    });
    
    // Show/hide rejection reason field based on status
    document.getElementById('newStatus').addEventListener('change', function() {
        const rejectionField = document.getElementById('rejectionReasonField');
        if (this.value === 'rejected') {
            rejectionField.classList.remove('hidden');
            document.getElementById('rejectionReason').required = true;
        } else {
            rejectionField.classList.add('hidden');
            document.getElementById('rejectionReason').required = false;
        }
    });
});

async function loadStats() {
    try {
        const response = await fetchAPI('/api/applications/sponsorships/list/');
        const data = await response.json();
        
        const sponsorships = data.results || [];
        const stats = {
            total: sponsorships.length,
            pending: sponsorships.filter(s => s.status === 'pending').length,
            approved: sponsorships.filter(s => s.status === 'approved').length,
            active: sponsorships.filter(s => s.status === 'active').length
        };
        
        document.getElementById('totalSponsorships').textContent = stats.total;
        document.getElementById('pendingSponsorships').textContent = stats.pending;
        document.getElementById('approvedSponsorships').textContent = stats.approved;
        document.getElementById('activeSponsorships').textContent = stats.active;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function loadSponsorships(page = 1) {
    try {
        const search = document.getElementById('searchInput').value;
        const status = document.getElementById('statusFilter').value;
        const type = document.getElementById('typeFilter').value;
        
        let url = `/api/applications/sponsorships/list/?page=${page}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;
        if (status) url += `&status=${status}`;
        if (type) url += `&type=${encodeURIComponent(type)}`;
        
        const response = await fetchAPI(url);
        const data = await response.json();
        
        // Load assignment data for each sponsorship
        const sponsorshipsWithAssignments = await Promise.all(
            (data.results || []).map(async (sponsorship) => {
                try {
                    const assignmentResponse = await fetchAPI(`/api/applications/sponsorships/${sponsorship.id}/assignments/`);
                    const assignments = await assignmentResponse.json();
                    return {
                        ...sponsorship,
                        assignments: assignments,
                        hasApprovedChildren: assignments.some(a => a.status === 'approved')
                    };
                } catch (error) {
                    return {
                        ...sponsorship,
                        assignments: [],
                        hasApprovedChildren: false
                    };
                }
            })
        );
        
        displaySponsorships(sponsorshipsWithAssignments);
        setupPagination(data);
        currentPage = page;
    } catch (error) {
        console.error('Error loading sponsorships:', error);
        document.getElementById('sponsorshipsTableBody').innerHTML = `
            <tr>
                <td colspan="8" class="px-4 py-8 text-center text-red-400">
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <p>Error loading sponsorships</p>
                </td>
            </tr>
        `;
    }
}

function displaySponsorships(sponsorships) {
    const tbody = document.getElementById('sponsorshipsTableBody');
    
    if (sponsorships.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="px-4 py-8 text-center text-slate-400">
                    <i class="fas fa-heart text-4xl mb-4 opacity-50"></i>
                    <p>No sponsorships found</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = sponsorships.map(sponsorship => `
        <tr class="hover:bg-slate-700/50">
            <td class="px-4 py-4">
                <div>
                    <div class="font-medium text-white">${sponsorship.full_name}</div>
                    <div class="text-sm text-slate-400">${sponsorship.email}</div>
                    <div class="text-sm text-slate-400">${sponsorship.phone}</div>
                    <div class="text-sm text-slate-400">${sponsorship.country}</div>
                </div>
            </td>
            <td class="px-4 py-4">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getSponsorshipTypeColor(sponsorship.sponsorship_type)}">
                    ${sponsorship.sponsorship_type}
                </span>
            </td>
            <td class="px-4 py-4">
                            <div class="text-sm text-slate-300">
                                ${sponsorship.child_gender ? `<div>Gender: ${sponsorship.child_gender}</div>` : ''}
                                ${sponsorship.child_age ? `<div>Age: ${sponsorship.child_age}</div>` : ''}
                                <div>Updates: ${sponsorship.update_frequency}</div>
                                ${sponsorship.status === 'rejected' && sponsorship.can_reapply ? '<div class="text-yellow-400">Can Reapply</div>' : ''}
                            </div>
            </td>
            <td class="px-4 py-4">
                <div class="text-sm text-slate-300">
                    ${sponsorship.payment_amount ? `<div class="font-medium">Rs. ${sponsorship.payment_amount}</div>` : '<div class="text-slate-500">Not specified</div>'}
                    <div class="text-slate-400">${sponsorship.payment_method}</div>
                </div>
            </td>
            <td class="px-4 py-4">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(sponsorship.status)}">
                    ${sponsorship.status.charAt(0).toUpperCase() + sponsorship.status.slice(1)}
                </span>
            </td>
            <td class="px-4 py-4">
                <div class="text-sm text-slate-300">
                    ${sponsorship.assignments && sponsorship.assignments.filter(a => a.status === 'approved').length > 0 ? `
                        <div class="space-y-1">
                            ${sponsorship.assignments.filter(a => a.status === 'approved').map(assignment => {
                                const child = assignment.child;
                                const isActive = child.current_sponsor && child.status === 'sponsored';
                                return `
                                <div class="flex items-center space-x-2">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                        isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                    }">
                                        ${child.full_name}
                                    </span>
                                    <i class="fas ${
                                        isActive ? 'fa-check-circle text-green-400' : 'fa-times-circle text-red-400'
                                    }" title="${isActive ? 'Active' : 'Cancelled'}"></i>
                                </div>
                            `}).join('')}
                        </div>
                    ` : '<span class="text-slate-500">No sponsored children</span>'}"
                </div>
            </td>
            <td class="px-4 py-4">
                <div class="text-sm text-slate-300">
                    ${sponsorship.assignments && sponsorship.assignments.filter(a => a.status === 'approved').length > 0 ? `
                        <button onclick="viewSponsorshipPayments('${sponsorship.user_email}')" 
                            class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-sm rounded transition-colors">
                            <i class="fas fa-money-bill-wave mr-1"></i>
                        </button>
                    ` : '<span class="text-slate-500">No payments</span>'}
                </div>
            </td>
            <td class="px-4 py-4">
                <div class="text-sm text-slate-300">
                    ${new Date(sponsorship.created_at).toLocaleDateString()}
                </div>
            </td>
            <td class="px-4 py-4">
                <div class="flex space-x-2">
                    <button onclick="viewSponsorship(${sponsorship.id})" 
                        class="text-indigo-400 hover:text-indigo-300" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${sponsorship.status === 'pending' ? `
                        <button onclick="quickApprove(${sponsorship.id})" 
                            class="text-green-400 hover:text-green-300" title="Approve">
                            <i class="fas fa-check"></i>
                        </button>
                    ` : ''}
                    <button onclick="quickReject(${sponsorship.id})" 
                        class="text-red-400 hover:text-red-300" title="Reject">
                        <i class="fas fa-times"></i>
                    </button>
                    <button onclick="openStatusModal(${sponsorship.id}, '${sponsorship.status}')" 
                        class="text-yellow-400 hover:text-yellow-300" title="Update Status">
                        <i class="fas fa-edit"></i>
                    </button>
                    ${sponsorship.status === 'approved' ? `
                        ${sponsorship.hasApprovedChildren ? `
                            <button onclick="removeAllAssignments(${sponsorship.id})" 
                                class="text-red-400 hover:text-red-300" title="Remove All Assignments">
                                <i class="fas fa-user-minus"></i>
                            </button>
                        ` : `
                            <button onclick="openAssignModal(${sponsorship.id})" 
                                class="text-purple-400 hover:text-purple-300" title="Assign Children">
                                <i class="fas fa-user-plus"></i>
                            </button>
                        `}
                        <button onclick="editAssignments(${sponsorship.id})" 
                            class="text-blue-400 hover:text-blue-300" title="Edit Assignments">
                            <i class="fas fa-edit"></i>
                        </button>
                    ` : ''}
                </div>
            </td>
        </tr>
    `).join('');
}

function getSponsorshipTypeColor(type) {
    const colors = {
        'Full Sponsorship': 'bg-green-100 text-green-800',
        'Partial Sponsorship': 'bg-blue-100 text-blue-800',
        'One-time Donation': 'bg-purple-100 text-purple-800'
    };
    return colors[type] || 'bg-gray-100 text-gray-800';
}

function getStatusColor(status) {
    const colors = {
        pending: 'bg-yellow-100 text-yellow-800',
        approved: 'bg-green-100 text-green-800',
        rejected: 'bg-red-100 text-red-800',
        active: 'bg-indigo-100 text-indigo-800',
        completed: 'bg-gray-100 text-gray-800'
    };
    return colors[status] || 'bg-gray-100 text-gray-800';
}

function setupPagination(data) {
    const pagination = document.getElementById('pagination');
    if (!data.next && !data.previous) {
        pagination.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    if (data.previous) {
        paginationHTML += `<button onclick="loadSponsorships(${currentPage - 1})" class="px-3 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600">Previous</button>`;
    }
    
    paginationHTML += `<span class="px-4 py-2 text-slate-300">Page ${currentPage}</span>`;
    
    if (data.next) {
        paginationHTML += `<button onclick="loadSponsorships(${currentPage + 1})" class="px-3 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600">Next</button>`;
    }
    
    pagination.innerHTML = paginationHTML;
}

async function viewSponsorship(id) {
    try {
        const response = await fetchAPI(`/api/applications/sponsorships/${id}/`);
        const sponsorship = await response.json();
        
        const modalBody = document.getElementById('sponsorshipModalBody');
        modalBody.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Personal Information -->
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-white border-b border-slate-600 pb-2">Personal Information</h4>
                    <div class="space-y-2">
                        <div><span class="text-slate-400">Name:</span> <span class="text-white">${sponsorship.full_name}</span></div>
                        <div><span class="text-slate-400">Email:</span> <span class="text-white">${sponsorship.email}</span></div>
                        <div><span class="text-slate-400">Phone:</span> <span class="text-white">${sponsorship.phone}</span></div>
                        <div><span class="text-slate-400">Country:</span> <span class="text-white">${sponsorship.country}</span></div>
                        <div><span class="text-slate-400">City:</span> <span class="text-white">${sponsorship.city}</span></div>
                        <div><span class="text-slate-400">Address:</span> <span class="text-white">${sponsorship.address}</span></div>
                        ${sponsorship.occupation ? `<div><span class="text-slate-400">Occupation:</span> <span class="text-white">${sponsorship.occupation}</span></div>` : ''}
                        ${sponsorship.organization ? `<div><span class="text-slate-400">Organization:</span> <span class="text-white">${sponsorship.organization}</span></div>` : ''}
                    </div>
                </div>
                
                <!-- Sponsorship Preferences -->
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-white border-b border-slate-600 pb-2">Sponsorship Preferences</h4>
                    <div class="space-y-2">
                        <div><span class="text-slate-400">Type:</span> <span class="text-white">${sponsorship.sponsorship_type}</span></div>
                        ${sponsorship.child_gender ? `<div><span class="text-slate-400">Child Gender:</span> <span class="text-white">${sponsorship.child_gender}</span></div>` : ''}
                        ${sponsorship.child_age ? `<div><span class="text-slate-400">Child Age:</span> <span class="text-white">${sponsorship.child_age}</span></div>` : ''}
                        ${sponsorship.special_requests ? `<div><span class="text-slate-400">Special Requests:</span> <span class="text-white">${sponsorship.special_requests}</span></div>` : ''}
                    </div>
                </div>
                
                <!-- Communication -->
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-white border-b border-slate-600 pb-2">Communication</h4>
                    <div class="space-y-2">
                        <div><span class="text-slate-400">Update Frequency:</span> <span class="text-white">${sponsorship.update_frequency}</span></div>
                        <div><span class="text-slate-400">Methods:</span> <span class="text-white">${sponsorship.comm_method.join(', ')}</span></div>
                        ${sponsorship.message ? `<div><span class="text-slate-400">Message:</span> <span class="text-white">${sponsorship.message}</span></div>` : ''}
                    </div>
                </div>
                
                <!-- Payment Information -->
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-white border-b border-slate-600 pb-2">Payment Information</h4>
                    <div class="space-y-2">
                        <div><span class="text-slate-400">Method:</span> <span class="text-white">${sponsorship.payment_method}</span></div>
                        ${sponsorship.payment_amount ? `<div><span class="text-slate-400">Amount:</span> <span class="text-white">Rs. ${sponsorship.payment_amount}</span></div>` : ''}
                        <div><span class="text-slate-400">Frequency:</span> <span class="text-white">${sponsorship.payment_frequency}</span></div>
                        <div><span class="text-slate-400">Tax Deductible:</span> <span class="text-white">${sponsorship.tax_deductible ? 'Yes' : 'No'}</span></div>
                    </div>
                </div>
            </div>
            
            <!-- Status and Admin Notes -->
            <div class="mt-6 space-y-4">
                <h4 class="text-lg font-semibold text-white border-b border-slate-600 pb-2">Status & Admin</h4>
                <div class="space-y-2">
                    <div><span class="text-slate-400">Status:</span> 
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(sponsorship.status)}">
                            ${sponsorship.status.charAt(0).toUpperCase() + sponsorship.status.slice(1)}
                        </span>
                    </div>
                    ${sponsorship.rejection_reason ? `<div><span class="text-slate-400">Rejection Reason:</span> <span class="text-white">${sponsorship.rejection_reason}</span></div>` : ''}
                    ${sponsorship.admin_notes ? `<div><span class="text-slate-400">Admin Notes:</span> <span class="text-white">${sponsorship.admin_notes}</span></div>` : ''}
                    <div><span class="text-slate-400">Created:</span> <span class="text-white">${new Date(sponsorship.created_at).toLocaleString()}</span></div>
                    <div><span class="text-slate-400">Updated:</span> <span class="text-white">${new Date(sponsorship.updated_at).toLocaleString()}</span></div>
                </div>
            </div>
        `;
        
        document.getElementById('sponsorshipModal').classList.remove('hidden');
        document.getElementById('sponsorshipModal').classList.add('flex');
    } catch (error) {
        console.error('Error loading sponsorship details:', error);
        alert('Error loading sponsorship details');
    }
}

function closeSponsorshipModal() {
    document.getElementById('sponsorshipModal').classList.add('hidden');
    document.getElementById('sponsorshipModal').classList.remove('flex');
}

function openStatusModal(id, currentStatus) {
    currentSponsorshipId = id;
    document.getElementById('newStatus').value = currentStatus;
    document.getElementById('adminNotes').value = '';
    document.getElementById('rejectionReason').value = '';
    document.getElementById('allowReapply').checked = false;
    
    // Show/hide rejection reason field
    const rejectionField = document.getElementById('rejectionReasonField');
    if (currentStatus === 'rejected') {
        rejectionField.classList.remove('hidden');
        document.getElementById('rejectionReason').required = true;
    } else {
        rejectionField.classList.add('hidden');
        document.getElementById('rejectionReason').required = false;
    }
    
    document.getElementById('statusModal').classList.remove('hidden');
    document.getElementById('statusModal').classList.add('flex');
}

function closeStatusModal() {
    document.getElementById('statusModal').classList.add('hidden');
    document.getElementById('statusModal').classList.remove('flex');
    currentSponsorshipId = null;
}

async function updateSponsorshipStatus() {
    if (!currentSponsorshipId) return;
    
    const newStatus = document.getElementById('newStatus').value;
    const adminNotes = document.getElementById('adminNotes').value;
    const rejectionReason = document.getElementById('rejectionReason').value;
    const allowReapply = document.getElementById('allowReapply').checked;
    
    // Validate rejection reason if status is rejected
    if (newStatus === 'rejected' && !rejectionReason.trim()) {
        alert('Please provide a reason for rejection.');
        return;
    }
    
    try {
        const payload = {
            status: newStatus,
            admin_notes: adminNotes
        };
        
        if (newStatus === 'rejected') {
            payload.rejection_reason = rejectionReason;
            payload.allow_reapply = allowReapply;
        }
        
        const response = await fetchAPI(`/api/applications/sponsorships/${currentSponsorshipId}/update-status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });
        
        if (response.ok) {
            const result = await response.json();
            let message = 'Status updated successfully';
            
            if (newStatus === 'approved') {
                message += ' and sponsor account created with login credentials sent via email';
            } else if (newStatus === 'rejected') {
                message += allowReapply ? ' (sponsor can reapply)' : '';
                message += result.email_sent ? ' and email sent to sponsor' : '';
            } else if (result.email_sent) {
                message += ' and email sent to sponsor';
            }
            
            alert(message);
            closeStatusModal();
            loadSponsorships(currentPage);
            loadStats();
        } else {
            const error = await response.json();
            alert('Error updating status: ' + (error.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error updating status:', error);
        alert('Error updating status');
    }
}

async function quickApprove(id) {
    if (!confirm('Are you sure you want to approve this sponsorship? This will create a sponsor account and send login credentials.')) {
        return;
    }
    
    const button = document.querySelector(`button[onclick="quickApprove(${id})"]`);
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    try {
        const response = await fetchAPI(`/api/applications/sponsorships/${id}/update-status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: 'approved'
            })
        });
        
        if (response.ok) {
            alert('Sponsorship approved successfully and sponsor account created with login credentials sent via email');
            loadSponsorships(currentPage);
            loadStats();
        } else {
            const error = await response.json();
            alert('Error approving sponsorship: ' + (error.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error approving sponsorship:', error);
        alert('Error approving sponsorship');
    } finally {
        button.innerHTML = originalHTML;
        button.disabled = false;
    }
}

async function quickReject(id) {
    const reason = prompt('Please provide a reason for rejection:');
    if (!reason || !reason.trim()) {
        return;
    }
    
    const allowReapply = confirm('Allow sponsor to edit and reapply?');
    
    const button = document.querySelector(`button[onclick="quickReject(${id})"]`);
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    try {
        const response = await fetchAPI(`/api/applications/sponsorships/${id}/update-status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: 'rejected',
                rejection_reason: reason,
                allow_reapply: allowReapply
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            let message = 'Sponsorship rejected successfully';
            message += allowReapply ? ' (sponsor can reapply)' : '';
            message += result.email_sent ? ' and email sent to sponsor' : '';
            alert(message);
            loadSponsorships(currentPage);
            loadStats();
        } else {
            const error = await response.json();
            alert('Error rejecting sponsorship: ' + (error.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error rejecting sponsorship:', error);
        alert('Error rejecting sponsorship');
    } finally {
        button.innerHTML = originalHTML;
        button.disabled = false;
    }
}

function openAssignModal(sponsorshipId) {
    currentSponsorshipId = sponsorshipId;
    selectedChildrenIds = [];
    updateSelectedChildren();
    loadSponsorshipDetails(sponsorshipId);
    
    document.getElementById('assignModal').classList.remove('hidden');
    document.getElementById('assignModal').classList.add('flex');
}

async function loadSponsorshipDetails(sponsorshipId) {
    try {
        const response = await fetchAPI(`/api/applications/sponsorships/${sponsorshipId}/`);
        const sponsorship = await response.json();
        
        loadAvailableChildrenWithMatching(sponsorship);
    } catch (error) {
        console.error('Error loading sponsorship details:', error);
        loadAvailableChildren();
    }
}

async function loadAvailableChildrenWithMatching(sponsorship) {
    try {
        // Only load children that are available (not sponsored)
        const response = await fetchAPI('/api/applications/children/?status=available');
        const allChildren = await response.json();
        
        // Filter out children who already have pending or approved assignments
        const availableChildren = [];
        for (const child of allChildren) {
            // Check if child has any pending/approved assignments
            const hasAssignment = await checkChildAssignment(child.id);
            if (!hasAssignment) {
                availableChildren.push(child);
            }
        }
        
        // Calculate matching scores
        const childrenWithScores = availableChildren.map(child => ({
            ...child,
            matchScore: calculateMatchScore(sponsorship, child)
        }));
        
        // Sort by match score (highest first)
        childrenWithScores.sort((a, b) => b.matchScore - a.matchScore);
        
        displayAvailableChildrenWithScores(childrenWithScores, sponsorship);
        
        document.getElementById('childSearchInput').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const filteredChildren = childrenWithScores.filter(child => 
                child.full_name.toLowerCase().includes(searchTerm) ||
                child.district.toLowerCase().includes(searchTerm) ||
                (child.school_name && child.school_name.toLowerCase().includes(searchTerm))
            );
            displayAvailableChildrenWithScores(filteredChildren, sponsorship);
        });
    } catch (error) {
        console.error('Error loading children:', error);
        document.getElementById('childrenList').innerHTML = `
            <div class="text-center text-red-400 py-8">
                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                <p>Error loading children</p>
            </div>
        `;
    }
}

async function checkChildAssignment(childId) {
    try {
        const response = await fetchAPI(`/api/applications/children/${childId}/`);
        const child = await response.json();
        return child.status === 'sponsored' || child.status === 'pending_assignment';
    } catch (error) {
        return false;
    }
}

function calculateMatchScore(sponsorship, child) {
    let score = 0;
    let totalCriteria = 0;
    
    // Gender preference (15 points)
    if (sponsorship.child_gender) {
        totalCriteria += 15;
        if (child.gender === sponsorship.child_gender) {
            score += 15;
        }
    }
    
    // Age preference (15 points)
    if (sponsorship.child_age) {
        totalCriteria += 15;
        const childAge = child.age;
        const ageRange = sponsorship.child_age;
        
        if (ageRange === '5-8' && childAge >= 5 && childAge <= 8) score += 15;
        else if (ageRange === '9-12' && childAge >= 9 && childAge <= 12) score += 15;
        else if (ageRange === '13-16' && childAge >= 13 && childAge <= 16) score += 15;
    }
    
    // Sponsorship type match (20 points)
    totalCriteria += 20;
    const sponsorType = sponsorship.sponsorship_type.toLowerCase().replace(' ', '_');
    if (child.preferred_sponsorship_type.includes(sponsorType) || 
        child.preferred_sponsorship_type.includes('full') && sponsorType.includes('full') ||
        child.preferred_sponsorship_type.includes('partial') && sponsorType.includes('partial')) {
        score += 20;
    }
    
    // Payment amount compatibility (15 points)
    if (sponsorship.payment_amount && child.monthly_sponsorship_amount) {
        totalCriteria += 15;
        const sponsorAmount = parseFloat(sponsorship.payment_amount);
        const childNeed = parseFloat(child.monthly_sponsorship_amount);
        
        if (sponsorAmount >= childNeed) {
            score += 15;
        } else if (sponsorAmount >= childNeed * 0.7) {
            score += 12;
        } else if (sponsorAmount >= childNeed * 0.5) {
            score += 8;
        }
    }
    
    // Payment frequency match (10 points)
    totalCriteria += 10;
    const sponsorFreq = sponsorship.payment_frequency.toLowerCase();
    if (child.preferred_frequency.includes(sponsorFreq)) {
        score += 10;
    }
    
    // Location preference (10 points)
    if (sponsorship.country && child.country) {
        totalCriteria += 10;
        if (sponsorship.country === child.country) {
            score += 10;
        }
    }
    
    // Text similarity matching (15 points)
    totalCriteria += 15;
    const textScore = calculateTextSimilarity(sponsorship, child);
    score += Math.round(textScore * 15);
    
    return totalCriteria > 0 ? Math.round((score / totalCriteria) * 100) : 0;
}

function calculateTextSimilarity(sponsorship, child) {
    const sponsorTexts = [
        sponsorship.special_requests || '',
        sponsorship.message || ''
    ].join(' ').toLowerCase();
    
    const childTexts = [
        child.story || '',
        child.interests_hobbies || '',
        child.personality_description || '',
        child.dreams_aspirations || '',
        child.educational_needs || '',
        child.health_status || '',
        child.family_situation || ''
    ].join(' ').toLowerCase();
    
    if (!sponsorTexts.trim() || !childTexts.trim()) return 0;
    
    // Extract keywords from sponsor text
    const sponsorKeywords = extractKeywords(sponsorTexts);
    const childKeywords = extractKeywords(childTexts);
    
    if (sponsorKeywords.length === 0 || childKeywords.length === 0) return 0;
    
    // Calculate keyword overlap
    const commonKeywords = sponsorKeywords.filter(word => 
        childKeywords.some(childWord => 
            childWord.includes(word) || word.includes(childWord) || 
            calculateLevenshteinSimilarity(word, childWord) > 0.7
        )
    );
    
    return commonKeywords.length / Math.max(sponsorKeywords.length, childKeywords.length);
}

function extractKeywords(text) {
    const stopWords = ['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'is', 'are', 'was', 'were', 'be', 'been', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'can', 'i', 'you', 'he', 'she', 'it', 'we', 'they', 'this', 'that', 'these', 'those'];
    
    return text
        .replace(/[^a-zA-Z\s]/g, '')
        .split(/\s+/)
        .filter(word => word.length > 2 && !stopWords.includes(word))
        .slice(0, 20); // Limit to top 20 keywords
}

function calculateLevenshteinSimilarity(str1, str2) {
    const matrix = [];
    const len1 = str1.length;
    const len2 = str2.length;
    
    if (len1 === 0) return len2 === 0 ? 1 : 0;
    if (len2 === 0) return 0;
    
    for (let i = 0; i <= len2; i++) {
        matrix[i] = [i];
    }
    
    for (let j = 0; j <= len1; j++) {
        matrix[0][j] = j;
    }
    
    for (let i = 1; i <= len2; i++) {
        for (let j = 1; j <= len1; j++) {
            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1,
                    matrix[i][j - 1] + 1,
                    matrix[i - 1][j] + 1
                );
            }
        }
    }
    
    const maxLen = Math.max(len1, len2);
    return (maxLen - matrix[len2][len1]) / maxLen;
}

function closeAssignModal() {
    document.getElementById('assignModal').classList.add('hidden');
    document.getElementById('assignModal').classList.remove('flex');
    currentSponsorshipId = null;
    selectedChildrenIds = [];
}

async function loadAvailableChildren() {
    try {
        const response = await fetchAPI('/api/applications/children/?status=available');
        const children = await response.json();
        
        displayAvailableChildren(children);
        
        document.getElementById('childSearchInput').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const filteredChildren = children.filter(child => 
                child.full_name.toLowerCase().includes(searchTerm) ||
                child.district.toLowerCase().includes(searchTerm) ||
                (child.school_name && child.school_name.toLowerCase().includes(searchTerm))
            );
            displayAvailableChildren(filteredChildren);
        });
    } catch (error) {
        console.error('Error loading children:', error);
        document.getElementById('childrenList').innerHTML = `
            <div class="text-center text-red-400 py-8">
                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                <p>Error loading children</p>
            </div>
        `;
    }
}

function displayAvailableChildrenWithScores(children, sponsorship) {
    const childrenList = document.getElementById('childrenList');
    
    if (children.length === 0) {
        childrenList.innerHTML = `
            <div class="text-center text-slate-400 py-8">
                <i class="fas fa-child text-4xl mb-4 opacity-50"></i>
                <p>No available children found</p>
            </div>
        `;
        return;
    }
    
    childrenList.innerHTML = children.map(child => {
        const matchColor = child.matchScore >= 80 ? 'text-green-400' : 
                          child.matchScore >= 60 ? 'text-yellow-400' : 
                          child.matchScore >= 40 ? 'text-orange-400' : 'text-red-400';
        
        const matchBg = child.matchScore >= 80 ? 'bg-green-500/20' : 
                       child.matchScore >= 60 ? 'bg-yellow-500/20' : 
                       child.matchScore >= 40 ? 'bg-orange-500/20' : 'bg-red-500/20';
        
        return `
        <div class="flex items-center p-3 bg-slate-700 rounded-lg hover:bg-slate-600 transition-colors border-l-4 ${child.matchScore >= 80 ? 'border-green-400' : child.matchScore >= 60 ? 'border-yellow-400' : child.matchScore >= 40 ? 'border-orange-400' : 'border-red-400'}">
            <input type="checkbox" id="child_${child.id}" onchange="toggleChildSelection(${child.id})" 
                class="mr-3 rounded bg-slate-600 border-slate-500 text-indigo-600 focus:ring-indigo-500">
            <div class="flex-1">
                <div class="flex items-center justify-between">
                    <div class="flex items-center flex-1">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-semibold mr-3 overflow-hidden">
                            ${child.photo ? 
                                `<img src="${child.photo}" alt="${child.full_name}" class="w-full h-full object-cover">` :
                                `<div class="w-full h-full bg-indigo-500 flex items-center justify-center">${child.full_name.charAt(0).toUpperCase()}</div>`
                            }
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <div class="font-medium text-white">${child.full_name}</div>
                                <div class="px-2 py-1 rounded-full text-xs font-bold ${matchBg} ${matchColor}">
                                    ${child.matchScore}% Match
                                </div>
                            </div>
                            <div class="text-sm text-slate-400">${child.age} years, ${child.gender}</div>
                            <div class="text-sm text-slate-400">${child.district}, ${child.village}</div>
                            ${child.school_name ? `<div class="text-sm text-slate-400">${child.school_name} - Grade ${child.grade_level}</div>` : ''}
                            <div class="text-xs text-slate-500 mt-1">
                                ${getMatchDetails(sponsorship, child)}
                            </div>
                        </div>
                    </div>
                    <div class="text-right ml-4">
                        <div class="text-sm font-medium text-white">Rs. ${child.monthly_sponsorship_amount}/month</div>
                        <div class="text-xs text-slate-400">${child.preferred_sponsorship_type.join(', ')}</div>
                        <div class="text-xs text-slate-400">${child.preferred_frequency.join(', ')}</div>
                    </div>
                </div>
            </div>
        </div>
    `}).join('');
}

function getMatchDetails(sponsorship, child) {
    const details = [];
    
    // Gender match
    if (sponsorship.child_gender) {
        if (child.gender === sponsorship.child_gender) {
            details.push(' Gender match');
        } else {
            details.push(' Gender mismatch');
        }
    }
    
    // Age match
    if (sponsorship.child_age) {
        const childAge = child.age;
        const ageRange = sponsorship.child_age;
        let ageMatch = false;
        
        if (ageRange === '5-8' && childAge >= 5 && childAge <= 8) ageMatch = true;
        else if (ageRange === '9-12' && childAge >= 9 && childAge <= 12) ageMatch = true;
        else if (ageRange === '13-16' && childAge >= 13 && childAge <= 16) ageMatch = true;
        
        if (ageMatch) {
            details.push(' Age match');
        } else {
            details.push(' Age outside preference');
        }
    }
    
    // Amount compatibility
    if (sponsorship.payment_amount && child.monthly_sponsorship_amount) {
        const sponsorAmount = parseFloat(sponsorship.payment_amount);
        const childNeed = parseFloat(child.monthly_sponsorship_amount);
        
        if (sponsorAmount >= childNeed) {
            details.push(' Amount sufficient');
        } else {
            details.push(` Need Rs.${childNeed}, offering Rs.${sponsorAmount}`);
        }
    }
    
    // Type match
    const sponsorType = sponsorship.sponsorship_type.toLowerCase().replace(' ', '_');
    if (child.preferred_sponsorship_type.includes(sponsorType) || 
        child.preferred_sponsorship_type.includes('full') && sponsorType.includes('full')) {
        details.push(' Type match');
    } else {
        details.push(' Type mismatch');
    }
    
    // Text similarity
    const textSimilarity = calculateTextSimilarity(sponsorship, child);
    if (textSimilarity > 0.3) {
        details.push(` ${Math.round(textSimilarity * 100)}% text match`);
    } else if (textSimilarity > 0) {
        details.push(` ${Math.round(textSimilarity * 100)}% text match`);
    } else {
        details.push(' No text match');
    }
    
    return details.slice(0, 4).join('  ');
}

function toggleChildSelection(childId) {
    const checkbox = document.getElementById(`child_${childId}`);
    
    if (checkbox.checked) {
        if (!selectedChildrenIds.includes(childId)) {
            selectedChildrenIds.push(childId);
        }
    } else {
        selectedChildrenIds = selectedChildrenIds.filter(id => id !== childId);
    }
    
    updateSelectedChildren();
}

function updateSelectedChildren() {
    const selectedContainer = document.getElementById('selectedChildren');
    const countSpan = document.getElementById('selectedCount');
    
    countSpan.textContent = selectedChildrenIds.length;
    
    if (selectedChildrenIds.length === 0) {
        selectedContainer.innerHTML = '<p class="text-slate-400 text-sm">No children selected</p>';
        return;
    }
    
    const selectedChildren = selectedChildrenIds.map(id => {
        const checkbox = document.getElementById(`child_${id}`);
        const childDiv = checkbox.closest('.flex');
        const name = childDiv.querySelector('.font-medium').textContent;
        return { id, name };
    });
    
    selectedContainer.innerHTML = selectedChildren.map(child => `
        <div class="flex items-center justify-between p-2 bg-slate-600 rounded">
            <span class="text-white text-sm">${child.name}</span>
            <button onclick="removeChildSelection(${child.id})" class="text-red-400 hover:text-red-300">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

function removeChildSelection(childId) {
    const checkbox = document.getElementById(`child_${childId}`);
    if (checkbox) {
        checkbox.checked = false;
    }
    selectedChildrenIds = selectedChildrenIds.filter(id => id !== childId);
    updateSelectedChildren();
}

async function assignSelectedChildren() {
    if (selectedChildrenIds.length === 0) {
        alert('Please select at least one child to assign.');
        return;
    }
    
    const assignBtn = document.getElementById('assignBtn');
    const originalHTML = assignBtn.innerHTML;
    assignBtn.disabled = true;
    assignBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Assigning...';
    
    try {
        const response = await fetchAPI(`/api/applications/sponsorships/${currentSponsorshipId}/assign-children/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                child_ids: selectedChildrenIds
            })
        });
        
        if (response.ok) {
            alert(`Successfully assigned ${selectedChildrenIds.length} children to sponsor!`);
            closeAssignModal();
            loadSponsorships(currentPage);
        } else {
            const error = await response.json();
            alert('Error assigning children: ' + (error.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error assigning children:', error);
        alert('Error assigning children');
    } finally {
        assignBtn.disabled = false;
        assignBtn.innerHTML = originalHTML;
    }
}

async function editAssignments(sponsorshipId) {
    try {
        // Get current assignments for this sponsorship
        const response = await fetchAPI(`/api/applications/sponsorships/${sponsorshipId}/assignments/`);
        if (response.ok) {
            const assignments = await response.json();
            showEditAssignmentsModal(sponsorshipId, assignments);
        } else {
            alert('Error loading assignments');
        }
    } catch (error) {
        console.error('Error loading assignments:', error);
        alert('Error loading assignments');
    }
}

function showEditAssignmentsModal(sponsorshipId, assignments) {
    // Get sponsorship details for matching calculation
    fetchAPI(`/api/applications/sponsorships/${sponsorshipId}/`)
        .then(response => response.json())
        .then(sponsorship => {
            // Calculate match scores for assignments
            const assignmentsWithScores = assignments.map(assignment => ({
                ...assignment,
                matchScore: calculateMatchScore(sponsorship, assignment.child)
            }));
            
            displayEditAssignmentsModal(sponsorshipId, assignmentsWithScores);
        })
        .catch(error => {
            console.error('Error loading sponsorship details:', error);
            displayEditAssignmentsModal(sponsorshipId, assignments);
        });
}

function displayEditAssignmentsModal(sponsorshipId, assignments) {
    const modalHTML = `
        <div id="editAssignmentsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-slate-800 rounded-lg max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                <div class="p-6 border-b border-slate-700">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-white">Edit Assignments</h3>
                        <button onclick="closeEditAssignmentsModal()" class="text-slate-400 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        ${assignments.length === 0 ? 
                            '<p class="text-slate-400 text-center py-8">No assignments found</p>' :
                            assignments.map(assignment => {
                                const matchColor = assignment.matchScore >= 80 ? 'text-green-400' : 
                                                  assignment.matchScore >= 60 ? 'text-yellow-400' : 
                                                  assignment.matchScore >= 40 ? 'text-orange-400' : 'text-red-400';
                                
                                const matchBg = assignment.matchScore >= 80 ? 'bg-green-500/20' : 
                                               assignment.matchScore >= 60 ? 'bg-yellow-500/20' : 
                                               assignment.matchScore >= 40 ? 'bg-orange-500/20' : 'bg-red-500/20';
                                
                                const borderColor = assignment.matchScore >= 80 ? 'border-green-400' : 
                                                   assignment.matchScore >= 60 ? 'border-yellow-400' : 
                                                   assignment.matchScore >= 40 ? 'border-orange-400' : 'border-red-400';
                                
                                return `
                                <div class="flex items-center justify-between p-4 bg-slate-700 rounded-lg border-l-4 ${borderColor}">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-12 rounded-full overflow-hidden">
                                            ${assignment.child.photo ? 
                                                `<img src="${assignment.child.photo}" alt="${assignment.child.full_name}" class="w-full h-full object-cover">` :
                                                `<div class="w-full h-full bg-indigo-500 flex items-center justify-center text-white font-bold">${assignment.child.full_name.charAt(0).toUpperCase()}</div>`
                                            }
                                        </div>
                                        <div>
                                            <div class="flex items-center gap-2 mb-1">
                                                <p class="font-medium text-white">${assignment.child.full_name}</p>
                                                ${assignment.matchScore !== undefined ? `
                                                    <div class="px-2 py-1 rounded-full text-xs font-bold ${matchBg} ${matchColor}">
                                                        ${assignment.matchScore}% Match
                                                    </div>
                                                ` : ''}
                                            </div>
                                            <p class="text-sm text-slate-400">${assignment.child.age} years, ${assignment.child.district}</p>
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                                assignment.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                                assignment.status === 'approved' ? 'bg-green-100 text-green-800' :
                                                'bg-red-100 text-red-800'
                                            }">
                                                ${assignment.status.charAt(0).toUpperCase() + assignment.status.slice(1)}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        ${assignment.status === 'pending' ? `
                                            <button onclick="removeAssignment(${assignment.id})" 
                                                class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition-colors">
                                                Remove
                                            </button>
                                        ` : assignment.status === 'approved' ? `
                                            <button onclick="removeAssignment(${assignment.id})" 
                                                class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition-colors">
                                                Unassign
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `}).join('')
                        }
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="closeEditAssignmentsModal()" 
                            class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg transition-colors">
                            Close
                        </button>
                        <button onclick="openAssignModal(${sponsorshipId}); closeEditAssignmentsModal();" 
                            class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>Add More Children
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeEditAssignmentsModal() {
    const modal = document.getElementById('editAssignmentsModal');
    if (modal) {
        modal.remove();
    }
}

async function removeAssignment(assignmentId) {
    if (!confirm('Are you sure you want to remove this assignment?')) {
        return;
    }
    
    try {
        const response = await fetchAPI(`/api/applications/assignments/${assignmentId}/remove/`, {
            method: 'POST'
        });
        
        if (response.ok) {
            alert('Assignment removed successfully');
            closeEditAssignmentsModal();
            loadSponsorships(currentPage);
        } else {
            const error = await response.json();
            alert('Error removing assignment: ' + (error.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error removing assignment:', error);
        alert('Error removing assignment');
    }
}

async function removeAllAssignments(sponsorshipId) {
    if (!confirm('Are you sure you want to remove ALL assignments for this sponsorship? This will make all children available again.')) {
        return;
    }
    
    try {
        // Get all assignments for this sponsorship
        const response = await fetchAPI(`/api/applications/sponsorships/${sponsorshipId}/assignments/`);
        if (response.ok) {
            const assignments = await response.json();
            
            // Remove each assignment
            const removePromises = assignments.map(assignment => 
                fetchAPI(`/api/applications/assignments/${assignment.id}/remove/`, {
                    method: 'POST'
                })
            );
            
            await Promise.all(removePromises);
            
            alert('All assignments removed successfully');
            loadSponsorships(currentPage);
        } else {
            alert('Error loading assignments');
        }
    } catch (error) {
        console.error('Error removing all assignments:', error);
        alert('Error removing all assignments');
    }
}

function viewSponsorshipPayments(sponsorEmail) {
    // Open the admin sponsorship payments page with sponsor filter
    window.open(`/admin/sponsorship-payments/?sponsor=${encodeURIComponent(sponsorEmail)}`, '_blank');
}
</script>
{% endblock %}