{% extends 'admin/base.html' %}
{% load static %}

{% block page_title %}Task Details{% endblock %}

{% block content %}
{% csrf_token %}
<div class="mb-6">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
            <a href="{% url 'admin_tasks' %}" class="text-slate-400 hover:text-white">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h2 class="text-2xl font-bold text-white">Task Details</h2>
        </div>
    </div>
</div>

<div id="taskDetailContent">
    <div class="text-center py-8">
        <i class="fas fa-spinner fa-spin fa-2x text-slate-400 mb-3"></i>
        <p class="text-slate-400">Loading task details...</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const taskId = new URLSearchParams(window.location.search).get('id');
        if (taskId) {
            loadTaskDetail(taskId);
        }
    });
    
    async function loadTaskDetail(taskId) {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/api/tasks/admin/${taskId}/detail/`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) throw new Error('Failed to fetch task details');
            
            const task = await response.json();
            displayTaskDetail(task);
        } catch (error) {
            console.error('Error loading task details:', error);
            document.getElementById('taskDetailContent').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle fa-2x text-red-400 mb-2"></i>
                    <p class="text-red-400">Error loading task details.</p>
                </div>
            `;
        }
    }
    
    function displayTaskDetail(task) {
        const deadline = new Date(task.deadline).toLocaleString();
        const isOverdue = task.is_overdue;
        
        const assignedUsers = task.assigned_users.map(user => {
            const statusColor = {
                'sent': 'text-green-400',
                'failed': 'text-red-400',
                'pending': 'text-yellow-400',
                'no_email': 'text-slate-400'
            }[user.email_status] || 'text-slate-400';
            
            const submissionStatus = user.submission_status === 'submitted' ? 
                '<span class="text-green-400">‚úì Submitted</span>' : 
                (user.is_overdue ? '<span class="text-red-400">‚ö† Overdue</span>' : '<span class="text-yellow-400">‚è≥ Not Submitted</span>');
            
            const actionButton = (user.submission_status === 'submitted' || user.submission_status === 'approved' || user.submission_status === 'redo_requested') ? 
                `<button onclick="viewSubmission(${user.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs">
                    <i class="fas fa-eye mr-1"></i>View
                </button>` : 
                '<span class="text-slate-500 text-xs">No submission</span>';
            
            return `
                <tr class="border-b border-slate-600">
                    <td class="py-3 px-4 text-sm text-white">${user.name}</td>
                    <td class="py-3 px-4 text-sm text-slate-300">${user.email}</td>
                    <td class="py-3 px-4 text-sm ${statusColor}">${user.email_status.replace('_', ' ').toUpperCase()}</td>
                    <td class="py-3 px-4 text-sm">${submissionStatus}</td>
                    <td class="py-3 px-4 text-sm">${actionButton}</td>
                </tr>
            `;
        }).join('');
        
        document.getElementById('taskDetailContent').innerHTML = `
            <div class="space-y-6">
                <div class="bg-slate-800 p-6 rounded-lg">
                    <h3 class="text-xl font-bold text-white mb-4">${task.title}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div><p class="text-slate-300"><strong>Status:</strong> <span class="text-white">${task.status.replace('_', ' ').toUpperCase()}</span></p></div>
                        <div><p class="text-slate-300"><strong>Deadline:</strong> <span class="${isOverdue ? 'text-red-400' : 'text-white'}">${deadline} ${isOverdue ? '(OVERDUE)' : ''}</span></p></div>
                        <div><p class="text-slate-300"><strong>Created:</strong> ${new Date(task.created_at).toLocaleString()}</p></div>
                        <div><p class="text-slate-300"><strong>Assigned:</strong> ${task.assigned_users.length} users</p></div>
                    </div>
                    <div class="mt-4">
                        <p class="text-slate-300"><strong>Description:</strong> ${task.description}</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    ${task.materials.length > 0 ? `
                        <div class="bg-slate-800 p-6 rounded-lg">
                            <h4 class="text-lg font-semibold text-white mb-3">Materials</h4>
                            <div class="space-y-2">
                                ${task.materials.map(m => `<a href="${m.url}" target="_blank" class="block text-blue-400 hover:underline"><i class="fas fa-file mr-2"></i>${m.filename}</a>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${task.task_links ? `
                        <div class="bg-slate-800 p-6 rounded-lg">
                            <h4 class="text-lg font-semibold text-white mb-3">Helpful Links</h4>
                            <div class="text-slate-300 whitespace-pre-line text-sm">${task.task_links}</div>
                        </div>
                    ` : ''}
                    
                    <div class="bg-slate-800 p-6 rounded-lg">
                        <h4 class="text-lg font-semibold text-white mb-3">Email Statistics</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-400">${task.email_stats.sent}</div>
                                <div class="text-slate-400 text-xs">Sent</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-red-400">${task.email_stats.failed}</div>
                                <div class="text-slate-400 text-xs">Failed</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-yellow-400">${task.email_stats.pending}</div>
                                <div class="text-slate-400 text-xs">Pending</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-white">${task.email_stats.total}</div>
                                <div class="text-slate-400 text-xs">Total</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${task.admin_feedback ? `
                    <div class="bg-slate-800 p-6 rounded-lg">
                        <h4 class="text-lg font-semibold text-white mb-3">Admin Feedback</h4>
                        <p class="text-slate-300">${task.admin_feedback}</p>
                    </div>
                ` : ''}
                
                <div class="bg-slate-800 p-6 rounded-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-white">Assigned Users (${task.assigned_users.length})</h4>
                        <div class="flex gap-2">
                            <input type="text" id="userSearchInput" placeholder="Search users..." class="px-3 py-1 bg-slate-700 text-white rounded text-sm" oninput="filterUsers()">
                            <select id="statusFilter" class="px-3 py-1 bg-slate-700 text-white rounded text-sm" onchange="filterUsers()">
                                <option value="">All Status</option>
                                <option value="submitted">Submitted</option>
                                <option value="not_submitted">Not Submitted</option>
                                <option value="overdue">Overdue</option>
                            </select>
                            <select id="emailFilter" class="px-3 py-1 bg-slate-700 text-white rounded text-sm" onchange="filterUsers()">
                                <option value="">All Emails</option>
                                <option value="sent">Sent</option>
                                <option value="failed">Failed</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full" id="usersTable">
                            <thead class="bg-slate-700">
                                <tr>
                                    <th class="py-3 px-4 text-left text-slate-300 text-sm cursor-pointer" onclick="sortTable(0)">Name <i class="fas fa-sort ml-1"></i></th>
                                    <th class="py-3 px-4 text-left text-slate-300 text-sm cursor-pointer" onclick="sortTable(1)">Email <i class="fas fa-sort ml-1"></i></th>
                                    <th class="py-3 px-4 text-left text-slate-300 text-sm cursor-pointer" onclick="sortTable(2)">Email Status <i class="fas fa-sort ml-1"></i></th>
                                    <th class="py-3 px-4 text-left text-slate-300 text-sm cursor-pointer" onclick="sortTable(3)">Submission <i class="fas fa-sort ml-1"></i></th>
                                    <th class="py-3 px-4 text-left text-slate-300 text-sm">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                ${assignedUsers}
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <div class="text-sm text-slate-400" id="tableInfo">Showing 1-${task.assigned_users.length} of ${task.assigned_users.length}</div>
                        <div class="flex gap-2" id="pagination">
                            <!-- Pagination will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Store original data and initialize table
        originalUsers = task.assigned_users;
        updateTable();
        updatePagination();
    }
    
    let originalUsers = [];
    let filteredUsers = null;
    let currentPage = 1;
    let itemsPerPage = 10;
    let sortColumn = -1;
    let sortDirection = 'asc';
    
    function filterUsers() {
        const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const emailFilter = document.getElementById('emailFilter').value;
        
        filteredUsers = originalUsers.filter(user => {
            const matchesSearch = user.name.toLowerCase().includes(searchTerm) || 
                                user.email.toLowerCase().includes(searchTerm);
            
            const matchesStatus = !statusFilter || 
                                (statusFilter === 'submitted' && user.submission_status === 'submitted') ||
                                (statusFilter === 'not_submitted' && user.submission_status !== 'submitted') ||
                                (statusFilter === 'overdue' && user.is_overdue);
            
            const matchesEmail = !emailFilter || user.email_status === emailFilter;
            
            return matchesSearch && matchesStatus && matchesEmail;
        });
        
        currentPage = 1;
        updateTable();
        updatePagination();
    }
    
    function sortTable(column) {
        if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = column;
            sortDirection = 'asc';
        }
        
        const users = filteredUsers || originalUsers;
        const sortedUsers = [...users].sort((a, b) => {
            let aVal, bVal;
            
            switch(column) {
                case 0: aVal = a.name; bVal = b.name; break;
                case 1: aVal = a.email; bVal = b.email; break;
                case 2: aVal = a.email_status; bVal = b.email_status; break;
                case 3: aVal = a.submission_status; bVal = b.submission_status; break;
            }
            
            if (sortDirection === 'asc') {
                return aVal.localeCompare(bVal);
            } else {
                return bVal.localeCompare(aVal);
            }
        });
        
        filteredUsers = sortedUsers;
        updateTable();
    }
    
    function updateTable() {
        const users = filteredUsers || originalUsers;
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageUsers = users.slice(start, end);
        
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = pageUsers.map(user => {
            const statusColor = {
                'sent': 'text-green-400',
                'failed': 'text-red-400',
                'pending': 'text-yellow-400',
                'no_email': 'text-slate-400'
            }[user.email_status] || 'text-slate-400';
            
            const submissionStatus = user.submission_status === 'submitted' ? 
                '<span class="text-green-400">‚úì Submitted</span>' : 
                user.submission_status === 'redo_requested' ? 
                '<span class="text-orange-400">üîÑ Redo Requested</span>' :
                user.submission_status === 'approved' ? 
                '<span class="text-green-500">‚úÖ Approved</span>' :
                (user.is_overdue ? '<span class="text-red-400">‚ö† Overdue</span>' : '<span class="text-yellow-400">‚è≥ Not Submitted</span>');
            
            const actionButton = (user.submission_status === 'submitted' || user.submission_status === 'approved' || user.submission_status === 'redo_requested') ? 
                `<button onclick="viewSubmission(${user.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs">
                    <i class="fas fa-eye mr-1"></i>View
                </button>` : 
                '<span class="text-slate-500 text-xs">No submission</span>';
            
            return `
                <tr class="border-b border-slate-600">
                    <td class="py-3 px-4 text-sm text-white">${user.name}</td>
                    <td class="py-3 px-4 text-sm text-slate-300">${user.email}</td>
                    <td class="py-3 px-4 text-sm ${statusColor}">${user.email_status.replace('_', ' ').toUpperCase()}</td>
                    <td class="py-3 px-4 text-sm">${submissionStatus}</td>
                    <td class="py-3 px-4 text-sm">${actionButton}</td>
                </tr>
            `;
        }).join('');
        
        document.getElementById('tableInfo').textContent = 
            `Showing ${start + 1}-${Math.min(end, users.length)} of ${users.length}`;
    }
    
    function updatePagination() {
        const users = filteredUsers || originalUsers;
        const totalPages = Math.ceil(users.length / itemsPerPage);
        const pagination = document.getElementById('pagination');
        
        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }
        
        let paginationHTML = '';
        
        if (currentPage > 1) {
            paginationHTML += `<button onclick="changePage(${currentPage - 1})" class="px-3 py-1 bg-slate-700 text-white rounded text-sm hover:bg-slate-600">Previous</button>`;
        }
        
        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage) {
                paginationHTML += `<button class="px-3 py-1 bg-blue-600 text-white rounded text-sm">${i}</button>`;
            } else {
                paginationHTML += `<button onclick="changePage(${i})" class="px-3 py-1 bg-slate-700 text-white rounded text-sm hover:bg-slate-600">${i}</button>`;
            }
        }
        
        if (currentPage < totalPages) {
            paginationHTML += `<button onclick="changePage(${currentPage + 1})" class="px-3 py-1 bg-slate-700 text-white rounded text-sm hover:bg-slate-600">Next</button>`;
        }
        
        pagination.innerHTML = paginationHTML;
    }
    
    function changePage(page) {
        currentPage = page;
        updateTable();
        updatePagination();
    }
    
    function viewSubmission(userId) {
        // Find user submission data
        const user = originalUsers.find(u => u.id === userId);
        if (!user || (user.submission_status !== 'submitted' && user.submission_status !== 'approved' && user.submission_status !== 'redo_requested')) return;
        
        // Create submission modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-slate-800 p-6 rounded-lg max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">Submission by ${user.name}</h3>
                    <button onclick="closeSubmissionModal()" class="text-slate-400 hover:text-white">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <h4 class="text-lg font-semibold text-white mb-2">Submission Content</h4>
                        <div class="bg-slate-700 p-4 rounded text-slate-300" id="submissionContent">
                            Loading submission...
                        </div>
                    </div>
                    ${user.submission_status === 'submitted' ? `
                        <div class="flex gap-3">
                            <button onclick="reviewSubmission('approve')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                                <i class="fas fa-check mr-2"></i>Approve
                            </button>
                            <button onclick="reviewSubmission('redo')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                                <i class="fas fa-redo mr-2"></i>Request Redo
                            </button>
                        </div>
                        <div>
                            <label class="block text-slate-300 text-sm font-medium mb-2">Rating (1-10)</label>
                            <select id="submissionRating" class="w-full p-2 bg-slate-700 text-white rounded">
                                <option value="">Select rating...</option>
                                <option value="1">1 - Poor</option>
                                <option value="2">2 - Below Average</option>
                                <option value="3">3 - Fair</option>
                                <option value="4">4 - Below Good</option>
                                <option value="5">5 - Average</option>
                                <option value="6">6 - Above Average</option>
                                <option value="7">7 - Good</option>
                                <option value="8">8 - Very Good</option>
                                <option value="9">9 - Excellent</option>
                                <option value="10">10 - Outstanding</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-slate-300 text-sm font-medium mb-2">Admin Comment</label>
                            <textarea id="adminComment" class="w-full p-2 bg-slate-700 text-white rounded" rows="3" placeholder="Add your feedback..."></textarea>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        window.currentSubmissionModal = modal;
        window.currentSubmissionUserId = userId;
        
        // Load submission details
        loadSubmissionDetails(userId);
    }
    
    async function loadSubmissionDetails(userId) {
        const taskId = new URLSearchParams(window.location.search).get('id');
        
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/api/tasks/admin/${taskId}/submission/${userId}/`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const submission = await response.json();
                
                document.getElementById('submissionContent').innerHTML = `
                    <div class="space-y-3">
                        <div>
                            <strong class="text-white">Status:</strong> 
                            <span class="text-slate-300">${submission.status.replace('_', ' ').toUpperCase()}</span>
                        </div>
                        <div>
                            <strong class="text-white">Submitted:</strong> 
                            <span class="text-slate-300">${new Date(submission.submitted_at).toLocaleString()}</span>
                        </div>
                        ${submission.submission_text ? `
                            <div>
                                <strong class="text-white">Content:</strong>
                                <div class="bg-slate-600 p-3 rounded mt-2 text-slate-200">${submission.submission_text}</div>
                            </div>
                        ` : ''}
                        ${submission.submission_file ? `
                            <div>
                                <strong class="text-white">File:</strong>
                                <a href="${submission.submission_file}" target="_blank" class="text-blue-400 hover:underline ml-2">
                                    <i class="fas fa-file mr-1"></i>View Submitted File
                                </a>
                            </div>
                        ` : ''}
                        ${submission.admin_feedback ? `
                            <div>
                                <strong class="text-white">Admin Feedback:</strong>
                                <div class="bg-slate-600 p-3 rounded mt-2 text-slate-200">${submission.admin_feedback}</div>
                            </div>
                        ` : ''}
                        ${submission.rating ? `
                            <div>
                                <strong class="text-white">Rating:</strong>
                                <span class="text-yellow-400 ml-2">${submission.rating}/10 ${'‚òÖ'.repeat(Math.floor(submission.rating/2))}${'‚òÜ'.repeat(5-Math.floor(submission.rating/2))}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                document.getElementById('submissionContent').innerHTML = '<p class="text-slate-400">Error loading submission details.</p>';
            }
        } catch (error) {
            console.error('Error loading submission details:', error);
            document.getElementById('submissionContent').innerHTML = '<p class="text-slate-400">Error loading submission details.</p>';
        }
    }
    
    function closeSubmissionModal() {
        if (window.currentSubmissionModal) {
            document.body.removeChild(window.currentSubmissionModal);
            window.currentSubmissionModal = null;
            window.currentSubmissionUserId = null;
        }
    }
    
    async function reviewSubmission(action) {
        const commentField = document.getElementById('adminComment');
        const ratingField = document.getElementById('submissionRating');
        const comment = commentField ? commentField.value : '';
        const rating = ratingField ? ratingField.value : '';
        const userId = window.currentSubmissionUserId;
        const taskId = new URLSearchParams(window.location.search).get('id');
        
        if (!userId || !taskId) return;
        
        // Show loading state
        const approveBtn = document.querySelector('button[onclick="reviewSubmission(\'approve\')"]');
        const redoBtn = document.querySelector('button[onclick="reviewSubmission(\'redo\')"]');
        
        if (!approveBtn || !redoBtn) return; // Buttons don't exist for already reviewed submissions
        
        const originalApproveText = approveBtn.innerHTML;
        const originalRedoText = redoBtn.innerHTML;
        
        if (action === 'approve') {
            approveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
            approveBtn.disabled = true;
        } else {
            redoBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
            redoBtn.disabled = true;
        }
        
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/api/tasks/admin/${taskId}/review/${userId}/`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    action: action,
                    feedback: comment,
                    rating: rating
                })
            });
            
            if (!response.ok) throw new Error('Failed to review submission');
            
            alert(`Submission ${action === 'approve' ? 'approved' : 'sent for revision'} successfully!`);
            closeSubmissionModal();
            loadTaskDetail(taskId);
        } catch (error) {
            console.error('Error reviewing submission:', error);
            alert('Error processing review.');
        } finally {
            // Reset button states
            if (approveBtn && redoBtn) {
                approveBtn.innerHTML = originalApproveText;
                approveBtn.disabled = false;
                redoBtn.innerHTML = originalRedoText;
                redoBtn.disabled = false;
            }
        }
    }
</script>
{% endblock %}