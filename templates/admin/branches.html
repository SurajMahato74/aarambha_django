{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Branches{% endblock %}
{% block page_title %}Branches Management{% endblock %}

{% block content %}
<!-- Add Branch Modal -->
<div id="addBranchModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-white">Add New Branch</h3>
            <button onclick="closeModal()" class="text-slate-400 hover:text-white text-2xl">&times;</button>
        </div>
        <form id="addBranchForm" class="space-y-4">
            <div>
                <label class="block text-sm text-slate-300 mb-1">Branch Code *</label>
                <input type="text" name="code" required placeholder="e.g., KTM, PKR"
                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white uppercase">
            </div>
            <div>
                <label class="block text-sm text-slate-300 mb-1">Branch Name *</label>
                <input type="text" name="name" required placeholder="e.g., Kathmandu Branch"
                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white">
            </div>
            <div>
                <label class="block text-sm text-slate-300 mb-1">Location *</label>
                <input type="text" name="location" required placeholder="e.g., Kathmandu, Nepal"
                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white">
            </div>
            <div>
                <label class="block text-sm text-slate-300 mb-1">Branch Admin (Optional)</label>
                <select name="admin" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white">
                    <option value="">Select Admin</option>
                </select>
            </div>
            <div id="formMessage" class="text-sm"></div>
            <div class="flex gap-2">
                <button type="submit"
                    class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Create Branch</button>
                <button type="button" onclick="closeModal()"
                    class="px-4 py-2 bg-slate-600 text-white rounded hover:bg-slate-700">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div class="grid grid-cols-3 gap-4 mb-8">
    <div class="card p-5 rounded-lg bg-transparent">
        <p class="text-slate-400 text-xs">Total Branches</p>
        <p class="text-2xl font-bold text-white mt-1" id="totalBranches">0</p>
    </div>
    <div class="card p-5 rounded-lg bg-transparent">
        <p class="text-slate-400 text-xs">Active Branches</p>
        <p class="text-2xl font-bold text-white mt-1" id="activeBranches">0</p>
    </div>
    <div class="card p-5 rounded-lg bg-transparent">
        <p class="text-slate-400 text-xs">Total Members</p>
        <p class="text-2xl font-bold text-white mt-1">125</p>
    </div>
</div>

<div class="card rounded-lg overflow-hidden bg-transparent">
    <div class="p-5 border-b border-slate-700 flex justify-between items-center">
        <h3 class="font-medium text-white">All Branches</h3>
        <button onclick="openModal()"
            class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700">+ Add Branch</button>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-slate-800/50 text-xs text-slate-400">
                <tr>
                    <th class="text-left p-4">Code</th>
                    <th class="text-left p-4">Branch Name</th>
                    <th class="text-left p-4">Location</th>
                    <th class="text-left p-4">Admin</th>
                    <th class="text-left p-4">Status</th>
                    <th class="text-left p-4">Actions</th>
                </tr>
            </thead>
            <tbody id="branchesTableBody" class="divide-y divide-slate-700">
                <tr>
                    <td colspan="5" class="p-4 text-center text-slate-400">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Assign Admin Modal -->
<div id="assignAdminModal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-slate-800 rounded-lg max-w-md w-full p-6">
        <h2 class="text-xl font-bold text-white mb-4">Assign Branch Admin</h2>
        <div class="space-y-4">
            <div>
                <label class="block text-sm text-slate-300 mb-1">Select User from this Branch</label>
                <select id="branchUserSelect"
                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white">
                    <option value="">Select User</option>
                </select>
            </div>
            <div class="flex gap-2">
                <button onclick="assignBranchAdmin()"
                    class="flex-1 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Assign</button>
                <button onclick="closeAssignModal()"
                    class="px-4 py-2 bg-slate-600 text-white rounded hover:bg-slate-700">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'js/config.js' %}"></script>
<script>
    function openModal() {
        document.getElementById('addBranchModal').classList.remove('hidden');
        loadBranchAdmins();
    }

    function closeModal() {
        document.getElementById('addBranchModal').classList.add('hidden');
        document.getElementById('addBranchForm').reset();
        document.getElementById('formMessage').textContent = '';
    }

    async function loadBranchAdmins() {
        try {
            const response = await fetchAPI('/api/users/list/');
            const users = await response.json();
            const adminSelect = document.querySelector('select[name="admin"]');

            const branchAdmins = users.filter(u => u.user_type === 'branchadmin');
            adminSelect.innerHTML = '<option value="">Select Admin</option>' +
                branchAdmins.map(u => `<option value="${u.id}">${u.first_name} ${u.last_name} (${u.username})</option>`).join('');
        } catch (error) {
            console.error('Error loading admins:', error);
        }
    }

    async function loadBranches() {
        try {
            const response = await fetchAPI('/api/branches/list/');
            const branches = await response.json();

            document.getElementById('totalBranches').textContent = branches.length;
            document.getElementById('activeBranches').textContent = branches.filter(b => b.is_active).length;

            const tbody = document.getElementById('branchesTableBody');
            if (branches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-slate-400">No branches found</td></tr>';
                return;
            }

            tbody.innerHTML = branches.map(branch => `
                <tr class="hover:bg-slate-800/30 transition">
                    <td class="p-4"><span class="badge bg-indigo-900/30 text-indigo-300">${branch.code}</span></td>
                    <td class="p-4">${branch.name}</td>
                    <td class="p-4">${branch.location}</td>
                    <td class="p-4">${branch.admin_name || '<span class="text-slate-500">Not assigned</span>'}</td>
                    <td class="p-4">
                        <span class="badge ${branch.is_active ? 'bg-emerald-900/30 text-emerald-300' : 'bg-slate-700 text-slate-400'}">
                            ${branch.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    
                    <td class="p-4 text-center">
                        <button onclick="openAssignModal(${branch.id})" class="text-green-400 hover:text-green-300">
                            <i class="fa-solid fa-user-plus"></i>
                        </button>
                    </td>

                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading branches:', error);
        }
    }

    document.getElementById('addBranchForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        // Convert empty admin to null
        if (!data.admin) delete data.admin;

        // Uppercase the code
        data.code = data.code.toUpperCase();

        const messageDiv = document.getElementById('formMessage');

        try {
            const response = await fetchAPI('/api/branches/create/', {
                method: 'POST',
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                messageDiv.className = 'text-sm text-emerald-400';
                messageDiv.textContent = 'Branch created successfully!';
                setTimeout(() => {
                    closeModal();
                    loadBranches();
                }, 1000);
            } else {
                messageDiv.className = 'text-sm text-rose-400';
                messageDiv.textContent = Object.values(result).flat().join(', ');
            }
        } catch (error) {
            messageDiv.className = 'text-sm text-rose-400';
            messageDiv.textContent = 'Error creating branch';
        }
    });

    let currentBranchId = null;

    async function openAssignModal(branchId) {
        currentBranchId = branchId;
        document.getElementById('assignAdminModal').classList.remove('hidden');

        // Load users from this branch
        try {
            const response = await fetchAPI(`/api/users/list/?branch=${branchId}`);
            const data = await response.json();
            const users = data.results;

            const userSelect = document.getElementById('branchUserSelect');

            userSelect.innerHTML = '<option value="">Select User</option>' +
                users.map(u => `<option value="${u.id}">${u.first_name} ${u.last_name} (${u.username})</option>`).join('');
        } catch (error) {
            console.error('Error loading branch users:', error);
        }
    }

    function closeAssignModal() {
        document.getElementById('assignAdminModal').classList.add('hidden');
        currentBranchId = null;
        document.getElementById('branchUserSelect').value = '';
    }

    async function assignBranchAdmin() {
        const userId = document.getElementById('branchUserSelect').value;

        if (!userId) {
            alert('Please select a user');
            return;
        }

        try {
            const response = await fetchAPI(`/api/branches/${currentBranchId}/assign-admin/`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ admin: userId })
            });

            if (response.ok) {
                alert('Admin assigned successfully!');
                closeAssignModal();
                loadBranches();
            } else {
                alert('Failed to assign admin');
            }
        } catch (error) {
            console.error('Error assigning admin:', error);
            alert('Error assigning admin');
        }
    }

    loadBranches();
</script>
{% endblock %}