{% extends 'admin/base.html' %}

{% block title %}Children Management{% endblock %}
{% block page_title %}Children Management{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card p-4 rounded-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-slate-400 text-sm">Total Children</p>
                    <p class="text-2xl font-bold text-white" id="totalChildren">0</p>
                </div>
                <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-child text-blue-400 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="card p-4 rounded-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-slate-400 text-sm">Available</p>
                    <p class="text-2xl font-bold text-green-400" id="availableChildren">0</p>
                </div>
                <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-heart text-green-400 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="card p-4 rounded-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-slate-400 text-sm">Sponsored</p>
                    <p class="text-2xl font-bold text-indigo-400" id="sponsoredChildren">0</p>
                </div>
                <div class="w-12 h-12 bg-indigo-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-handshake text-indigo-400 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="card p-4 rounded-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-slate-400 text-sm">Graduated</p>
                    <p class="text-2xl font-bold text-purple-400" id="graduatedChildren">0</p>
                </div>
                <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-graduation-cap text-purple-400 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Child Button -->
    <div class="flex justify-between items-center">
        <h3 class="text-xl font-semibold text-white">Children Database</h3>
        <button onclick="openAddChildModal()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
            <i class="fas fa-plus mr-2"></i>Add New Child
        </button>
    </div>

    <!-- Children Table -->
    <div class="card rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-slate-800">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Child</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Age/Gender</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Location</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Education</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Sponsor</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="childrenTableBody" class="divide-y divide-slate-700">
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-slate-400">
                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Loading children...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Child Modal -->
<div id="childModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-slate-800 rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-slate-700">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold text-white" id="modalTitle">Add New Child</h3>
                <button onclick="closeChildModal()" class="text-slate-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        <div class="p-6">
            <form id="childForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Basic Information -->
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-white">Basic Information</h4>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Full Name *</label>
                            <input type="text" name="full_name" required class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Date of Birth *</label>
                            <input type="date" name="date_of_birth" required class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Gender *</label>
                            <select name="gender" required class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Child Photo</label>
                            <input type="file" name="photo" accept="image/*" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700">
                            <p class="text-xs text-slate-400 mt-1">Upload a photo of the child (JPG, PNG, max 5MB)</p>
                        </div>
                    </div>

                    <!-- Location -->
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-white">Location</h4>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Country *</label>
                            <select name="country" id="countrySelect" required class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="Nepal" selected>Nepal</option>
                            </select>
                        </div>
                        <div id="districtField">
                            <label class="block text-sm font-medium text-slate-300 mb-2">District *</label>
                            <select name="district" id="districtSelect" required class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">Select District</option>
                            </select>
                        </div>
                        <div id="districtInputField" style="display: none;">
                            <label class="block text-sm font-medium text-slate-300 mb-2">District *</label>
                            <input type="text" name="district_input" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Village *</label>
                            <input type="text" name="village" required class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Address</label>
                            <textarea name="address" rows="2" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                    </div>

                    <!-- Family Information -->
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-white">Family Information</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Father's Name</label>
                                <input type="text" name="father_name" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Father's Occupation</label>
                                <input type="text" name="father_occupation" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="father_alive" id="fatherAlive" checked class="mr-2 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500">
                            <label for="fatherAlive" class="text-sm text-slate-300">Father is alive</label>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Mother's Name</label>
                                <input type="text" name="mother_name" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Mother's Occupation</label>
                                <input type="text" name="mother_occupation" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="mother_alive" id="motherAlive" checked class="mr-2 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500">
                            <label for="motherAlive" class="text-sm text-slate-300">Mother is alive</label>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Guardian Name</label>
                                <input type="text" name="guardian_name" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Guardian Relationship</label>
                                <input type="text" name="guardian_relationship" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Guardian Occupation</label>
                            <input type="text" name="guardian_occupation" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Family Monthly Income (NPR)</label>
                            <input type="number" name="family_income" step="0.01" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>

                    <!-- Education & Sponsorship -->
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-white">Education & Sponsorship</h4>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">School Name</label>
                            <input type="text" name="school_name" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Grade Level</label>
                            <input type="text" name="grade_level" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Monthly Sponsorship Amount (NPR) *</label>
                            <input type="number" name="monthly_sponsorship_amount" step="0.01" required class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Preferred Sponsorship Type *</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" name="preferred_sponsorship_type" value="full" class="mr-2 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500">
                                    <span class="text-sm text-slate-300">Full Sponsorship</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="preferred_sponsorship_type" value="partial" class="mr-2 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500">
                                    <span class="text-sm text-slate-300">Partial Sponsorship</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="preferred_sponsorship_type" value="one_time" class="mr-2 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500">
                                    <span class="text-sm text-slate-300">One-time Donation</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="preferred_sponsorship_type" value="educational" class="mr-2 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500">
                                    <span class="text-sm text-slate-300">Educational Support</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="preferred_sponsorship_type" value="medical" class="mr-2 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500">
                                    <span class="text-sm text-slate-300">Medical Support</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Preferred Payment Frequency *</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" name="preferred_frequency" value="monthly" class="mr-2 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500">
                                    <span class="text-sm text-slate-300">Monthly</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="preferred_frequency" value="quarterly" class="mr-2 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500">
                                    <span class="text-sm text-slate-300">Quarterly</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="preferred_frequency" value="annually" class="mr-2 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500">
                                    <span class="text-sm text-slate-300">Annually</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="preferred_frequency" value="one_time" class="mr-2 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500">
                                    <span class="text-sm text-slate-300">One-time</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Information -->
                <div class="mt-6 space-y-4">
                    <h4 class="text-lg font-semibold text-white">Additional Information</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Family Situation</label>
                            <textarea name="family_situation" rows="3" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Health Status</label>
                            <textarea name="health_status" rows="3" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Interests & Hobbies</label>
                            <textarea name="interests_hobbies" rows="3" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Dreams & Aspirations</label>
                            <textarea name="dreams_aspirations" rows="3" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Child's Story (for sponsors)</label>
                        <textarea name="story" rows="4" placeholder="Write a compelling story about this child for potential sponsors..." class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeChildModal()" class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit" id="saveChildBtn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-save mr-2"></i>Save Child
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentChildId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadChildren();
    loadCountries();
    
    document.getElementById('childForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveChild();
    });
    
    // Handle country change
    document.getElementById('countrySelect').addEventListener('change', function() {
        toggleDistrictField();
    });
});

async function loadCountries() {
    try {
        const response = await fetch('https://restcountries.com/v3.1/all?fields=name');
        const countries = await response.json();
        const sorted = countries.sort((a, b) => a.name.common.localeCompare(b.name.common));
        
        const select = document.getElementById('countrySelect');
        select.innerHTML = sorted.map(c => 
            `<option value="${c.name.common}" ${c.name.common === 'Nepal' ? 'selected' : ''}>${c.name.common}</option>`
        ).join('');
        
        // Load districts for Nepal by default
        toggleDistrictField();
    } catch (error) {
        console.error('Error loading countries:', error);
        document.getElementById('countrySelect').innerHTML = '<option value="Nepal" selected>Nepal</option>';
        toggleDistrictField();
    }
}

function toggleDistrictField() {
    const country = document.getElementById('countrySelect').value;
    const districtField = document.getElementById('districtField');
    const districtInputField = document.getElementById('districtInputField');
    const districtSelect = document.getElementById('districtSelect');
    
    if (country === 'Nepal') {
        districtField.style.display = 'block';
        districtInputField.style.display = 'none';
        districtSelect.required = true;
        document.querySelector('input[name="district_input"]').required = false;
        
        // Load Nepal districts
        const districts = ['Achham', 'Arghakhanchi', 'Baglung', 'Baitadi', 'Bajhang', 'Bajura', 'Banke', 'Bara', 'Bardiya', 'Bhaktapur', 'Bhojpur', 'Chitwan', 'Dadeldhura', 'Dailekh', 'Dang', 'Darchula', 'Dhading', 'Dhankuta', 'Dhanusa', 'Dolakha', 'Dolpa', 'Doti', 'Gorkha', 'Gulmi', 'Humla', 'Ilam', 'Jajarkot', 'Jhapa', 'Jumla', 'Kailali', 'Kalikot', 'Kanchanpur', 'Kapilvastu', 'Kaski', 'Kathmandu', 'Kavrepalanchok', 'Khotang', 'Lalitpur', 'Lamjung', 'Mahottari', 'Makwanpur', 'Manang', 'Morang', 'Mugu', 'Mustang', 'Myagdi', 'Nawalparasi', 'Nuwakot', 'Okhaldhunga', 'Palpa', 'Panchthar', 'Parbat', 'Parsa', 'Pyuthan', 'Ramechhap', 'Rasuwa', 'Rautahat', 'Rolpa', 'Rukum', 'Rupandehi', 'Salyan', 'Sankhuwasabha', 'Saptari', 'Sarlahi', 'Sindhuli', 'Sindhupalchok', 'Siraha', 'Solukhumbu', 'Sunsari', 'Surkhet', 'Syangja', 'Tanahu', 'Taplejung', 'Terhathum', 'Udayapur'];
        districtSelect.innerHTML = '<option value="">Select District</option>' + 
            districts.map(d => `<option value="${d}">${d}</option>`).join('');
    } else {
        districtField.style.display = 'none';
        districtInputField.style.display = 'block';
        districtSelect.required = false;
        document.querySelector('input[name="district_input"]').required = true;
    }
}

async function loadChildren() {
    try {
        const response = await fetch('/api/applications/children/');
        const children = await response.json();
        
        const tbody = document.getElementById('childrenTableBody');
        
        if (children.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-slate-400">
                        <i class="fas fa-child text-4xl mb-4 opacity-50"></i>
                        <p class="text-lg mb-2">No children registered yet</p>
                        <p class="text-sm">Click "Add New Child" to start building your children database</p>
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = children.map(child => `
                <tr class="hover:bg-slate-700">
                    <td class="px-4 py-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold mr-3 overflow-hidden">
                                ${child.photo ? 
                                    `<img src="${child.photo}" alt="${child.full_name}" class="w-full h-full object-cover">` :
                                    `<div class="w-full h-full bg-indigo-500 flex items-center justify-center">${child.full_name.charAt(0).toUpperCase()}</div>`
                                }
                            </div>
                            <div>
                                <div class="text-sm font-medium text-white">${child.full_name}</div>
                                <div class="text-sm text-slate-400">${child.village}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 text-sm text-slate-300">
                        <div>${child.age} years</div>
                        <div class="text-slate-400">${child.gender}</div>
                    </td>
                    <td class="px-4 py-4 text-sm text-slate-300">
                        <div>${child.district}</div>
                        <div class="text-slate-400">${child.village}</div>
                    </td>
                    <td class="px-4 py-4 text-sm text-slate-300">
                        <div>${child.school_name || 'Not specified'}</div>
                        <div class="text-slate-400">${child.grade_level || 'N/A'}</div>
                    </td>
                    <td class="px-4 py-4">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                            child.status === 'available' ? 'bg-green-100 text-green-800' :
                            child.status === 'sponsored' ? 'bg-blue-100 text-blue-800' :
                            child.status === 'graduated' ? 'bg-purple-100 text-purple-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${child.status.charAt(0).toUpperCase() + child.status.slice(1)}
                        </span>
                    </td>
                    <td class="px-4 py-4 text-sm text-slate-300">
                        ${child.current_sponsor || 'None'}
                    </td>
                    <td class="px-4 py-4 text-sm font-medium">
                        <button onclick="editChild(${child.id})" class="text-indigo-400 hover:text-indigo-300 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteChild(${child.id})" class="text-red-400 hover:text-red-300">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Load statistics
        loadChildrenStats();
    } catch (error) {
        console.error('Error loading children:', error);
        document.getElementById('childrenTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center text-red-400">
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <p>Error loading children data</p>
                </td>
            </tr>
        `;
    }
}

async function loadChildrenStats() {
    try {
        const response = await fetch('/api/applications/children/stats/');
        const stats = await response.json();
        
        document.getElementById('totalChildren').textContent = stats.total || 0;
        document.getElementById('availableChildren').textContent = stats.available || 0;
        document.getElementById('sponsoredChildren').textContent = stats.sponsored || 0;
        document.getElementById('graduatedChildren').textContent = stats.graduated || 0;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

function openAddChildModal() {
    currentChildId = null;
    document.getElementById('modalTitle').textContent = 'Add New Child';
    document.getElementById('childForm').reset();
    
    // Reset checkboxes
    document.getElementById('fatherAlive').checked = true;
    document.getElementById('motherAlive').checked = true;
    
    // Uncheck all multi-select checkboxes
    document.querySelectorAll('input[name="preferred_sponsorship_type"]').forEach(cb => {
        cb.checked = false;
    });
    document.querySelectorAll('input[name="preferred_frequency"]').forEach(cb => {
        cb.checked = false;
    });
    
    // Reset to Nepal and load districts
    document.getElementById('countrySelect').value = 'Nepal';
    toggleDistrictField();
    
    document.getElementById('childModal').classList.remove('hidden');
    document.getElementById('childModal').classList.add('flex');
}

function closeChildModal() {
    document.getElementById('childModal').classList.add('hidden');
    document.getElementById('childModal').classList.remove('flex');
    currentChildId = null;
}

async function saveChild() {
    const saveBtn = document.getElementById('saveChildBtn');
    const originalText = saveBtn.innerHTML;
    
    // Show loading state
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
    
    const formData = new FormData(document.getElementById('childForm'));
    
    // Handle district field based on country
    const country = formData.get('country');
    if (country === 'Nepal') {
        // Keep district as is
    } else {
        formData.set('district', formData.get('district_input'));
    }
    formData.delete('district_input');
    
    // Handle checkboxes
    formData.set('father_alive', document.getElementById('fatherAlive').checked);
    formData.set('mother_alive', document.getElementById('motherAlive').checked);
    
    // Handle multi-select checkboxes for sponsorship preferences
    formData.delete('preferred_sponsorship_type');
    document.querySelectorAll('input[name="preferred_sponsorship_type"]:checked').forEach(cb => {
        formData.append('preferred_sponsorship_type', cb.value);
    });
    
    formData.delete('preferred_frequency');
    document.querySelectorAll('input[name="preferred_frequency"]:checked').forEach(cb => {
        formData.append('preferred_frequency', cb.value);
    });
    
    try {
        const isEdit = currentChildId !== null;
        const url = isEdit ? `/api/applications/children/${currentChildId}/` : '/api/applications/children/';
        const method = isEdit ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(isEdit ? 'Child information updated successfully!' : 'Child information saved successfully!');
            closeChildModal();
            loadChildren();
        } else {
            alert('Error saving child: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving child:', error);
        alert('Error saving child information');
    } finally {
        // Reset button state
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
    }
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function editChild(childId) {
    // Load child data and populate form
    loadChildForEdit(childId);
}

async function loadChildForEdit(childId) {
    try {
        const response = await fetch(`/api/applications/children/${childId}/`);
        const child = await response.json();
        
        if (response.ok) {
            // Set modal title
            document.getElementById('modalTitle').textContent = 'Edit Child';
            currentChildId = childId;
            
            // Populate form fields
            document.querySelector('input[name="full_name"]').value = child.full_name;
            document.querySelector('input[name="date_of_birth"]').value = child.date_of_birth;
            document.querySelector('select[name="gender"]').value = child.gender;
            document.querySelector('select[name="country"]').value = child.country;
            
            // Handle district based on country
            if (child.country === 'Nepal') {
                document.getElementById('districtSelect').value = child.district;
            } else {
                document.querySelector('input[name="district_input"]').value = child.district;
            }
            
            document.querySelector('input[name="village"]').value = child.village;
            document.querySelector('textarea[name="address"]').value = child.address;
            document.querySelector('input[name="father_name"]').value = child.father_name;
            document.querySelector('input[name="father_occupation"]').value = child.father_occupation;
            document.getElementById('fatherAlive').checked = child.father_alive;
            document.querySelector('input[name="mother_name"]').value = child.mother_name;
            document.querySelector('input[name="mother_occupation"]').value = child.mother_occupation;
            document.getElementById('motherAlive').checked = child.mother_alive;
            document.querySelector('input[name="guardian_name"]').value = child.guardian_name;
            document.querySelector('input[name="guardian_relationship"]').value = child.guardian_relationship;
            document.querySelector('input[name="guardian_occupation"]').value = child.guardian_occupation;
            document.querySelector('input[name="family_income"]').value = child.family_income;
            document.querySelector('input[name="school_name"]').value = child.school_name;
            document.querySelector('input[name="grade_level"]').value = child.grade_level;
            document.querySelector('input[name="monthly_sponsorship_amount"]').value = child.monthly_sponsorship_amount;
            
            // Handle multi-select checkboxes
            document.querySelectorAll('input[name="preferred_sponsorship_type"]').forEach(cb => {
                cb.checked = child.preferred_sponsorship_type.includes(cb.value);
            });
            
            document.querySelectorAll('input[name="preferred_frequency"]').forEach(cb => {
                cb.checked = child.preferred_frequency.includes(cb.value);
            });
            
            // Additional fields
            document.querySelector('textarea[name="family_situation"]').value = child.family_situation;
            document.querySelector('textarea[name="health_status"]').value = child.health_status;
            document.querySelector('textarea[name="interests_hobbies"]').value = child.interests_hobbies;
            document.querySelector('textarea[name="dreams_aspirations"]').value = child.dreams_aspirations;
            document.querySelector('textarea[name="story"]').value = child.story;
            
            // Show modal
            document.getElementById('childModal').classList.remove('hidden');
            document.getElementById('childModal').classList.add('flex');
        } else {
            alert('Error loading child data: ' + (child.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error loading child:', error);
        alert('Error loading child data');
    }
}

async function deleteChild(childId) {
    if (confirm('Are you sure you want to delete this child record? This action cannot be undone.')) {
        try {
            const response = await fetch(`/api/applications/children/${childId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const result = await response.json();
            
            if (response.ok) {
                alert(result.message || 'Child deleted successfully!');
                loadChildren();
            } else {
                alert('Error deleting child: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error deleting child:', error);
            alert('Error deleting child');
        }
    }
}
</script>
{% endblock %}