{% extends 'admin/base.html' %}
{% load static %}

{% block page_title %}Tasks Management{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
    <div class="bg-slate-800 p-6 rounded-lg">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-400 text-sm">Total Tasks</p>
                <p class="text-3xl font-bold text-white" id="totalTasks">0</p>
            </div>
            <i class="fas fa-tasks text-4xl text-blue-500"></i>
        </div>
    </div>
    <div class="bg-slate-800 p-6 rounded-lg">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-400 text-sm">Submitted</p>
                <p class="text-3xl font-bold text-white" id="submittedTasks">0</p>
            </div>
            <i class="fas fa-clock text-4xl text-yellow-500"></i>
        </div>
    </div>
    <div class="bg-slate-800 p-6 rounded-lg">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-400 text-sm">Approved</p>
                <p class="text-3xl font-bold text-white" id="approvedTasks">0</p>
            </div>
            <i class="fas fa-check-circle text-4xl text-green-500"></i>
        </div>
    </div>
    <div class="bg-slate-800 p-6 rounded-lg">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-400 text-sm">Needs Review</p>
                <p class="text-3xl font-bold text-white" id="needsReview">0</p>
            </div>
            <i class="fas fa-exclamation-triangle text-4xl text-red-500"></i>
        </div>
    </div>
</div>

<div class="bg-slate-800 rounded-lg p-6">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-white">Task Management</h3>
        <button onclick="showCreateTaskModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
            <i class="fas fa-plus mr-2"></i>Create Task
        </button>
    </div>
    
    <div id="tasksContainer" class="max-h-96 overflow-y-auto">
        <div class="overflow-x-auto">
            <table class="w-full" id="tasksTable">
                <thead class="bg-slate-700">
                    <tr>
                        <th class="py-3 px-4 text-left text-slate-300 text-sm cursor-pointer" onclick="sortTable(0)">Task Name <i class="fas fa-sort ml-1"></i></th>
                        <th class="py-3 px-4 text-left text-slate-300 text-sm cursor-pointer" onclick="sortTable(1)">Deadline <i class="fas fa-sort ml-1"></i></th>
                        <th class="py-3 px-4 text-left text-slate-300 text-sm cursor-pointer" onclick="sortTable(2)">Participants <i class="fas fa-sort ml-1"></i></th>
                        <th class="py-3 px-4 text-left text-slate-300 text-sm cursor-pointer" onclick="sortTable(3)">Submissions <i class="fas fa-sort ml-1"></i></th>
                        <th class="py-3 px-4 text-left text-slate-300 text-sm cursor-pointer" onclick="sortTable(4)">Overdue <i class="fas fa-sort ml-1"></i></th>
                        <th class="py-3 px-4 text-left text-slate-300 text-sm cursor-pointer" onclick="sortTable(5)">Emails Sent <i class="fas fa-sort ml-1"></i></th>
                        <th class="py-3 px-4 text-left text-slate-300 text-sm">Actions</th>
                    </tr>
                </thead>
                <tbody id="tasksTableBody">
                    <tr>
                        <td colspan="7" class="py-8 text-center text-slate-400">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                            <p>Loading tasks...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="flex justify-between items-center mt-4">
            <div class="text-sm text-slate-400" id="tableInfo">Loading...</div>
            <div class="flex gap-2" id="pagination"></div>
        </div>
    </div>
</div>

<!-- Create Task Modal -->
<div id="createTaskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-slate-800 p-6 rounded-lg max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
        <h3 class="text-xl font-bold text-white mb-4">Create New Task</h3>
        <form id="createTaskForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="mb-4">
                    <label class="block text-slate-300 text-sm font-medium mb-2">Title</label>
                    <input type="text" id="taskTitle" class="w-full p-2 bg-slate-700 text-white rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block text-slate-300 text-sm font-medium mb-2">Deadline</label>
                    <input type="datetime-local" id="taskDeadline" class="w-full p-2 bg-slate-700 text-white rounded" required>
                </div>
                <div class="mb-4 md:col-span-2">
                    <label class="block text-slate-300 text-sm font-medium mb-2">Description</label>
                    <textarea id="taskDescription" class="w-full p-2 bg-slate-700 text-white rounded" rows="3" required></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-slate-300 text-sm font-medium mb-2">Assignment Type</label>
                    <select id="assignmentMode" class="w-full p-2 bg-slate-700 text-white rounded mb-2" onchange="changeAssignmentMode()">
                        <option value="individual">Individual Users</option>
                        <option value="all">All Users</option>
                        <option value="branch">By Branch</option>
                        <option value="branch_individual">Branch + Individual Users</option>
                    </select>
                </div>
                <div id="userTypeSection" class="mb-4">
                    <label class="block text-slate-300 text-sm font-medium mb-2">User Type</label>
                    <select id="taskAssignType" class="w-full p-2 bg-slate-700 text-white rounded mb-2" onchange="loadUsersByType()">
                        <option value="both">Members & Volunteers</option>
                        <option value="member">Members Only</option>
                        <option value="volunteer">Volunteers Only</option>
                    </select>
                </div>
                <div id="individualSection" class="mb-4">
                    <label class="block text-slate-300 text-sm font-medium mb-2">Select Users</label>
                    <div class="relative">
                        <input type="text" id="userSearch" class="w-full p-2 bg-slate-700 text-white rounded" placeholder="Search users..." oninput="searchUsers()" onfocus="showUserDropdown()">
                        <div id="userDropdown" class="absolute z-10 w-full bg-slate-700 border border-slate-600 rounded mt-1 max-h-40 overflow-y-auto hidden">
                            <!-- Search results will appear here -->
                        </div>
                    </div>
                    <div id="selectedUsers" class="mt-2">
                        <!-- Selected users will appear here -->
                    </div>
                    <small class="text-slate-400">Type to search and select users</small>
                </div>
                <div id="branchSection" class="mb-4" style="display: none;">
                    <label class="block text-slate-300 text-sm font-medium mb-2">Select Branch</label>
                    <select id="branchSelect" class="w-full p-2 bg-slate-700 text-white rounded" onchange="loadBranchUsers()">
                        <!-- Branches will be loaded here -->
                    </select>
                </div>
                <div id="branchIndividualSection" class="mb-4" style="display: none;">
                    <label class="block text-slate-300 text-sm font-medium mb-2">Select Users from Branch</label>
                    <div class="relative">
                        <input type="text" id="branchUserSearch" class="w-full p-2 bg-slate-700 text-white rounded" placeholder="Search users in selected branch..." oninput="searchBranchUsers()" onfocus="showBranchUserDropdown()">
                        <div id="branchUserDropdown" class="absolute z-10 w-full bg-slate-700 border border-slate-600 rounded mt-1 max-h-40 overflow-y-auto hidden">
                            <!-- Branch user search results will appear here -->
                        </div>
                    </div>
                    <div id="selectedBranchUsers" class="mt-2">
                        <!-- Selected branch users will appear here -->
                    </div>
                    <small class="text-slate-400">First select a branch, then search users</small>
                </div>
                <div class="mb-4">
                    <label class="block text-slate-300 text-sm font-medium mb-2">Task Materials (Optional)</label>
                    <input type="file" id="taskMaterials" class="w-full p-2 bg-slate-700 text-white rounded mb-2" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif" multiple onchange="previewFiles()">
                    <small class="text-slate-400">Upload multiple files: PDF, images, documents, etc.</small>
                    <div id="filePreview" class="mt-2"></div>
                </div>
                <div class="mb-4 md:col-span-2">
                    <label class="block text-slate-300 text-sm font-medium mb-2">Helpful Links (Optional)</label>
                    <textarea id="taskLinks" class="w-full p-2 bg-slate-700 text-white rounded" rows="2" placeholder="Enter helpful links (one per line)"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-4">
                <button type="button" onclick="createTask()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Create</button>
                <button type="button" onclick="closeCreateTaskModal()" class="bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Task Detail Modal -->
<div id="taskDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-slate-800 p-6 rounded-lg max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white">Task Details</h3>
            <button onclick="closeTaskDetailModal()" class="text-slate-400 hover:text-white">
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>
        <div id="taskDetailContent">
            <!-- Task details will be loaded here -->
        </div>
    </div>
</div>

<!-- Review Task Modal -->
<div id="reviewTaskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-slate-800 p-6 rounded-lg max-w-md w-full mx-4">
        <h3 class="text-xl font-bold text-white mb-4">Review Task</h3>
        <div id="reviewTaskContent"></div>
        <div class="mb-4">
            <label class="block text-slate-300 text-sm font-medium mb-2">Feedback</label>
            <textarea id="reviewFeedback" class="w-full p-2 bg-slate-700 text-white rounded" rows="3" placeholder="Add your feedback..."></textarea>
        </div>
        <div class="flex gap-3">
            <button type="button" onclick="reviewTask('approve')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Approve</button>
            <button type="button" onclick="reviewTask('redo')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Request Redo</button>
            <button type="button" onclick="closeReviewModal()" class="bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded">Cancel</button>
        </div>
    </div>
</div>

<!-- Email Progress Floating Window -->
<div id="emailProgressFloat" class="fixed bottom-4 right-4 bg-slate-800 border border-slate-600 rounded-lg p-4 shadow-lg z-50" style="display: none; width: 300px;">
    <div class="flex justify-between items-center mb-2">
        <h4 class="text-white font-medium text-sm">üìß Email Progress</h4>
        <button onclick="closeEmailProgress()" class="text-slate-400 hover:text-white">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="space-y-2">
        <div class="flex justify-between text-xs">
            <span class="text-slate-300">Pending:</span>
            <span id="pendingCount" class="text-yellow-400">0</span>
        </div>
        <div class="flex justify-between text-xs">
            <span class="text-slate-300">Sending:</span>
            <span id="sendingCount" class="text-blue-400">0</span>
        </div>
        <div class="flex justify-between text-xs">
            <span class="text-slate-300">Sent:</span>
            <span id="sentCount" class="text-green-400">0</span>
        </div>
        <div class="flex justify-between text-xs">
            <span class="text-slate-300">Failed:</span>
            <span id="failedCount" class="text-red-400">0</span>
        </div>
        <div class="w-full bg-slate-700 rounded-full h-2 mt-3">
            <div id="progressBar" class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <div class="text-xs text-slate-400 text-center" id="progressText">0% Complete</div>
    </div>
</div>

<script>
    let allTasks = [];
    let currentPage = 1;
    let itemsPerPage = 10;
    let sortColumn = -1;
    let sortDirection = 'asc';
    let currentReviewTaskId = null;
    
    function sortTable(column) {
        if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = column;
            sortDirection = 'asc';
        }
        
        const sortedTasks = [...allTasks].sort((a, b) => {
            let aVal, bVal;
            
            switch(column) {
                case 0: aVal = a.title; bVal = b.title; break;
                case 1: aVal = new Date(a.deadline); bVal = new Date(b.deadline); break;
                case 2: aVal = a.assigned_to.length; bVal = b.assigned_to.length; break;
                case 3: aVal = a.status === 'submitted' ? 1 : 0; bVal = b.status === 'submitted' ? 1 : 0; break;
                case 4: 
                    aVal = new Date() > new Date(a.deadline) && a.status !== 'submitted' ? 1 : 0;
                    bVal = new Date() > new Date(b.deadline) && b.status !== 'submitted' ? 1 : 0;
                    break;
                case 5: aVal = a.email_status || '0/0'; bVal = b.email_status || '0/0'; break;
            }
            
            if (column === 1) { // Date sorting
                return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            } else if (column >= 2 && column <= 4) { // Number sorting
                return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            } else {
                return sortDirection === 'asc' ? aVal.toString().localeCompare(bVal.toString()) : bVal.toString().localeCompare(aVal.toString());
            }
        });
        
        displayTasks(sortedTasks);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        loadTasks();
        loadUsers();
        loadBranches();
    });
    
    function changeAssignmentMode() {
        const mode = document.getElementById('assignmentMode').value;
        const individualSection = document.getElementById('individualSection');
        const branchSection = document.getElementById('branchSection');
        const branchIndividualSection = document.getElementById('branchIndividualSection');
        const userTypeSection = document.getElementById('userTypeSection');
        
        // Hide all sections first
        individualSection.style.display = 'none';
        branchSection.style.display = 'none';
        branchIndividualSection.style.display = 'none';
        
        if (mode === 'individual') {
            individualSection.style.display = 'block';
            userTypeSection.style.display = 'block';
        } else if (mode === 'branch') {
            branchSection.style.display = 'block';
            userTypeSection.style.display = 'block';
        } else if (mode === 'branch_individual') {
            branchSection.style.display = 'block';
            branchIndividualSection.style.display = 'block';
            userTypeSection.style.display = 'block';
        } else { // all
            userTypeSection.style.display = 'block';
        }
        
        selectedUserIds = [];
        selectedBranchUserIds = [];
        updateSelectedUsers();
        updateSelectedBranchUsers();
    }
    
    async function loadBranches() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/branches/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const branches = await response.json();
                const select = document.getElementById('branchSelect');
                select.innerHTML = '<option value="">Select Branch</option>' + 
                    branches.map(branch => `<option value="${branch.id}">${branch.name}</option>`).join('');
            }
        } catch (error) {
            console.error('Error loading branches:', error);
        }
    }
    
    async function loadTasks() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/tasks/admin/all-tasks/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) throw new Error('Failed to fetch tasks');
            
            allTasks = await response.json();
            updateStats(allTasks);
            displayTasks(allTasks);
        } catch (error) {
            console.error('Error loading tasks:', error);
            document.getElementById('tasksTableBody').innerHTML = `
                <tr>
                    <td colspan="7" class="py-8 text-center text-red-400">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>Error loading tasks.</p>
                    </td>
                </tr>
            `;
        }
    }
    
    function updateStats(tasks) {
        const stats = {
            total: tasks.length,
            submitted: tasks.filter(t => t.status === 'submitted').length,
            approved: tasks.filter(t => t.status === 'approved').length,
            needsReview: tasks.filter(t => t.status === 'submitted').length
        };
        
        document.getElementById('totalTasks').textContent = stats.total;
        document.getElementById('submittedTasks').textContent = stats.submitted;
        document.getElementById('approvedTasks').textContent = stats.approved;
        document.getElementById('needsReview').textContent = stats.needsReview;
    }
    
    function displayTasks(tasks) {
        const tbody = document.getElementById('tasksTableBody');
        
        if (tasks.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="py-8 text-center text-slate-400">
                        <i class="fas fa-tasks fa-3x mb-3"></i>
                        <p>No tasks created yet.</p>
                    </td>
                </tr>
            `;
            document.getElementById('tableInfo').textContent = 'No tasks';
            return;
        }
        
        tbody.innerHTML = tasks.map(task => {
            const deadline = new Date(task.deadline);
            const isOverdue = new Date() > deadline;
            const deadlineStr = deadline.toLocaleDateString();
            
            // Calculate metrics
            const totalParticipants = task.assigned_to.length;
            const submittedCount = task.submission_count || 0;
            const overdueCount = isOverdue && task.status !== 'submitted' ? 1 : 0;
            const emailStatus = task.email_status || '0/0 sent';
            
            const statusColors = {
                'assigned': 'bg-blue-500',
                'submitted': 'bg-yellow-500',
                'approved': 'bg-green-500',
                'redo_requested': 'bg-red-500'
            };
            
            return `
                <tr class="border-b border-slate-600 hover:bg-slate-700/30">
                    <td class="py-3 px-4 text-sm text-white">${task.title}</td>
                    <td class="py-3 px-4 text-sm ${isOverdue ? 'text-red-400' : 'text-slate-300'}">${deadlineStr} ${isOverdue ? '(OVERDUE)' : ''}</td>
                    <td class="py-3 px-4 text-sm text-slate-300">${totalParticipants}</td>
                    <td class="py-3 px-4 text-sm text-slate-300">${submittedCount}/${totalParticipants}</td>
                    <td class="py-3 px-4 text-sm ${overdueCount > 0 ? 'text-red-400' : 'text-slate-300'}">${overdueCount}/${totalParticipants}</td>
                    <td class="py-3 px-4 text-sm text-slate-300">${emailStatus}</td>
                    <td class="py-3 px-4 text-sm">
                        <button onclick="window.location.href='/admin/tasks/detail/?id=${task.id}'" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs">
                            <i class="fas fa-eye mr-1"></i>Details
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        document.getElementById('tableInfo').textContent = `Showing ${tasks.length} tasks`;
    }
    
    let allUsers = [];
    let branchUsers = [];
    let selectedUserIds = [];
    let selectedBranchUserIds = [];
    
    async function loadUsers() {
        loadUsersByType();
    }
    
    async function loadUsersByType() {
        try {
            const token = localStorage.getItem('access_token');
            const assignType = document.getElementById('taskAssignType').value;
            const response = await fetch('/api/users/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const users = await response.json();
                
                if (assignType === 'member') {
                    allUsers = users.filter(u => u.user_type === 'member');
                } else if (assignType === 'volunteer') {
                    allUsers = users.filter(u => u.user_type === 'volunteer');
                } else {
                    allUsers = users.filter(u => u.user_type === 'member' || u.user_type === 'volunteer');
                }
                
                document.getElementById('userSearch').value = '';
                selectedUserIds = [];
                updateSelectedUsers();
            }
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }
    
    function searchUsers() {
        const query = document.getElementById('userSearch').value.toLowerCase();
        const dropdown = document.getElementById('userDropdown');
        
        if (query.length === 0) {
            dropdown.classList.add('hidden');
            return;
        }
        
        const filteredUsers = allUsers.filter(user => {
            const fullName = `${user.first_name} ${user.last_name}`.toLowerCase();
            const email = user.email.toLowerCase();
            return fullName.includes(query) || email.includes(query);
        }).filter(user => !selectedUserIds.includes(user.id));
        
        if (filteredUsers.length === 0) {
            dropdown.innerHTML = '<div class="p-2 text-slate-400 text-sm">No users found</div>';
        } else {
            dropdown.innerHTML = filteredUsers.map(user => `
                <div class="p-2 hover:bg-slate-600 cursor-pointer text-sm" onclick="selectUser(${user.id})">
                    ${user.first_name} ${user.last_name} (${user.email}) - ${user.user_type.toUpperCase()}
                </div>
            `).join('');
        }
        
        dropdown.classList.remove('hidden');
    }
    
    function showUserDropdown() {
        if (document.getElementById('userSearch').value.length > 0) {
            searchUsers();
        }
    }
    
    function selectUser(userId) {
        if (!selectedUserIds.includes(userId)) {
            selectedUserIds.push(userId);
            updateSelectedUsers();
        }
        document.getElementById('userSearch').value = '';
        document.getElementById('userDropdown').classList.add('hidden');
    }
    
    function removeUser(userId) {
        selectedUserIds = selectedUserIds.filter(id => id !== userId);
        updateSelectedUsers();
    }
    
    function updateSelectedUsers() {
        const container = document.getElementById('selectedUsers');
        const selectedUsers = allUsers.filter(user => selectedUserIds.includes(user.id));
        
        if (selectedUsers.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = selectedUsers.map(user => `
            <div class="inline-flex items-center bg-blue-600 text-white px-2 py-1 rounded text-xs mr-2 mb-1">
                ${user.first_name} ${user.last_name} (${user.user_type.toUpperCase()})
                <button type="button" onclick="removeUser(${user.id})" class="ml-2 text-white hover:text-red-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');
    }
    
    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#userSearch') && !e.target.closest('#userDropdown')) {
            document.getElementById('userDropdown').classList.add('hidden');
        }
        if (!e.target.closest('#branchUserSearch') && !e.target.closest('#branchUserDropdown')) {
            document.getElementById('branchUserDropdown').classList.add('hidden');
        }
    });
    
    async function loadBranchUsers() {
        const branchId = document.getElementById('branchSelect').value;
        const assignType = document.getElementById('taskAssignType').value;
        
        if (!branchId) {
            branchUsers = [];
            return;
        }
        
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/users/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const users = await response.json();
                
                // Filter by branch and user type
                branchUsers = users.filter(user => {
                    const matchesBranch = user.branch_id == branchId;
                    if (assignType === 'member') {
                        return matchesBranch && user.user_type === 'member';
                    } else if (assignType === 'volunteer') {
                        return matchesBranch && user.user_type === 'volunteer';
                    } else {
                        return matchesBranch && (user.user_type === 'member' || user.user_type === 'volunteer');
                    }
                });
                
                selectedBranchUserIds = [];
                updateSelectedBranchUsers();
            }
        } catch (error) {
            console.error('Error loading branch users:', error);
        }
    }
    
    function searchBranchUsers() {
        const query = document.getElementById('branchUserSearch').value.toLowerCase();
        const dropdown = document.getElementById('branchUserDropdown');
        
        if (query.length === 0) {
            dropdown.classList.add('hidden');
            return;
        }
        
        const filteredUsers = branchUsers.filter(user => {
            const fullName = `${user.first_name} ${user.last_name}`.toLowerCase();
            const email = user.email.toLowerCase();
            return fullName.includes(query) || email.includes(query);
        }).filter(user => !selectedBranchUserIds.includes(user.id));
        
        if (filteredUsers.length === 0) {
            dropdown.innerHTML = '<div class="p-2 text-slate-400 text-sm">No users found</div>';
        } else {
            dropdown.innerHTML = filteredUsers.map(user => `
                <div class="p-2 hover:bg-slate-600 cursor-pointer text-sm" onclick="selectBranchUser(${user.id})">
                    ${user.first_name} ${user.last_name} (${user.email}) - ${user.user_type.toUpperCase()}
                </div>
            `).join('');
        }
        
        dropdown.classList.remove('hidden');
    }
    
    function showBranchUserDropdown() {
        if (document.getElementById('branchUserSearch').value.length > 0) {
            searchBranchUsers();
        }
    }
    
    function selectBranchUser(userId) {
        if (!selectedBranchUserIds.includes(userId)) {
            selectedBranchUserIds.push(userId);
            updateSelectedBranchUsers();
        }
        document.getElementById('branchUserSearch').value = '';
        document.getElementById('branchUserDropdown').classList.add('hidden');
    }
    
    function removeBranchUser(userId) {
        selectedBranchUserIds = selectedBranchUserIds.filter(id => id !== userId);
        updateSelectedBranchUsers();
    }
    
    function updateSelectedBranchUsers() {
        const container = document.getElementById('selectedBranchUsers');
        const selectedUsers = branchUsers.filter(user => selectedBranchUserIds.includes(user.id));
        
        if (selectedUsers.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = selectedUsers.map(user => `
            <div class="inline-flex items-center bg-green-600 text-white px-2 py-1 rounded text-xs mr-2 mb-1">
                ${user.first_name} ${user.last_name} (${user.user_type.toUpperCase()})
                <button type="button" onclick="removeBranchUser(${user.id})" class="ml-2 text-white hover:text-red-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');
    }
    
    function showCreateTaskModal() {
        document.getElementById('createTaskModal').style.display = 'flex';
        loadUsersByType(); // Initialize users when modal opens
    }
    
    function previewFiles() {
        const files = document.getElementById('taskMaterials').files;
        const preview = document.getElementById('filePreview');
        preview.innerHTML = '';
        
        Array.from(files).forEach((file, index) => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'flex items-center justify-between bg-slate-600 p-2 rounded mb-1';
            
            const fileName = document.createElement('span');
            fileName.className = 'text-slate-300 text-xs truncate';
            fileName.textContent = file.name;
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'text-red-400 hover:text-red-300 text-xs ml-2';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.onclick = () => removeFile(index);
            
            fileDiv.appendChild(fileName);
            fileDiv.appendChild(removeBtn);
            preview.appendChild(fileDiv);
        });
    }
    
    function removeFile(index) {
        const input = document.getElementById('taskMaterials');
        const dt = new DataTransfer();
        const files = input.files;
        
        for (let i = 0; i < files.length; i++) {
            if (i !== index) dt.items.add(files[i]);
        }
        
        input.files = dt.files;
        previewFiles();
    }
    
    function closeCreateTaskModal() {
        document.getElementById('createTaskModal').style.display = 'none';
        document.getElementById('createTaskForm').reset();
        document.getElementById('filePreview').innerHTML = '';
        document.getElementById('userSearch').value = '';
        document.getElementById('userDropdown').classList.add('hidden');
        selectedUserIds = [];
        updateSelectedUsers();
    }
    
    async function createTask() {
        try {
            const token = localStorage.getItem('access_token');
            const assignmentMode = document.getElementById('assignmentMode').value;
            
            const formData = new FormData();
            formData.append('title', document.getElementById('taskTitle').value);
            formData.append('description', document.getElementById('taskDescription').value);
            formData.append('deadline', document.getElementById('taskDeadline').value);
            formData.append('assign_to_type', document.getElementById('taskAssignType').value);
            formData.append('assignment_mode', assignmentMode);
            formData.append('task_links', document.getElementById('taskLinks').value);
            
            if (assignmentMode === 'individual') {
                formData.append('assigned_to', JSON.stringify(selectedUserIds));
            } else if (assignmentMode === 'branch') {
                formData.append('branch_id', document.getElementById('branchSelect').value);
            } else if (assignmentMode === 'branch_individual') {
                formData.append('assigned_to', JSON.stringify(selectedBranchUserIds));
                formData.append('branch_id', document.getElementById('branchSelect').value);
            }
            // For 'all' mode, no additional data needed
            
            const materialsFiles = document.getElementById('taskMaterials').files;
            for (let i = 0; i < materialsFiles.length; i++) {
                formData.append('task_materials', materialsFiles[i]);
            }
            
            const response = await fetch('/api/tasks/admin/create/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                alert(`Task created successfully! Assigned to ${result.assigned_count} users.`);
                closeCreateTaskModal();
                loadTasks();
                
                // Start monitoring email progress if users were assigned
                if (result.assigned_count > 0) {
                    startEmailProgressMonitoring();
                }
            } else {
                alert('Error creating task.');
            }
        } catch (error) {
            console.error('Error creating task:', error);
            alert('Error creating task.');
        }
    }
    
    function showReviewModal(taskId, title, submissionText, submissionFile) {
        currentReviewTaskId = taskId;
        document.getElementById('reviewTaskContent').innerHTML = `
            <div class="mb-4">
                <h4 class="text-white font-medium mb-2">${title}</h4>
                <p class="text-slate-300 text-sm mb-2"><strong>Submission:</strong> ${submissionText}</p>
                ${submissionFile ? `<a href="${submissionFile}" target="_blank" class="text-blue-400 text-sm hover:underline"><i class="fas fa-file mr-1"></i>View File</a>` : ''}
            </div>
        `;
        document.getElementById('reviewTaskModal').style.display = 'flex';
    }
    
    function closeReviewModal() {
        document.getElementById('reviewTaskModal').style.display = 'none';
        currentReviewTaskId = null;
        document.getElementById('reviewFeedback').value = '';
    }
    
    async function reviewTask(action) {
        if (!currentReviewTaskId) return;
        
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/api/tasks/admin/${currentReviewTaskId}/review/`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: action,
                    feedback: document.getElementById('reviewFeedback').value
                })
            });
            
            if (response.ok) {
                alert(`Task ${action === 'approve' ? 'approved' : 'sent for revision'} successfully!`);
                closeReviewModal();
                loadTasks();
            } else {
                alert('Error reviewing task.');
            }
        } catch (error) {
            console.error('Error reviewing task:', error);
            alert('Error reviewing task.');
        }
    }
    
    let emailProgressInterval = null;
    
    function startEmailProgressMonitoring() {
        document.getElementById('emailProgressFloat').style.display = 'block';
        updateEmailProgress();
        
        // Update every 3 seconds
        emailProgressInterval = setInterval(updateEmailProgress, 3000);
    }
    
    async function updateEmailProgress() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/tasks/admin/email-status/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const data = await response.json();
                const stats = data.stats;
                
                // Update counts
                document.getElementById('pendingCount').textContent = stats.pending;
                document.getElementById('sendingCount').textContent = stats.sending;
                document.getElementById('sentCount').textContent = stats.sent;
                document.getElementById('failedCount').textContent = stats.failed;
                
                // Calculate progress
                const total = stats.pending + stats.sending + stats.sent + stats.failed;
                const completed = stats.sent + stats.failed;
                const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                // Update progress bar
                document.getElementById('progressBar').style.width = percentage + '%';
                document.getElementById('progressText').textContent = percentage + '% Complete';
                
                // Auto-close when all emails are processed
                if (stats.pending === 0 && stats.sending === 0 && total > 0) {
                    setTimeout(() => {
                        closeEmailProgress();
                    }, 3000); // Close after 3 seconds
                }
            }
        } catch (error) {
            console.error('Error fetching email status:', error);
        }
    }
    
    async function viewTaskDetail(taskId) {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/api/tasks/admin/${taskId}/detail/`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) throw new Error('Failed to fetch task details');
            
            const task = await response.json();
            displayTaskDetail(task);
            document.getElementById('taskDetailModal').style.display = 'flex';
        } catch (error) {
            console.error('Error loading task details:', error);
            alert('Error loading task details.');
        }
    }
    
    function displayTaskDetail(task) {
        const deadline = new Date(task.deadline).toLocaleString();
        const isOverdue = task.is_overdue;
        
        const assignedUsers = task.assigned_users.map(user => {
            const statusColor = {
                'sent': 'text-green-400',
                'failed': 'text-red-400',
                'pending': 'text-yellow-400',
                'no_email': 'text-slate-400'
            }[user.email_status] || 'text-slate-400';
            
            const submissionStatus = user.submission_status === 'submitted' ? 
                '<span class="text-green-400">‚úì Submitted</span>' : 
                (user.is_overdue ? '<span class="text-red-400">‚ö† Overdue</span>' : '<span class="text-yellow-400">‚è≥ Pending</span>');
            
            return `
                <tr class="border-b border-slate-600">
                    <td class="py-2 px-3 text-sm text-white">${user.name}</td>
                    <td class="py-2 px-3 text-sm text-slate-300">${user.email}</td>
                    <td class="py-2 px-3 text-sm ${statusColor}">${user.email_status.replace('_', ' ').toUpperCase()}</td>
                    <td class="py-2 px-3 text-sm">${submissionStatus}</td>
                </tr>
            `;
        }).join('');
        
        document.getElementById('taskDetailContent').innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-lg font-semibold text-white mb-3">${task.title}</h4>
                    <div class="space-y-2 mb-4">
                        <p class="text-slate-300"><strong>Description:</strong> ${task.description}</p>
                        <p class="text-slate-300"><strong>Deadline:</strong> <span class="${isOverdue ? 'text-red-400' : 'text-white'}">${deadline} ${isOverdue ? '(OVERDUE)' : ''}</span></p>
                        <p class="text-slate-300"><strong>Status:</strong> <span class="text-white">${task.status.replace('_', ' ').toUpperCase()}</span></p>
                        <p class="text-slate-300"><strong>Created:</strong> ${new Date(task.created_at).toLocaleString()}</p>
                    </div>
                    
                    ${task.materials.length > 0 ? `
                        <div class="mb-4">
                            <h5 class="text-white font-medium mb-2">Materials:</h5>
                            <div class="space-y-1">
                                ${task.materials.map(m => `<a href="${m.url}" target="_blank" class="block text-blue-400 hover:underline text-sm"><i class="fas fa-file mr-1"></i>${m.filename}</a>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${task.task_links ? `
                        <div class="mb-4">
                            <h5 class="text-white font-medium mb-2">Helpful Links:</h5>
                            <div class="text-sm text-slate-300 whitespace-pre-line">${task.task_links}</div>
                        </div>
                    ` : ''}
                    
                    ${task.submission_text || task.submission_file ? `
                        <div class="bg-slate-700 p-3 rounded mb-4">
                            <h5 class="text-white font-medium mb-2">Submission:</h5>
                            ${task.submission_text ? `<p class="text-slate-300 text-sm mb-2">${task.submission_text}</p>` : ''}
                            ${task.submission_file ? `<a href="${task.submission_file}" target="_blank" class="text-green-400 hover:underline text-sm"><i class="fas fa-file mr-1"></i>View Submitted File</a>` : ''}
                        </div>
                    ` : ''}
                    
                    ${task.admin_feedback ? `
                        <div class="bg-slate-700 p-3 rounded">
                            <h5 class="text-white font-medium mb-2">Admin Feedback:</h5>
                            <p class="text-slate-300 text-sm">${task.admin_feedback}</p>
                        </div>
                    ` : ''}
                </div>
                
                <div>
                    <div class="bg-slate-700 p-4 rounded mb-4">
                        <h5 class="text-white font-medium mb-3">Email Statistics</h5>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-400">${task.email_stats.sent}</div>
                                <div class="text-slate-400">Sent</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-red-400">${task.email_stats.failed}</div>
                                <div class="text-slate-400">Failed</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-yellow-400">${task.email_stats.pending}</div>
                                <div class="text-slate-400">Pending</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-white">${task.email_stats.total}</div>
                                <div class="text-slate-400">Total</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-700 p-4 rounded">
                        <h5 class="text-white font-medium mb-3">Assigned Users (${task.assigned_users.length})</h5>
                        <div class="max-h-64 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-600">
                                    <tr>
                                        <th class="py-2 px-3 text-left text-slate-300">Name</th>
                                        <th class="py-2 px-3 text-left text-slate-300">Email</th>
                                        <th class="py-2 px-3 text-left text-slate-300">Email Status</th>
                                        <th class="py-2 px-3 text-left text-slate-300">Submission</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${assignedUsers}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function closeTaskDetailModal() {
        document.getElementById('taskDetailModal').style.display = 'none';
    }
    
    function closeEmailProgress() {
        document.getElementById('emailProgressFloat').style.display = 'none';
        if (emailProgressInterval) {
            clearInterval(emailProgressInterval);
            emailProgressInterval = null;
        }
    }
</script>
{% endblock %}