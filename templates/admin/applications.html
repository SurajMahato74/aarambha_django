{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Member Applications{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
    rel="stylesheet" />
<style>
    .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block page_title %}Applications{% endblock %}

{% block content %}
<div class="p-6">

    <!-- Filters -->
    <div class="bg-transparent p-4 rounded-lg mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <input type="text" id="searchInput" placeholder="Search by name, email..."
                class="px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white">
            <select id="statusFilter" class="px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="interview_scheduled">Interview Scheduled</option>
                <option value="rejected">Rejected</option>
                <option value="approved">Approved</option>
            </select>
            <select id="typeFilter" class="px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white">
                <option value="">All Types</option>
                <option value="member">Member</option>
                <option value="volunteer">Volunteer</option>
            </select>
            <select id="districtFilter" class="px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white">
                <option value="">All Districts</option>
            </select>
        </div>
    </div>

    <!-- Applications Table -->
    <div class="bg-transparent rounded-lg overflow-hidden">
        <table class="w-full">
            <thead class="bg-slate-700">
                <tr>
                    <th class="px-4 py-3 text-left text-white">Name</th>
                    <th class="px-4 py-3 text-left text-white">Type</th>
                    <th class="px-4 py-3 text-left text-white">Country</th>
                    <th class="px-4 py-3 text-left text-white">Phone</th>
                    <th class="px-4 py-3 text-left text-white">Status</th>
                    <th class="px-4 py-3 text-left text-white">Applied</th>
                    <th class="px-4 py-3 text-left text-white">Actions</th>
                </tr>
            </thead>
            <tbody id="applicationsTable" class="text-slate-300">
                <tr>
                    <td colspan="7" class="text-center py-8">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="flex justify-between items-center mt-4">
        <div class="text-slate-400" id="pageInfo"></div>
        <div class="flex gap-2" id="pagination"></div>
    </div>
</div>

<!-- View Application Modal -->
<div id="viewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-slate-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">Application Details</h2>
                <div class="flex items-center gap-2">
                    <button onclick="printApplication()"
                        class="px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 flex items-center gap-2"
                        title="Print">
                        <span class="material-symbols-outlined" style="font-size:20px">print</span>
                        <span class="text-sm">Print</span>
                    </button>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-white">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>
</div>

<!-- Interview Modal -->
<div id="interviewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-slate-800 rounded-lg max-w-md w-full p-6">
        <h2 class="text-xl font-bold text-white mb-4" id="interviewModalTitle">Schedule Interview</h2>
        <div class="space-y-4">
            <div>
                <label class="block text-sm text-slate-300 mb-1">Interview Date & Time *</label>
                <input type="datetime-local" id="interviewDatetime"
                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white">
            </div>
            <div>
                <label class="block text-sm text-slate-300 mb-1">Meeting Link</label>
                <input type="url" id="interviewLink" placeholder="https://meet.google.com/..."
                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white">
            </div>
            <div>
                <label class="block text-sm text-slate-300 mb-1">Description/Notes</label>
                <textarea id="interviewDescription" rows="3" placeholder="Additional details for the candidate..."
                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white"></textarea>
            </div>
            <div class="flex gap-2">
                <button onclick="scheduleInterview()" id="scheduleBtn"
                    class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Schedule</button>
                <button onclick="closeInterviewModal()" id="cancelBtn"
                    class="px-4 py-2 bg-slate-600 text-white rounded hover:bg-slate-700">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div id="rejectModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-slate-800 rounded-lg max-w-md w-full p-6">
        <h2 class="text-xl font-bold text-white mb-4">Reject Application</h2>
        <div class="space-y-4">
            <div>
                <label class="block text-sm text-slate-300 mb-1">Rejection Type *</label>
                <select id="rejectionType"
                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white">
                    <option value="correction">Correction Required</option>
                    <option value="final">Final Rejection</option>
                </select>
            </div>
            <div>
                <label class="block text-sm text-slate-300 mb-1">Reason for Rejection</label>
                <textarea id="rejectionReason" rows="4"
                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white"></textarea>
            </div>
            <div class="flex gap-2">
                <button onclick="rejectApplication()"
                    class="flex-1 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Reject</button>
                <button onclick="closeRejectModal()"
                    class="px-4 py-2 bg-slate-600 text-white rounded hover:bg-slate-700">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentPage = 1;
    let currentAppId = null;

    async function loadApplications() {
        const search = document.getElementById('searchInput').value;
        const status = document.getElementById('statusFilter').value;
        const type = document.getElementById('typeFilter').value;
        const district = document.getElementById('districtFilter').value;

        const params = new URLSearchParams({
            page: currentPage,
            search, status, type, district
        });

        const response = await fetchAPI(`/api/applications/list/?${params}`);
        const data = await response.json();

        const tbody = document.getElementById('applicationsTable');
        tbody.innerHTML = data.results.map(app => `
        <tr class="border-t border-slate-700">
            <td class="px-4 py-3">${app.full_name}</td>
            <td class="px-4 py-3">${app.application_type}</td>
            <td class="px-4 py-3">${app.country || 'Nepal'}${app.district && app.country === 'Nepal' ? ' - ' + app.district : ''}</td>
            <td class="px-4 py-3">${app.phone}</td>
            <td class="px-4 py-3">
                <span class="px-2 py-1 rounded text-xs ${getStatusColor(app.status)}">${app.status}</span>
            </td>
            <td class="px-4 py-3">${new Date(app.applied_at).toLocaleDateString()}</td>
            <td class="px-4 py-3">
                <div class="flex gap-2">
                    <button onclick="viewApplication(${app.id})" class="text-blue-400 hover:text-blue-300" title="View Details">
                        <span class="material-symbols-outlined" style="font-size:20px">visibility</span>
                    </button>
                    <button onclick="printApplicationDirect(${app.id})" class="text-purple-400 hover:text-purple-300" title="Print CV">
                        <span class="material-symbols-outlined" style="font-size:20px">print</span>
                    </button>
                    ${app.status === 'pending' ? `
                        <button onclick="openInterviewModal(${app.id})" class="text-green-400 hover:text-green-300" title="Schedule Interview">
                            <span class="material-symbols-outlined" style="font-size:20px">event</span>
                        </button>
                    ` : ''}
                    ${app.status === 'interview_scheduled' ? `
                        ${app.interview_acknowledged ? '<span class="text-green-400" title="User Acknowledged"><span class="material-symbols-outlined" style="font-size:20px">verified</span></span>' : '<span class="text-gray-500" title="Not Acknowledged Yet"><span class="material-symbols-outlined" style="font-size:20px">schedule</span></span>'}
                        <button onclick="openInterviewModal(${app.id}, true)" class="text-yellow-400 hover:text-yellow-300" title="Update Interview">
                            <span class="material-symbols-outlined" style="font-size:20px">edit_calendar</span>
                        </button>
                        <button onclick="markAttendance(${app.id}, true)" class="text-green-400 hover:text-green-300" title="Mark Attended">
                            <span class="material-symbols-outlined" style="font-size:20px">check_circle</span>
                        </button>
                        <button onclick="markAttendance(${app.id}, false)" class="text-red-400 hover:text-red-300" title="Mark Not Attended">
                            <span class="material-symbols-outlined" style="font-size:20px">cancel</span>
                        </button>
                    ` : ''}
                    <button onclick="approveApplication(${app.id})" class="text-emerald-400 hover:text-emerald-300" title="Approve">
                        <span class="material-symbols-outlined" style="font-size:20px">check_circle</span>
                    </button>
                    ${app.application_type === 'member' && app.is_upgrade && app.status !== 'approved' ? `
                        <button onclick="approveUpgrade(${app.id})" class="text-blue-400 hover:text-blue-300" title="Approve Upgrade">
                            <span class="material-symbols-outlined" style="font-size:20px">upgrade</span>
                        </button>
                    ` : ''}
                    ${app.status !== 'rejected' ? `
                        <button onclick="openRejectModal(${app.id})" class="text-red-400 hover:text-red-300" title="Reject">
                            <span class="material-symbols-outlined" style="font-size:20px">close</span>
                        </button>
                    ` : ''}
                    ${(app.status === 'approved' || app.status === 'rejected' || app.status === 'interview_scheduled') && !app.email_sent ? `
                        <button onclick="resendEmail(${app.id})" class="text-orange-400 hover:text-orange-300" title="Resend Email">
                            <span class="material-symbols-outlined" style="font-size:20px">mail</span>
                        </button>
                    ` : ''}
                </div>
            </td>
        </tr>
    `).join('');

        document.getElementById('pageInfo').textContent = `Showing ${data.results.length} of ${data.count}`;
    }

    function getStatusColor(status) {
        const colors = {
            pending: 'bg-yellow-600',
            interview_scheduled: 'bg-blue-600',
            rejected: 'bg-red-600',
            approved: 'bg-green-600'
        };
        return colors[status] || 'bg-gray-600';
    }

    async function viewApplication(id) {
        const response = await fetchAPI(`/api/applications/${id}/`);
        const app = await response.json();
        window.currentAppData = app;

        const skills = Array.isArray(app.skills) ? app.skills : [];
        const statusBadge = `<span class="px-3 py-1 rounded-full text-xs font-semibold ${getStatusColor(app.status)}">${app.status.replace('_', ' ').toUpperCase()}</span>`;

        document.getElementById('modalContent').innerHTML = `
        <div class="bg-gradient-to-br from-slate-700 to-slate-800 p-6 rounded-lg mb-6">
            <div class="flex items-start gap-6">
                ${app.photo ? `
                    <div class="flex-shrink-0">
                        <img src="${app.photo}" class="w-32 h-32 rounded-lg object-cover border-4 border-slate-600" />
                    </div>
                ` : ''}
                <div class="flex-1">
                    <h3 class="text-2xl font-bold text-white mb-2">${app.full_name}</h3>
                    <div class="flex items-center gap-3 mb-3">
                        <span class="text-slate-300">${app.user_email}</span>
                        ${app.user_is_active ? '<span class="px-2 py-0.5 bg-green-600 text-white text-xs rounded">✓ Verified</span>' : '<span class="px-2 py-0.5 bg-red-600 text-white text-xs rounded">Not Verified</span>'}
                        ${statusBadge}
                    </div>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-sm text-slate-300">
                        <div><span class="text-slate-400">Phone:</span> ${app.phone}</div>
                        <div><span class="text-slate-400">DOB:</span> ${app.date_of_birth || 'N/A'}</div>
                        <div><span class="text-slate-400">Country:</span> ${app.country || 'Nepal'}</div>
                        ${app.district ? `<div><span class="text-slate-400">District:</span> ${app.district}</div>` : ''}
                        <div><span class="text-slate-400">Type:</span> <span class="capitalize">${app.application_type}</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-5">
            <!-- Contact Information -->
            <div class="bg-slate-700/50 p-4 rounded-lg">
                <h4 class="text-white font-semibold mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-indigo-400" style="font-size:20px">home</span>
                    Contact Information
                </h4>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <p class="text-slate-400 text-xs mb-1">Temporary Address</p>
                        <p class="text-slate-200">${app.temporary_address}</p>
                    </div>
                    <div>
                        <p class="text-slate-400 text-xs mb-1">Permanent Address</p>
                        <p class="text-slate-200">${app.permanent_address}</p>
                    </div>
                    <div class="col-span-2">
                        <p class="text-slate-400 text-xs mb-1">Social Profile</p>
                        <a href="${app.social_link}" target="_blank" class="text-blue-400 hover:underline break-all">${app.social_link}</a>
                    </div>
                </div>
            </div>

            <!-- Professional Background -->
            <div class="bg-slate-700/50 p-4 rounded-lg">
                <h4 class="text-white font-semibold mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-indigo-400" style="font-size:20px">work</span>
                    Professional Background
                </h4>
                <p class="text-slate-200 text-sm leading-relaxed">${app.profession}</p>
            </div>

            <!-- Skills & Commitment -->
            <div class="bg-slate-700/50 p-4 rounded-lg">
                <h4 class="text-white font-semibold mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-indigo-400" style="font-size:20px">psychology</span>
                    Skills & Availability
                </h4>
                <div class="mb-3">
                    <p class="text-slate-400 text-xs mb-2">Skills</p>
                    <div class="flex flex-wrap gap-2">
                        ${skills.map(skill => `<span class="px-3 py-1 bg-indigo-600/30 text-indigo-300 rounded-full text-xs">${skill}</span>`).join('')}
                    </div>
                </div>
                <div>
                    <p class="text-slate-400 text-xs mb-1">Time Commitment</p>
                    <p class="text-slate-200 text-sm">${app.time_commitment}</p>
                </div>
            </div>

            <!-- Application Responses -->
            <div class="bg-slate-700/50 p-4 rounded-lg">
                <h4 class="text-white font-semibold mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-indigo-400" style="font-size:20px">description</span>
                    Application Responses
                </h4>
                <div class="space-y-3">
                    <div>
                        <p class="text-slate-400 text-xs mb-1">Why join Aarambha Foundation?</p>
                        <p class="text-slate-200 text-sm leading-relaxed">${app.why_join}</p>
                    </div>
                    <div>
                        <p class="text-slate-400 text-xs mb-1">Self Definition & Goals</p>
                        <p class="text-slate-200 text-sm leading-relaxed">${app.self_definition}</p>
                    </div>
                    <div>
                        <p class="text-slate-400 text-xs mb-1">Hobbies, Interests & Achievements</p>
                        <p class="text-slate-200 text-sm leading-relaxed">${app.hobbies_interests}</p>
                    </div>
                    ${app.ideas ? `
                        <div>
                            <p class="text-slate-400 text-xs mb-1">Ideas & Contributions</p>
                            <p class="text-slate-200 text-sm leading-relaxed">${app.ideas}</p>
                        </div>
                    ` : ''}
                    ${app.other_organizations ? `
                        <div>
                            <p class="text-slate-400 text-xs mb-1">Other Organizations & Expectations</p>
                            <p class="text-slate-200 text-sm leading-relaxed">${app.other_organizations}</p>
                        </div>
                    ` : ''}
                </div>
            </div>

            <!-- Documents -->
            <div class="bg-slate-700/50 p-4 rounded-lg">
                <h4 class="text-white font-semibold mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-indigo-400" style="font-size:20px">folder</span>
                    Attached Documents
                </h4>
                <div class="grid grid-cols-3 gap-4">
                    ${app.citizenship_front ? `
                        <div>
                            <p class="text-slate-400 text-xs mb-2">Citizenship Front</p>
                            <a href="${app.citizenship_front}" target="_blank" class="block">
                                <img src="${app.citizenship_front}" class="w-full h-40 object-cover rounded-lg border-2 border-slate-600 hover:border-indigo-400 transition" />
                            </a>
                        </div>
                    ` : ''}
                    ${app.citizenship_back ? `
                        <div>
                            <p class="text-slate-400 text-xs mb-2">Citizenship Back</p>
                            <a href="${app.citizenship_back}" target="_blank" class="block">
                                <img src="${app.citizenship_back}" class="w-full h-40 object-cover rounded-lg border-2 border-slate-600 hover:border-indigo-400 transition" />
                            </a>
                        </div>
                    ` : ''}
                </div>
            </div>

            <!-- Application Meta -->
            <div class="text-center text-slate-400 text-xs pt-4 border-t border-slate-700">
                Applied on ${new Date(app.applied_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
            </div>
        </div>
    `;
        document.getElementById('viewModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('viewModal').classList.add('hidden');
    }

    async function openInterviewModal(id, isUpdate = false) {
        currentAppId = id;
        document.getElementById('interviewModalTitle').textContent = isUpdate ? 'Update Interview' : 'Schedule Interview';

        if (isUpdate) {
            const response = await fetchAPI(`/api/applications/${id}/`);
            const app = await response.json();
            if (app.interview_datetime) {
                const dt = new Date(app.interview_datetime);
                document.getElementById('interviewDatetime').value = dt.toISOString().slice(0, 16);
            }
            document.getElementById('interviewLink').value = app.interview_link || '';
            document.getElementById('interviewDescription').value = app.interview_description || '';
        } else {
            document.getElementById('interviewDatetime').value = '';
            document.getElementById('interviewLink').value = '';
            document.getElementById('interviewDescription').value = '';
        }

        document.getElementById('interviewModal').classList.remove('hidden');
    }

    function closeInterviewModal() {
        document.getElementById('interviewModal').classList.add('hidden');
        currentAppId = null;
    }

    async function scheduleInterview() {
        const datetime = document.getElementById('interviewDatetime').value;
        const link = document.getElementById('interviewLink').value;
        const description = document.getElementById('interviewDescription').value;

        if (!datetime) {
            alert('Please select date and time');
            return;
        }

        // Show loading state
        const scheduleBtn = document.getElementById('scheduleBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        scheduleBtn.disabled = true;
        cancelBtn.disabled = true;
        scheduleBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size:16px; animation: spin 1s linear infinite;">refresh</span> Scheduling...';

        try {
            const response = await fetchAPI(`/api/applications/${currentAppId}/update-status/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    status: 'interview_scheduled',
                    interview_datetime: datetime,
                    interview_link: link,
                    interview_description: description
                })
            });

            if (response.ok) {
                const data = await response.json();
                if (data.email_sent) {
                    alert('Interview scheduled and email sent to candidate!');
                } else {
                    alert('Interview scheduled but email failed to send. Please check email configuration.');
                }
                closeInterviewModal();
                loadApplications();
            } else {
                alert('Failed to schedule interview');
            }
        } catch (error) {
            alert('An error occurred while scheduling the interview');
        } finally {
            // Reset loading state
            scheduleBtn.disabled = false;
            cancelBtn.disabled = false;
            scheduleBtn.innerHTML = 'Schedule';
        }
    }

    async function markAttendance(id, attended) {
        if (!confirm(`Mark as ${attended ? 'attended' : 'not attended'}?`)) return;

        const response = await fetchAPI(`/api/applications/${id}/update-status/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                interview_attended: attended
            })
        });

        if (response.ok) {
            alert(`Marked as ${attended ? 'attended' : 'not attended'}`);
            loadApplications();
        } else {
            alert('Failed to update attendance');
        }
    }

    async function approveApplication(id) {
        if (!confirm('Approve this application? User will receive login credentials via email.')) return;

        // Show loading state
        const approveBtn = document.querySelector(`button[onclick="approveApplication(${id})"]`);
        const originalText = approveBtn.innerHTML;
        approveBtn.disabled = true;
        approveBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size:16px; animation: spin 1s linear infinite;">refresh</span>';

        try {
            const response = await fetchAPI(`/api/applications/${id}/update-status/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    status: 'approved'
                })
            });

            if (response.ok) {
                const data = await response.json();
                if (data.email_sent) {
                    alert('Application approved! Credentials sent to user via email.');
                } else {
                    alert('Application approved but email failed to send. Please check email configuration.');
                }
                loadApplications();
            } else {
                alert('Failed to approve application');
            }
        } catch (error) {
            alert('An error occurred while approving the application');
        } finally {
            // Reset button state
            approveBtn.disabled = false;
            approveBtn.innerHTML = originalText;
        }
    }

    async function approveUpgrade(id) {
        if (!confirm('Approve this upgrade application? User will be upgraded from volunteer to member and will need to pay the membership fee.')) return;

        const response = await fetchAPI(`/api/applications/${id}/approve-upgrade/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
            const data = await response.json();
            if (data.email_sent) {
                alert('Upgrade approved! User has been upgraded to member and notification sent via email.');
            } else {
                alert('Upgrade approved but email failed to send. Please check email configuration.');
            }
            loadApplications();
        } else {
            alert('Failed to approve upgrade');
        }
    }

    function openRejectModal(id) {
        currentAppId = id;
        document.getElementById('rejectModal').classList.remove('hidden');
    }

    function closeRejectModal() {
        document.getElementById('rejectModal').classList.add('hidden');
        document.getElementById('rejectionType').value = 'correction';
        document.getElementById('rejectionReason').value = '';
        currentAppId = null;
    }

    async function rejectApplication() {
        const reason = document.getElementById('rejectionReason').value;
        const rejectionType = document.getElementById('rejectionType').value;

        // Show loading state
        const rejectBtn = document.querySelector('#rejectModal button[onclick="rejectApplication()"]');
        const cancelBtn = document.querySelector('#rejectModal button[onclick="closeRejectModal()"]');
        rejectBtn.disabled = true;
        cancelBtn.disabled = true;
        rejectBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size:16px; animation: spin 1s linear infinite;">refresh</span> Rejecting...';

        try {
            const response = await fetchAPI(`/api/applications/${currentAppId}/update-status/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    status: 'rejected',
                    rejection_reason: reason,
                    rejection_type: rejectionType
                })
            });

            if (response.ok) {
                const data = await response.json();
                if (data.email_sent) {
                    alert('Application rejected. Email sent to user.');
                } else {
                    alert('Application rejected but email failed to send.');
                    // Add resend email button to the row
                    addResendEmailButton(currentAppId);
                }
                closeRejectModal();
                loadApplications();
            } else {
                alert('Failed to reject application');
            }
        } catch (error) {
            alert('An error occurred while rejecting the application');
        } finally {
            // Reset loading state
            rejectBtn.disabled = false;
            cancelBtn.disabled = false;
            rejectBtn.innerHTML = 'Reject';
        }
    }

    document.getElementById('searchInput').addEventListener('input', () => { currentPage = 1; loadApplications(); });
    document.getElementById('statusFilter').addEventListener('change', () => { currentPage = 1; loadApplications(); });
    document.getElementById('typeFilter').addEventListener('change', () => { currentPage = 1; loadApplications(); });
    document.getElementById('districtFilter').addEventListener('change', () => { currentPage = 1; loadApplications(); });

    loadApplications();

    async function printApplicationDirect(id) {
        const response = await fetchAPI(`/api/applications/${id}/`);
        const app = await response.json();
        const skills = Array.isArray(app.skills) ? app.skills : [];

        const content = generatePrintContent(app, skills);
        openPrintWindow(content, app.full_name);
    }

    function printApplication() {
        const app = window.currentAppData;
        if (!app) return;
        const skills = Array.isArray(app.skills) ? app.skills : [];
        const content = generatePrintContent(app, skills);
        openPrintWindow(content, app.full_name);
    }

    function generatePrintContent(app, skills) {
        return '<div class="header">' +
            (app.photo ? '<img src="' + app.photo + '" alt="Photo"/>' : '') +
            '<div class="header-info"><h3>' + app.full_name + '</h3>' +
            '<p><strong>Email:</strong> ' + app.user_email + ' ' + (app.user_is_active ? '<span class="badge badge-verified">✓ Verified</span>' : '') + '</p>' +
            '<div class="info-grid">' +
            '<p><strong>Phone:</strong> ' + app.phone + '</p>' +
            '<p><strong>DOB:</strong> ' + (app.date_of_birth || 'N/A') + '</p>' +
            '<p><strong>Country:</strong> ' + (app.country || 'Nepal') + '</p>' +
            (app.district ? '<p><strong>District:</strong> ' + app.district + '</p>' : '') +
            '<p><strong>Type:</strong> ' + app.application_type + '</p>' +
            '</div></div></div>' +
            (app.status === 'interview_scheduled' && app.interview_acknowledged ? '<div style="background:#065f46;padding:8px;border-radius:4px;margin-bottom:10px"><p style="color:#10b981;font-size:12px;margin:0">✓ User has acknowledged the interview schedule</p></div>' : '') +
            '<div class="section"><h4>Contact Information</h4><div class="section-content">' +
            '<p class="label">Temporary Address</p><p class="value">' + app.temporary_address + '</p>' +
            '<p class="label">Permanent Address</p><p class="value">' + app.permanent_address + '</p>' +
            '<p class="label">Social Profile</p><p class="value">' + app.social_link + '</p>' +
            '</div></div>' +
            '<div class="section"><h4>Professional Background</h4><div class="section-content">' +
            '<p class="value">' + app.profession + '</p>' +
            '</div></div>' +
            '<div class="section"><h4>Skills & Availability</h4><div class="section-content">' +
            '<p class="label">Skills</p><div class="skills">' +
            skills.map(s => '<span class="skill-tag">' + s + '</span>').join('') +
            '</div><p class="label">Time Commitment</p><p class="value">' + app.time_commitment + '</p>' +
            '</div></div>' +
            '<div class="section"><h4>Application Responses</h4><div class="section-content">' +
            '<p class="label">Why join Aarambha Foundation?</p><p class="value">' + app.why_join + '</p>' +
            '<p class="label">Self Definition & Goals</p><p class="value">' + app.self_definition + '</p>' +
            '<p class="label">Hobbies, Interests & Achievements</p><p class="value">' + app.hobbies_interests + '</p>' +
            (app.ideas ? '<p class="label">Ideas & Contributions</p><p class="value">' + app.ideas + '</p>' : '') +
            (app.other_organizations ? '<p class="label">Other Organizations</p><p class="value">' + app.other_organizations + '</p>' : '') +
            '</div></div>' +
            (app.citizenship_front || app.citizenship_back ? '<div class="section"><h4>Documents</h4><div class="docs">' +
                (app.citizenship_front ? '<div class="doc-item"><p class="doc-label">Citizenship Front</p><img src="' + app.citizenship_front + '"/></div>' : '') +
                (app.citizenship_back ? '<div class="doc-item"><p class="doc-label">Citizenship Back</p><img src="' + app.citizenship_back + '"/></div>' : '') +
                '</div></div>' : '') +
            '<p style="text-align:center;margin-top:30px;font-size:11px;color:#64748b">Applied on ' + new Date(app.applied_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) + '</p>';
    }

    function openPrintWindow(content, name) {
        const title = name || 'Applicant';
        const printWindow = window.open('', '', 'width=800,height=600');
        const html = '<!DOCTYPE html><html><head><title>Application - ' + title + '</title>' +
            '<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>' +
            '<style>' +
            'body{font-family:Inter,sans-serif;padding:30px;background:white;color:#1e293b;line-height:1.6}' +
            '*{box-sizing:border-box}' +
            'h3{font-size:28px;margin:0 0 10px;color:#1e293b}' +
            'h4{font-size:16px;margin:20px 0 10px;color:#334155;font-weight:600;border-bottom:2px solid #e2e8f0;padding-bottom:5px}' +
            'img{max-width:150px;height:150px;object-fit:cover;border:3px solid #cbd5e1;border-radius:8px}' +
            'p{margin:5px 0;font-size:13px}' +
            '.header{display:flex;gap:20px;margin-bottom:25px;padding-bottom:20px;border-bottom:3px solid #334155}' +
            '.header img{flex-shrink:0}' +
            '.header-info{flex:1}' +
            '.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;font-size:12px}' +
            '.section{margin-bottom:20px;page-break-inside:avoid}' +
            '.section-content{padding:10px;background:#f8fafc;border-radius:6px}' +
            '.label{font-size:11px;color:#64748b;font-weight:500;margin-bottom:3px}' +
            '.value{font-size:13px;color:#1e293b}' +
            '.skills{display:flex;flex-wrap:wrap;gap:6px;margin-top:5px}' +
            '.skill-tag{display:inline-block;padding:4px 10px;background:#e0e7ff;color:#4338ca;border-radius:12px;font-size:11px}' +
            '.docs{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-top:10px}' +
            '.doc-item img{width:100%;height:200px;object-fit:cover;border:2px solid #cbd5e1;border-radius:6px}' +
            '.doc-label{font-size:11px;color:#64748b;margin-bottom:5px;font-weight:500}' +
            '.badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600}' +
            '.badge-verified{background:#dcfce7;color:#166534}' +
            '.badge-status{background:#fef3c7;color:#92400e}' +
            '@media print{body{padding:15px}h3{font-size:24px}img{max-width:120px;height:120px}.docs img{height:180px}}' +
            '</style>' +
            '</head><body>' + content + '<scr' + 'ipt>window.onload=function(){window.print()}</scr' + 'ipt></body></html>';
        printWindow.document.write(html);
        printWindow.document.close();
    }

    async function resendEmail(id) {
        if (!confirm('Resend email notification to the user?')) return;

        try {
            const response = await fetchAPI(`/api/applications/${id}/resend-email/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (response.ok) {
                alert('Email sent successfully!');
                loadApplications();
            } else {
                const data = await response.json();
                alert('Failed to send email: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Network error occurred while sending email');
        }
    }
</script>
{% endblock %}