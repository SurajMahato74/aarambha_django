{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Birthday Campaigns Management{% endblock %}

{% block content %}
<div class="bg-slate-800 rounded-lg p-6">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-xl font-semibold text-white flex items-center gap-2">
      <i class="fas fa-birthday-cake"></i>Birthday Campaigns Management
    </h2>
    <div class="flex gap-2">
      <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg" onclick="showCreateForm()">
        <i class="fas fa-plus mr-2"></i>Create Campaign
      </button>

      <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg" onclick="location.reload()">
        <i class="fas fa-sync-alt mr-2"></i>Refresh
      </button>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-lg p-4 text-white text-center">
      <i class="fas fa-gift text-2xl mb-2"></i>
      <h3 class="text-2xl font-bold">{{ stats.total_campaigns }}</h3>
      <p class="text-sm opacity-90">Total Campaigns</p>
    </div>
    <div class="bg-gradient-to-r from-green-500 to-teal-600 rounded-lg p-4 text-white text-center">
      <i class="fas fa-play-circle text-2xl mb-2"></i>
      <h3 class="text-2xl font-bold">{{ stats.active_campaigns }}</h3>
      <p class="text-sm opacity-90">Active Campaigns</p>
    </div>
    <div class="bg-gradient-to-r from-yellow-500 to-orange-600 rounded-lg p-4 text-white text-center">
      <i class="fas fa-money-bill-wave text-2xl mb-2"></i>
      <h3 class="text-2xl font-bold">Rs. {{ stats.total_raised|floatformat:0 }}</h3>
      <p class="text-sm opacity-90">Total Raised</p>
    </div>
    <div class="bg-gradient-to-r from-pink-500 to-red-600 rounded-lg p-4 text-white text-center">
      <i class="fas fa-users text-2xl mb-2"></i>
      <h3 class="text-2xl font-bold">{{ stats.total_donors }}</h3>
      <p class="text-sm opacity-90">Total Donors</p>
    </div>
  </div>

  <!-- Campaigns List -->
  <div class="bg-slate-700 rounded-lg">
    <div class="p-4 border-b border-slate-600">
      <h5 class="text-lg font-medium text-white">Birthday Campaigns</h5>
    </div>
    <div class="p-4">
      {% if campaigns %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {% for campaign in campaigns %}
            <div class="bg-slate-600 rounded-lg p-4 hover:bg-slate-500 transition-colors">
              <div class="flex justify-between items-start mb-2">
                <h6 class="text-white font-medium">{{ campaign.title }}</h6>
                <span class="bg-{% if campaign.status == 'active' %}green{% elif campaign.status == 'completed' %}blue{% else %}red{% endif %}-500 text-white px-2 py-1 rounded text-xs">
                  {{ campaign.status|title }}
                </span>
              </div>
              <p class="text-slate-300 text-sm mb-2">by {{ campaign.full_name }}</p>
              <p class="text-slate-400 text-xs mb-3">{{ campaign.description|striptags|truncatechars:80 }}</p>
              
              <div class="mb-3">
                <div class="flex justify-between text-xs text-slate-300 mb-1">
                  <span>Progress</span>
                  <span>Rs. {{ campaign.current_amount|floatformat:0 }} / Rs. {{ campaign.target_amount|floatformat:0 }}</span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-2">
                  <div class="{% if campaign.progress_percentage >= 100 %}bg-green-500{% elif campaign.progress_percentage >= 50 %}bg-yellow-500{% else %}bg-blue-500{% endif %} h-2 rounded-full" style="width: {{ campaign.progress_percentage }}%"></div>
                </div>
                <div class="flex justify-between text-xs text-slate-400 mt-1">
                  <span>{{ campaign.donors_count }} donors</span>
                  <span>{{ campaign.progress_percentage|floatformat:0 }}%</span>
                </div>
              </div>
              
              <div class="flex justify-between items-center mb-2">
                <small class="text-slate-400">
                  <i class="fas fa-calendar mr-1"></i>
                  {{ campaign.birthday_date }}
                </small>
                <a href="/birthday-campaign/{{ campaign.id }}/" target="_blank" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-xs">
                  <i class="fas fa-eye mr-1"></i>View
                </a>
              </div>
              
              <!-- Donate Button -->
              <div class="mt-2">
                <button onclick="showDonateModal({{ campaign.id }}, '{{ campaign.title|escapejs }}', '{{ campaign.full_name|escapejs }}')" class="w-full bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm font-medium">
                  <i class="fas fa-heart mr-2"></i>Donate to Campaign
                </button>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center py-8">
          <i class="fas fa-birthday-cake text-3xl text-slate-500 mb-3"></i>
          <h5 class="text-lg text-slate-400">No campaigns found</h5>
          <p class="text-slate-500">No birthday campaigns have been created yet.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Create Campaign Modal -->
<div id="createCampaignModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-slate-800 rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-white">üéÇ Create Birthday Campaign</h3>
          <button onclick="hideCreateForm()" class="text-slate-400 hover:text-white">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <form id="campaignForm" class="space-y-4">
          {% csrf_token %}
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-slate-300 text-sm font-medium mb-2">Full Name *</label>
              <input type="text" name="full_name" required class="w-full p-2 bg-slate-700 text-white rounded border border-slate-600 focus:border-indigo-500">
            </div>
            <div>
              <label class="block text-slate-300 text-sm font-medium mb-2">Email *</label>
              <input type="email" name="email" required class="w-full p-2 bg-slate-700 text-white rounded border border-slate-600 focus:border-indigo-500">
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-slate-300 text-sm font-medium mb-2">Phone *</label>
              <input type="tel" name="phone" required class="w-full p-2 bg-slate-700 text-white rounded border border-slate-600 focus:border-indigo-500">
            </div>
            <div>
              <label class="block text-slate-300 text-sm font-medium mb-2">Birthday Date *</label>
              <input type="date" name="birthday_date" required class="w-full p-2 bg-slate-700 text-white rounded border border-slate-600 focus:border-indigo-500">
            </div>
          </div>
          
          <div>
            <label class="block text-slate-300 text-sm font-medium mb-2">Campaign Title *</label>
            <input type="text" name="title" required placeholder="e.g., Help me celebrate by supporting education" class="w-full p-2 bg-slate-700 text-white rounded border border-slate-600 focus:border-indigo-500">
          </div>
          
          <div>
            <label class="block text-slate-300 text-sm font-medium mb-2">Target Amount (NPR) *</label>
            <input type="number" name="target_amount" min="1000" step="100" required class="w-full p-2 bg-slate-700 text-white rounded border border-slate-600 focus:border-indigo-500">
          </div>
          
          <div>
            <label class="block text-slate-300 text-sm font-medium mb-2">Campaign Description *</label>
            <textarea name="description" rows="4" required placeholder="Tell the story and why this cause matters..." class="w-full p-2 bg-slate-700 text-white rounded border border-slate-600 focus:border-indigo-500"></textarea>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-slate-300 text-sm font-medium mb-2">Profile Photo</label>
              <input type="file" name="profile_photo" accept="image/*" class="w-full p-2 bg-slate-700 text-white rounded border border-slate-600 focus:border-indigo-500">
            </div>
            <div>
              <label class="block text-slate-300 text-sm font-medium mb-2">Campaign Photo</label>
              <input type="file" name="photo" accept="image/*" class="w-full p-2 bg-slate-700 text-white rounded border border-slate-600 focus:border-indigo-500">
            </div>
          </div>
          
          <div class="flex justify-end gap-3 pt-4">
            <button type="button" onclick="hideCreateForm()" class="bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded">
              Cancel
            </button>
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
              <i class="fas fa-rocket mr-2"></i>Create Campaign
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Donate to Campaign Modal -->
<div id="donateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-slate-800 rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-white">üíù Donate to Campaign</h3>
          <button onclick="hideDonateModal()" class="text-slate-400 hover:text-white">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <div class="mb-4 p-3 bg-slate-700 rounded">
          <h4 id="donate-campaign-title" class="text-white font-medium">Campaign Title</h4>
          <p id="donate-campaign-organizer" class="text-slate-300 text-sm">by Campaign Organizer</p>
        </div>
        
        <form id="donateForm" class="space-y-4">
          {% csrf_token %}
          <input type="hidden" id="donate-campaign-id" name="campaign_id" value="">
          
          <div>
            <label class="block text-slate-300 text-sm font-medium mb-2">Your Name *</label>
            <input type="text" name="donor_name" required placeholder="Enter your full name" class="w-full p-2 bg-slate-700 text-white rounded border border-slate-600 focus:border-green-500">
          </div>
          
          <div>
            <label class="block text-slate-300 text-sm font-medium mb-2">Email Address *</label>
            <input type="email" name="donor_email" required placeholder="Enter your email" class="w-full p-2 bg-slate-700 text-white rounded border border-slate-600 focus:border-green-500">
          </div>
          
          <div>
            <label class="block text-slate-300 text-sm font-medium mb-2">Phone Number</label>
            <input type="tel" name="donor_phone" placeholder="Enter your phone number" class="w-full p-2 bg-slate-700 text-white rounded border border-slate-600 focus:border-green-500">
          </div>
          
          <div>
            <label class="block text-slate-300 text-sm font-medium mb-2">Donation Amount (NPR) *</label>
            <input type="number" name="amount" min="100" step="10" required placeholder="Minimum Rs. 100" class="w-full p-2 bg-slate-700 text-white rounded border border-slate-600 focus:border-green-500">
          </div>
          
          <div>
            <label class="block text-slate-300 text-sm font-medium mb-2">Message (Optional)</label>
            <textarea name="message" rows="3" placeholder="Leave a message for the birthday person..." class="w-full p-2 bg-slate-700 text-white rounded border border-slate-600 focus:border-green-500"></textarea>
          </div>
          
          <div class="flex items-center">
            <input type="checkbox" name="is_anonymous" id="is_anonymous" class="mr-2">
            <label for="is_anonymous" class="text-slate-300 text-sm">Donate anonymously</label>
          </div>
          
          <div class="flex justify-end gap-3 pt-4">
            <button type="button" onclick="hideDonateModal()" class="bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded">
              Cancel
            </button>
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
              <i class="fas fa-save mr-2"></i>Save Donation
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function showCreateForm() {
  document.getElementById('createCampaignModal').classList.remove('hidden');
}

function hideCreateForm() {
  document.getElementById('createCampaignModal').classList.add('hidden');
  document.getElementById('campaignForm').reset();
}

function showDonateModal(campaignId, campaignTitle, campaignOrganizer) {
  document.getElementById('donateModal').classList.remove('hidden');
  document.getElementById('donate-campaign-id').value = campaignId;
  document.getElementById('donate-campaign-title').textContent = campaignTitle;
  document.getElementById('donate-campaign-organizer').textContent = 'by ' + campaignOrganizer;
  
  // Fetch campaign details to auto-fill form
  fetch(`/api/applications/birthday-campaign/${campaignId}/`)
    .then(response => response.json())
    .then(data => {
      document.querySelector('input[name="donor_name"]').value = data.full_name || '';
      document.querySelector('input[name="donor_email"]').value = data.email || '';
      document.querySelector('input[name="donor_phone"]').value = data.phone || '';
    })
    .catch(error => console.log('Could not fetch campaign details'));
}

function hideDonateModal() {
  document.getElementById('donateModal').classList.add('hidden');
  document.getElementById('donateForm').reset();
}

document.getElementById('campaignForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
  
  try {
    const response = await fetch('/api/applications/birthday-campaign/create/', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      hideCreateForm();
      alert('Campaign created successfully!');
      location.reload();
    } else {
      alert('Error: ' + (data.error || 'Failed to create campaign'));
    }
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
  }
});

document.getElementById('donateForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const campaignId = document.getElementById('donate-campaign-id').value;
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  
  // Validate minimum amount
  const amount = parseFloat(formData.get('amount'));
  if (amount < 100) {
    alert('Minimum donation amount is Rs. 100');
    return;
  }
  
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
  
  try {
    const response = await fetch('/api/applications/donation-record/create/', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      hideDonateModal();
      alert('Donation recorded successfully!');
      location.reload();
    } else {
      alert('Error: ' + (data.error || 'Failed to record donation'));
    }
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
  }
});

// Auto-refresh campaign data every 30 seconds to show updated amounts
setInterval(function() {
  location.reload();
}, 30000);
</script>
{% endblock %}