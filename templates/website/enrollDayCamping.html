{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
  <link href="{% static 'website/css/bootstrap.min.css' %}" rel="stylesheet" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="{% static 'website/css/slick.min.css' %}" crossorigin="anonymous"
    referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="{% static 'website/css/owl.carousel.min.css' %}" />
  <!-- Link Swiper's CSS -->
  <link rel="stylesheet" href="{% static 'website/css/swiper-bundle.min.css' %}" />
  <!-- Link Swiper's CSS end-->
  <link rel="stylesheet" href="{% static 'website/css/animate.min.css' %}" />
  <!-- custom-css  -->
  <link rel="stylesheet" href="{% static 'website/css/index.css' %}" />
  <link rel="stylesheet" href="{% static 'website/css/style.css' %}" />
  <!-- custom-css end -->
  <link rel="icon" type="image.png" href="{% static 'website/images/favicon.png' %}" />
  <title>Aarambha Foundation &#8211; Our Beginning for the Change</title>
  <style>
    .privacy ul {
      padding-left: 20px;

    }

    .privacy ul li {
      list-style: dotted;
      margin: 10px 0;
    }
  </style>
  
</head>

<body>
  {% include 'website/includes/navbar.html'%}
  {% include 'website/includes/navbar_login_modal.html'%}
 <section id="one-rupee-campaign" class="py-3 campaign-bg-1">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h3 class=" fw-bold text-primary">Enroll in One Rupee a Day Campaign</h3>
                    <p class=" mt-4">Your small daily contribution of just <strong>Rs 1 per day</strong> (Rs 365 per year) can transform a child's life by providing access to quality education, school supplies, and support to prevent dropouts.</p>
                    <p>At Aarambha Foundation, we believe that every child deserves the light of education. With your support through the One Rupee a Day Campaign, we can clear school fees, distribute stationery, and empower children in rural Nepal to stay in school and dream big.</p>
                    <ul class="list-unstyled mt-4">
                        <li class="mb-3"><strong>Impact:</strong> Sponsor education for underprivileged children in Nepal.</li>
                        <li class="mb-3"><strong>Easy Recurring Donation:</strong> Set up automatic daily/monthly contributions.</li>
                        <li class="mb-3"><strong>Transparent:</strong> Regular updates on how your contribution is making a difference.</li>
                    </ul>
                     <div id="campaignActionButton">
                        <a href="javascript:void(0)" onclick="handleCampaignAction()"
                          class="btn py-2" style="font-size:13px; background-color: white; color: white; border: 1px solid #ccc;" id="mainActionBtn">Enroll Now & Donate</a>
                     </div>
                </div>
                <div class="col-lg-6 text-center">
                    <img src="{% static 'website/images/mission.png' %}" alt="Children learning in school" class="img-fluid rounded shadow-sm">
                    <p class="mt-3 text-muted">Children supported by Aarambha Foundation's education programs</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Campaign Enrollment Modal -->
    <div class="modal fade" id="campaignEnrollModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content" style="background-color: white; color: black; border: 1px solid #ccc;">
                <div class="modal-header">
                    <h5 class="modal-title">Enroll in One Rupee a Day Campaign</h5>
                    <button type="button" class="close" onclick="closeEnrollModal()">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="campaignEnrollForm">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Full Name *</label>
                                    <input type="text" class="form-control" name="full_name" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Email *</label>
                                    <input type="email" class="form-control" name="email" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" class="form-control" name="phone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Country</label>
                                    <input type="text" class="form-control" name="country" value="Nepal">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>City</label>
                                    <input type="text" class="form-control" name="city">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Occupation</label>
                                    <input type="text" class="form-control" name="occupation">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Address</label>
                                    <textarea class="form-control" name="address" rows="2"></textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Organization</label>
                                    <input type="text" class="form-control" name="organization">
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <strong>Annual Contribution:</strong> Rs. 365 (Rs. 1 per day)<br>
                            <small>You will be redirected to payment gateway to complete your first year contribution.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEnrollModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitEnrollment()">Enroll & Pay Rs. 365</button>
                </div>
            </div>
        </div>
    </div>

  {% include "website/includes/login_modal.html" %}

  {% include "website/includes/footer.html" %}
  <!-- scripts start -->
  <!-- jquery  start-->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"
    referrerpolicy="no-referrer"></script>
  <!-- jquery end -->
  <!-- bootstrap  start -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
    crossorigin="anonymous"></script>
  <!-- bootstrap end -->
  <script src="{% static 'website/js/slick.min.js' %}" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- Swiper JS -->
  <script src="{% static 'website/js/swiper-bundle.min.js' %}" crossorigin="anonymous"
    referrerpolicy="no-referrer"></script>
  <script src="{% static 'website/js/modernizr.min.js' %}" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script>
  <script src="{% static 'website/js/owl.carousel.min.js' %}"></script>
  <script src="{% static 'website/js/api.js' %}"></script>
  <script src="{% static 'website/js/main.js' %}"></script>
  <script src="{% static 'website/js/animation.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="{% static 'website/js/general.js' %}"></script>
  <script src="{% static 'website/js/nav.js' %}"></script>
  <script src="{% static 'website/js/script.js' %}"></script>
  <script src="{% static 'website/js/min.js' %}"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  {% comment %} <script src="{% static 'js/navbar.js' %}"></script> {% endcomment %}
  <script src="{% static 'js/config.js' %}"></script>
  
  <script type="application/json" id="django-user-data">
  {% if user.is_authenticated %}
  {"isAuthenticated": true, "email": "{{ user.email }}", "id": {{ user.id }}, "first_name": "{{ user.first_name }}", "last_name": "{{ user.last_name }}"}
  {% else %}
  {"isAuthenticated": false, "email": null}
  {% endif %}
  </script>
  
  <script>
  // Set user info for JavaScript
  window.djangoUser = JSON.parse(document.getElementById('django-user-data').textContent);
  let currentCampaignId = null;
  
  document.addEventListener('DOMContentLoaded', function() {
      checkCampaignStatus();
  });
  
  async function checkCampaignStatus() {
      try {
          const response = await fetchAPI('/api/applications/my-campaign-status/');
          const data = await response.json();
          
          if (data.enrolled) {
              // User is enrolled, show track campaign button
              document.getElementById('mainActionBtn').innerHTML = '<i class="fas fa-chart-line mr-2"></i>Track Campaign';
              document.getElementById('mainActionBtn').onclick = function() { showCampaignDashboard(data); };
              currentCampaignId = data.campaign.id;
          }
      } catch (error) {
          // User not logged in or not enrolled, keep default button
          console.log('User not enrolled or not logged in');
      }
  }
  
  function handleCampaignAction() {
      if (!isLoggedIn()) {
          // Show navbar login modal
          document.getElementById('navbarLoginModal').style.display = 'flex';
      } else {
          showEnrollmentForm();
      }
  }
  
  async function showEnrollmentForm() {
      try {
          // Check if already enrolled
          const response = await fetchAPI('/api/applications/my-campaign-status/');
          const data = await response.json();
          
          if (data.enrolled) {
              alert('You are already enrolled in the One Rupee a Day Campaign!');
              showCampaignDashboard(data);
              return;
          }
      } catch (error) {
          // Not enrolled, continue with enrollment
      }
      
      // Pre-fill form with user data if available
      try {
          const userResponse = await fetchAPI('/api/applications/my-applications/');
          const applications = await userResponse.json();
          
          if (applications.length > 0) {
              const app = applications[0];
              document.querySelector('[name="full_name"]').value = app.full_name || '';
              document.querySelector('[name="email"]').value = app.user_email || '';
              document.querySelector('[name="phone"]').value = app.phone || '';
              document.querySelector('[name="country"]').value = app.country || 'Nepal';
          }
      } catch (error) {
          // Use current user email if available
          const currentUser = getCurrentUser();
          if (currentUser) {
              document.querySelector('[name="email"]').value = currentUser.email || '';
              document.querySelector('[name="full_name"]').value = (currentUser.first_name + ' ' + currentUser.last_name).trim() || '';
          }
      }
      
      // Show modal using Bootstrap 4 method
      const modal = document.getElementById('campaignEnrollModal');
      if (typeof $ !== 'undefined' && $.fn.modal) {
          $('#campaignEnrollModal').modal('show');
      } else {
          // Fallback to vanilla JS
          modal.style.display = 'block';
          modal.classList.add('show');
          document.body.classList.add('modal-open');
      }
  }
  
  function closeEnrollModal() {
      const modal = document.getElementById('campaignEnrollModal');
      if (typeof $ !== 'undefined' && $.fn.modal) {
          $('#campaignEnrollModal').modal('hide');
      } else {
          modal.style.display = 'none';
          modal.classList.remove('show');
          document.body.classList.remove('modal-open');
      }
  }
  
  async function submitEnrollment() {
      const form = document.getElementById('campaignEnrollForm');
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      
      try {
          const token = localStorage.getItem('access_token');
          const csrfToken = getCookie('csrftoken');
          
          const headers = {
              'Content-Type': 'application/json',
          };
          
          if (token) {
              headers['Authorization'] = `Bearer ${token}`;
          }
          
          if (csrfToken) {
              headers['X-CSRFToken'] = csrfToken;
          }
          
          const response = await fetch('/api/applications/one-rupee-campaign/enroll/', {
              method: 'POST',
              headers: headers,
              body: JSON.stringify(data),
              credentials: 'include'
          });
          
          if (response.ok) {
              const result = await response.json();
              currentCampaignId = result.campaign_id;
              
              // Hide modal
              const modal = document.getElementById('campaignEnrollModal');
              if (typeof $ !== 'undefined' && $.fn.modal) {
                  $('#campaignEnrollModal').modal('hide');
              } else {
                  modal.style.display = 'none';
                  modal.classList.remove('show');
                  document.body.classList.remove('modal-open');
              }
              
              // Initiate payment
              initiatePayment(currentCampaignId);
          } else {
              const error = await response.json();
              alert('Error: ' + (error.error || 'Enrollment failed'));
          }
      } catch (error) {
          console.error('Enrollment error:', error);
          alert('Error during enrollment');
      }
  }
  
  async function initiatePayment(campaignId) {
      try {
          const token = localStorage.getItem('access_token');
          const csrfToken = getCookie('csrftoken');
          
          const headers = {
              'Content-Type': 'application/json',
          };
          
          if (token) {
              headers['Authorization'] = `Bearer ${token}`;
          }
          
          if (csrfToken) {
              headers['X-CSRFToken'] = csrfToken;
          }
          
          const response = await fetch(`/api/applications/one-rupee-campaign/${campaignId}/initiate-payment/`, {
              method: 'POST',
              headers: headers,
              credentials: 'include'
          });
          
          if (response.ok) {
              const data = await response.json();
              
              if (data.success && data.payment_url) {
                  // Redirect to Khalti payment page
                  window.location.href = data.payment_url;
              } else {
                  alert('Failed to initiate payment');
              }
          } else {
              const error = await response.json();
              alert('Error: ' + (error.error || 'Payment initiation failed'));
          }
      } catch (error) {
          console.error('Payment error:', error);
          alert('Error initiating payment');
      }
  }
  
  function showCampaignDashboard(data) {
      const currentYear = new Date().getFullYear();
      const currentYearPayment = data.payments.find(p => p.year == currentYear);
      const hasCurrentYearPayment = currentYearPayment && currentYearPayment.status === 'completed';
      
      let paymentsHtml = '';
      if (data.payments && data.payments.length > 0) {
          paymentsHtml = data.payments.map(payment => `
              <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                  <div>
                      <strong>Year ${payment.year}</strong><br>
                      <small class="text-muted">Rs. ${payment.amount}</small>
                  </div>
                  <div>
                      <span class="badge badge-${payment.status === 'completed' ? 'success' : payment.status === 'pending' ? 'warning' : 'danger'}">
                          ${payment.status.charAt(0).toUpperCase() + payment.status.slice(1)}
                      </span>
                  </div>
              </div>
          `).join('');
      } else {
          paymentsHtml = '<p class="text-muted">No payments yet</p>';
      }
      
      // Add current year payment status if not paid
      if (!hasCurrentYearPayment) {
          paymentsHtml = `
              <div class="alert alert-warning mb-3">
                  <strong>No payment for ${currentYear} due</strong><br>
                  <small>Please make your payment for this year to continue supporting children's education.</small>
              </div>
              ${paymentsHtml}
          `;
      }
      
      Swal.fire({
          title: 'Your One Rupee Campaign',
          html: `
              <div class="text-left">
                  <div class="row mb-3">
                      <div class="col-6">
                          <div class="card bg-light">
                              <div class="card-body text-center">
                                  <h5 class="card-title">Rs. ${data.campaign.total_paid}</h5>
                                  <p class="card-text small">Total Contributed</p>
                              </div>
                          </div>
                      </div>
                      <div class="col-6">
                          <div class="card bg-light">
                              <div class="card-body text-center">
                                  <h5 class="card-title">${data.campaign.payments_count}</h5>
                                  <p class="card-text small">Years Contributed</p>
                              </div>
                          </div>
                      </div>
                  </div>
                  <h6>Payment History:</h6>
                  <div class="mb-3" style="max-height: 200px; overflow-y: auto;">
                      ${paymentsHtml}
                  </div>
                  <div class="text-center">
                      ${hasCurrentYearPayment ? 
                          '<p class="text-success"><i class="fas fa-check-circle"></i> Payment completed for this year</p>' : 
                          '<button class="btn btn-primary btn-sm" onclick="makeNewPayment()">Make This Year\'s Payment</button>'
                      }
                  </div>
              </div>
          `,
          width: '500px',
          showCloseButton: true,
          showConfirmButton: false
      });
  }
  
  function makeNewPayment() {
      if (currentCampaignId) {
          Swal.close();
          initiatePayment(currentCampaignId);
      }
  }
  
  function isLoggedIn() {
      // Check both localStorage token and Django session
      const hasToken = localStorage.getItem('access_token') !== null;
      const hasDjangoSession = window.djangoUser && window.djangoUser.isAuthenticated;
      return hasToken || hasDjangoSession;
  }
  
  function getCurrentUser() {
      // First try localStorage
      const userData = localStorage.getItem('user_data');
      if (userData) {
          return JSON.parse(userData);
      }
      
      // Fall back to Django session data
      if (window.djangoUser && window.djangoUser.isAuthenticated) {
          return window.djangoUser;
      }
      
      return null;
  }
  
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  </script>
</body>

</html>