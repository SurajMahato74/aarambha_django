{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
  <link href="{% static 'website/css/bootstrap.min.css' %}" rel="stylesheet" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="{% static 'website/css/slick.min.css' %}" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="{% static 'website/css/owl.carousel.min.css' %}" />
  <link rel="stylesheet" href="{% static 'website/css/swiper-bundle.min.css' %}" />
  <link rel="stylesheet" href="{% static 'website/css/animate.min.css' %}" />
  <link rel="stylesheet" href="{% static 'website/css/index.css' %}" />
  <link rel="stylesheet" href="{% static 'website/css/style.css' %}" />
  <link rel="icon" type="image.png" href="{% static 'website/images/favicon.png' %}" />
  <title>Celebrate Your Birthday - Aarambha Foundation</title>
  <style>
    .modal {
      display: none;
      position: fixed;
      z-index: 100010;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: rgba(0,0,0,0.5);
    }
    .modal.show {
      display: block !important;
    }
    .modal-dialog {
      position: relative;
      width: auto;
      margin: 1.75rem;
      pointer-events: none;
    }
    .modal-content {
      position: relative;
      display: flex;
      flex-direction: column;
      width: 100%;
      pointer-events: auto;
      background-color: #fff;
      border: 1px solid rgba(0,0,0,.2);
      border-radius: 0.3rem;
      box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,.5);
    }
    @media (min-width: 576px) {
      .modal-dialog {
        max-width: 500px;
        margin: 1.75rem auto;
      }
    }
    @media (min-width: 992px) {
      .modal-lg {
        max-width: 800px;
      }
    }
    .modal-backdrop {
      z-index: 100009;
    }
    .modal-body {
      max-height: 70vh;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  {% include 'website/includes/navbar.html' %}
  {% include 'website/includes/navbar_login_modal.html' %}

  <!-- Hero Section -->
  <section class="split-banner">
    <div class="full-width">
      <div class="split-banner__content split-banner__content--image-on-left theme--orange">
        <div class="split-banner__text">
          <h2 class="split-banner__title">ðŸŽ‰ Celebrate Your Birthday with Purpose</h2>
          <div class="max-text-width">
            <div class="rich-text">
              <p>Turn your special day into a life-changing moment for children in need. Create a birthday fundraiser and invite friends to donate instead of giving gifts!</p>
            </div>
          </div>
          <div class="d-flex gap-3 flex-wrap">
            <a href="javascript:void(0)" onclick="scrollToActiveCampaigns()" class="btn btn--orange-white">
              <i class="fas fa-heart me-2"></i>Support Active Campaigns
            </a>
          </div>
        </div>
        <div class="split-banner__image">
          <img src="{% static 'website/images/health.jpg' %}" alt="Birthday Celebration" loading="lazy" fetchpriority="auto" decoding="async" />
        </div>
      </div>
    </div>
  </section>



  <!-- Active Campaigns -->
  <section id="active-campaigns" class="events">
    <div class="vission__content wow fadeInUp" data-wow-duration="1s" data-wow-delay="0.2s">
      <div class="d-flex justify-content-center">
        <h1 class="py-0 my-0">ACTIVE BIRTHDAY CAMPAIGNS</h1>
      </div>
    </div>
    <div class="card-group card-group--blue-dark">
      <div class="container">
        <ul id="campaigns-container" class="grid--3-col card-group__items">
          <!-- Campaigns will be loaded here -->
        </ul>
        <div id="no-campaigns" class="text-center py-5" style="display: none;">
          <i class="fas fa-birthday-cake fa-3x text-muted mb-3"></i>
          <h4 class="text-muted">No active campaigns yet</h4>
          <p class="text-muted">Be the first to create a birthday campaign!</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Create Campaign Modal -->
  <div class="modal fade" id="createCampaignModal" tabindex="-1" style="display: none;">
    <!-- Modal content removed - campaigns now created from admin -->
  </div>

  {% include "website/includes/login_modal.html" %}
  {% include "website/includes/footer.html" %}

  <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="{% static 'website/js/slick.min.js' %}" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="{% static 'website/js/swiper-bundle.min.js' %}" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="{% static 'website/js/modernizr.min.js' %}" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script>
  <script src="{% static 'website/js/owl.carousel.min.js' %}"></script>
  <script src="{% static 'website/js/api.js' %}"></script>
  <script src="{% static 'website/js/main.js' %}"></script>
  <script src="{% static 'website/js/animation.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="{% static 'website/js/general.js' %}"></script>
  <script src="{% static 'website/js/nav.js' %}"></script>
  <script src="{% static 'website/js/script.js' %}"></script>
  <script src="{% static 'website/js/min.js' %}"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="{% static 'js/navbar.js' %}"></script>
  <script src="{% static 'js/config.js' %}"></script>

  <script>
    let activeCampaigns = [];

    $(document).ready(function() {
      loadActiveCampaigns();
    });

    function showCreateCampaignModal() {
      // Check if user is logged in
      if (!window.djangoUser || !window.djangoUser.isAuthenticated) {
        // Show navbar login modal instead
        const navbarLoginModal = document.getElementById('navbarLoginModal');
        if (navbarLoginModal) {
          navbarLoginModal.style.display = 'flex';
          return;
        }
      }

      const modal = document.getElementById('createCampaignModal');
      modal.style.display = 'block';
      modal.classList.add('show');
      document.body.classList.add('modal-open');

      // Add backdrop
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop fade show';
      backdrop.id = 'modal-backdrop';
      document.body.appendChild(backdrop);
    }
    
    function hideCreateCampaignModal() {
      const modal = document.getElementById('createCampaignModal');
      modal.style.display = 'none';
      modal.classList.remove('show');
      document.body.classList.remove('modal-open');
      
      // Remove backdrop
      const backdrop = document.getElementById('modal-backdrop');
      if (backdrop) {
        backdrop.remove();
      }
    }

    function scrollToActiveCampaigns() {
      document.getElementById('active-campaigns').scrollIntoView({ behavior: 'smooth' });
    }

    async function loadActiveCampaigns() {
      try {
        const response = await fetch('/api/applications/birthday-campaign/list/');
        const campaigns = await response.json();

        if (response.ok) {
          displayCampaigns(campaigns);
        } else {
          throw new Error('Failed to load campaigns');
        }
      } catch (error) {
        console.error('Error loading campaigns:', error);
        $('#no-campaigns').show();
      }
    }

    function displayCampaigns(campaigns) {
      const container = $('#campaigns-container');
      container.empty();

      if (campaigns.length === 0) {
        $('#no-campaigns').show();
        return;
      }

      campaigns.forEach(campaign => {
        const campaignCard = `
          <li class="card card--standard card--full-link wow fadeInUp" data-wow-duration="1s" data-wow-delay="0.2s">
            <div>
              <div class="event-image">
                ${campaign.photo ? `<img src="${campaign.photo}" alt="${campaign.title}" loading="lazy" fetchpriority="auto" decoding="async" />` : `<img src="{% static 'website/images/health.jpg' %}" alt="${campaign.title}" loading="lazy" fetchpriority="auto" decoding="async" />`}
              </div>
              <div class="card__text">
                <div>
                  <h3 class="card__title"><span>${campaign.title}</span></h3>
                  <div class="card__blurb">
                    <p class="text-muted mb-2">by ${campaign.full_name}</p>
                    <p>${campaign.description.substring(0, 100)}...</p>
                    <div class="mb-3">
                      <div class="d-flex justify-content-between mb-1">
                        <small>Progress</small>
                        <small>Rs. ${parseInt(campaign.current_amount).toLocaleString()} / Rs. ${parseInt(campaign.target_amount).toLocaleString()}</small>
                      </div>
                      <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: ${campaign.progress_percentage}%"></div>
                      </div>
                      <div class="d-flex justify-content-between mt-1">
                        <small class="text-muted">${campaign.donors_count} donors</small>
                        <small class="text-muted">${Math.round(campaign.progress_percentage)}%</small>
                      </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                      <small class="text-muted">
                        <i class="fas fa-birthday-cake me-1"></i>
                        ${new Date(campaign.birthday_date).toLocaleDateString()}
                      </small>
                      <a href="/birthday-campaign/${campaign.id}/" class="btn btn--orange-white btn-sm">
                        <i class="fas fa-eye me-1"></i>Details
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </li>
        `;
        container.append(campaignCard);
      });
    }

    async function createCampaign() {
      const form = document.getElementById('campaignForm');
      const submitButton = form.querySelector('button[type="submit"]') || document.querySelector('.modal-footer .btn-primary');
      const formData = new FormData(form);

      // Disable form and show loading
      const originalButtonText = submitButton.innerHTML;
      submitButton.disabled = true;
      submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';

      // Disable all form inputs
      const inputs = form.querySelectorAll('input, textarea, select');
      inputs.forEach(input => input.disabled = true);

      try {
        const response = await fetch('/api/applications/birthday-campaign/create/', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        });

        const data = await response.json();

        if (data.success) {
          hideCreateCampaignModal();
          Swal.fire({
            icon: 'success',
            title: 'Campaign Created!',
            text: data.message || 'Your birthday campaign has been created successfully!',
            confirmButtonText: 'View Campaign'
          }).then(() => {
            window.location.href = `/birthday-campaign/${data.campaign_id}/`;
          });
        } else {
          throw new Error(data.error || 'Failed to create campaign');
        }
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: error.message || 'Failed to create campaign. Please try again.'
        });
      } finally {
        // Re-enable form
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
        inputs.forEach(input => input.disabled = false);
      }
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>
</body>
</html>
