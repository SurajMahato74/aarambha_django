{% load static %}
<style>
    .donation-container {
        display: flex;
        max-width: 800px;
        margin: 10px auto;
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        border-radius: 12px;
        overflow: hidden;
        min-height: 420px;
    }

    /* Left Side - Static */
    .info-panel {
        flex: 1;
        background: #fff;
        display: flex;
        flex-direction: column;
    }

    .image-header img {
        width: 100%;
        height: 160px;
        object-fit: contain;
        background: #f8f9fa;
        padding: 20px;
    }

    .info-content {
        padding: 20px;
    }

    .logo {
        height: 25px;
        margin-bottom: 10px;
    }

    .info-content h2 {
        font-size: 18px;
        color: #222;
        margin-bottom: 8px;
    }

    .info-content p {
        color: #666;
        line-height: 1.4;
        font-size: 13px;
        margin-bottom: 15px;
    }

    .footer-links {
        font-size: 14px;
        color: #999;
    }

    .footer-links a {
        color: #999;
        text-decoration: none;
        margin-right: 5px;
    }

    /* Right Side - Dynamic Card */
    .donation-card {
        flex: 0.9;
        padding: 25px;
        background: #fff;
        border-left: 1px solid #f0f0f0;
        display: flex;
        flex-direction: column;
    }

    /* Common Form Styles */
    .step-content {
        display: none;
        flex-direction: column;
        height: 100%;
    }

    .step-content.active {
        display: flex;
    }

    .secure-header {
        font-size: 14px;
        font-weight: 600;
        color: #444;
        margin-bottom: 15px;
        text-align: center;
    }

    .form-group {
        margin-bottom: 12px;
    }

    .form-group label {
        display: block;
        font-size: 12px;
        color: #666;
        margin-bottom: 4px;
    }

    input[type="text"],
    input[type="email"],
    select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .amount-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 15px;
    }

    .amt-btn {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #fff;
        cursor: pointer;
        font-size: 13px;
    }

    .amt-btn:hover {
        border-color: #D6692A;
        color: #D6692A;
    }

    .custom-amount {
        display: flex;
        align-items: center;
        border: 1.5px solid #D6692A;
        border-radius: 8px;
        padding: 8px 12px;
        margin-bottom: 20px;
    }

    .custom-amount input {
        border: none;
        font-size: 20px;
        width: 100%;
        outline: none;
        font-weight: bold;
        padding: 0;
    }

    .donate-submit {
        width: 100%;
        background: #D6692A;
        color: white;
        padding: 14px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        margin-top: auto;
    }

    /* Payment Option Style */
    .payment-option {
        display: flex;
        align-items: center;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.2s;
    }

    .payment-option:hover {
        border-color: #5c2d91;
        background: #f9f5ff;
    }

    .payment-option img {
        height: 20px;
        margin-right: 10px;
    }

    .success-msg {
        text-align: center;
        margin-top: 40px;
    }

    .success-icon {
        font-size: 50px;
        color: #4bb543;
        margin-bottom: 10px;
    }

    @media (max-width: 600px) {
        .donation-container {
            flex-direction: column;
        }

        .donation-card {
            border-left: none;
            border-top: 1px solid #eee;
        }
    }
</style>

<div class="donation-container">
    <div class="info-panel">
        <div class="image-header">
            <img src="{% static 'website/images/logo.png' %}" alt="Aarambha Foundation">
        </div>
        <div class="info-content">
            <p>Your support helps us provide education, healthcare, and community development programs. Join us in making a lasting impact today.</p>
            <div class="footer-links">
                <a href="#">Privacy</a> â€¢ <a href="#">Usage</a> â€¢ <a href="#">Contact</a>
            </div>
        </div>
    </div>

    <div class="donation-card">

        <div id="step1" class="step-content active">
            {% if not user.is_authenticated %}
                <div style="text-align: center; padding: 20px;">
                    <h3 style="margin-bottom: 20px; color: #333;">Choose how to donate</h3>
                    
                    <!-- Anonymous Donation Option -->
                    <button class="donate-submit" onclick="proceedAsAnonymous()" style="margin-bottom: 15px; background: #28a745;">
                        Donate Anonymously
                    </button>
                    
                    <div style="margin: 20px 0; color: #666; font-size: 14px;">or login with</div>
                    
                    <!-- Login Options -->
                    <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;">
                        <a href="/accounts/google/login/?process=login&next={{ request.get_full_path }}" style="text-decoration: none;">
                            <img src="{% static 'website/images/google.png' %}" style="width: 45px; cursor: pointer;" alt="Google Login" title="Login with Google"/>
                        </a>
                        <button onclick="showEmailOtpLogin()" style="background: none; border: none; cursor: pointer;">
                            <img src="{% static 'website/images/gmail.png' %}" style="width: 60px;" alt="Email OTP" title="Login with Email OTP"/>
                        </button>
                    </div>
                    
                    <!-- Email OTP Form (Hidden) -->
                    <div id="emailOtpSection" style="display: none; border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;">
                        <div id="emailStepDonate">
                            <input type="email" id="donateEmail" placeholder="Enter your email" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px;">
                            <button onclick="sendDonateOTP(this)" class="donate-submit" style="background: #2d3b5b;">Send OTP</button>
                        </div>
                        <div id="otpStepDonate" style="display: none;">
                            <input type="text" id="donateOtpInput" placeholder="6-digit OTP" maxlength="6" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px;">
                            <button onclick="verifyDonateOTP(this)" class="donate-submit" style="background: #28a745;">Verify & Continue</button>
                            <button onclick="resetDonateOtp()" style="background: none; border: none; color: #666; font-size: 12px; margin-top: 10px; text-decoration: underline;">Change Email</button>
                        </div>
                        <div id="donateOtpError" style="color: #dc3545; font-size: 12px; text-align: center; margin-top: 10px;"></div>
                    </div>
                </div>
            {% else %}
            <div class="secure-header">ðŸ”’ Secure Donation</div>
            <div class="amount-grid">
                <button class="amt-btn" onclick="setAmount('1,000')">1,000</button>
                <button class="amt-btn" onclick="setAmount('2,000')">2,000</button>
                <button class="amt-btn" onclick="setAmount('5,000')">5,000</button>
                <button class="amt-btn" onclick="setAmount('10,000')">10,000</button>
                <button class="amt-btn" onclick="setAmount('20,000')">20,000</button>
                <button class="amt-btn" onclick="setAmount('')">Other</button>
            </div>
            <div class="custom-amount">
                <span style="font-size:18px; margin-right:5px;">Rs</span>
                <input type="text" id="donationInput" value="1,000">
                <span style="color:#888; font-size:12px;">NPR âŒµ</span>
            </div>
            <button class="donate-submit" onclick="nextStep(2)">Next</button>
            {% endif %}
        </div>

        <div id="step2" class="step-content">
            <div class="secure-header">Personal Details</div>
            <div class="form-group">
                <label>Title</label>
                <select id="title">
                    <option>Mr.</option>
                    <option>Mrs.</option>
                    <option>Ms.</option>
                </select>
            </div>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="fullname" placeholder="John Doe">
            </div>
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="email" placeholder="john@example.com" value="{% if user.is_authenticated %}{{ user.email }}{% endif %}">
            </div>
            <div class="form-group">
                <label>Phone Number (Optional)</label>
                <input type="text" id="phone" placeholder="98XXXXXXXX">
            </div>
            <button class="donate-submit" onclick="nextStep(3)">Continue to Payment</button>
        </div>

        <div id="step3" class="step-content">
            <div class="secure-header">Payment Method</div>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">Choosing to pay: <strong id="summaryAmt">Rs
                    1,000</strong></p>
            <div class="payment-option" onclick="finish('khalti')" style="margin-bottom: 10px;">
                <img src="https://web.khalti.com/static/img/logo1.png" alt="Khalti">
                <span>Pay with Khalti</span>
            </div>
            <div class="payment-option" onclick="finish('stripe')">
                <img src="https://stripe.com/img/v3/home/twitter.png" alt="Stripe" style="height: 16px;">
                <span>Pay with Stripe</span>
            </div>
            <p style="font-size: 11px; color: #999; margin-top: 10px; text-align: center;">You will be redirected to
                secure payment portal.</p>
        </div>

        <div id="step4" class="step-content">
            <div class="success-msg">
                <div class="success-icon">âœ“</div>
                <h3>Thank You!</h3>
                <p style="font-size: 14px; color: #666;">Your donation has been received successfully.</p>
                <button class="donate-submit" style="margin-top:20px" onclick="location.reload()">Done</button>
            </div>
        </div>

    </div>
</div>

<script>
    function setAmount(val) {
        document.getElementById('donationInput').value = val;
        if (val === '') document.getElementById('donationInput').focus();
    }

    function nextStep(step) {
        // Validation for step 1
        if (step === 2) {
            const amountStr = document.getElementById('donationInput').value.replace(/,/g, '');
            const amount = parseFloat(amountStr);
            if (!amount || amount < 10) {
                alert("Please enter a valid amount (minimum Rs. 10)");
                return;
            }
        }

        // Validation for step 2
        if (step === 3) {
            const name = document.getElementById('fullname').value;
            const email = document.getElementById('email').value;
            if (!name || !email) {
                alert("Please fill in Name and Email");
                return;
            }
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert("Please enter a valid email address");
                return;
            }
            document.getElementById('summaryAmt').innerText = "Rs " + document.getElementById('donationInput').value;
        }

        // Hide all steps
        for (let i = 1; i <= 4; i++) {
            const stepEl = document.getElementById('step' + i);
            if (stepEl) {
                stepEl.style.display = 'none';
                stepEl.classList.remove('active');
            }
        }
        // Show target step
        const targetStep = document.getElementById('step' + step);
        if (targetStep) {
            targetStep.style.display = 'flex';
            targetStep.classList.add('active');
        }
    }

    async function finish(paymentMethod = 'khalti') {
        {% if not user.is_authenticated %}
            alert('Please login first to make a donation.');
            document.getElementById('donationModal').style.display = 'none';
            document.getElementById('loginModal').style.display = 'flex';
            return;
        {% endif %}

        // Collect donation data
        const title = document.getElementById('title').value;
        const fullName = document.getElementById('fullname').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const amountStr = document.getElementById('donationInput').value.replace(/,/g, '');
        const amount = parseFloat(amountStr);

        // Validate
        if (!fullName || !email || !amount || amount < 10) {
            alert("Please fill in all required fields");
            return;
        }

        // Show loading state on clicked option only
        const clickedOption = event.target.closest('.payment-option');
        const originalText = clickedOption.innerHTML;
        clickedOption.innerHTML = '<span>Processing...</span>';
        clickedOption.style.pointerEvents = 'none';

        try {
            if (paymentMethod === 'stripe') {
                // Stripe payment (placeholder - implement Stripe integration)
                alert('Stripe payment coming soon!');
                clickedOption.innerHTML = originalText;
                clickedOption.style.pointerEvents = 'auto';
                return;
            }

            // Khalti payment
            const token = localStorage.getItem('access_token');
            const headers = {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            };
            
            // Only add Authorization header if token exists and is valid format
            if (token && token.trim() && !token.includes('undefined')) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            const response = await fetch('/api/core/donations/initiate/', {
                method: 'POST',
                headers: headers,
                credentials: 'include',
                body: JSON.stringify({
                    title: title,
                    full_name: fullName,
                    email: email,
                    phone: phone,
                    amount: amount
                })
            });

            const data = await response.json();

            if (response.ok && data.success && data.payment_url) {
                // Redirect to Khalti payment page
                window.location.href = data.payment_url;
            } else {
                // Show error
                alert(data.error || 'Failed to initiate payment. Please try again.');
                clickedOption.innerHTML = originalText;
                clickedOption.style.pointerEvents = 'auto';
            }
        } catch (error) {
            console.error('Payment initiation error:', error);
            alert('An error occurred. Please try again.');
            clickedOption.innerHTML = originalText;
            clickedOption.style.pointerEvents = 'auto';
        }
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // New functions for donation modal login
    function proceedAsAnonymous() {
        // Set a flag to indicate anonymous donation
        window.isAnonymousDonation = true;
        nextStep(2);
    }
    
    function showEmailOtpLogin() {
        document.getElementById('emailOtpSection').style.display = 'block';
    }
    
    async function sendDonateOTP(btn) {
        const email = document.getElementById('donateEmail').value;
        const errorDiv = document.getElementById('donateOtpError');
        
        if (!email) {
            errorDiv.textContent = 'Please enter email';
            return;
        }
        
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Sending...';
        errorDiv.textContent = '';
        
        try {
            const response = await fetch('/api/users/send-otp/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });
            const data = await response.json();
            
            if (response.ok) {
                document.getElementById('emailStepDonate').style.display = 'none';
                document.getElementById('otpStepDonate').style.display = 'block';
                errorDiv.style.color = 'green';
                errorDiv.textContent = 'OTP Sent!';
            } else {
                errorDiv.style.color = '#dc3545';
                errorDiv.textContent = data.error || 'Failed to send OTP';
            }
        } catch (e) {
            errorDiv.style.color = '#dc3545';
            errorDiv.textContent = 'Network error';
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    
    async function verifyDonateOTP(btn) {
        const email = document.getElementById('donateEmail').value;
        const otp = document.getElementById('donateOtpInput').value;
        const errorDiv = document.getElementById('donateOtpError');
        
        if (!otp || otp.length < 6) {
            errorDiv.textContent = 'Invalid OTP';
            return;
        }
        
        btn.disabled = true;
        btn.innerHTML = 'Verifying...';
        
        try {
            const response = await fetch('/api/users/verify-otp/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, otp })
            });
            const data = await response.json();
            
            if (response.ok) {
                // Store tokens and user data
                if (typeof setToken === 'function') setToken(data.access, data.refresh);
                if (typeof setUser === 'function') setUser(data.user);
                
                // Update navbar if function exists
                if (window.updateNavbarAuthState) {
                    window.updateNavbarAuthState();
                }
                
                // Pre-fill email and proceed to donation form
                document.getElementById('email').value = email;
                nextStep(2);
            } else {
                errorDiv.style.color = '#dc3545';
                errorDiv.textContent = data.error || 'Invalid OTP';
            }
        } catch (e) {
            errorDiv.style.color = '#dc3545';
            errorDiv.textContent = 'Error verifying OTP';
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Verify & Continue';
        }
    }
    
    function resetDonateOtp() {
        document.getElementById('emailStepDonate').style.display = 'block';
        document.getElementById('otpStepDonate').style.display = 'none';
        document.getElementById('donateOtpError').textContent = '';
    }
</script>