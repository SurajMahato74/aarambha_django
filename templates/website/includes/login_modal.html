<!-- Login Modal -->
{% load static %}
<div id="loginModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 99999; align-items: center; justify-content: center;">
    <div
        style="background: white; padding: 2rem; border-radius: 10px; max-width: 400px; width: 90%; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div  style="display: flex; justify-content: center; margin-bottom: 5px;">
            <img src="{% static 'website/images/logo.png' %}" style="width: 190px;" alt="logo"/>
        </div>
        <p class="text-center text-muted mb-4" style="font-size: 0.9rem;">Please sign in to continue.</p>

        <button onclick="document.getElementById('loginModal').style.display = 'none'"
            style="position: absolute; top: 0px; right: 15px; background: none; border: none; font-size: 2.5rem; cursor: pointer;">&times;</button>

        <!-- Username/Password Login -->
        <form id="modalLoginForm" onsubmit="handleModalLogin(event)">
            <div class="mb-3">
                <!-- <label style="font-weight: 500; margin-bottom: 2px; text-transform: capitalize;">Username</label> -->
                <input type="text" id="modalUsername" class="form-control" required placeholder="Username"
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div class="mb-3">
                <!-- <label style="font-weight: 500; margin-bottom: 2px; text-transform: capitalize;">Password</label> -->
                <input type="password" id="modalPassword" class="form-control" required placeholder=" Password"
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div id="modalLoginError" class="text-danger text-center mb-3"
                style="color: #dc3545; font-size: 0.9rem;"></div>
            <button type="submit" class="btn btn-primary w-100 mt-2"
                style="background: #2d3b5b; color: white; border: none; padding: 8px; border-radius: 5px; width: 100%; font-weight: 600;">Login</button>
        </form>

        <div id="modalSeparator" style="display: flex; align-items: center; margin: 10px 0;">
            <div style="flex-grow: 1; height: 1px; background: #e0e0e0;"></div>
            <span style="padding: 0 10px; color: #666; font-size: 0.8rem;">OR</span>
            <div style="flex-grow: 1; height: 1px; background: #e0e0e0;"></div>
        </div>

       <div class="d-flex justify-content-evenly align-items-center">
         <!-- Google Login -->
        <a href="/accounts/google/login/?process=login" class="">
            
            <img src="{% static 'website/images/google.png' %}" style="width: 45px;" alt="google"/>
        </a>

        <!-- OTP Trigger -->
        <button onclick="toggleModalOtpLogin()" id="otpToggleBtn">
           <img src="{% static 'website/images/gmail.png' %}" style="width: 60px;" alt="gmail"/>
        </button>
       </div>

        <!-- OTP Form (Hidden) -->
        <div id="modalOtpForm" style="display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
            <!-- Email Step -->
            <div id="modalEmailStep">
                <div class="mb-3">
                    <label style="font-weight: 500; margin-bottom: 5px; display: block; text-transform: capitalize;">Email Address</label>
                    <input type="email" id="modalEmail" class="form-control" placeholder="Enter your email"
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <button type="button" onclick="sendModalOTP(this)"
                    style="background: #2d3b5b; color: white; border: none; padding: 10px; border-radius: 5px; width: 100%;">Send
                    OTP</button>
                <button type="button" onclick="showUsernameLogin()" class="mt-2"
                    style="background: none; border: none; color: #666; width: 100%; font-size: 0.9rem; text-decoration: underline;">Back
                    to Username Login</button>
            </div>

            <!-- OTP Step -->
            <div id="modalOtpStep" style="display: none;">
                <div class="mb-3">
                    <label style="font-weight: 500; margin-bottom: 5px; display: block;">Enter OTP</label>
                    <input type="text" id="modalotpInput" class="form-control" placeholder="6-digit OTP" maxlength="6"
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <button type="button" onclick="verifyModalOTP(this)"
                    style="background: #28a745; color: white; border: none; padding: 10px; border-radius: 5px; width: 100%;">Verify
                    & Login</button>
                <button onclick="resetModalOtp()"
                    style="background: none; border: none; color: #666; font-size: 0.8rem; margin-top: 10px; text-decoration: underline; width: 100%;">Change
                    Email</button>
            </div>
            <div id="modalOtpError" class="text-center mt-2" style="color: #dc3545; font-size: 0.9rem;"></div>
        </div>
    </div>
</div>

<script>
    // Navbar Auth Update Function
    function updateNavbarAuth() {
        const user = getUser();
        const navLink = document.getElementById('navLoginLink');
        if (!navLink) return;

        if (user) {
            navLink.textContent = 'My Profile';
            let dashUrl = '/guest/welcome/';

            if (user.is_superuser || user.user_type === 'superadmin') {
                dashUrl = '/admin/dashboard/';
            } else if (user.user_type === 'member') {
                dashUrl = '/member/dashboard/';
            } else if (user.user_type === 'volunteer') {
                dashUrl = '/volunteer/dashboard/';
            } else if (user.user_type === 'guest') {
                dashUrl = '/guest/welcome/';
            } else if (user.user_type) {
                dashUrl = `/dashboard/${user.user_type}/`;
            }

            navLink.href = dashUrl;
            navLink.onclick = null;
        } else {
            navLink.textContent = 'Login';
            navLink.href = 'javascript:void(0)';
            navLink.onclick = function () {
                document.getElementById('loginModal').style.display = 'flex';
            };
        }
    }

    function handleNavLoginClick() {
        document.getElementById('loginModal').style.display = 'flex';
    }

    // Initial check could be done here if needed but typically handled by parent page or DOMContentLoaded
    document.addEventListener('DOMContentLoaded', updateNavbarAuth);

    async function handleModalLogin(e) {
        e.preventDefault();
        const username = document.getElementById('modalUsername').value;
        const password = document.getElementById('modalPassword').value;
        const errorDiv = document.getElementById('modalLoginError');
        const btn = e.submitter || e.target.querySelector('button[type="submit"]');

        btn.disabled = true;
        btn.innerHTML = 'Logging in...';
        errorDiv.textContent = '';

        try {
            // FIX: Use the correct API URL (match your config.js or urls.py)
            const response = await fetch('/api/users/login/', {  // <-- Change 'login/' to this
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();

            if (response.ok) {
                setToken(data.access, data.refresh);
                setUser(data.user);
                document.getElementById('loginModal').style.display = 'none';

                // Update navbar immediately
                updateNavbarAuth();

                // Check if donation modal should be opened after login
                if (localStorage.getItem('openDonationAfterLogin') === 'true') {
                    localStorage.removeItem('openDonationAfterLogin');
                    // Open donation modal and auto-fill email
                    setTimeout(() => {
                        document.getElementById('donationModal').style.display = 'flex';
                        const emailField = document.getElementById('email');
                        if (emailField && data.user.email) {
                            emailField.value = data.user.email;
                        }
                    }, 100); // Small delay to ensure modal is ready
                } else {
                    // Set flag for success message on dashboard
                    localStorage.setItem('justLoggedIn', 'true');

                    // Redirect immediately based on user type, prioritizing is_superuser
                    let redirectUrl = '/guest/welcome/';
                    if (data.user.is_superuser) {
                        redirectUrl = '/admin/dashboard/';
                    } else if (data.user.user_type === 'superadmin') {
                        redirectUrl = '/admin/dashboard/';
                    } else if (data.user.user_type === 'member') {
                        redirectUrl = '/member/dashboard/';
                    } else if (data.user.user_type === 'volunteer') {
                        redirectUrl = '/volunteer/dashboard/';
                    } else if (data.user.user_type === 'guest') {
                        redirectUrl = '/guest/welcome/';
                    } else if (data.user.user_type) {
                        redirectUrl = `/dashboard/${data.user.user_type}/`;
                    }
                    window.location.href = redirectUrl;
                }
            } else {
                errorDiv.textContent = data.non_field_errors?.[0] || 'Login failed. Please check credentials.';
            }
        } catch (error) {
            console.error(error);  // Add this for debugging
            errorDiv.textContent = 'Network error. Please try again.';
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Login';
        }
    }

    function toggleModalOtpLogin() {
        document.getElementById('modalLoginForm').style.display = 'none';
        document.getElementById('modalSeparator').style.display = 'none';
        document.getElementById('otpToggleBtn').style.display = 'none';
        document.getElementById('modalOtpForm').style.display = 'block';
    }

    function showUsernameLogin() {
        document.getElementById('modalLoginForm').style.display = 'block';
        document.getElementById('modalSeparator').style.display = 'flex';
        document.getElementById('otpToggleBtn').style.display = 'block';
        document.getElementById('modalOtpForm').style.display = 'none';
    }

    async function sendModalOTP(btn) {
        const email = document.getElementById('modalEmail').value;
        const errorDiv = document.getElementById('modalOtpError');

        if (!email) {
            errorDiv.textContent = 'Please enter email';
            return;
        }

        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Sending...';
        errorDiv.textContent = '';

        try {
            const response = await fetch('/api/users/send-otp/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });
            const data = await response.json();

            if (response.ok) {
                document.getElementById('modalEmailStep').style.display = 'none';
                document.getElementById('modalOtpStep').style.display = 'block';
                errorDiv.style.color = 'green';
                errorDiv.textContent = 'OTP Sent!';
            } else {
                errorDiv.style.color = '#dc3545';
                errorDiv.textContent = data.error || 'Failed to send OTP';
            }
        } catch (e) {
            errorDiv.style.color = '#dc3545';
            errorDiv.textContent = 'Network error';
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    async function verifyModalOTP(btn) {
        const email = document.getElementById('modalEmail').value;
        const otp = document.getElementById('modalotpInput').value;
        const errorDiv = document.getElementById('modalOtpError');

        if (!otp || otp.length < 6) {
            errorDiv.textContent = 'Invalid OTP';
            return;
        }

        btn.disabled = true;
        btn.innerHTML = 'Verifying...';

        try {
            const response = await fetch('/api/users/verify-otp/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, otp })
            });
            const data = await response.json();

            if (response.ok) {
                setToken(data.access, data.refresh);
                setUser(data.user);
                document.getElementById('loginModal').style.display = 'none';

                // Update navbar immediately
                updateNavbarAuth();

                // Check if donation modal should be opened after login
                if (localStorage.getItem('openDonationAfterLogin') === 'true') {
                    localStorage.removeItem('openDonationAfterLogin');
                    // Open donation modal and auto-fill email
                    setTimeout(() => {
                        document.getElementById('donationModal').style.display = 'flex';
                        const emailField = document.getElementById('email');
                        if (emailField && data.user.email) {
                            emailField.value = data.user.email;
                        }
                    }, 100); // Small delay to ensure modal is ready
                } else {
                    // Set flag for success message on dashboard
                    localStorage.setItem('justLoggedIn', 'true');

                    // Redirect immediately based on user type, prioritizing is_superuser
                    let redirectUrl = '/guest/welcome/';
                    if (data.user.is_superuser) {
                        redirectUrl = '/admin/dashboard/';
                    } else if (data.user.user_type === 'superadmin') {
                        redirectUrl = '/admin/dashboard/';
                    } else if (data.user.user_type === 'member') {
                        redirectUrl = '/member/dashboard/';
                    } else if (data.user.user_type === 'volunteer') {
                        redirectUrl = '/volunteer/dashboard/';
                    } else if (data.user.user_type === 'guest') {
                        redirectUrl = '/guest/welcome/';
                    } else if (data.user.user_type) {
                        redirectUrl = `/dashboard/${data.user.user_type}/`;
                    }
                    window.location.href = redirectUrl;
                }
            } else {
                errorDiv.style.color = '#dc3545';
                errorDiv.textContent = data.error || 'Invalid OTP';
            }
        } catch (e) {
            errorDiv.style.color = '#dc3545';
            errorDiv.textContent = 'Error verifying OTP';
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Verify & Login';
        }
    }

    function resetModalOtp() {
        document.getElementById('modalEmailStep').style.display = 'block';
        document.getElementById('modalOtpStep').style.display = 'none';
        document.getElementById('modalOtpError').textContent = '';
    }
</script>