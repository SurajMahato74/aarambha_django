<!-- Login Modal -->
{% load static %}
<div id="loginModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 99999; align-items: center; justify-content: center;">
    <div
        style="background: white; padding: 2rem; border-radius: 10px; max-width: 400px; width: 90%; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div  style="display: flex; justify-content: center; margin-bottom: 5px;">
            <img src="{% static 'website/images/logo.png' %}" style="width: 190px;" alt="logo"/>
        </div>
        <p class="text-center text-muted mb-4" style="font-size: 0.9rem;">Please sign in to continue.</p>

        <button onclick="document.getElementById('loginModal').style.display = 'none'"
            style="position: absolute; top: 0px; right: 15px; background: none; border: none; font-size: 2.5rem; cursor: pointer;">&times;</button>



       <div class="d-flex justify-content-evenly align-items-center">
         <!-- Google Login -->
        <a href="/accounts/google/login/?process=login&next={{ request.get_full_path }}" class="">
            
            <img src="{% static 'website/images/google.png' %}" style="width: 45px;" alt="google"/>
        </a>

        <!-- OTP Trigger -->
        <button onclick="toggleModalOtpLogin()" id="otpToggleBtn">
           <img src="{% static 'website/images/gmail.png' %}" style="width: 60px;" alt="gmail"/>
        </button>
       </div>

        <!-- OTP Form (Hidden) -->
        <div id="modalOtpForm" style="display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
            <!-- Email Step -->
            <div id="modalEmailStep">
                <div class="mb-3">
                    <label style="font-weight: 500; margin-bottom: 5px; display: block; text-transform: capitalize;">Email Address</label>
                    <input type="email" id="modalEmail" class="form-control" placeholder="Enter your email"
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <button type="button" onclick="sendModalOTP(this)"
                    style="background: #2d3b5b; color: white; border: none; padding: 10px; border-radius: 5px; width: 100%;">Send
                    OTP</button>

            </div>

            <!-- OTP Step -->
            <div id="modalOtpStep" style="display: none;">
                <div class="mb-3">
                    <label style="font-weight: 500; margin-bottom: 5px; display: block;">Enter OTP</label>
                    <input type="text" id="modalotpInput" class="form-control" placeholder="6-digit OTP" maxlength="6"
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <button type="button" onclick="verifyModalOTP(this)"
                    style="background: #28a745; color: white; border: none; padding: 10px; border-radius: 5px; width: 100%;">Verify
                    & Login</button>
                <button onclick="resetModalOtp()"
                    style="background: none; border: none; color: #666; font-size: 0.8rem; margin-top: 10px; text-decoration: underline; width: 100%;">Change
                    Email</button>
            </div>
            <div id="modalOtpError" class="text-center mt-2" style="color: #dc3545; font-size: 0.9rem;"></div>
        </div>
    </div>
</div>

<script>
    function handleNavLoginClick() {
        document.getElementById('loginModal').style.display = 'flex';
    }



    function toggleModalOtpLogin() {
        document.getElementById('otpToggleBtn').style.display = 'none';
        document.getElementById('modalOtpForm').style.display = 'block';
    }

    async function sendModalOTP(btn) {
        const email = document.getElementById('modalEmail').value;
        const errorDiv = document.getElementById('modalOtpError');

        if (!email) {
            errorDiv.textContent = 'Please enter email';
            return;
        }

        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Sending...';
        errorDiv.textContent = '';

        try {
            const response = await fetch('/api/users/send-otp/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });
            const data = await response.json();

            if (response.ok) {
                document.getElementById('modalEmailStep').style.display = 'none';
                document.getElementById('modalOtpStep').style.display = 'block';
                errorDiv.style.color = 'green';
                errorDiv.textContent = 'OTP Sent!';
            } else {
                errorDiv.style.color = '#dc3545';
                errorDiv.textContent = data.error || 'Failed to send OTP';
            }
        } catch (e) {
            errorDiv.style.color = '#dc3545';
            errorDiv.textContent = 'Network error';
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    async function verifyModalOTP(btn) {
        const email = document.getElementById('modalEmail').value;
        const otp = document.getElementById('modalotpInput').value;
        const errorDiv = document.getElementById('modalOtpError');

        if (!otp || otp.length < 6) {
            errorDiv.textContent = 'Invalid OTP';
            return;
        }

        btn.disabled = true;
        btn.innerHTML = 'Verifying...';

        try {
            const response = await fetch('/api/users/verify-otp/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, otp })
            });
            const data = await response.json();

            if (response.ok) {
                setToken(data.access, data.refresh);
                setUser(data.user);
                document.getElementById('loginModal').style.display = 'none';

                // Update navbar immediately
                if (window.updateNavbarAuthState) {
                    window.updateNavbarAuthState();
                }

                // Check if there's a pending action to continue
                const pendingAction = localStorage.getItem('pendingAction');
                if (pendingAction === 'donate') {
                    localStorage.removeItem('pendingAction');
                    // Reload page to update authentication state and show donation modal
                    window.location.reload();
                    return;
                }
                
                // Set flag for success message on dashboard
                localStorage.setItem('justLoggedIn', 'true');

                // Check user's actual application status for proper redirect
                try {
                    const appsResponse = await fetch('/api/applications/my-applications/', {
                        headers: { 'Authorization': `Bearer ${data.access}` }
                    });
                    
                    if (appsResponse.ok) {
                        const applications = await appsResponse.json();
                        const memberApp = applications.find(app => 
                            app.application_type === 'member' && 
                            app.status === 'approved' && 
                            app.payment_completed
                        );
                        const volunteerApp = applications.find(app => 
                            app.application_type === 'volunteer' && 
                            app.status === 'approved'
                        );
                        
                        // Redirect based on actual application status
                        if (data.user.is_superuser) {
                            window.location.href = '/admin/dashboard/';
                        } else if (memberApp) {
                            window.location.href = '/member/dashboard/';
                        } else if (volunteerApp) {
                            window.location.href = '/volunteer/dashboard/';
                        } else {
                            window.location.href = '/guest/profile/';
                        }
                    } else {
                        // Fallback to profile page if can't check applications
                        window.location.href = '/guest/profile/';
                    }
                } catch (error) {
                    console.error('Error checking applications:', error);
                    window.location.href = '/guest/profile/';
                }
            } else {
                errorDiv.style.color = '#dc3545';
                errorDiv.textContent = data.error || 'Invalid OTP';
            }
        } catch (e) {
            errorDiv.style.color = '#dc3545';
            errorDiv.textContent = 'Error verifying OTP';
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Verify & Login';
        }
    }

    function resetModalOtp() {
        document.getElementById('modalEmailStep').style.display = 'block';
        document.getElementById('modalOtpStep').style.display = 'none';
        document.getElementById('modalOtpError').textContent = '';
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>