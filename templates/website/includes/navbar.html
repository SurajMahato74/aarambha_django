{% load static %}
<nav class="navigation">
    <a href="{% url 'home' %}" aria-label="Home" class="navigation__home-link">
        <img src="{% static 'website/images/logo.png' %}" class="d-md-block d-none" style="width: 14rem"
            alt="Aarambha Foundation Logo" />
        <img src="{% static 'website/images/favicon.png' %}" class="d-block d-md-none" style="width: 6rem"
            alt="Aarambha Foundation" />
    </a>
    <div class="navigation__links">
        <ul class="navigation__level-one" id="navigation__level-one">
            <li class="navigation__level-one-item" tabindex="0">
                <a href="" class="navigation__level-one-link desktop-only--navigation">
                    Our Work
                    <svg width="7" height="5" fill="none" xmlns="http://www.w3.org/2000.svg' %}" aria-hidden="true"
                        class="arrow--down">
                        <path d="M6.364.682 3.682 3.364 1 .682" stroke="#E36F1E" stroke-width="1.5"></path>
                    </svg>
                </a>
                <button class="navigation__submenu-open-button mobile-only--navigation" aria-controls="#What_we_do"
                    aria-label="Open What we do menu">
                    Our Work
                    <svg width="7" height="5" fill="none" xmlns="http://www.w3.org/2000.svg' %}" aria-hidden="true"
                        class="arrow--down">
                        <path d="M6.364.682 3.682 3.364 1 .682" stroke="#E36F1E" stroke-width="1.5"></path>
                    </svg>
                </button>
                <div class="navigation__level-two navigation__submenu" id="What_we_do">
                    <div class="navigation__level-two-content contained-width">
                        <header class="navigation__level-two-header">
                            <button class="navigation__submenu-close-button mobile-only--navigation"
                                aria-controls="#What_we_do" aria-label="Close What we do menu">
                                <svg width="7" height="5" fill="none" xmlns="http://www.w3.org/2000.svg' %}"
                                    aria-hidden="true" class="arrow--down">
                                    <path d="M6.364.682 3.682 3.364 1 .682" stroke="#E36F1E" stroke-width="1.5"></path>
                                </svg>
                                Back
                            </button>
                            <h2 class="navigation__level-two-title">
                                <a href="" class="reverse-underline">Our Work</a>
                            </h2>
                        </header>

                        <ul id="our-work-list">
                            <!-- Items will be loaded via JS -->
                        </ul>
                    </div>
                </div>
            </li>

            <li class="navigation__level-one-item" tabindex="0">
                <a href="/get-involved/" class="navigation__level-one-link desktop-only--navigation">
                    Get involved
                    <svg width="7" height="5" fill="none" xmlns="http://www.w3.org/2000.svg' %}" aria-hidden="true"
                        class="arrow--down">
                        <path d="M6.364.682 3.682 3.364 1 .682" stroke="#E36F1E" stroke-width="1.5"></path>
                    </svg>
                </a>
                <button class="navigation__submenu-open-button mobile-only--navigation" aria-controls="#Get_involved"
                    aria-label="Open Get involved menu">
                    Get involved
                    <svg width="7" height="5" fill="none" xmlns="http://www.w3.org/2000.svg' %}" aria-hidden="true"
                        class="arrow--down">
                        <path d="M6.364.682 3.682 3.364 1 .682" stroke="#E36F1E" stroke-width="1.5"></path>
                    </svg>
                </button>
                <div class="navigation__level-two navigation__submenu" id="Get_involved">
                    <div class="navigation__level-two-content contained-width">
                        <header class="navigation__level-two-header">
                            <button class="navigation__submenu-close-button mobile-only--navigation"
                                aria-controls="#Get_involved" aria-label="Close Get involved menu">
                                <svg width="7" height="5" fill="none" xmlns="http://www.w3.org/2000.svg' %}"
                                    aria-hidden="true" class="arrow--down">
                                    <path d="M6.364.682 3.682 3.364 1 .682" stroke="#E36F1E" stroke-width="1.5"></path>
                                </svg>
                                Back
                            </button>
                            <h2 class="navigation__level-two-title">
                                <a href="/get-involved/" class="reverse-underline">Get involved</a>
                            </h2>
                        </header>

                        <ul>
                            <li class="navigation__level-two-item">
                                <a href="{% url 'website_member_form' %}" class="navigation__level-two-link">Become a
                                    Member</a>
                            </li>

                            <li class="navigation__level-two-item">
                                <a href="{% url 'website_volunteer_form' %}" class="navigation__level-two-link">Be a
                                    Volunteer</a>
                            </li>

                            <li class="navigation__level-two-item">
                                <a href="{% url 'website_sponsor_child_form' %}"
                                    class="navigation__level-two-link">Sponsor a
                                    Child</a>
                            </li>
                            <li class="navigation__level-two-item">
                                <a href="{% url 'website_enrollDayCamping' %}"
                                    class="navigation__level-two-link">Enroll in One Rupee a Day Campaign</a>
                            </li>
                            <li class="navigation__level-two-item">
                                <a href="{% url 'website_celebratebirthday' %}"
                                    class="navigation__level-two-link">Celebrate Your Birthday Sponsoring a Big Dream</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </li>

            <li class="navigation__level-one-item" tabindex="0">
                <a href="" class="navigation__level-one-link desktop-only--navigation">
                    Blogs
                    <svg width="7" height="5" fill="none" xmlns="http://www.w3.org/2000.svg' %}" aria-hidden="true"
                        class="arrow--down">
                        <path d="M6.364.682 3.682 3.364 1 .682" stroke="#E36F1E" stroke-width="1.5"></path>
                    </svg>
                </a>
                <button class="navigation__submenu-open-button mobile-only--navigation" aria-controls="#News_+_Stories"
                    aria-label="Open News + Stories menu">
                    Blogs 
                    <svg width="7" height="5" fill="none" xmlns="http://www.w3.org/2000.svg' %}" aria-hidden="true"
                        class="arrow--down">
                        <path d="M6.364.682 3.682 3.364 1 .682" stroke="#E36F1E" stroke-width="1.5"></path>
                    </svg>
                </button>
                <div class="navigation__level-two navigation__submenu" id="News_+_Stories">
                    <div
                        class="contained-width navigation__level-two-content navigation__level-two-content--with-highlight">
                        <ul>
                            <li>
                                <p class="fw-bold pb-2">Aapghari: Beginning point for Aarambha</p>
                                <a href="{% url 'website_blogs' %}" class="navigation__level-two-link reverse-underline" style="padding-left:8px">
                                    Test1
                                </a> <br>
                                 <a href="{% url 'website_blogs' %}" class="navigation__level-two-link reverse-underline" style="padding-left:8px">
                                    Test2
                                </a>
                            </li>

                            
                        </ul>
                    </div>
                </div>
            </li>

            <li class="navigation__level-one-item navigation__search" tabindex="0" id="navAuthSection">
                {% if user.is_authenticated %}
                    <a href="/guest/profile/" class="navigation__level-one-link">Profile</a>
                {% else %}
                    <a href="javascript:void(0)" id="navLoginLink" class="navigation__level-one-link" onclick="handleNavLoginClick()">Login</a>
                {% endif %}
            </li>
            <li id="navLogoutSection" style="display: inline; margin-right:20px" class="navigation__level-one-link">
            {% if user.is_authenticated %}
            <form method="POST" action="{% url 'logout' %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" onclick="clearToken()" class="navigation__level-one-link" style="background: none; border: none; color: #E36F1E; font: inherit; cursor: pointer; " title="Logout">
                    <i class="fas fa-sign-out-alt fs-4"></i>
                </button>
            </form>
            {% endif %}
            </li>

        </ul>

        <button class="btn navigation__donate" onclick="openDonationModal()">Donate</button>
        
        
        <button class="navigation__toggle mobile-only--navigation" aria-expanded="false"
            aria-label="Open navigation menu" aria-controls="#navigation__level-one">
            <svg width="22" height="20" fill="none" xmlns="http://www.w3.org/2000.svg' %}" aria-hidden="true">
                <path d="M0 1h22M0 9.556h22M0 18.111h22" stroke="#000" stroke-width="2"></path>
            </svg>
        </button>
    </div>
</nav>

<!-- Donation Modal -->
<div id="donationModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 99999; align-items: center; justify-content: center;">
    <div
        style="background: white; padding: 2rem; border-radius: 10px; max-width: 800px; width: 90%; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto;">
        <button onclick="closeDonationModal()"
            style="position: absolute; top: 3px; right: 3px;  border: none; font-size: 2rem; cursor: pointer; padding:0px 16px; color:#fff; border-radius:50%; background:#D6692A">&times;</button>
        {% include 'website/includes/donation_model.html' %}
    </div>
</div>

<script type="application/json" id="django-user-data">
{% if user.is_authenticated %}
{"isAuthenticated": true, "email": "{{ user.email }}", "id": {{ user.id }}, "first_name": "{{ user.first_name }}", "last_name": "{{ user.last_name }}"}
{% else %}
{"isAuthenticated": false, "email": null}
{% endif %}
</script>
<script src="{% static 'js/auth-utils.js' %}"></script>
<script>
    // Set user info for JavaScript
    window.djangoUser = JSON.parse(document.getElementById('django-user-data').textContent);
    
    // Make updateNavbarAuthState globally available
    window.updateNavbarAuthState = updateNavbarAuthState;

    document.addEventListener('DOMContentLoaded', function () {
        fetch('/api/our-work/')  // Your API URL
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('our-work-list');
                if (data.length === 0) {
                    list.innerHTML = '<li class="navigation__level-two-item"><a href="" class="navigation__level-two-link">No work items available</a></li>';
                } else {
                    data.forEach(work => {
                        const li = document.createElement('li');
                        li.className = 'navigation__level-two-item';
                        li.innerHTML = `<a href="${work.url}" class="navigation__level-two-link">${work.title}</a>`;
                        list.appendChild(li);
                    });
                }
            })
            .catch(error => console.error('Error fetching Our Work:', error));
    });

    function openDonationModal() {
        if (window.djangoUser.isAuthenticated) {
            document.getElementById('donationModal').style.display = 'flex';
            // Auto-fill email if user is logged in
            const emailField = document.getElementById('email');
            if (emailField && window.djangoUser.email) {
                emailField.value = window.djangoUser.email;
            }
        } else {
            // Set flag to open donation modal after login
            localStorage.setItem('openDonationAfterLogin', 'true');
            document.getElementById('loginModal').style.display = 'flex';
        }
    }

    function closeDonationModal() {
        document.getElementById('donationModal').style.display = 'none';
    }

    function toggleProfileDropdown() {
        const dropdown = document.getElementById('navProfileDropdown');
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }

    // Update navbar auth state based on both Django session and localStorage
    function updateNavbarAuthState() {
        const user = getUser(); // From localStorage
        const navAuthSection = document.getElementById('navAuthSection');
        const navLogoutSection = document.getElementById('navLogoutSection');
        
        if (!navAuthSection || !navLogoutSection) return;
        
        // Show logout if Django user is authenticated OR localStorage has user
        const isAuthenticated = window.djangoUser.isAuthenticated || user;
        
        if (isAuthenticated) {
            // Update profile link
            const profileLink = navAuthSection.querySelector('a');
            if (profileLink) {
                profileLink.textContent = 'Profile';
                profileLink.href = '/guest/profile/';
                profileLink.onclick = null;
            }
            
            // Show logout button if not already visible
            if (!navLogoutSection.querySelector('form')) {
                navLogoutSection.innerHTML = `
                    <button onclick="handleDynamicLogout()" class="navigation__level-one-link" style="background: none; border: none; color: inherit; font: inherit; cursor: pointer; padding: 0.5rem;" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                `;
            }
            navLogoutSection.style.display = 'inline';
        } else {
            // Update to login link
            const loginLink = navAuthSection.querySelector('a');
            if (loginLink) {
                loginLink.textContent = 'Login';
                loginLink.href = 'javascript:void(0)';
                loginLink.onclick = handleNavLoginClick;
            }
            
            // Hide logout button
            navLogoutSection.style.display = 'none';
        }
    }
    
    function handleDynamicLogout() {
        if (confirm('Are you sure you want to logout?')) {
            clearToken();
            // If Django session exists, submit logout form
            const logoutForm = document.querySelector('form[action*="logout"]');
            if (logoutForm) {
                logoutForm.submit();
            } else {
                // Just redirect to home
                window.location.href = '/';
            }
        }
    }
    
    // Check auth state on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateNavbarAuthState();
    });
</script>

<a href="javascript:void(0)" onclick="openDonationModal()" class="floating-icon"><span><i
            class="bi bi-heart-fill"></i></span> DONATE</a>