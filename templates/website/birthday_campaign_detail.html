{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
  <link href="{% static 'website/css/bootstrap.min.css' %}" rel="stylesheet" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="{% static 'website/css/slick.min.css' %}" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="{% static 'website/css/owl.carousel.min.css' %}" />
  <link rel="stylesheet" href="{% static 'website/css/swiper-bundle.min.css' %}" />
  <link rel="stylesheet" href="{% static 'website/css/animate.min.css' %}" />
  <link rel="stylesheet" href="{% static 'website/css/index.css' %}" />
  <link rel="stylesheet" href="{% static 'website/css/style.css' %}" />
  <link rel="icon" type="image.png" href="{% static 'website/images/favicon.png' %}" />
  <title>Birthday Campaign - Aarambha Foundation</title>
</head>

<body>
  {% include 'website/includes/navbar.html' %}

  <!-- Campaign Stats -->
  <section class="stats-block wow fadeInUp" data-wow-duration="1s" data-wow-delay="0.4s">
    <div class="container">
      <div class="stats-block__content py-4">
        <ul class="stats-block__items d-flex flex-column flex-md-row justify-content-around flex-grow-1">
          <li class="stats-block__item">
            <h3 class="stats-block__stat">
              <span class="stats-block__stat-content">
                <span id="current-amount" class="stats-block__stat-value">0</span>
              </span>
            </h3>
            <p class="stats-block__description">Raised (NPR)</p>
          </li>
          <li class="stats-block__item">
            <h3 class="stats-block__stat1">
              <span class="stats-block__stat-content">
                <span id="target-amount" class="stats-block__stat-value">0</span>
              </span>
            </h3>
            <p class="stats-block__description">Goal (NPR)</p>
          </li>
          <li class="stats-block__item">
            <h3 class="stats-block__stat2">
              <span class="stats-block__stat-content">
                <span id="donors-count" class="stats-block__stat-value">0</span>
              </span>
            </h3>
            <p class="stats-block__description">Donors</p>
          </li>
        </ul>
        <div class="text-center mt-3">
          <button id="payNowBtn" class="btn btn-success btn-lg" onclick="showDonationModal()">
            <i class="fas fa-heart me-1"></i>Pay Now
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Campaign Details -->
  <section class="py-5">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <!-- Campaign Story -->
          <div class="card mb-4">
            <div class="card-body">
              <h3 class="card-title">Campaign Story</h3>
              <p id="full-description" class="card-text">Loading story...</p>
            </div>
          </div>

          <!-- Donations List -->
          <div class="card mb-4">
            <div class="card-body">
              <h3 class="card-title">Recent Donations</h3>
              <div id="donations-list">
                <p class="text-muted">Loading donations...</p>
              </div>
            </div>
          </div>

          <!-- Campaign Info -->
          <div class="card">
            <div class="card-body">
              <h3 class="card-title">Campaign Information</h3>
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Birthday Date:</strong> <span id="birthday-date">Loading...</span></p>
                  <p><strong>Organizer:</strong> <span id="organizer-name">Loading...</span></p>
                </div>
                <div class="col-md-6">
                  <p><strong>Target Amount:</strong> NPR <span id="target-display">0</span></p>
                  <p><strong>Current Amount:</strong> NPR <span id="current-display">0</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  {% include 'website/includes/birthday_payment_modal.html' %}

  {% include "website/includes/footer.html" %}

  <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="{% static 'website/js/slick.min.js' %}" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="{% static 'website/js/swiper-bundle.min.js' %}" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="{% static 'website/js/modernizr.min.js' %}" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script>
  <script src="{% static 'website/js/owl.carousel.min.js' %}"></script>
  <script src="{% static 'website/js/api.js' %}"></script>
  <script src="{% static 'website/js/main.js' %}"></script>
  <script src="{% static 'website/js/animation.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="{% static 'website/js/general.js' %}"></script>
  <script src="{% static 'website/js/nav.js' %}"></script>
  <script src="{% static 'website/js/script.js' %}"></script>
  <script src="{% static 'website/js/min.js' %}"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="{% static 'js/navbar.js' %}"></script>
  <script src="{% static 'js/config.js' %}"></script>

  <script>
    // Set campaign ID for the JavaScript file
    window.campaignId = "{{ campaign_id|default:'0' }}";
    
    // Birthday Campaign Detail Page JavaScript
    const campaignId = window.campaignId || 0;
    let campaignData = null;

    $(document).ready(function() {
        console.log('Birthday campaign page loaded');
        console.log('Campaign ID:', campaignId);
        
        if (campaignId && campaignId !== '0') {
            loadCampaignDetails();
        } else {
            showError('Invalid campaign ID');
        }
    });

    async function loadCampaignDetails() {
        try {
            showLoading();
            const response = await fetch(`/api/applications/birthday-campaign/${campaignId}/`);
            const data = await response.json();

            if (response.ok) {
                campaignData = data;
                displayCampaignDetails(campaignData);
                displayDonations(data.donations || []);
            } else {
                throw new Error(data.error || 'Failed to load campaign details');
            }
        } catch (error) {
            console.error('Error loading campaign:', error);
            showError('Failed to load campaign details. The campaign may not exist or may have been removed.');
            displayDonations([]);
        }
    }

    function showLoading() {
        $('#current-amount').text('0');
        $('#target-amount').text('0');
        $('#donors-count').text('0');
        $('#full-description').text('Loading story...');
        $('#target-display').text('0');
        $('#current-display').text('0');
        $('#birthday-date').text('Loading...');
        $('#organizer-name').text('Loading...');
    }

    function showError(message) {
        $('#current-amount').text('0');
        $('#target-amount').text('0');
        $('#donors-count').text('0');
        $('#full-description').text('This campaign is not available.');
        $('#target-display').text('0');
        $('#current-display').text('0');
        $('#birthday-date').text('N/A');
        $('#organizer-name').text('N/A');
        
        Swal.fire({
            icon: 'error',
            title: 'Campaign Not Found',
            text: message
        });
    }

    function displayCampaignDetails(campaign) {
        console.log('Displaying campaign details:', campaign);
        
        const currentAmount = parseFloat(campaign.current_amount) || 0;
        const targetAmount = parseFloat(campaign.target_amount) || 0;
        const donorsCount = parseInt(campaign.donors_count) || 0;
        
        console.log('Parsed amounts:', { currentAmount, targetAmount, donorsCount });
        
        $('#current-amount').text(currentAmount.toLocaleString());
        $('#target-amount').text(targetAmount.toLocaleString());
        $('#donors-count').text(donorsCount);
        
        $('#target-display').text(targetAmount.toLocaleString());
        $('#current-display').text(currentAmount.toLocaleString());
        $('#birthday-date').text(new Date(campaign.birthday_date).toLocaleDateString());
        $('#organizer-name').text(campaign.full_name);
        $('#full-description').text(campaign.description);
        
        $('#payNowBtn').show();
    }

    function displayDonations(donations) {
        const container = $('#donations-list');
        container.empty();

        if (!donations || donations.length === 0) {
            container.html('<p class="text-muted">No donations yet. Be the first to donate!</p>');
            return;
        }

        donations.forEach(donation => {
            const donationItem = `
                <div class="donor-item p-3 mb-3 bg-light rounded">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${donation.donor_name}</h6>
                            <p class="mb-1 text-success fw-bold">Rs. ${parseInt(donation.amount).toLocaleString()}</p>
                            ${donation.message ? `<p class="mb-0 text-muted small">"${donation.message}"</p>` : ''}
                        </div>
                        <div class="text-end">
                            <small class="text-muted d-block">${new Date(donation.date).toLocaleDateString()}</small>
                        </div>
                    </div>
                </div>
            `;
            container.append(donationItem);
        });
    }

    function showDonationModal() {
        Swal.fire({
            title: 'Choose Payment Method',
            html: `
                <div class="text-center">
                    <button class="btn btn-primary btn-lg m-2" onclick="selectPaymentMethod('khalti')">
                        <i class="fas fa-wallet me-2"></i>Khalti
                    </button>
                    <button class="btn btn-success btn-lg m-2" onclick="selectPaymentMethod('stripe')">
                        <i class="fas fa-credit-card me-2"></i>Stripe
                    </button>
                </div>
            `,
            showConfirmButton: false,
            showCancelButton: true,
            cancelButtonText: 'Cancel'
        });
    }

    function selectPaymentMethod(method) {
        Swal.close();
        if (method === 'khalti') {
            openBirthdayPaymentModal();
        } else {
            Swal.fire({
                icon: 'info',
                title: 'Stripe Payment',
                text: 'Stripe payment integration coming soon!'
            });
        }
    }



    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
  </script>
