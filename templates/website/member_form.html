{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
  <link href="{% static 'website/css/bootstrap.min.css' %}" rel="stylesheet" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="{% static 'website/css/slick.min.css' %}" crossorigin="anonymous"
    referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="{% static 'website/css/owl.carousel.min.css' %}" />
  <!-- Link Swiper's CSS -->
  <link rel="stylesheet" href="{% static 'website/css/swiper-bundle.min.css' %}" />
  <!-- Link Swiper's CSS end-->
  <link rel="stylesheet" href="{% static 'website/css/animate.min.css' %}" />
  <!-- custom-css  -->
  <link rel="stylesheet" href="{% static 'website/css/index.css' %}" />
  <link rel="stylesheet" href="{% static 'website/css/style.css' %}" />
  <!-- custom-css end -->
  <link rel="icon" type="image/png" href="{% static 'website/images/favicon.png' %}" />
  <title>Aarambha Foundation &#8211; Our Beginning for the Change</title>
  <style>
    .header-top img {
      width: 100%;
      height: 450px;
      object-fit: cover;
      border-radius: 10px;
    }
    @media (max-width: 768px) {
       .header-top img {
      width: 100%;
      height: 250px;
      object-fit: cover;
      border-radius: 10px;
    }
    }


    .header-bottom {
      color: #2d3b5b;
      background-color: #fff;

      border-radius: 10px 10px 0 0;
    }

    .header-bottom h1 {
      margin: 0;
      font-size: 25px;
    }

    .header-bottom .header-content p {
      color: #0b0b0b;
      text-align: justify;
    }

    .content {
      line-height: 1.6;
    }

    #membershipForm {
      display: none;
    }
    
    #membershipForm.show {
      display: block;
    }

    .start-section h2 {
      margin: 0;
      padding: 0;
    }

    .start-btn {
      background: #2d3b5b;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 18px;
      cursor: pointer;
    }

    .start-btn:hover {
      background: #8f5556;
    }

    .btn-success {
      background: #8f5556 !important;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 18px;
      cursor: pointer;
    }

    .btn-success:hover {
      background: #2d3b5b !important;
    }

    .member-tab-container {
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }

    .member-tab-header {
      display: flex;
      background: #f8f9fa;
      border-bottom: 1px solid #ddd;
    }

    .member-tab-button {
      flex: 1;
      padding: 12px 16px;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 500;
      color: #666;
      border-right: 1px solid #ddd;
    }

    .member-tab-button:last-child {
      border-right: none;
    }

    .member-tab-button.member-active {
      background: #2d3b5b;
      color: white;
    }

    .member-tab-content {
      display: none;
      padding: 20px;
    }

    .member-tab-content.member-active {
      display: block;
    }

    .member-tab-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }

    .member-nav-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }

    .member-nav-btn.member-prev {
      background: #6c757d;
      color: white;
    }

    .member-nav-btn.member-next {
      background: #2d3b5b;
      color: white;
    }

    .member-nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .form-step h2 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .form-step p {
      color: #171717;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 10px;
    }

    label {
      text-align: left !important;
      color: #000;
      text-transform: capitalize;
      font-weight: 400;
    }

    input[type="text"],
    input[type="date"],
    input[type="email"],
    input[type="tel"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }

    .required {
      color: red;
    }

    .progress {
      text-align: center;
      margin: 20px 0;
      font-weight: bold;
      color: #8b6f47;
    }
  </style>
</head>

<body>
  {% include 'website/includes/navbar.html'%}
  <section class="member-section">
  <div class="container">
    <div class="row">
      <div class="col-12 col-md-12 wow fadeInUp">
        <div class="header-top " style="margin-top: 90px; margin-bottom: 10px">
          <img src="{% static 'website/images/volentier.jpg' %}" alt="Aarambha Foundation" class="" />
        </div>
        <div class="header-bottom mb-3 wow fadeInUp" data-wow-duration="1s" data-wow-delay="0.2s">
          <h1 class="bg-orange text-white" style="border-radius:10px">&nbsp;&nbsp;Membership Application</h1>
          <div class="header-content py-2">
            <p class="mb-3">
             Aarambha Foundation, formally registered on 3rd August 2015, is a non-profit, non-governmental
organization dedicated to child welfare, youth empowerment, and social development. We strongly
believe in teamwork and collective action, guided by our tagline: <strong>“Our Beginning for Change.”</strong>
            </p>
            <p class="mb-3">
              We work to bring the light of education, promote better health, and nurture a safe and supportive
environment across the nation—where the laughter, voices, and aspirations of every child, both
heard and unheard, are valued and celebrated. Our mission is to ensure that every child has the
opportunity to learn, grow, and develop through personal and behavioural empowerment.
            </p>
            <p class="mb-3">
              Since its establishment, Aarambha Foundation has touched hundreds of lives through impactful
initiatives such as the <strong>School Dropouts’ Prevention and Re-Enrollment Project (SDPRP), Free
Tuition Campaign, Rural Library Project, Free Health Camps and Clothes Distribution, Teaching
Fellowship, Digital Classroom programs and Modular Montessori.</strong> Thousands of young people have
also been inspired through our motivational seminar series, <strong>“Getting into Yourself.”</strong> While our
journey has just begun, our passionate team is committed to reaching thousands of lives across
Nepal.
            </p>
            <p class="mb-3">We are a group of enthusiastic young individuals driven by a shared vision to create meaningful
change in society. United by selflessness and determination, we dedicate a part of our lives to
building a better, more beautiful, and productive society. Through thoughtful planning and small yet
impactful efforts, Aarambha Foundation and its dedicated members come together for the greater
good—creating positive change in the lives of children and communities.</p>
            <p>
              If you share this vision and believe in the power of collective action, <strong>join us today and become a
member of the Aarambha Family.</strong> Together, we can be the beginning of change.
            </p>
            <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 20px 0;">
              <h4 style="color: #2d3b5b; margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Membership Information</h4>
              <p style="margin-bottom: 10px;"><strong>Membership Fee:</strong> Rs. 1,000 (One-time payment)</p>
              <p style="margin-bottom: 10px;"><strong>Benefits:</strong> Full voting rights, priority in programs, exclusive member events, and official membership certificate</p>
              <p style="margin-bottom: 0; color: #666;"><strong>Note:</strong> After your application is approved, you will need to complete the membership fee payment to activate your full membership status.</p>
            </div>
          </div>
          <hr style="border: 1px solid #000" />
          <div class="content">
            <div class="start-section mb-3" id="startSection">
              <h3 class="mt-1 pb-0">Ready to Join Aarambha Foundation?</h3>
              <p class="mb-0">
                Click below to start your membership application process.
              </p>
              <button class="start-btn" onclick="startApplication()">
                Start Application
              </button>
            </div>
            <form class="pb-4" id="membershipForm">
              <div class="row">
                <!-- Personal Information Section -->
                <div class="col-12 mb-4">
                  <h3 style="color: #2d3b5b; border-bottom: 2px solid #8f5556; padding-bottom: 5px;">Personal Information</h3>
                  <p style="color: #666;">We ensure your personal information won't be shared in any public sites or agencies.</p>
                </div>
                
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="name">Name <span class="required">*</span></label>
                    <input type="text" id="name" name="full_name" placeholder="First and last name" required />
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="dob">Date of Birth <span class="required">*</span></label>
                    <input type="date" id="dob" name="date_of_birth" required />
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="contactNumber">Contact Number <span class="required">*</span></label>
                    <input type="text" id="contactNumber" name="phone" placeholder="+977 9800000000" required />
                  </div>
                </div>
                
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="tempCountry">Country (Temporary Address) <span class="required">*</span></label>
                    <select id="tempCountry" name="country" required class="w-100 p-2">
                      <option value="">Loading countries...</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-4" id="tempDistrictField" style="display:none;">
                  <div class="form-group">
                    <label for="tempDistrict">District (Temporary Address) <span class="required">*</span></label>
                    <select id="tempDistrict" name="district" class="w-100 p-2">
                      <option value="">Select District</option>
                      {% for district in districts %}
                      <option value="{{ district }}">{{ district }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="tempAddress">Street Address / City (Temporary) <span class="required">*</span></label>
                    <input type="text" id="tempAddress" name="temporary_address" placeholder="e.g., Kathmandu, Nepal" required />
                  </div>
                </div>
                
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="permAddress">Permanent Address <span class="required">*</span></label>
                    <input type="text" id="permAddress" name="permanent_address" placeholder="e.g., Bhaktapur, Nepal" required />
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="profession">Profession and Academic Qualification <span class="required">*</span></label>
                    <input type="text" id="profession" name="profession" placeholder="" required />
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="fb_link">Social Media Link <span class="required">*</span></label>
                    <input type="text" id="fb_link" name="social_link" placeholder="Facebook/LinkedIn/Twitter" required />
                  </div>
                </div>

                <!-- Application Section -->
                <div class="col-12 mb-4 mt-4">
                  <h3 style="color: #2d3b5b; border-bottom: 2px solid #8f5556; padding-bottom: 5px;">Application Proper</h3>
                </div>
                
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="why_join">Why do you want to join Aarambha Foundation? <span class="required">*</span></label>
                    <textarea id="why_join" name="why_join" required class="w-100 p-2" rows="3"></textarea>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="self_definition">How do you define yourself and your goal in life? <span class="required">*</span></label>
                    <textarea id="self_definition" name="self_definition" required class="w-100 p-2" rows="3"></textarea>
                  </div>
                </div>
                
                <div class="col-12">
                  <div class="form-group">
                    <label for="ideas">What ideas can you bring if you are given a platform with a full support?</label>
                    <textarea id="ideas" name="ideas" class="w-100 p-2" rows="3"></textarea>
                  </div>
                </div>

                <div class="col-12">
                  <div class="form-group">
                    <label>What skills do you possess? <span class="required">*</span><br /><small>(Select all that apply)</small></label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 10px;">
                      <label><input type="checkbox" name="skills" value="Leadership" /> Leadership</label>
                      <label><input type="checkbox" name="skills" value="Graphics Designing" /> Graphics Designing</label>
                      <label><input type="checkbox" name="skills" value="Photoshop" /> Photoshop / Photo Editing</label>
                      <label><input type="checkbox" name="skills" value="Web Designing" /> Web Designing / Development</label>
                      <label><input type="checkbox" name="skills" value="Team Building" /> Team Building</label>
                      <label><input type="checkbox" name="skills" value="Management" /> Management / Coordination</label>
                      <label><input type="checkbox" name="skills" value="Social Media Marketing" /> Social Media Marketing</label>
                      <label><input type="checkbox" id="otherSkillCheck" value="Other" /> Other (please specify)</label>
                    </div>
                    <div id="otherSkillBox" style="margin-top: 12px; display: none">
                      <input type="text" name="skills_other" placeholder="Please specify your skill..." style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px;" />
                    </div>
                  </div>
                </div>

                <div class="col-12">
                  <div class="form-group">
                    <label>How much time can you give to Aarambha Foundation in a week? <span class="required">*</span></label>
                    <div style="margin-top: 12px; display: flex; flex-direction: column; gap: 12px;">
                      <label><input type="radio" name="time_commitment" value="Less than 5 hours" required /> Less than 5 hours a week</label>
                      <label><input type="radio" name="time_commitment" value="5-10 hours" required /> 5–10 hours a week</label>
                      <label><input type="radio" name="time_commitment" value="10-15 hours" required /> 10–15 hours a week</label>
                      <label><input type="radio" name="time_commitment" value="15-20 hours" required /> 15–20 hours a week</label>
                      <label><input type="radio" name="time_commitment" value="More than 20 hours" required /> More than 20 hours a week</label>
                    </div>
                  </div>
                </div>

                <div class="col-12">
                  <div class="form-group">
                    <label for="other_organizations">Are you involved in any other organizations? What are your expectations from us?</label>
                    <textarea id="other_organizations" name="other_organizations" class="w-100 p-2" rows="3"></textarea>
                  </div>
                </div>

                <!-- Document Upload Section -->
                <div class="col-12 mb-4 mt-4">
                  <h3 style="color: #2d3b5b; border-bottom: 2px solid #8f5556; padding-bottom: 5px;">Upload Required Documents</h3>
                  <p style="color: #555;">Please upload clear scans/photos of the following documents (JPG, PNG or PDF • Max 10 MB each).</p>
                </div>
                
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="citizenship_front">Upload Citizenship Front <span class="required">*</span></label>
                    <p style="font-size: 14px; color: #666;">Upload 1 supported file. Max 10 MB.</p>
                    <input type="file" id="citizenship_front" name="citizenship_front" accept="image/jpeg,image/png,application/pdf" required style="margin-top: 10px; padding: 10px; border: 2px dashed #ccc; border-radius: 8px; width: 100%; background: #f9f9f9;" />
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="citizenship_back">Upload Citizenship Back <span class="required">*</span></label>
                    <p style="font-size: 14px; color: #666;">Upload 1 supported file. Max 10 MB.</p>
                    <input type="file" id="citizenship_back" name="citizenship_back" accept="image/jpeg,image/png,application/pdf" required style="margin-top: 10px; padding: 10px; border: 2px dashed #ccc; border-radius: 8px; width: 100%; background: #f9f9f9;" />
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="photo">Upload Photo <span class="required">*</span></label>
                    <p style="font-size: 14px; color: #666;">Upload 1 supported file. Max 10 MB. (Passport-size preferred)</p>
                    <input type="file" id="photo" name="photo" accept="image/jpeg,image/png" required style="margin-top: 10px; padding: 10px; border: 2px dashed #ccc; border-radius: 8px; width: 100%; background: #f9f9f9;" />
                  </div>
                </div>

                <!-- Final Section -->
                <div class="col-12 mb-4 mt-4">
                  <h3 style="color: #2d3b5b; border-bottom: 2px solid #8f5556; padding-bottom: 5px;">Almost Done!</h3>
                  <p>Thank you for your interest in becoming a member of <strong>Aarambha Foundation</strong>.</p>
                  <p>After submission, our team will review your application and contact you soon.</p>
                  <div class="form-group">
                    <label><input type="checkbox" required /> I agree to the terms and wish to join Aarambha Foundation as a member.</label>
                  </div>
                  <button type="submit" class="start-btn" style="background: #2e8b57; margin-top: 20px;">Submit Application</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  </section>


    {% include "website/includes/footer.html" %}
  <!-- scripts start -->
  <!-- jquery  start-->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"
    referrerpolicy="no-referrer"></script>
  <!-- jquery end -->
  <!-- bootstrap  start -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
    crossorigin="anonymous"></script>
  <!-- bootstrap end -->
  <script src="{% static 'website/js/slick.min.js' %}" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- Swiper JS -->
  <script src="{% static 'website/js/swiper-bundle.min.js' %}" crossorigin="anonymous"
    referrerpolicy="no-referrer"></script>
  <script src="{% static 'website/js/modernizr.min.js' %}" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script>
  <script src="{% static 'website/js/owl.carousel.min.js' %}"></script>
  <script src="{% static 'website/js/api.js' %}"></script>
  <script src="{% static 'website/js/main.js' %}"></script>
  <script src="{% static 'website/js/animation.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="{% static 'website/js/general.js' %}"></script>
  <script src="{% static 'website/js/nav.js' %}"></script>
  <script src="{% static 'website/js/script.js' %}"></script>
  <script src="{% static 'website/js/min.js' %}"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <!-- jquery  start-->
  <!-- Upgrade Confirmation Modal -->
  <div id="upgradeModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div
      style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%; text-align: center;">
      <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #111827;">Upgrade to Member</h2>
      <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 20px 0; text-align: left;">
        <h4 style="color: #2d3b5b; margin-bottom: 15px;"><i class="fas fa-arrow-up"></i> Membership Upgrade</h4>
        <p style="margin-bottom: 10px;"><strong>Current Status:</strong> Volunteer</p>
        <p style="margin-bottom: 10px;"><strong>Upgrading to:</strong> Full Member</p>
        <p style="margin-bottom: 10px;"><strong>Membership Fee:</strong> Rs. 1,000 (One-time payment)</p>
        <p style="margin-bottom: 0; color: #666;"><strong>Note:</strong> Once approved, you will need to pay the membership fee to complete your upgrade.</p>
      </div>
      <p style="color: #4b5563; font-size: 0.875rem; margin-bottom: 1rem;">Do you want to proceed with the membership upgrade application?</p>
      <div style="display: flex; gap: 0.5rem; justify-content: center;">
        <button onclick="confirmUpgrade()"
          style="background-color: #2d3b5b; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600;">Yes, Upgrade</button>
        <button onclick="closeUpgradeModal()"
          style="background-color: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-left: 10px; cursor: pointer;">Cancel</button>
      </div>
    </div>
  </div>
  </div>

  {% include 'website/includes/login_modal.html' %}
  {% include 'website/includes/navbar_login_modal.html' %}

  <!-- Hidden Config for JS -->
  <script src="{% static 'js/config.js' %}"></script>
  <script>
    // CSRF token helper function
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    
    async function startApplication() {
      // Check both Django session and localStorage token
      const user = getUser();
      const isDjangoAuthenticated = window.djangoUser && window.djangoUser.isAuthenticated;
      
      if (!user && !isDjangoAuthenticated) {
        // Store flag to show form after login
        localStorage.setItem('showMemberFormAfterLogin', 'true');
        document.getElementById('loginModal').style.display = 'flex';
        return;
      }

      // Check application status
      await checkApplicationStatus();
      
      // If still showing start section, show the form
      if (document.getElementById('startSection').style.display !== 'none') {
        showMemberForm();
      }
    }

    function showMemberForm() {
      document.getElementById("startSection").style.display = "none";
      const form = document.getElementById("membershipForm");
      form.style.display = "block";
      form.classList.add("show");
    }

    // Check User Login Status and Show Modal
    function checkLoginAndShowModal() {
      const user = getUser();
      if (!user) {
        document.getElementById('loginModal').style.display = 'flex';
      } else {
        document.getElementById('loginModal').style.display = 'none';
      }
      updateNavbarAuth();
    }

    // Check application status on page load
    document.addEventListener('DOMContentLoaded', async function() {
      updateNavbarAuth();
      
      // Check if user is logged in
      const user = getUser();
      const isDjangoAuthenticated = window.djangoUser && window.djangoUser.isAuthenticated;
      
      if (user || isDjangoAuthenticated) {
        await checkApplicationStatus();
        
        // Check if form should be shown after login
        if (localStorage.getItem('showMemberFormAfterLogin') === 'true') {
          localStorage.removeItem('showMemberFormAfterLogin');
          if (document.getElementById('startSection').style.display !== 'none') {
            showMemberForm();
          }
        }
      }
    });

    async function checkApplicationStatus() {
      try {
        const token = getToken();
        const headers = {};
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        
        const csrfToken = getCookie('csrftoken');
        if (csrfToken) {
          headers['X-CSRFToken'] = csrfToken;
        }

        const response = await fetch('/api/applications/my-applications/', {
          method: 'GET',
          headers: headers,
          credentials: 'include'
        });

        if (response.ok) {
          const applications = await response.json();
          
          // Check if user has any member applications
          const hasMemberApplication = applications.some(app => app.application_type === 'member');
          
          if (hasMemberApplication) {
            // User already has member application
            document.getElementById('startSection').innerHTML = `
              <h3 class="mt-1 pb-0">Application Status</h3>
              <p class="mb-0">You have already submitted a membership application.</p>
              <button class="start-btn" onclick="window.location.href='/guest/profile/#applications'">
                See Application Status
              </button>
            `;
            return;
          }
          
          // Check if user is volunteer (has volunteer application but no member application)
          const hasVolunteerApplication = applications.some(app => app.application_type === 'volunteer');
          
          if (hasVolunteerApplication) {
            // User is volunteer, show upgrade option
            document.getElementById('startSection').innerHTML = `
              <h3 class="mt-1 pb-0">Upgrade to Member</h3>
              <p class="mb-0">You are currently a volunteer. Upgrade to become a full member of Aarambha Foundation.</p>
              <p style="color: #666; font-size: 14px; margin-top: 10px;"><strong>Note:</strong> Membership requires a one-time fee of Rs. 1,000 after approval.</p>
              <button class="start-btn" onclick="showUpgradeModal()">
                Upgrade to Member
              </button>
              <button class="start-btn" onclick="window.location.href='/guest/profile/#applications'" style="background: #6c757d; margin-left: 10px;">
                See Application Status
              </button>
            `;
            return;
          }
        }
      } catch (error) {
        console.error('Error checking application status:', error);
      }
    }
      const originalHandleModalLogin = window.handleModalLogin;
      window.handleModalLogin = async function (e) {
        e.preventDefault();
        const username = document.getElementById("modalUsername").value;
        const password = document.getElementById("modalPassword").value;
        const errorDiv = document.getElementById("modalLoginError");
        const btn =
          e.submitter || e.target.querySelector('button[type="submit"]');

        btn.disabled = true;
        btn.innerHTML = "Logging in...";
        errorDiv.textContent = "";

        try {
          const response = await fetch("/api/users/login/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });
          const data = await response.json();

          if (response.ok) {
            setToken(data.access, data.refresh);
            setUser(data.user);
            document.getElementById("loginModal").style.display = "none";

            updateNavbarAuth();

            if (showFormAfterLogin) {
              showFormAfterLogin = false;
              document.getElementById("startSection").style.display = "none";
              document.getElementById("membershipForm").style.display = "block";
            }
          } else {
            errorDiv.textContent =
              data.non_field_errors?.[0] ||
              "Login failed. Please check credentials.";
          }
        } catch (error) {
          console.error(error);
          errorDiv.textContent = "Network error. Please try again.";
        } finally {
          btn.disabled = false;
          btn.innerHTML = "Login";
        }
      };

      // Override OTP login too
      const originalVerifyModalOTP = window.verifyModalOTP;
      window.verifyModalOTP = async function (btn) {
        const email = document.getElementById("modalEmail").value;
        const otp = document.getElementById("modalotpInput").value;
        const errorDiv = document.getElementById("modalOtpError");

        if (!otp || otp.length < 6) {
          errorDiv.textContent = "Invalid OTP";
          return;
        }

        btn.disabled = true;
        btn.innerHTML = "Verifying...";

        try {
          const response = await fetch("/api/users/verify-otp/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, otp }),
          });
          const data = await response.json();

          if (response.ok) {
            setToken(data.access, data.refresh);
            setUser(data.user);
            document.getElementById("loginModal").style.display = "none";

            updateNavbarAuth();

            if (showFormAfterLogin) {
              showFormAfterLogin = false;
              document.getElementById("startSection").style.display = "none";
              document.getElementById("membershipForm").style.display = "block";
            }
          } else {
            errorDiv.style.color = "#dc3545";
            errorDiv.textContent = data.error || "Invalid OTP";
          }
        } catch (e) {
          errorDiv.style.color = "#dc3545";
          errorDiv.textContent = "Error verifying OTP";
        } finally {
          btn.disabled = false;
          btn.innerHTML = "Verify & Login";
        }
      };




    // Load Countries
    fetch('https://restcountries.com/v3.1/all?fields=name')
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById('tempCountry');
        const sorted = data.sort((a, b) => a.name.common.localeCompare(b.name.common));
        select.innerHTML = sorted.map(c =>
          `<option value="${c.name.common}" ${c.name.common === 'Nepal' ? 'selected' : ''}>${c.name.common}</option>`
        ).join('');
        toggleDistrictField();
      })
      .catch(err => {
        console.error('Failed to load countries:', err);
        document.getElementById('tempCountry').innerHTML = '<option value="Nepal" selected>Nepal</option>';
        toggleDistrictField();
      });

    // Toggle district field based on country
    document.getElementById('tempCountry').addEventListener('change', toggleDistrictField);

    function toggleDistrictField() {
      const country = document.getElementById('tempCountry').value;
      const districtField = document.getElementById('tempDistrictField');
      const districtSelect = document.getElementById('tempDistrict');

      if (country === 'Nepal') {
        districtField.style.display = 'block';
        districtSelect.required = true;
      } else {
        districtField.style.display = 'none';
        districtSelect.required = false;
        districtSelect.value = '';
      }
    }

    document.getElementById("membershipForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      // Basic Validation if needed

      const formData = new FormData(e.target);

      // Add default values for fields not in UI
      // formData.append('country', 'Nepal'); // dynamic now

      const country = document.getElementById('tempCountry').value;
      const district = document.getElementById('tempDistrict').value;

      formData.append('country', country);
      if (country === 'Nepal' && district) {
        formData.append('district', district);
      }

      formData.append('application_type', 'member');
      
      // Add upgrade flag if this is an upgrade application
      if (window.isUpgradeApplication) {
        formData.append('is_upgrade', 'true');
      }

      // Handle Skills
      const skills = [];
      document.querySelectorAll('input[name="skills"]:checked').forEach(cb => {
        skills.push(cb.value);
      });
      // Check for "other" text
      const otherSkillText = document.querySelector('input[name="skills_other"]')?.value;
      if (otherSkillText && skills.includes('Other')) {
        // Append detail to Other or just add it
        // Start-up ghar backend likely just takes the list. 
        // We can replace "Other" with "Other: value" or just append it.
        skills.push(`Other: ${otherSkillText}`);
      }
      formData.delete('skills');
      formData.append('skills', JSON.stringify(skills));

      const submitBtn = e.submitter || document.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = 'Submitting...';
      submitBtn.disabled = true;

      try {
        // Check authentication method
        const token = getToken();
        const isDjangoAuthenticated = window.djangoUser && window.djangoUser.isAuthenticated;
        
        if (!token && !isDjangoAuthenticated) {
          alert('Please login first to submit the application.');
          window.location.href = '/accounts/login/';
          return;
        }

        // Use appropriate authentication method
        const headers = {};
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        
        // Add CSRF token for session auth
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.querySelector('meta[name=csrf-token]')?.content ||
                         getCookie('csrftoken');
        if (csrfToken) {
          headers['X-CSRFToken'] = csrfToken;
        }
        // For Django session auth, credentials are sent automatically

        const response = await fetch('/api/applications/submit/', {
          method: 'POST',
          headers: headers,
          body: formData,
          credentials: 'include' // Include cookies for session auth
        });

        const data = await response.json();

        if (response.ok) {
          // Always show success message without payment modal
          Swal.fire({
            title: "Success!",
            text: "Application submitted successfully! You can view your application status in your profile.",
            icon: "success"
          }).then(() => {
            window.location.href = '/guest/profile/#applications';
          });
        } else {
          console.error(data);
          let errorMsg = 'Submission failed.';
          if (typeof data === 'object') {
            errorMsg = Object.entries(data).map(([k, v]) => `${k}: ${v}`).join('\n');
          }
          Swal.fire({
            title: "Error!",
            text: errorMsg,
            icon: "error"
          });
        }
      } catch (error) {
        console.error(error);
        Swal.fire({
          title: "Error!",
          text: "Network error. Please try again.",
          icon: "error"
        });
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    function showUpgradeModal() {
      document.getElementById('upgradeModal').style.display = 'flex';
    }

    function closeUpgradeModal() {
      document.getElementById('upgradeModal').style.display = 'none';
    }

    function confirmUpgrade() {
      closeUpgradeModal();
      // Call automatic upgrade API instead of showing form
      performAutoUpgrade();
    }

    async function performAutoUpgrade() {
      // Show loading state
      Swal.fire({
        title: 'Processing Upgrade...',
        text: 'Please wait while we process your membership upgrade.',
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      try {
        const token = getToken();
        const headers = {};
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        
        const csrfToken = getCookie('csrftoken');
        if (csrfToken) {
          headers['X-CSRFToken'] = csrfToken;
        }

        const response = await fetch('/api/applications/auto-upgrade/', {
          method: 'POST',
          headers: headers,
          credentials: 'include'
        });

        const data = await response.json();

        if (response.ok) {
          Swal.fire({
            title: "Success!",
            text: "Your membership upgrade application has been submitted successfully!",
            icon: "success"
          }).then(() => {
            window.location.href = '/guest/profile/#applications';
          });
        } else {
          Swal.fire({
            title: "Error!",
            text: data.error || "Failed to submit upgrade application.",
            icon: "error"
          });
        }
      } catch (error) {
        console.error('Upgrade error:', error);
        Swal.fire({
          title: "Error!",
          text: "Network error. Please try again.",
          icon: "error"
        });
      }
    }

  </script>

</body>

</html>