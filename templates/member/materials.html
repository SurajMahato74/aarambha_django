{% extends 'member/base.html' %}
{% load static %}

{% block page_title %}Reading Materials{% endblock %}

{% block header_title %}
<div class="flex items-center">
    <a href="/member/dashboard/" class="text-orange-500 hover:text-orange-400 mr-3">
        <i class="fas fa-arrow-left"></i>
    </a>
    Reading Materials
</div>
{% endblock %}

{% block content %}
<div class="bg-white rounded-xl shadow-lg p-6">
    <div class="mb-6">
        <div class="flex flex-wrap gap-3">
            <button class="category-filter bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium" data-category="all">
                All Categories
            </button>
            <div id="categoryFilters"></div>
        </div>
    </div>
    
    <div id="materialsContainer">
        <div class="text-center py-8">
            <i class="fas fa-spinner fa-spin fa-2x text-gray-400 mb-3"></i>
            <p class="text-gray-500">Loading materials...</p>
        </div>
    </div>
</div>

<script>
    // Remove redirect - let Django handle authentication
    console.log('Member materials loaded - no client-side auth check');
    
    let materials = [];
    let categories = [];
    let currentCategory = 'all';
    
    loadMaterials();
    loadCategories();
    
    async function loadMaterials() {
        try {
            const response = await fetch('/api/materials/my-materials/', {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                materials = data.materials || [];
                renderMaterials();
            } else {
                document.getElementById('materialsContainer').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle fa-2x text-red-500 mb-3"></i>
                        <p class="text-red-600 font-medium">Error loading materials: ${response.status}</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading materials:', error);
            document.getElementById('materialsContainer').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle fa-2x text-red-500 mb-3"></i>
                    <p class="text-red-600 font-medium">Network error loading materials</p>
                </div>
            `;
        }
    }
    
    async function loadCategories() {
        try {
            const response = await fetch('/api/materials/categories/', {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                categories = data.categories || [];
                renderCategoryFilters();
            }
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }
    
    function renderCategoryFilters() {
        const container = document.getElementById('categoryFilters');
        container.innerHTML = categories.map(category => `
            <button class="category-filter bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium" data-category="${category.id}">
                ${category.name}
            </button>
        `).join('');
        
        // Add event listeners
        document.querySelectorAll('.category-filter').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.category-filter').forEach(b => {
                    b.classList.remove('bg-orange-600', 'text-white');
                    b.classList.add('bg-gray-200', 'text-gray-700');
                });
                e.target.classList.remove('bg-gray-200', 'text-gray-700');
                e.target.classList.add('bg-orange-600', 'text-white');
                
                currentCategory = e.target.dataset.category;
                renderMaterials();
            });
        });
    }
    
    function renderMaterials() {
        const container = document.getElementById('materialsContainer');
        
        let filteredMaterials = materials;
        if (currentCategory !== 'all') {
            filteredMaterials = materials.filter(m => m.category === categories.find(c => c.id == currentCategory)?.name);
        }
        
        if (filteredMaterials.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-book fa-3x text-gray-400 mb-4"></i>
                    <p class="text-gray-600 font-medium">No materials available.</p>
                    <p class="text-gray-500 text-sm mt-1">Check back later for new materials</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${filteredMaterials.map(material => `
                    <div class="bg-white border border-gray-200 rounded-lg p-6 cursor-pointer hover:shadow-lg transition-all duration-300" onclick="showMaterialDetail(${material.id})">
                        ${material.cover_image_url ? `<img src="${material.cover_image_url}" alt="${material.title}" class="w-full h-32 object-cover rounded-lg mb-4">` : ''}
                        <div class="flex items-start justify-between mb-3">
                            <h3 class="text-gray-800 font-semibold text-lg">${material.title}</h3>
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-medium">${material.category}</span>
                        </div>
                        <p class="text-gray-600 text-sm mb-4 line-clamp-3">${material.description.replace(/<[^>]*>/g, '').substring(0, 100)}...</p>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-500">${new Date(material.created_at).toLocaleDateString()}</span>
                            <button onclick="event.stopPropagation(); window.open('${material.file_url}', '_blank')" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded-lg text-sm font-medium">
                                <i class="fas fa-download mr-1"></i>Download
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
</script>

<!-- Material Detail Modal -->
<div id="materialDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-2xl font-bold text-gray-800"></h3>
                <button onclick="closeMaterialModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <div id="modalCoverImage" class="mb-6"></div>
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Description</h4>
                        <div id="modalDescription" class="text-gray-600 prose max-w-none"></div>
                    </div>
                </div>
                
                <div class="space-y-6">
                    <div class="bg-gray-50 rounded-lg p-4 border">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Material Info</h4>
                        <div class="space-y-3">
                            <div>
                                <span class="text-gray-600 text-sm font-medium">Category:</span>
                                <span id="modalCategory" class="text-gray-800 ml-2"></span>
                            </div>
                            <div>
                                <span class="text-gray-600 text-sm font-medium">Published:</span>
                                <span id="modalDate" class="text-gray-800 ml-2"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <button id="modalDownloadBtn" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-3 px-4 rounded-lg font-medium">
                            <i class="fas fa-download mr-2"></i>Download Material
                        </button>
                        <button id="modalOpenBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium">
                            <i class="fas fa-external-link-alt mr-2"></i>Open in New Tab
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function showMaterialDetail(materialId) {
        const material = materials.find(m => m.id === materialId);
        if (!material) return;
        
        document.getElementById('modalTitle').textContent = material.title;
        document.getElementById('modalCategory').textContent = material.category;
        document.getElementById('modalDate').textContent = new Date(material.created_at).toLocaleDateString();
        document.getElementById('modalDescription').innerHTML = material.description;
        
        if (material.cover_image_url) {
            document.getElementById('modalCoverImage').innerHTML = `<img src="${material.cover_image_url}" alt="${material.title}" class="w-full h-48 object-cover rounded-lg">`;
        } else {
            document.getElementById('modalCoverImage').innerHTML = '';
        }
        
        document.getElementById('modalDownloadBtn').onclick = () => {
            const a = document.createElement('a');
            a.href = material.file_url;
            a.download = material.title;
            a.click();
        };
        
        document.getElementById('modalOpenBtn').onclick = () => {
            window.open(material.file_url, '_blank');
        };
        
        document.getElementById('materialDetailModal').classList.remove('hidden');
    }
    
    function closeMaterialModal() {
        document.getElementById('materialDetailModal').classList.add('hidden');
    }
</script>
{% endblock %}