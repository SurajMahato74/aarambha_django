{% extends 'sponsor/base.html' %}

{% block title %}My Assignments{% endblock %}
{% block page_title %}Child Assignments{% endblock %}
{% block page_subtitle %}Review and approve your assigned children{% endblock %}

{% block content %}
<div class="space-y-6">
    <div id="assignmentsList" class="space-y-4">
        <div class="text-center py-8 text-slate-400">
            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
            <p>Loading assignments...</p>
        </div>
    </div>
</div>

<!-- Child Detail Modal -->
<div id="childModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-slate-800 rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-slate-700">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold text-white">Child Profile</h3>
                <button onclick="closeChildModal()" class="text-slate-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        <div id="childModalBody" class="p-6">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>

<script>
let currentAssignmentId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadAssignments();
    
    // Check for specific assignment ID in URL
    const urlParams = new URLSearchParams(window.location.search);
    const assignmentId = urlParams.get('id');
    if (assignmentId) {
        setTimeout(() => viewChildDetails(assignmentId), 1000);
    }
});

async function loadAssignments() {
    try {
        const response = await fetchAPI('/api/applications/my-assignments/');
        const assignments = await response.json();
        
        // Get sponsor's sponsorship details for matching calculation
        const sponsorshipResponse = await fetchAPI('/api/applications/sponsorships/my/');
        const sponsorshipData = await sponsorshipResponse.json();
        const sponsorship = sponsorshipData.length > 0 ? sponsorshipData[0] : null;
        
        // If no sponsorship found, try to get from assignment data
        let sponsorshipForMatching = sponsorship;
        if (!sponsorship && assignments.length > 0) {
            // Create a mock sponsorship object from assignment data if available
            sponsorshipForMatching = {
                child_gender: '',
                child_age: '',
                sponsorship_type: 'Full Sponsorship',
                payment_amount: null,
                payment_frequency: 'Monthly',
                country: 'Nepal',
                special_requests: '',
                message: ''
            };
        }
        
        // Calculate match scores for each assignment
        const assignmentsWithScores = assignments.map(assignment => ({
            ...assignment,
            matchScore: sponsorshipForMatching ? calculateMatchScore(sponsorshipForMatching, assignment.child) : 0
        }));
        
        displayAssignments(assignmentsWithScores);
    } catch (error) {
        console.error('Error loading assignments:', error);
        document.getElementById('assignmentsList').innerHTML = `
            <div class="text-center py-8 text-red-400">
                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                <p>Error loading assignments</p>
            </div>
        `;
    }
}

function displayAssignments(assignments) {
    const container = document.getElementById('assignmentsList');
    
    if (assignments.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12 text-slate-400">
                <i class="fas fa-child text-6xl mb-4 opacity-50"></i>
                <h3 class="text-xl font-semibold mb-2">No Assignments Yet</h3>
                <p>You haven't been assigned any children for sponsorship yet.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = assignments.map(assignment => `
        <div class="card p-6 rounded-lg border-l-4 ${assignment.matchScore >= 80 ? 'border-green-400' : assignment.matchScore >= 60 ? 'border-yellow-400' : assignment.matchScore >= 40 ? 'border-orange-400' : 'border-red-400'}">
            <div class="flex items-start justify-between">
                <div class="flex items-start space-x-4">
                    <div class="w-16 h-16 rounded-full overflow-hidden flex-shrink-0">
                        ${assignment.child.photo ? 
                            `<img src="${assignment.child.photo}" alt="${assignment.child.full_name}" class="w-full h-full object-cover">` :
                            `<div class="w-full h-full bg-indigo-500 flex items-center justify-center text-white font-bold text-xl">${assignment.child.full_name.charAt(0).toUpperCase()}</div>`
                        }
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <h3 class="text-lg font-semibold text-white">${assignment.child.full_name}</h3>
                            <div class="px-2 py-1 rounded-full text-xs font-bold ${assignment.matchScore >= 80 ? 'bg-green-500/20 text-green-400' : assignment.matchScore >= 60 ? 'bg-yellow-500/20 text-yellow-400' : assignment.matchScore >= 40 ? 'bg-orange-500/20 text-orange-400' : 'bg-red-500/20 text-red-400'}">
                                ${assignment.matchScore}% Match
                            </div>
                        </div>
                        <p class="text-slate-400">${assignment.child.age} years old, ${assignment.child.gender}</p>
                        <p class="text-slate-400">${assignment.child.district}, ${assignment.child.village}</p>
                        ${assignment.child.school_name ? `<p class="text-slate-400">${assignment.child.school_name} - Grade ${assignment.child.grade_level}</p>` : ''}
                        <p class="text-indigo-400 font-medium mt-2">Rs. ${assignment.child.monthly_sponsorship_amount}/month</p>
                        <p class="text-slate-500 text-sm mt-1">Assigned ${formatDate(assignment.assigned_at)}</p>
                    </div>
                </div>
                <div class="flex flex-col space-y-2">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${getAssignmentStatusColor(assignment.status)}">
                        ${assignment.status.charAt(0).toUpperCase() + assignment.status.slice(1)}
                    </span>
                    <button onclick="viewChildDetails(${assignment.id})" 
                        class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                        View Profile
                    </button>
                    ${assignment.status === 'pending' ? `
                        <button onclick="approveAssignment(${assignment.id})" 
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                            Approve
                        </button>
                    ` : ''}
                </div>
            </div>
            ${assignment.child.story ? `
                <div class="mt-4 p-4 bg-slate-700 rounded-lg">
                    <h4 class="font-medium text-white mb-2">Child's Story</h4>
                    <p class="text-slate-300 text-sm">${assignment.child.story.substring(0, 200)}${assignment.child.story.length > 200 ? '...' : ''}</p>
                </div>
            ` : ''}
        </div>
    `).join('');
}

async function viewChildDetails(assignmentId) {
    try {
        const response = await fetchAPI('/api/applications/my-assignments/');
        const assignments = await response.json();
        const assignment = assignments.find(a => a.id == assignmentId);
        
        if (!assignment) {
            alert('Assignment not found');
            return;
        }
        
        const child = assignment.child;
        currentAssignmentId = assignmentId;
        
        document.getElementById('childModalBody').innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div class="text-center">
                        <div class="w-32 h-32 rounded-full overflow-hidden mx-auto mb-4">
                            ${child.photo ? 
                                `<img src="${child.photo}" alt="${child.full_name}" class="w-full h-full object-cover">` :
                                `<div class="w-full h-full bg-indigo-500 flex items-center justify-center text-white font-bold text-4xl">${child.full_name.charAt(0).toUpperCase()}</div>`
                            }
                        </div>
                        <h3 class="text-xl font-semibold text-white">${child.full_name}</h3>
                        <p class="text-slate-400">${child.age} years old, ${child.gender}</p>
                    </div>
                    
                    <div class="space-y-3">
                        <div><span class="text-slate-400">Location:</span> <span class="text-white">${child.district}, ${child.village}</span></div>
                        ${child.school_name ? `<div><span class="text-slate-400">School:</span> <span class="text-white">${child.school_name}</span></div>` : ''}
                        ${child.grade_level ? `<div><span class="text-slate-400">Grade:</span> <span class="text-white">${child.grade_level}</span></div>` : ''}
                        <div><span class="text-slate-400">Monthly Need:</span> <span class="text-white font-medium">Rs. ${child.monthly_sponsorship_amount}</span></div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    ${child.story ? `
                        <div>
                            <h4 class="font-medium text-white mb-2">Story</h4>
                            <p class="text-slate-300 text-sm">${child.story}</p>
                        </div>
                    ` : ''}
                    
                    ${child.interests_hobbies ? `
                        <div>
                            <h4 class="font-medium text-white mb-2">Interests & Hobbies</h4>
                            <p class="text-slate-300 text-sm">${child.interests_hobbies}</p>
                        </div>
                    ` : ''}
                    
                    ${child.dreams_aspirations ? `
                        <div>
                            <h4 class="font-medium text-white mb-2">Dreams & Aspirations</h4>
                            <p class="text-slate-300 text-sm">${child.dreams_aspirations}</p>
                        </div>
                    ` : ''}
                    
                    ${child.family_situation ? `
                        <div>
                            <h4 class="font-medium text-white mb-2">Family Situation</h4>
                            <p class="text-slate-300 text-sm">${child.family_situation}</p>
                        </div>
                    ` : ''}
                    
                    ${child.educational_needs ? `
                        <div>
                            <h4 class="font-medium text-white mb-2">Educational Needs</h4>
                            <p class="text-slate-300 text-sm">${child.educational_needs}</p>
                        </div>
                    ` : ''}
                </div>
            </div>
            
            ${assignment.status === 'pending' ? `
                <div class="mt-6 flex justify-center">
                    <button onclick="approveAssignment(${assignment.id})" 
                        class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-medium">
                        <i class="fas fa-heart mr-2"></i>Approve Sponsorship
                    </button>
                </div>
            ` : ''}
        `;
        
        document.getElementById('childModal').classList.remove('hidden');
        document.getElementById('childModal').classList.add('flex');
    } catch (error) {
        console.error('Error loading child details:', error);
        alert('Error loading child details');
    }
}

function closeChildModal() {
    document.getElementById('childModal').classList.add('hidden');
    document.getElementById('childModal').classList.remove('flex');
    currentAssignmentId = null;
}

async function approveAssignment(assignmentId) {
    if (!confirm('Are you sure you want to approve this sponsorship? This will start your sponsorship journey with this child.')) {
        return;
    }
    
    try {
        const response = await fetchAPI(`/api/applications/assignments/${assignmentId}/approve/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            alert('Sponsorship approved successfully! Welcome to your sponsorship journey.');
            closeChildModal();
            // Redirect to children page
            window.location.href = result.redirect_url || '/sponsor/children/';
        } else {
            const error = await response.json();
            alert('Error approving sponsorship: ' + (error.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error approving assignment:', error);
        alert('Error approving sponsorship');
    }
}

function getAssignmentStatusColor(status) {
    const colors = {
        pending: 'bg-yellow-100 text-yellow-800',
        approved: 'bg-green-100 text-green-800',
        rejected: 'bg-red-100 text-red-800'
    };
    return colors[status] || 'bg-gray-100 text-gray-800';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString();
}

// Matching algorithm functions (same as admin side)
function calculateMatchScore(sponsorship, child) {
    let score = 0;
    let totalCriteria = 0;
    
    // Gender preference (15 points)
    if (sponsorship.child_gender) {
        totalCriteria += 15;
        if (child.gender === sponsorship.child_gender) {
            score += 15;
        }
    }
    
    // Age preference (15 points)
    if (sponsorship.child_age) {
        totalCriteria += 15;
        const childAge = child.age;
        const ageRange = sponsorship.child_age;
        
        if (ageRange === '5-8' && childAge >= 5 && childAge <= 8) score += 15;
        else if (ageRange === '9-12' && childAge >= 9 && childAge <= 12) score += 15;
        else if (ageRange === '13-16' && childAge >= 13 && childAge <= 16) score += 15;
    }
    
    // Sponsorship type match (20 points)
    totalCriteria += 20;
    const sponsorType = sponsorship.sponsorship_type ? sponsorship.sponsorship_type.toLowerCase().replace(' ', '_') : '';
    if (child.preferred_sponsorship_type && Array.isArray(child.preferred_sponsorship_type)) {
        if (child.preferred_sponsorship_type.includes(sponsorType) || 
            (child.preferred_sponsorship_type.includes('full') && sponsorType.includes('full')) ||
            (child.preferred_sponsorship_type.includes('partial') && sponsorType.includes('partial'))) {
            score += 20;
        }
    }
    
    // Payment amount compatibility (15 points)
    if (sponsorship.payment_amount && child.monthly_sponsorship_amount) {
        totalCriteria += 15;
        const sponsorAmount = parseFloat(sponsorship.payment_amount);
        const childNeed = parseFloat(child.monthly_sponsorship_amount);
        
        if (sponsorAmount >= childNeed) {
            score += 15;
        } else if (sponsorAmount >= childNeed * 0.7) {
            score += 12;
        } else if (sponsorAmount >= childNeed * 0.5) {
            score += 8;
        }
    }
    
    // Payment frequency match (10 points)
    totalCriteria += 10;
    const sponsorFreq = sponsorship.payment_frequency ? sponsorship.payment_frequency.toLowerCase() : '';
    if (child.preferred_frequency && Array.isArray(child.preferred_frequency) && child.preferred_frequency.includes(sponsorFreq)) {
        score += 10;
    }
    
    // Location preference (10 points)
    if (sponsorship.country && child.country) {
        totalCriteria += 10;
        if (sponsorship.country === child.country) {
            score += 10;
        }
    }
    
    // Text similarity matching (15 points)
    totalCriteria += 15;
    const textScore = calculateTextSimilarity(sponsorship, child);
    score += Math.round(textScore * 15);
    
    return totalCriteria > 0 ? Math.round((score / totalCriteria) * 100) : 0;
}

function calculateTextSimilarity(sponsorship, child) {
    const sponsorTexts = [
        sponsorship.special_requests || '',
        sponsorship.message || ''
    ].join(' ').toLowerCase();
    
    const childTexts = [
        child.story || '',
        child.interests_hobbies || '',
        child.personality_description || '',
        child.dreams_aspirations || '',
        child.educational_needs || '',
        child.health_status || '',
        child.family_situation || ''
    ].join(' ').toLowerCase();
    
    if (!sponsorTexts.trim() || !childTexts.trim()) return 0;
    
    // Extract keywords from sponsor text
    const sponsorKeywords = extractKeywords(sponsorTexts);
    const childKeywords = extractKeywords(childTexts);
    
    if (sponsorKeywords.length === 0 || childKeywords.length === 0) return 0;
    
    // Calculate keyword overlap
    const commonKeywords = sponsorKeywords.filter(word => 
        childKeywords.some(childWord => 
            childWord.includes(word) || word.includes(childWord) || 
            calculateLevenshteinSimilarity(word, childWord) > 0.7
        )
    );
    
    return commonKeywords.length / Math.max(sponsorKeywords.length, childKeywords.length);
}

function extractKeywords(text) {
    const stopWords = ['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'is', 'are', 'was', 'were', 'be', 'been', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'can', 'i', 'you', 'he', 'she', 'it', 'we', 'they', 'this', 'that', 'these', 'those'];
    
    return text
        .replace(/[^a-zA-Z\s]/g, '')
        .split(/\s+/)
        .filter(word => word.length > 2 && !stopWords.includes(word))
        .slice(0, 20); // Limit to top 20 keywords
}

function calculateLevenshteinSimilarity(str1, str2) {
    const matrix = [];
    const len1 = str1.length;
    const len2 = str2.length;
    
    if (len1 === 0) return len2 === 0 ? 1 : 0;
    if (len2 === 0) return 0;
    
    for (let i = 0; i <= len2; i++) {
        matrix[i] = [i];
    }
    
    for (let j = 0; j <= len1; j++) {
        matrix[0][j] = j;
    }
    
    for (let i = 1; i <= len2; i++) {
        for (let j = 1; j <= len1; j++) {
            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1,
                    matrix[i][j - 1] + 1,
                    matrix[i - 1][j] + 1
                );
            }
        }
    }
    
    const maxLen = Math.max(len1, len2);
    return (maxLen - matrix[len2][len1]) / maxLen;
}
</script>
{% endblock %}